<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operation Electi - Homepage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .file-input-label {
            cursor: pointer;
            display: inline-block;
            text-align: center;
            transition: background-color 0.3s;
        }
        input[type="file"] {
            display: none;
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }
        .toast-notification {
            background-color: #2d3748;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transform: translateX(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            position: relative;
        }
        .toast-notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast-notification.info { background-color: #2b6cb0; }
        .toast-notification.error { background-color: #c53030; }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-7xl">
        <header class="text-center mb-12">
            <div class="flex justify-center items-center gap-4 mb-2">
                <img src="https://i.ibb.co/JNyxxBv/logo.png" alt="Operation Electi Logo" class="h-20 w-20" onerror="this.onerror=null; this.src='https://placehold.co/80x80/e0e0e0/333?text=Logo';">
                <h1 class="text-6xl font-bold text-gray-900">Operation Electi</h1>
            </div>
            <p class="mt-2 text-xl text-gray-600">Your central hub for competitive programming analytics and tools.</p>
        </header>

        <main class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-8">
            <!-- Card 1: Readiness Calculator -->
            <div class="bg-white rounded-xl shadow-lg p-8 flex flex-col hover:shadow-2xl transition-shadow duration-300">
                <h2 class="text-2xl font-bold text-gray-800 mb-3">Contest Readiness Calculator</h2>
                <p class="text-gray-600 flex-grow mb-6">
                    Analyze Codeforces performance to determine readiness for Div. 2 contests and Luna rounds.
                </p>
                <a href="readiness.html" class="text-center bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors duration-300">
                    Open Calculator
                </a>
            </div>

            <!-- Card 2: User Management -->
            <div class="bg-white rounded-xl shadow-lg p-8 flex flex-col hover:shadow-2xl transition-shadow duration-300">
                <h2 class="text-2xl font-bold text-gray-800 mb-3">User Management</h2>
                <p class="text-gray-600 flex-grow mb-6">
                    Manage the user database. Add, edit, and view detailed user profiles, including placements and scores.
                </p>
                <a href="data.html" class="text-center bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-300">
                    Manage Users
                </a>
            </div>

            <!-- Card 3: Data Editor -->
            <div class="bg-white rounded-xl shadow-lg p-8 flex flex-col hover:shadow-2xl transition-shadow duration-300">
                <h2 class="text-2xl font-bold text-gray-800 mb-3">Data Editor</h2>
                <p class="text-gray-600 flex-grow mb-6">
                    Edit and manage core datasets. This includes adding or modifying competitions, universities, and teams.
                </p>
                <a href="editor.html" class="text-center bg-sky-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-sky-700 transition-colors duration-300">
                    Open Editor
                </a>
            </div>

            <!-- Card 4: Analytics Dashboard -->
            <div class="bg-white rounded-xl shadow-lg p-8 flex flex-col hover:shadow-2xl transition-shadow duration-300">
                <h2 class="text-2xl font-bold text-gray-800 mb-3">Analytics Dashboard</h2>
                <p class="text-gray-600 flex-grow mb-6">
                   Explore insightful visualizations and analyze performance across universities, teams, and competitions.
                </p>
                <a href="analytics.html" class="text-center bg-teal-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-700 transition-colors duration-300">
                    Open Dashboard
                </a>
            </div>

            <!-- Card 5: Data Management -->
            <div class="bg-white rounded-xl shadow-lg p-8 flex flex-col hover:shadow-2xl transition-shadow duration-300">
                <h2 class="text-2xl font-bold text-gray-800 mb-3">Data Management</h2>
                <p class="text-gray-600 flex-grow mb-6">
                   Import and export your entire dataset. Use this to backup your data or load a previous state.
                </p>
                <div class="flex flex-col space-y-3">
                    <label for="jsonFileInput" class="file-input-label bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700">
                        Import Data (JSON)
                    </label>
                    <input type="file" id="jsonFileInput" accept=".json">
                    <button id="exportDataBtn" class="text-center bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                        Export Data (JSON)
                    </button>
                </div>
            </div>
        </main>
        
        <!-- Toast Notification Container -->
        <div id="toast-container"></div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm p-6 relative transform scale-95">
            <h3 id="passwordModalTitle" class="text-lg font-bold mb-4">Enter Password</h3>
            <form id="passwordForm">
                <div class="space-y-4">
                    <div>
                        <label for="passwordField" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="passwordField" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div id="confirmPasswordContainer" class="hidden">
                        <label for="confirmPasswordField" class="block text-sm font-medium text-gray-700">Confirm Password</label>
                        <input type="password" id="confirmPasswordField" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="passwordCancelBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" id="passwordOkBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">OK</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative transform scale-95">
            <h3 id="confirmationModalTitle" class="text-lg font-bold mb-4">Confirm Action</h3>
            <p id="confirmationModalMessage" class="text-gray-700 mb-6">Are you sure?</p>
            <div class="flex justify-end gap-4">
                <button id="confirmCancelBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="confirmOkBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENT REFERENCES ---
            const jsonFileInput = document.getElementById('jsonFileInput');
            const exportDataBtn = document.getElementById('exportDataBtn');
            const confirmationModal = document.getElementById('confirmationModal');
            const confirmationModalTitle = document.getElementById('confirmationModalTitle');
            const confirmationModalMessage = document.getElementById('confirmationModalMessage');
            const confirmCancelBtn = document.getElementById('confirmCancelBtn');
            const confirmOkBtn = document.getElementById('confirmOkBtn');
            const passwordModal = document.getElementById('passwordModal');
            const passwordModalTitle = document.getElementById('passwordModalTitle');
            const passwordForm = document.getElementById('passwordForm');
            const passwordField = document.getElementById('passwordField');
            const confirmPasswordContainer = document.getElementById('confirmPasswordContainer');
            const confirmPasswordField = document.getElementById('confirmPasswordField');
            const passwordCancelBtn = document.getElementById('passwordCancelBtn');
            const passwordOkBtn = document.getElementById('passwordOkBtn');

            // --- STATE VARIABLES ---
            let confirmCallback = null;
            let passwordCallback = null;
            const LOCAL_STORAGE_KEY = 'electiToolData_v18';

            // --- CRYPTOGRAPHY ---
            const textEncoder = new TextEncoder();
            const textDecoder = new TextDecoder();

            function arrayBufferToBase64(buffer) {
                let binary = '';
                const bytes = new Uint8Array(buffer);
                const len = bytes.byteLength;
                for (let i = 0; i < len; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return window.btoa(binary);
            }

            function base64ToArrayBuffer(base64) {
                const binary_string = window.atob(base64);
                const len = binary_string.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binary_string.charCodeAt(i);
                }
                return bytes.buffer;
            }

            async function getEncryptionKey(password, salt) {
                const keyMaterial = await window.crypto.subtle.importKey(
                    "raw",
                    textEncoder.encode(password),
                    { name: "PBKDF2" },
                    false,
                    ["deriveKey"]
                );
                return window.crypto.subtle.deriveKey(
                    {
                        name: "PBKDF2",
                        salt: salt,
                        iterations: 100000,
                        hash: "SHA-256",
                    },
                    keyMaterial,
                    { name: "AES-GCM", length: 256 },
                    true,
                    ["encrypt", "decrypt"]
                );
            }

            async function encryptData(data, password) {
                try {
                    const salt = window.crypto.getRandomValues(new Uint8Array(16));
                    const iv = window.crypto.getRandomValues(new Uint8Array(12));
                    const key = await getEncryptionKey(password, salt);
                    
                    const encryptedContent = await window.crypto.subtle.encrypt(
                        { name: "AES-GCM", iv: iv },
                        key,
                        textEncoder.encode(data)
                    );

                    return {
                        salt: arrayBufferToBase64(salt),
                        iv: arrayBufferToBase64(iv),
                        data: arrayBufferToBase64(encryptedContent)
                    };
                } catch (error) {
                    console.error("Encryption failed:", error);
                    showToast("Encryption failed. See console for details.", "error");
                    return null;
                }
            }

            async function decryptData(encryptedPayload, password) {
                try {
                    const salt = base64ToArrayBuffer(encryptedPayload.salt);
                    const iv = base64ToArrayBuffer(encryptedPayload.iv);
                    const data = base64ToArrayBuffer(encryptedPayload.data);
                    const key = await getEncryptionKey(password, salt);

                    const decryptedContent = await window.crypto.subtle.decrypt(
                        { name: "AES-GCM", iv: iv },
                        key,
                        data
                    );

                    return textDecoder.decode(decryptedContent);
                } catch (error) {
                    console.error("Decryption failed:", error);
                    return null;
                }
            }

            // --- NOTIFICATION & MODAL ---
            function showToast(message, type = 'info', duration = 3000) {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast-notification ${type}`;
                toast.textContent = message;
                container.appendChild(toast);

                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);

                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, duration);
            }

            function showConfirmationModal(title, message, onConfirm) { 
                confirmationModalTitle.textContent = title; 
                confirmationModalMessage.textContent = message; 
                confirmCallback = onConfirm; 
                confirmationModal.classList.remove('hidden'); 
                setTimeout(() => { 
                    confirmationModal.querySelector('.modal-overlay')?.classList.remove('opacity-0'); 
                    confirmationModal.querySelector('.modal-content')?.classList.remove('scale-95'); 
                }, 10); 
            }

            function hideConfirmationModal() { 
                confirmationModal.querySelector('.modal-overlay')?.classList.add('opacity-0'); 
                confirmationModal.querySelector('.modal-content')?.classList.add('scale-95'); 
                setTimeout(() => { 
                    confirmationModal.classList.add('hidden'); 
                    confirmCallback = null; 
                }, 300); 
            }

            function showPasswordModal(title, showConfirm, onConfirm) {
                passwordModalTitle.textContent = title;
                passwordForm.reset();
                confirmPasswordContainer.style.display = showConfirm ? 'block' : 'none';
                confirmPasswordField.required = showConfirm;
                passwordCallback = onConfirm;
                passwordModal.classList.remove('hidden');
                setTimeout(() => {
                    passwordModal.querySelector('.modal-overlay')?.classList.remove('opacity-0');
                    passwordModal.querySelector('.modal-content')?.classList.remove('scale-95');
                    passwordField.focus();
                }, 10);
            }

            function hidePasswordModal() {
                passwordModal.querySelector('.modal-overlay')?.classList.add('opacity-0');
                passwordModal.querySelector('.modal-content')?.classList.add('scale-95');
                setTimeout(() => {
                    passwordModal.classList.add('hidden');
                    passwordCallback = null;
                }, 300);
            }

            // --- HELPER FUNCTIONS ---
            function getFormattedDateTimeString() { 
                const now = new Date(); 
                const pad = (num) => num.toString().padStart(2, '0'); 
                return `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}`; 
            }

            function downloadFile(content, fileName, mimeType) { 
                const blob = new Blob([content], { type: mimeType }); 
                const link = document.createElement('a'); 
                link.href = URL.createObjectURL(blob); 
                link.download = fileName; 
                document.body.appendChild(link); 
                link.click(); 
                document.body.removeChild(link); 
            }

            // --- CORE LOGIC ---
            function loadDataIntoStorage(jsonData, fileName) {
                try {
                    const data = JSON.parse(jsonData);
                    if (data.users && data.teams && data.competitions && data.universities) {
                        showConfirmationModal('Overwrite Local Data?', `This will overwrite all existing data in your browser's storage. Are you sure you want to continue?`, () => {
                            localStorage.setItem(LOCAL_STORAGE_KEY, jsonData);
                            showToast(`Data from ${fileName} imported successfully!`, 'info');
                        });
                    } else {
                        showToast('Error: Invalid JSON file format.', 'error');
                    }
                } catch (error) {
                    console.error("Error parsing JSON data:", error);
                    showToast('Error: Failed to read or parse the data.', 'error');
                }
            }

            // --- Event listener for file import ---
            jsonFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileContent = e.target.result;
                    try {
                        const data = JSON.parse(fileContent);
                        // Check if it's an encrypted backup
                        if (data.salt && data.iv && data.data) {
                            showPasswordModal('Enter Decryption Password', false, async (password) => {
                                const decryptedJson = await decryptData(data, password);
                                if (!decryptedJson) {
                                    showToast('Decryption failed. Incorrect password or corrupt file.', 'error');
                                    return;
                                }
                                loadDataIntoStorage(decryptedJson, file.name);
                            });
                        } else { // Assume it's a plain JSON backup
                            loadDataIntoStorage(fileContent, file.name);
                        }
                    } catch (error) {
                        console.error("Error reading file:", error);
                        showToast('Error: Could not read the file. It might not be valid JSON.', 'error');
                    }
                };
                reader.readAsText(file);
                jsonFileInput.value = ''; // Reset for re-upload
            });

            // --- Event listener for data export ---
            exportDataBtn.addEventListener('click', () => {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (!data) {
                    showToast('No data in local storage to export.', 'error');
                    return;
                }

                showPasswordModal('Create Backup Password', true, async (password) => {
                    const encryptedPayload = await encryptData(data, password);
                    if (encryptedPayload) {
                        const encryptedJsonString = JSON.stringify(encryptedPayload, null, 2);
                        downloadFile(encryptedJsonString, `electi_backup_encrypted_${getFormattedDateTimeString()}.json`, 'application/json');
                        showToast("Encrypted backup downloaded successfully.", "info");
                    }
                });
            });

            // --- Modal event listeners ---
            confirmCancelBtn.addEventListener('click', hideConfirmationModal);
            confirmOkBtn.addEventListener('click', () => { 
                if (confirmCallback) confirmCallback(); 
                hideConfirmationModal(); 
            });
            passwordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const password = passwordField.value;
                if (confirmPasswordField.required && password !== confirmPasswordField.value) {
                    showToast("Passwords do not match.", "error");
                    return;
                }
                if (passwordCallback) {
                    passwordCallback(password);
                }
                hidePasswordModal();
            });
            passwordCancelBtn.addEventListener('click', hidePasswordModal);
        });
    </script>

</body>
</html>

