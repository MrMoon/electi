<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codeforces Div. 2 Readiness Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Modal styles */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-gray-900">Codeforces Div. 2 Readiness Analyzer</h1>
            <p class="mt-2 text-lg text-gray-600">Evaluate user profiles to estimate their readiness for Division 2 contests.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Left Column: Inputs and Controls -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Manual User Input -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold mb-4">1. Add User Manually</h2>
                    <div class="space-y-4">
                        <input type="text" id="handleInput" placeholder="Codeforces Handle" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="number" id="lunaScoreInput" placeholder="Luna Score (0-200)" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="placementsInput" placeholder="Placements (e.g., 15, 22, 8)" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="addManualUserBtn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 transition duration-200">Add User</button>
                    </div>
                </div>

                <!-- CSV Upload -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold mb-4">2. Or Load from CSV</h2>
                    <p class="text-sm text-gray-500 mb-3">CSV format: `handle,luna_score,"placement1;placement2;..."`</p>
                    <input type="file" id="csvFileInput" accept=".csv" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <button id="loadCsvBtn" class="w-full mt-4 bg-gray-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-700 transition duration-200">Load from File</button>
                </div>

                <!-- User List -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">3. User List (<span id="userCount">0</span>)</h2>
                        <button id="clearListBtn" class="text-sm text-red-500 hover:text-red-700 font-semibold">Clear All</button>
                    </div>
                    <div id="noUsersMessage" class="text-center text-gray-500 py-4">Add users to get started.</div>
                    <ul id="userList" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- User list items will be injected here -->
                    </ul>
                </div>
            </div>

            <!-- Right Column: Processing and Results -->
            <div class="lg:col-span-8">
                <!-- Controls -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                     <h2 class="text-xl font-bold mb-4">4. Analyze & Download</h2>
                     <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mb-4" role="alert"></div>
                     <div class="flex flex-col sm:flex-row gap-4">
                        <button id="processAllBtn" class="flex-1 bg-green-600 text-white font-bold py-3 px-4 rounded-md hover:bg-green-700 transition duration-200 flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                            Process All Users
                        </button>
                        <button id="downloadCsvBtn" disabled class="flex-1 bg-purple-600 text-white font-bold py-3 px-4 rounded-md hover:bg-purple-700 transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            Download Results
                        </button>
                     </div>
                </div>

                <!-- Loading Indicator -->
                <div id="loadingIndicator" class="hidden text-center py-10">
                    <div class="spinner h-12 w-12 rounded-full border-4 border-gray-200 mx-auto"></div>
                    <p class="mt-4 text-lg font-semibold text-gray-600">Processing users... This may take a moment.</p>
                    <p class="text-sm text-gray-500">Fetching data from the Codeforces API with rate limiting.</p>
                </div>

                <!-- Results Table -->
                <div id="resultsTableContainer" class="hidden bg-white rounded-lg shadow-md overflow-x-auto">
                    <table id="resultsTable" class="w-full text-sm text-left text-gray-600">
                        <thead class="bg-gray-100 text-xs text-gray-700 uppercase">
                            <tr>
                                <th scope="col" class="px-4 py-3">Handle</th>
                                <th scope="col" class="px-4 py-3">Div2 Perf. Score</th>
                                <th scope="col" class="px-4 py-3">Avg Placement</th>
                                <th scope="col" class="px-4 py-3 text-center">Readiness</th>
                                <th scope="col" class="px-4 py-3 text-center">Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Result rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- Model Explanation -->
        <section id="modelExplanation" class="mt-12 bg-white rounded-lg shadow-md p-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">How It Works: The Readiness Model</h2>
            <div class="space-y-6 text-gray-700">
                 <p>This tool estimates a user's readiness for Codeforces Division 2 contests using a model that combines multiple data points. It's not a simple checklist; instead, it weighs different factors to produce a probabilistic score.</p>
                
                <div>
                    <h3 class="text-lg font-semibold mb-2">1. Feature Scoring with Logistic Curves</h3>
                    <p>Raw statistics (like a rating of 2000 or 100 contests) are not used directly. Instead, each key metric is converted into a standardized score (typically on a 0-100 scale) using a <strong class="font-semibold">logistic function (S-curve)</strong>. This has two benefits:</p>
                    <ul class="list-disc list-inside mt-2 pl-4 space-y-1">
                        <li><strong>Diminishing Returns:</strong> The difference between 0 and 20 contests is significant, but the difference between 100 and 120 is less so. S-curves capture this reality.</li>
                        <li><strong>Normalization:</strong> It puts different metrics (like rating and contest count) onto a comparable scale before they are combined.</li>
                    </ul>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-2">2. Key Metrics Used</h3>
                    <p>The model analyzes the following features:</p>
                    <ul class="list-disc list-inside mt-2 pl-4 space-y-2">
                        <li><strong class="font-semibold">Max & Average Rating:</strong> Measures peak performance and overall consistency.</li>
                        <li><strong class="font-semibold">Contest Count:</strong> A measure of overall experience.</li>
                        <li><strong class="font-semibold">Recency-Weighted Solved Problems:</strong> Scores all solved problems, giving more weight to harder problems and more recent solves. This rewards continuous practice.</li>
                        <li><strong class="font-semibold">Average Div. 2 Performance Score:</strong> This metric calculates a weighted score for each Div. 2 contest (A=1, B=2, C=4, etc.) and then finds the *average* score across all Div. 2 contests. This value is then curved to produce a score from 0-100, rewarding consistent high performance.</li>
                        <li><strong class="font-semibold">Luna Score (Manual Input):</strong> A manually provided score that can represent factors not visible on Codeforces, like theoretical knowledge or performance in other platforms.</li>
                        <li><strong class="font-semibold">Placement Score (Manual Input):</strong> This score is derived from user-provided contest placement percentages. To better reward top-tier performance, the model uses a non-linear curve by calculating the <strong class="font-semibold">Root Mean Square (RMS)</strong> of the inverted placements. This gives much greater weight to top placements (e.g., Top 5%) compared to mediocre ones.</li>
                        <li><strong class="font-semibold">Inactivity & Skipped Submissions:</strong> Small penalties are applied for long periods of inactivity and for skipped problems in contests.</li>
                    </ul>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-2">3. Final Probability Calculation</h3>
                    <p>Each of the feature scores is multiplied by a specific <strong class="font-semibold">weight</strong>, reflecting its importance in the model. These weighted scores are summed up. Finally, this total sum is passed through a <strong class="font-semibold">Sigmoid function</strong>, which squashes the output into a value between 0 and 1, representing the final readiness probability.</p>
                    <p class="mt-2 text-sm text-gray-600"><strong>Disclaimer:</strong> This is an estimation model based on statistical analysis. It provides a data-driven guideline but is not a definitive judgment of a user's ability or future success.</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-6 relative transform scale-95">
            <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <div id="modalContentContainer">
                <!-- Content will be injected here -->
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            const handleInput = document.getElementById('handleInput');
            const lunaScoreInput = document.getElementById('lunaScoreInput');
            const placementsInput = document.getElementById('placementsInput');
            const addManualUserBtn = document.getElementById('addManualUserBtn');
            const csvFileInput = document.getElementById('csvFileInput');
            const loadCsvBtn = document.getElementById('loadCsvBtn');
            const clearListBtn = document.getElementById('clearListBtn');
            const processAllBtn = document.getElementById('processAllBtn');
            const downloadCsvBtn = document.getElementById('downloadCsvBtn');
            const userList = document.getElementById('userList');
            const userCount = document.getElementById('userCount');
            const noUsersMessage = document.getElementById('noUsersMessage');
            const resultsTableContainer = document.getElementById('resultsTableContainer');
            const resultsTableBody = document.querySelector('#resultsTable tbody');
            const errorMessageDiv = document.getElementById('errorMessage');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const detailsModal = document.getElementById('detailsModal');
            const modalContentContainer = document.getElementById('modalContentContainer');
            const closeModalBtn = document.getElementById('closeModalBtn');

            // --- State Variables ---
            let usersToAnalyze = [];
            let cachedUserData = [];
            let ratingChart = null;
            let problemChart = null;

            // --- Core Calculation Logic & Model ---

            const sigmoid = (x) => 1 / (1 + Math.exp(-x));
            const logisticCurve = (x, L, k, x0) => L / (1 + Math.exp(-k * (x - x0)));

            // --- Feature Scoring Functions ---
            function getScoreFromMaxRating(maxRating) { return logisticCurve(maxRating, 60, 0.01, 1750); }
            function getScoreFromAvgRating(avgRating) { return logisticCurve(avgRating, 50, 0.012, 1650); }
            function getScoreFromContestCount(contestCount) { return logisticCurve(contestCount, 20, 0.05, 75); }
            function getScoreFromLunaScore(lunaScore) { return logisticCurve(lunaScore, 50, 0.05, 150); }
            
            // ** IMPROVED **: This function now scores the *average* performance per Div. 2 contest.
            function getScoreFromAvgDiv2Performance(avgScore) { 
                // The curve is centered around an average score of 7 (e.g., solving A+B+C on average).
                return logisticCurve(avgScore, 80, 0.4, 7); 
            }

            function getScoreFromPlacements(placements) {
                if (!placements || placements.length === 0) return 0;
                const invertedScores = placements.map(p => 100 - p);
                const sumOfSquares = invertedScores.reduce((acc, score) => acc + score * score, 0);
                const rms = Math.sqrt(sumOfSquares / invertedScores.length);
                return logisticCurve(rms, 70, 0.08, 75);
            }

            function getRecencyWeightedSolvedProblemScore(submissions) {
                let score = 0;
                const solvedProblemIds = new Set();
                const now = Date.now() / 1000;
                const DECAY_CONSTANT = 0.005; 
                const RATING_BASE = 1200;
                const GROWTH_FACTOR = 1.15;

                const sortedSubmissions = submissions.sort((a, b) => b.creationTimeSeconds - a.creationTimeSeconds);

                for (const sub of sortedSubmissions) {
                    if (sub.verdict !== 'OK' || !sub.problem.rating) continue;
                    const problemId = `${sub.problem.contestId || 'gym'}-${sub.problem.index}`;
                    if (solvedProblemIds.has(problemId)) continue;
                    solvedProblemIds.add(problemId);

                    const daysOld = (now - sub.creationTimeSeconds) / (60 * 60 * 24);
                    const recencyWeight = Math.exp(-DECAY_CONSTANT * daysOld);
                    const problemScore = Math.pow(GROWTH_FACTOR, (sub.problem.rating - RATING_BASE) / 100);
                    score += problemScore * recencyWeight;
                }
                return logisticCurve(score, 40, 0.002, 1500);
            }

            function calculateReadinessProbability(stats) {
                const weights = {
                    bias: -6.0,
                    maxRating: 0.02,
                    avgRating: 0.01,
                    contestCount: 0.03,
                    lunaScore: 0.04,
                    placementScore: 0.08,
                    avgDiv2PerfScore: 0.15, // Increased weight for this powerful metric
                    weightedSolves: 0.07,
                    daysInactive: -0.02,
                    skipped: -0.01
                };

                const z = weights.bias +
                    (stats.scoreMaxRating * weights.maxRating) +
                    (stats.scoreAvgRating * weights.avgRating) +
                    (stats.scoreContestCount * weights.contestCount) +
                    (stats.scoreFromLunaScore * weights.lunaScore) +
                    (stats.scoreFromPlacements * weights.placementScore) +
                    (stats.scoreFromAvgDiv2Performance * weights.avgDiv2PerfScore) +
                    (stats.scoreWeightedSolvedProblems * weights.weightedSolves) +
                    (stats.daysSinceLastAttempt * weights.daysInactive) +
                    (stats.skippedSubmissionsCount * weights.skipped);

                return sigmoid(z);
            }

            // --- UI and Helper Functions ---

            function addManualUserToList() {
                const handle = handleInput.value.trim();
                const lunaScore = parseFloat(lunaScoreInput.value);
                const placementsStr = placementsInput.value.trim();

                if (!handle) { displayError('Please enter a Codeforces handle.'); return; }
                if (isNaN(lunaScore) || lunaScore < 0 || lunaScore > 200) { displayError('Please enter a valid Luna Score (0-200).'); return; }
                if (!placementsStr) { displayError('Please enter contest placement percentages.'); return; }

                const placements = placementsStr.split(',').map(p => parseFloat(p.trim())).filter(p => !isNaN(p));
                if (placements.length === 0 || !placements.every(p => p >= 0 && p <= 100)) {
                    displayError('Please enter valid, comma-separated percentages (0-100).'); return;
                }

                const normalizedHandle = handle.toLowerCase();
                if (usersToAnalyze.some(user => user.handle.toLowerCase() === normalizedHandle)) {
                    displayError(`User "${handle}" is already in the list.`); return;
                }

                usersToAnalyze.push({ handle, lunaScore, placements });
                updateUserListDisplay();
                handleInput.value = '';
                lunaScoreInput.value = '';
                placementsInput.value = '';
                hideError();
            }

            function loadCSVFile() {
                const file = csvFileInput.files[0];
                if (!file) { displayError('Please select a CSV file.'); return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try { parseCSV(e.target.result); hideError(); } 
                    catch (error) { displayError(`Error parsing CSV: ${error.message}`); }
                };
                reader.readAsText(file);
            }

            function parseCSV(csvString) {
                const lines = csvString.trim().split('\n');
                if (lines.length === 0) throw new Error('CSV file is empty or invalid.');
                
                const newUsersFromCsv = [];
                const startLine = lines[0].toLowerCase().includes('handle') ? 1 : 0;

                for(let i = startLine; i < lines.length; i++) {
                    const line = lines[i];
                    const parts = line.split(',');
                    if (parts.length < 3) continue;

                    const handle = parts[0]?.trim();
                    const lunaScore = parseFloat(parts[1]?.trim());
                    const placementsStr = parts.slice(2).join(',').trim().replace(/"/g, ''); 
                    
                    if (!handle || isNaN(lunaScore) || !placementsStr) continue;

                    const placements = placementsStr.split(/[;,]/).map(p => parseFloat(p.trim())).filter(p => !isNaN(p));
                    if (placements.length === 0 || !placements.every(p => p >= 0 && p <= 100)) continue;

                    const normalizedHandle = handle.toLowerCase();
                    if (usersToAnalyze.some(u => u.handle.toLowerCase() === normalizedHandle)) continue;
                    
                    newUsersFromCsv.push({ handle, lunaScore, placements });
                }

                if (newUsersFromCsv.length === 0) throw new Error('No valid new users found in CSV.');
                
                usersToAnalyze.push(...newUsersFromCsv);
                updateUserListDisplay();
                displayError(`Loaded ${newUsersFromCsv.length} new users. Total: ${usersToAnalyze.length}`);
                csvFileInput.value = '';
            }

            function updateUserListDisplay() {
                userList.innerHTML = '';
                userCount.textContent = usersToAnalyze.length;
                if (usersToAnalyze.length === 0) {
                    noUsersMessage.classList.remove('hidden');
                } else {
                    noUsersMessage.classList.add('hidden');
                    usersToAnalyze.forEach((user, index) => {
                        const listItem = document.createElement('li');
                        listItem.className = 'p-2 bg-gray-50 rounded-md text-sm flex justify-between items-center border border-gray-200';
                        listItem.innerHTML = `<span><span class="font-semibold">${user.handle}</span> (Luna: ${user.lunaScore})</span>
                                            <button data-index="${index}" class="remove-btn text-red-500 hover:text-red-700 font-bold px-2">Ã—</button>`;
                        userList.appendChild(listItem);
                    });
                    userList.querySelectorAll('.remove-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const indexToRemove = parseInt(e.currentTarget.dataset.index, 10);
                            usersToAnalyze.splice(indexToRemove, 1);
                            updateUserListDisplay();
                        });
                    });
                }
            }

            function clearUserList() {
                usersToAnalyze = [];
                cachedUserData = [];
                updateUserListDisplay();
                resultsTableBody.innerHTML = '';
                resultsTableContainer.classList.add('hidden');
                hideError();
                downloadCsvBtn.disabled = true;
                csvFileInput.value = '';
                handleInput.value = '';
                lunaScoreInput.value = '';
                placementsInput.value = '';
            }

            function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

            async function processAllUsers() {
                if (usersToAnalyze.length === 0) { displayError('Please add users to the list first.'); return; }
                resultsTableBody.innerHTML = '';
                resultsTableContainer.classList.remove('hidden');
                hideError();
                showLoading();
                downloadCsvBtn.disabled = true;

                for (let i = 0; i < usersToAnalyze.length; i++) {
                    const user = usersToAnalyze[i];
                    let userData;
                    const cachedUser = cachedUserData.find(data => data.handle.toLowerCase() === user.handle.toLowerCase());

                    if (cachedUser && !cachedUser.error) {
                        userData = { ...cachedUser, lunaScore: user.lunaScore, placements: user.placements };
                        userData.scoreFromLunaScore = getScoreFromLunaScore(user.lunaScore);
                        userData.scoreFromPlacements = getScoreFromPlacements(user.placements);
                        userData.readinessProbability = calculateReadinessProbability(userData);
                    } else {
                        try {
                            userData = await fetchStatsForHandle(user.handle, user.lunaScore, user.placements);
                        } catch (error) {
                            console.error(`Error fetching stats for ${user.handle}:`, error);
                            userData = { handle: user.handle, error: `Error: ${error.message.substring(0, 100)}...` };
                        }

                        const cacheIndex = cachedUserData.findIndex(data => data.handle.toLowerCase() === user.handle.toLowerCase());
                        if (cacheIndex > -1) cachedUserData[cacheIndex] = userData;
                        else cachedUserData.push(userData);

                        if (i < usersToAnalyze.length - 1) await sleep(1200);
                    }
                    appendUserRowToTable(userData);
                }
                hideLoading();
                downloadCsvBtn.disabled = false;
            }
            
            // ** IMPROVED **: This function now returns the *average* performance score per Div. 2 contest.
            function calculateAvgDiv2PerformanceScore(div2Submissions, div2ContestCount) {
                if (!div2Submissions || div2Submissions.length === 0 || div2ContestCount === 0) {
                    return 0;
                }

                const solvedInDiv2 = {};
                for (const sub of div2Submissions) {
                    if (sub.verdict === 'OK') {
                        if (!solvedInDiv2[sub.contestId]) solvedInDiv2[sub.contestId] = new Set();
                        solvedInDiv2[sub.contestId].add(sub.problem.index);
                    }
                }
                
                const problemWeights = { 'A': 1, 'B': 2, 'C': 4, 'D': 8, 'E': 12, 'F': 16 };
                let totalPerformanceScore = 0;

                for (const contestId in solvedInDiv2) {
                    const solvedProblems = Array.from(solvedInDiv2[contestId]);
                    let contestScore = 0;
                    for (const problemIndex of solvedProblems) {
                        const problemChar = problemIndex.charAt(0).toUpperCase();
                        contestScore += problemWeights[problemChar] || 0;
                    }
                    totalPerformanceScore += contestScore;
                }
                return totalPerformanceScore / div2ContestCount;
            }


            async function fetchStatsForHandle(handle, lunaScore, placements) {
                // Use Promise.all to fetch data concurrently
                const [userInfoResponse, userRatingResponse, userStatusResponse] = await Promise.all([
                    fetch(`https://codeforces.com/api/user.info?handles=${handle}`),
                    fetch(`https://codeforces.com/api/user.rating?handle=${handle}`),
                    fetch(`https://codeforces.com/api/user.status?handle=${handle}&from=1&count=5000`)
                ]);

                // User Info
                if (!userInfoResponse.ok) throw new Error(`User Info API failed: ${userInfoResponse.status}`);
                const userInfoData = await userInfoResponse.json();
                if (userInfoData.status === 'FAILED') throw new Error(userInfoData.comment);
                const userInfo = userInfoData.result[0];

                // User Rating
                if (!userRatingResponse.ok) throw new Error(`User Rating API failed: ${userRatingResponse.status}`);
                const userRatingData = await userRatingResponse.json();
                if (userRatingData.status === 'FAILED') throw new Error(userRatingData.comment);
                const allRatingChanges = userRatingData.result;
                
                // User Status
                if (!userStatusResponse.ok) throw new Error(`User Status API failed: ${userStatusResponse.status}`);
                const userStatusData = await userStatusResponse.json();
                if (userStatusData.status === 'FAILED') throw new Error(userStatusData.comment);
                const allSubmissions = userStatusData.result;
                
                const totalContestCount = allRatingChanges.length;
                const sumRatings = allRatingChanges.reduce((acc, curr) => acc + curr.newRating, 0);
                const averageContestRating = totalContestCount > 0 ? (sumRatings / totalContestCount) : 0;
                const maxRating = totalContestCount > 0 ? Math.max(...allRatingChanges.map(c => c.newRating)) : 0;
                let daysSinceLastAttempt = 365;
                if (allSubmissions.length > 0) {
                    const sortedSubs = [...allSubmissions].sort((a,b) => b.creationTimeSeconds - a.creationTimeSeconds);
                    daysSinceLastAttempt = (Date.now() / 1000 - sortedSubs[0].creationTimeSeconds) / (60 * 60 * 24);
                }
                const skippedSubmissionsCount = allSubmissions.filter(s => s.verdict === 'SKIPPED').length;
                
                const div2Contests = allRatingChanges.filter(c => c.contestName.includes('Div. 2'));
                const div2ContestIds = new Set(div2Contests.map(c => c.contestId));
                const div2Submissions = allSubmissions.filter(s => div2ContestIds.has(s.contestId));
                const div2ContestCount = div2Contests.length;
                
                const avgDiv2PerformanceScore = calculateAvgDiv2PerformanceScore(div2Submissions, div2ContestCount);

                const scoreMaxRating = getScoreFromMaxRating(maxRating);
                const scoreAvgRating = getScoreFromAvgRating(averageContestRating);
                const scoreContestCount = getScoreFromContestCount(totalContestCount);
                const scoreWeightedSolvedProblems = getRecencyWeightedSolvedProblemScore(allSubmissions);
                const scoreFromLunaScore = getScoreFromLunaScore(lunaScore);
                const scoreFromPlacements = getScoreFromPlacements(placements);
                const scoreFromAvgDiv2Performance = getScoreFromAvgDiv2Performance(avgDiv2PerformanceScore);

                const stats = {
                    handle, maxRating, averageContestRating, totalContestCount, lunaScore, placements, 
                    div2ContestCount, avgDiv2PerformanceScore,
                    skippedSubmissionsCount, daysSinceLastAttempt, 
                    scoreFromPlacements, scoreFromLunaScore, scoreMaxRating, scoreAvgRating, scoreContestCount,
                    scoreWeightedSolvedProblems, scoreFromAvgDiv2Performance,
                    // Additional data for modal
                    userInfo, allRatingChanges, allSubmissions
                };

                const readinessProbability = calculateReadinessProbability(stats);
                return { ...stats, readinessProbability };
            }

            function appendUserRowToTable(userData) {
                const row = resultsTableBody.insertRow();
                if (userData.error) {
                    row.innerHTML = `<td colspan="5" class="px-4 py-3 text-red-600 font-bold">${userData.handle}: ${userData.error}</td>`;
                    return;
                }

                const probability = userData.readinessProbability * 100;
                let probClass = '', confidence = 'Low';
                if (probability >= 85) { probClass = 'bg-green-100 text-green-800'; confidence = 'Very High'; }
                else if (probability >= 65) { probClass = 'bg-emerald-100 text-emerald-800'; confidence = 'High'; }
                else if (probability >= 40) { probClass = 'bg-yellow-100 text-yellow-800'; confidence = 'Medium'; }
                else { probClass = 'bg-red-100 text-red-800'; }

                const avgPlacement = userData.placements.length > 0 ? userData.placements.reduce((a, b) => a + b, 0) / userData.placements.length : 0;

                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap font-semibold">${userData.handle}</td>
                    <td class="px-4 py-3 whitespace-nowrap font-bold text-center">${userData.avgDiv2PerformanceScore.toFixed(2)}</td>
                    <td class="px-4 py-3 whitespace-nowrap">Top ${avgPlacement.toFixed(1)}%</td>
                    <td class="px-4 py-3 whitespace-nowrap text-center rounded-md ${probClass}">
                        <div class="font-bold text-lg">${probability.toFixed(2)}%</div>
                        <div class="text-xs font-semibold">${confidence}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-center">
                        <button class="details-btn bg-indigo-100 text-indigo-700 text-xs font-bold py-1 px-3 rounded-full hover:bg-indigo-200" data-handle="${userData.handle}">
                            Details
                        </button>
                    </td>
                `;
            }

            function downloadFile(content, fileName, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function downloadResults() {
                if (usersToAnalyze.length === 0) { displayError('No user data to download.'); return; }

                const userRows = usersToAnalyze.map(user => {
                    const placementsStr = `"${user.placements.join(';')}"`;
                    return [user.handle, user.lunaScore, placementsStr].join(',');
                });
                const userCsvString = "handle,luna_score,placements\n" + userRows.join('\n');
                downloadFile(userCsvString, 'users_to_analyze.csv', 'text/csv;charset=utf-8;');

                if (cachedUserData.filter(d => !d.error).length === 0) {
                    displayError('Process users first to download full results.');
                    return;
                }

                const headers = ["Handle", "Readiness Probability (%)", "Confidence", "Avg Div. 2 Perf Score", "Luna Score", "Avg Placement (%)", "Total Contests", "Max Rating", "Avg Rating"];
                const resultRows = [headers.join(',')];
                const sortedData = [...cachedUserData].sort((a, b) => (b.readinessProbability || 0) - (a.readinessProbability || 0));
                
                sortedData.forEach(data => {
                    if (data.error) return;
                    
                    const probability = data.readinessProbability * 100;
                    let confidence = 'Low';
                    if (probability >= 85) { confidence = 'Very High'; }
                    else if (probability >= 65) { confidence = 'High'; }
                    else if (probability >= 40) { confidence = 'Medium'; }

                    const avgPlacement = data.placements.length > 0 ? data.placements.reduce((a, b) => a + b, 0) / data.placements.length : 0;
                    
                    const rowData = [
                        data.handle, 
                        probability.toFixed(2),
                        confidence,
                        data.avgDiv2PerformanceScore.toFixed(2),
                        data.lunaScore,
                        avgPlacement.toFixed(1),
                        data.totalContestCount,
                        data.maxRating, 
                        data.averageContestRating.toFixed(0)
                    ];
                    resultRows.push(rowData.join(','));
                });
                
                const resultCsvString = resultRows.join('\n');
                setTimeout(() => {
                    downloadFile(`readiness_results_${new Date().toISOString().slice(0,10)}.csv`, resultCsvString, 'text/csv;charset=utf-8;');
                }, 500); 
            }

            // --- Modal Functions ---
            function showUserDetailsModal(handle) {
                const userData = cachedUserData.find(d => d.handle.toLowerCase() === handle.toLowerCase());
                if (!userData) return;

                const { userInfo, allRatingChanges, allSubmissions } = userData;
                
                const registrationDate = new Date(userInfo.registrationTimeSeconds * 1000);
                const accountAge = ((Date.now() - registrationDate.getTime()) / (1000 * 3600 * 24 * 365.25)).toFixed(1);
                const name = `${userInfo.firstName || ''} ${userInfo.lastName || ''}`.trim() || 'N/A';
                
                // Build modal content
                modalContentContainer.innerHTML = `
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold text-gray-900">${userInfo.handle}</h2>
                        <p class="text-md text-gray-600">Name: <span class="font-semibold">${name}</span></p>
                        <p class="text-md text-gray-600">Account Age: <span class="font-semibold">${accountAge} years</span> (since ${registrationDate.toLocaleDateString()})</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div>
                            <h3 class="text-xl font-bold mb-2">Rating History</h3>
                            <canvas id="ratingChartCanvas"></canvas>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-2">Solved Problem Distribution</h3>
                            <canvas id="problemChartCanvas"></canvas>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl font-bold mb-4">Calculation Breakdown</h3>
                        <div id="calculationDetails" class="space-y-3 text-sm bg-gray-50 p-4 rounded-lg"></div>
                    </div>
                `;

                // Render charts
                createRatingChart(allRatingChanges);
                createProblemDistributionChart(allSubmissions);
                populateCalculationDetails(userData);

                // Show modal
                detailsModal.classList.remove('hidden');
                setTimeout(() => {
                    detailsModal.querySelector('.modal-overlay')?.classList.remove('opacity-0');
                    detailsModal.querySelector('.modal-content')?.classList.remove('scale-95');
                }, 10);
            }

            function hideModal() {
                detailsModal.querySelector('.modal-overlay')?.classList.add('opacity-0');
                detailsModal.querySelector('.modal-content')?.classList.add('scale-95');
                setTimeout(() => {
                    detailsModal.classList.add('hidden');
                    modalContentContainer.innerHTML = ''; // Clear content
                    if (ratingChart) ratingChart.destroy();
                    if (problemChart) problemChart.destroy();
                }, 300);
            }

            function createRatingChart(ratingData) {
                const ctx = document.getElementById('ratingChartCanvas').getContext('2d');
                const labels = ratingData.map(d => new Date(d.ratingUpdateTimeSeconds * 1000).toLocaleDateString());
                const data = ratingData.map(d => d.newRating);

                if (ratingChart) ratingChart.destroy();
                ratingChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Rating',
                            data: data,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1,
                            fill: false
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: true }
                });
            }

            function createProblemDistributionChart(submissionData) {
                const ctx = document.getElementById('problemChartCanvas').getContext('2d');
                const solvedProblems = new Map();
                submissionData.forEach(sub => {
                    if (sub.verdict === 'OK' && sub.problem.rating) {
                        const problemId = `${sub.problem.contestId}-${sub.problem.index}`;
                        solvedProblems.set(problemId, sub.problem.rating);
                    }
                });

                const ratingBuckets = {};
                for (let rating = 800; rating <= 3500; rating += 100) {
                    ratingBuckets[rating] = 0;
                }

                solvedProblems.forEach(rating => {
                    const bucket = Math.floor(rating / 100) * 100;
                    if (ratingBuckets[bucket] !== undefined) {
                        ratingBuckets[bucket]++;
                    }
                });
                
                if (problemChart) problemChart.destroy();
                problemChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(ratingBuckets),
                        datasets: [{
                            label: '# of Solved Problems',
                            data: Object.values(ratingBuckets),
                            backgroundColor: 'rgba(153, 102, 255, 0.6)'
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true } }, responsive: true, maintainAspectRatio: true }
                });
            }

            function populateCalculationDetails(data) {
                const container = document.getElementById('calculationDetails');
                const p = (num) => num.toFixed(2);
                const avgPlacement = data.placements.length > 0 ? data.placements.reduce((a, b) => a + b, 0) / data.placements.length : 0;

                container.innerHTML = `
                    <p><strong>Max Rating Score:</strong> logisticCurve(${data.maxRating}, 60, 0.01, 1750) = <span class="font-mono font-bold">${p(data.scoreMaxRating)}</span></p>
                    <p><strong>Avg Rating Score:</strong> logisticCurve(${p(data.averageContestRating)}, 50, 0.012, 1650) = <span class="font-mono font-bold">${p(data.scoreAvgRating)}</span></p>
                    <p><strong>Contest Count Score:</strong> logisticCurve(${data.totalContestCount}, 20, 0.05, 75) = <span class="font-mono font-bold">${p(data.scoreContestCount)}</span></p>
                    <p><strong>Avg Div. 2 Perf. Score:</strong> logisticCurve(${p(data.avgDiv2PerformanceScore)}, 80, 0.4, 7) = <span class="font-mono font-bold">${p(data.scoreFromAvgDiv2Performance)}</span></p>
                    <p><strong>Placements Score (RMS):</strong> logisticCurve(RMS([${data.placements.join(', ')}]), 70, 0.08, 75) = <span class="font-mono font-bold">${p(data.scoreFromPlacements)}</span></p>
                    <p><strong>Luna Score:</strong> logisticCurve(${data.lunaScore}, 50, 0.05, 150) = <span class="font-mono font-bold">${p(data.scoreFromLunaScore)}</span></p>
                    <hr class="my-2"/>
                    <p><strong>Final Probability:</strong> sigmoid(Z) = <span class="font-mono font-bold">${(data.readinessProbability * 100).toFixed(2)}%</span></p>
                `;
            }


            function displayError(message) { errorMessageDiv.textContent = message; errorMessageDiv.classList.remove('hidden'); }
            function hideError() { errorMessageDiv.classList.add('hidden'); }
            function showLoading() { 
                loadingIndicator.classList.remove('hidden'); 
                document.querySelectorAll('button, input').forEach(el => el.disabled = true); 
            }
            function hideLoading() { 
                loadingIndicator.classList.add('hidden'); 
                document.querySelectorAll('button, input').forEach(el => el.disabled = false); 
                if (cachedUserData.filter(d => !d.error).length === 0) {
                    downloadCsvBtn.disabled = true;
                } else {
                    downloadCsvBtn.disabled = false;
                }
            }

            // --- Event Listeners ---
            addManualUserBtn.addEventListener('click', addManualUserToList);
            loadCsvBtn.addEventListener('click', loadCSVFile);
            clearListBtn.addEventListener('click', clearUserList);
            processAllBtn.addEventListener('click', processAllUsers);
            downloadCsvBtn.addEventListener('click', downloadResults);
            
            handleInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') addManualUserToList() });
            lunaScoreInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') addManualUserToList() });
            placementsInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') addManualUserToList() });

            // Modal listeners
            closeModalBtn.addEventListener('click', hideModal);
            detailsModal.addEventListener('click', (e) => {
                if (e.target === detailsModal) hideModal();
            });
            
            // Details button listener (event delegation)
            resultsTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('details-btn')) {
                    const handle = e.target.dataset.handle;
                    showUserDetailsModal(handle);
                }
            });

            updateUserListDisplay();
        });
    </script>

</body>
</html>

