<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operation Electi - Data Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .sortable-header {
            cursor: pointer;
            position: relative;
            user-select: none;
        }
        .sortable-header .sort-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.3;
        }
        .sortable-header.sort-asc .sort-icon, .sortable-header.sort-desc .sort-icon {
             opacity: 1;
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #f9fafb;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
            z-index: 10;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        .dropdown-content a, .dropdown-content button {
            color: black;
            padding: 10px 14px;
            text-decoration: none;
            display: block;
            font-size: 0.875rem;
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
        }
        .dropdown-content a:hover, .dropdown-content button:hover {background-color: #e5e7eb;}
        .dropdown:hover .dropdown-content {display: block;}
        .file-input-label {
            cursor: pointer;
            display: inline-block;
            padding: 0.5rem 1rem;
            color: white;
            background-color: #4f46e5;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .file-input-label:hover {
            background-color: #4338ca;
        }
        input[type="file"] {
            display: none;
        }
        #detailedUserTable thead tr:nth-child(2) th {
            padding: 0.5rem;
        }
        #detailedUserTable thead input[type="text"] {
            width: 100%;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
        }
         #detailedUserForm input, #detailedUserForm select {
             width: 100%;
             padding: 6px 10px;
             border-radius: 0.375rem;
             border: 1px solid #d1d5db;
         }
         #detailedUserForm label {
             font-weight: 500;
             font-size: 0.875rem;
             color: #374151;
             margin-bottom: 0.25rem;
             display: block;
         }
        .placement-entry {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            position: relative;
        }
        /* Styles for clickable links */
        .user-link, .team-link, .competition-link {
            font-weight: 500;
            color: #4f46e5;
            cursor: pointer;
            text-decoration: none;
            background: none;
            border: none;
            padding: 0;
        }
        .user-link:hover, .team-link:hover, .competition-link:hover {
            text-decoration: underline;
        }
        
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }
        .toast-notification {
            background-color: #2d3748;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transform: translateX(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            position: relative;
        }
        .toast-notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast-notification.info { background-color: #2b6cb0; }
        .toast-notification.error { background-color: #c53030; }

        /* Select2 Styles */
        .select2-container--default .select2-selection--multiple {
            border: 1px solid #d1d5db;
            background-color: #f9fafb;
            border-radius: 4px;
        }
        .select2-container .select2-selection--multiple {
            min-height: 38px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50 text-gray-800">

    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-6">
            <div class="flex justify-between items-center gap-4 mb-2">
                <div class="flex items-center gap-4">
                    <img src="https://i.ibb.co/JNyxxBv/logo.png" alt="Operation Electi Logo" class="h-16 w-16" onerror="this.onerror=null; this.src='https://placehold.co/64x64/e0e0e0/333?text=Logo';">
                    <h1 class="text-5xl font-bold text-gray-900">Operation Electi</h1>
                </div>
                <a href="index.html" class="file-input-label bg-gray-600 hover:bg-gray-700 text-sm !px-6 !py-3">Home</a>
            </div>
            <p class="text-center mt-2 text-lg text-gray-600">A data management and analytics tool.</p>
        </header>

        <!-- Data Management Panel -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-8">
            <div class="flex flex-wrap justify-center items-center gap-x-6 gap-y-4">
                <div class="text-center">
                    <p class="font-medium text-gray-700 text-sm">Upload Users (CSV)</p>
                    <label for="uploadUsersCsv" class="file-input-label bg-green-600 hover:bg-green-700 text-sm mt-1">Choose File</label>
                    <input type="file" id="uploadUsersCsv" accept=".csv">
                </div>
                <div class="text-center">
                    <p class="font-medium text-gray-700 text-sm">Upload Competitions (CSV)</p>
                    <label for="uploadCompetitionsCsv" class="file-input-label bg-blue-600 hover:bg-blue-700 text-sm mt-1">Choose File</label>
                    <input type="file" id="uploadCompetitionsCsv" accept=".csv">
                </div>
                <div class="text-center">
                    <p class="font-medium text-gray-700 text-sm">Upload Universities (CSV)</p>
                    <label for="uploadUniversitiesCsv" class="file-input-label bg-indigo-600 hover:bg-indigo-700 text-sm mt-1">Choose File</label>
                    <input type="file" id="uploadUniversitiesCsv" accept=".csv">
                </div>
                <div class="text-center">
                    <p class="font-medium text-gray-700 text-sm">Full Backup (JSON)</p>
                    <button id="downloadDbFullBackupBtn" class="file-input-label bg-purple-600 hover:bg-purple-700 text-sm mt-1 w-full text-center">Download</button>
                </div>
                <div class="text-center">
                    <p class="font-medium text-gray-700 text-sm">Restore Backup (JSON)</p>
                    <label for="jsonFileInput" class="file-input-label bg-red-600 hover:bg-red-700 text-sm mt-1">Restore</label>
                    <input type="file" id="jsonFileInput" accept=".json">
                </div>
                 <div class="text-center">
                    <p class="font-medium text-gray-700 text-sm">AI Insights</p>
                    <button id="aiInsightBtn" class="file-input-label bg-fuchsia-600 hover:bg-fuchsia-700 text-sm mt-1 w-full text-center">Generate</button>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div id="tabContentDatabase">
            <!-- Form, Stats, and Table will be stacked vertically -->
            
            <!-- Add/Update User Form -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-2xl font-bold mb-4">Add/Update User Info</h2>
                <form id="detailedUserForm" class="space-y-4">
                     <!-- User Info Row -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="handleField">Codeforces Handle*</label>
                            <input type="text" id="handleField" name="handle" placeholder="e.g., tourist" required>
                        </div>
                        <div>
                            <label for="fullNameField">Full Name</label>
                            <input type="text" id="fullNameField" name="fullName" placeholder="e.g., Gennady Korotkevich">
                        </div>
                        <div>
                            <label for="linkedinField">LinkedIn Profile</label>
                            <input type="url" id="linkedinField" name="linkedin" placeholder="https://linkedin.com/in/...">
                        </div>
                    </div>
                    <!-- University & Scores Row -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="md:col-span-2">
                            <label for="universityInput">University</label>
                            <input type="text" list="university-list" name="university" id="universityInput" placeholder="Type or select university">
                            <datalist id="university-list"></datalist>
                        </div>
                        <div>
                            <label for="lunaNovaScoreField">Luna Nova Score</label>
                            <input type="number" step="0.01" id="lunaNovaScoreField" name="lunaNovaScore" placeholder="0.00">
                        </div>
                        <div>
                            <label for="lunaHardScoreField">Luna Score</label>
                            <input type="number" step="0.01" id="lunaHardScoreField" name="lunaHardScore" placeholder="0.00">
                        </div>
                    </div>
                     <!-- Other Info Row -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div>
                            <label for="acmLevel">ACM Level</label>
                            <select name="acmLevel" id="acmLevel">
                                <option value="0">None</option>
                                <option value="-1">Codeability</option>
                                <option value="10">Level 0</option>
                                <option value="1">Level 1</option>
                                <option value="2">Level 2</option>
                            </select>
                        </div>
                        <div>
                            <label for="joinDate">Join Date</label>
                            <input type="month" id="joinDate" name="joinDate">
                        </div>
                         <div>
                            <label for="universityStartDate">University Start Date</label>
                            <input type="month" id="universityStartDate" name="universityStartDate">
                        </div>
                        <div class="flex items-end gap-4">
                            <div class="flex-grow">
                                <label class="block text-sm font-medium text-gray-700">Profile Picture</label>
                                <input type="hidden" name="profilePicUrl" id="profilePicUrlHidden">
                                <label for="profilePicFile" id="profilePicFileLabel" class="file-input-label bg-gray-600 hover:bg-gray-700 text-sm !px-3 !py-2.5 whitespace-nowrap w-full text-center">Choose File</label>
                                <input type="file" id="profilePicFile" accept="image/*">
                            </div>
                            <div class="flex items-center pb-1">
                                <input type="checkbox" name="isTrusted" id="isTrustedCheckbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                <label for="isTrustedCheckbox" class="ml-2 !mb-0 block text-sm font-medium text-gray-900">Trusted</label>
                            </div>
                        </div>
                    </div>
                    <!-- Placements Section -->
                    <hr class="!my-6"/>
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold">Placements</h3>
                    </div>
                    <div id="placementsContainer" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
                    <button type="button" id="addPlacementBtn" class="w-full text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 transition duration-200">Add Placement</button>
                    <datalist id="competition-list"></datalist>
                    <hr class="!my-6"/>
                    <!-- Action Buttons -->
                    <div class="flex gap-4">
                        <button type="submit" id="saveUserBtn" class="w-full bg-green-600 text-white font-bold py-2.5 px-4 rounded-md hover:bg-green-700 transition duration-200">Save User</button>
                        <button type="button" id="clearFormBtn" class="w-full bg-gray-500 text-white font-bold py-2.5 px-4 rounded-md hover:bg-gray-600 transition duration-200">Clear Form</button>
                    </div>
                </form>
            </div>

            <!-- Statistics Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-bold mb-4">Database Statistics</h2>
                <div id="statsContainer" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 text-center">
                    <!-- Stats will be dynamically inserted here -->
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-6">
                    <div class="p-4"><canvas id="acmLevelChart"></canvas></div>
                    <div class="p-4"><canvas id="studentYearChart"></canvas></div>
                    <div class="p-4"><canvas id="competitionChart"></canvas></div>
                </div>
            </div>
            
            <!-- User Table Section -->
            <div class="bg-white rounded-lg shadow-md">
                <div class="p-4 border-b border-gray-200 flex flex-wrap justify-between items-center gap-4">
                     <h2 class="text-xl font-bold">User Database (<span id="databaseUserCount">0</span>)</h2>
                     <div class="dropdown">
                        <button class="bg-purple-600 text-white font-bold py-2 px-4 rounded-md hover:bg-purple-700 transition duration-200 flex items-center gap-2">
                            Download
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="dropdown-content">
                            <button id="downloadSelectedUsersCsvBtn">Download Selected Users (CSV)</button>
                            <button id="downloadAllUsersCsvBtn">Download All Users (CSV)</button>
                            <button id="downloadReadinessModelBtn">Download Readiness Model Input</button>
                            <button id="downloadDbFullBackupBtn_dummy">Download Full Backup (JSON)</button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table id="detailedUserTable" class="w-full text-sm text-left text-gray-600">
                        <thead class="bg-gray-100 text-xs text-gray-700 uppercase">
                            <tr>
                                <th class="p-2 w-10 text-center"><input type="checkbox" id="selectAllUsersCheckbox"></th>
                                <th class="p-2 sortable-header" data-sort-key="handle">Handle <span class="sort-icon"></span></th>
                                <th class="p-2 sortable-header" data-sort-key="fullName">Full Name <span class="sort-icon"></span></th>
                                <th class="p-2 sortable-header" data-sort-key="university">University <span class="sort-icon"></span></th>
                                <th class="p-2 sortable-header" data-sort-key="academicYear">Student Year <span class="sort-icon"></span></th>
                                <th class="p-2 sortable-header sort-desc" data-sort-key="updatedAt">Last Updated <span class="sort-icon"></span></th>
                                <th class="p-2 text-center">Actions</th>
                            </tr>
                            <tr>
                                <th></th>
                                <th><input type="text" data-filter-key="handle" placeholder="Filter..."></th>
                                <th><input type="text" data-filter-key="fullName" placeholder="Filter..."></th>
                                <th><input type="text" data-filter-key="university" placeholder="Filter..."></th>
                                <th><input type="text" data-filter-key="academicYear" placeholder="Filter..."></th>
                                <th></th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="detailedUserTableBody">
                            <tr><td colspan="7" class="p-4 text-center text-gray-500">No users in the database yet.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm p-6 relative transform scale-95">
            <h3 id="passwordModalTitle" class="text-lg font-bold mb-4">Enter Password</h3>
            <form id="passwordForm">
                <div class="space-y-4">
                    <div>
                        <label for="passwordField" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="passwordField" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div id="confirmPasswordContainer" class="hidden">
                        <label for="confirmPasswordField" class="block text-sm font-medium text-gray-700">Confirm Password</label>
                        <input type="password" id="confirmPasswordField" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="passwordCancelBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" id="passwordOkBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">OK</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative transform scale-95">
            <h3 id="confirmationModalTitle" class="text-lg font-bold mb-4">Confirm Action</h3>
            <p id="confirmationModalMessage" class="text-gray-700 mb-6">Are you sure?</p>
            <div class="flex justify-end gap-4">
                <button id="confirmCancelBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="confirmOkBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-6 relative transform scale-95">
            <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <div id="modalContentContainer"></div>
        </div>
    </div>
    
    <!-- AI Modal -->
    <div id="aiModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 relative transform scale-95">
            <h3 class="text-2xl font-bold mb-4 text-fuchsia-800">AI-Powered Insights</h3>
            <div id="aiInsightContent" class="space-y-4 max-h-[60vh] overflow-y-auto pr-4">
                <p class="text-gray-600">Generating insights... Please wait.</p>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="closeAiModalBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Global Chart Configuration ---
            Chart.register(ChartDataLabels);

            // --- STATE VARIABLES ---
            let userDatabase = [];
            let teamDatabase = [];
            let competitionDatabase = {};
            let universityDatabase = [];
            let charts = {}; // Object to hold all chart instances
            let dbSortState = { key: 'updatedAt', direction: 'desc' };
            let dbFilters = {};
            let confirmCallback = null;
            let passwordCallback = null;

            // --- DOM ELEMENT REFERENCES ---
            const appContainer = document.getElementById('app-container');
            const jsonFileInput = document.getElementById('jsonFileInput');
            const downloadSelectedUsersCsvBtn = document.getElementById('downloadSelectedUsersCsvBtn');
            const downloadAllUsersCsvBtn = document.getElementById('downloadAllUsersCsvBtn');
            const downloadReadinessModelBtn = document.getElementById('downloadReadinessModelBtn');
            const downloadDbFullBackupBtn = document.getElementById('downloadDbFullBackupBtn');
            const downloadDbFullBackupBtn_dummy = document.getElementById('downloadDbFullBackupBtn_dummy');
            const detailedUserForm = document.getElementById('detailedUserForm');
            const handleField = document.getElementById('handleField');
            const clearFormBtn = document.getElementById('clearFormBtn');
            const placementsContainer = document.getElementById('placementsContainer');
            const addPlacementBtn = document.getElementById('addPlacementBtn');
            const competitionDataList = document.getElementById('competition-list');
            const universityInput = document.getElementById('universityInput');
            const universityDataList = document.getElementById('university-list');
            const detailedUserTable = document.getElementById('detailedUserTable');
            const detailedUserTableBody = document.getElementById('detailedUserTableBody');
            const databaseUserCount = document.getElementById('databaseUserCount');
            
            const statsContainer = document.getElementById('statsContainer');
            const detailsModal = document.getElementById('detailsModal');
            const modalContentContainer = document.getElementById('modalContentContainer');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const confirmationModal = document.getElementById('confirmationModal');
            const confirmationModalTitle = document.getElementById('confirmationModalTitle');
            const confirmationModalMessage = document.getElementById('confirmationModalMessage');
            const confirmCancelBtn = document.getElementById('confirmCancelBtn');
            const confirmOkBtn = document.getElementById('confirmOkBtn');
            const passwordModal = document.getElementById('passwordModal');
            const passwordModalTitle = document.getElementById('passwordModalTitle');
            const passwordForm = document.getElementById('passwordForm');
            const passwordField = document.getElementById('passwordField');
            const confirmPasswordContainer = document.getElementById('confirmPasswordContainer');
            const confirmPasswordField = document.getElementById('confirmPasswordField');
            const passwordCancelBtn = document.getElementById('passwordCancelBtn');
            const passwordOkBtn = document.getElementById('passwordOkBtn');
            const uploadUsersCsvInput = document.getElementById('uploadUsersCsv');
            const uploadCompetitionsCsvInput = document.getElementById('uploadCompetitionsCsv');
            const uploadUniversitiesCsvInput = document.getElementById('uploadUniversitiesCsv');
            const profilePicFileInput = document.getElementById('profilePicFile');
            const profilePicFileLabel = document.getElementById('profilePicFileLabel');
            const profilePicUrlHiddenInput = document.getElementById('profilePicUrlHidden');
            const aiInsightBtn = document.getElementById('aiInsightBtn');
            const aiModal = document.getElementById('aiModal');
            const aiInsightContent = document.getElementById('aiInsightContent');
            const closeAiModalBtn = document.getElementById('closeAiModalBtn');

            // --- CRYPTOGRAPHY ---
            const textEncoder = new TextEncoder();
            const textDecoder = new TextDecoder();

            function arrayBufferToBase64(buffer) {
                let binary = '';
                const bytes = new Uint8Array(buffer);
                const len = bytes.byteLength;
                for (let i = 0; i < len; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return window.btoa(binary);
            }

            function base64ToArrayBuffer(base64) {
                const binary_string = window.atob(base64);
                const len = binary_string.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binary_string.charCodeAt(i);
                }
                return bytes.buffer;
            }

            async function getEncryptionKey(password, salt) {
                const keyMaterial = await window.crypto.subtle.importKey(
                    "raw",
                    textEncoder.encode(password),
                    { name: "PBKDF2" },
                    false,
                    ["deriveKey"]
                );
                return window.crypto.subtle.deriveKey(
                    {
                        name: "PBKDF2",
                        salt: salt,
                        iterations: 100000,
                        hash: "SHA-256",
                    },
                    keyMaterial,
                    { name: "AES-GCM", length: 256 },
                    true,
                    ["encrypt", "decrypt"]
                );
            }

            async function encryptData(data, password) {
                try {
                    const salt = window.crypto.getRandomValues(new Uint8Array(16));
                    const iv = window.crypto.getRandomValues(new Uint8Array(12));
                    const key = await getEncryptionKey(password, salt);
                    
                    const encryptedContent = await window.crypto.subtle.encrypt(
                        { name: "AES-GCM", iv: iv },
                        key,
                        textEncoder.encode(data)
                    );

                    return {
                        salt: arrayBufferToBase64(salt),
                        iv: arrayBufferToBase64(iv),
                        data: arrayBufferToBase64(encryptedContent)
                    };
                } catch (error) {
                    console.error("Encryption failed:", error);
                    showToast("Encryption failed. See console for details.", "error");
                    return null;
                }
            }

            async function decryptData(encryptedPayload, password) {
                try {
                    const salt = base64ToArrayBuffer(encryptedPayload.salt);
                    const iv = base64ToArrayBuffer(encryptedPayload.iv);
                    const data = base64ToArrayBuffer(encryptedPayload.data);
                    const key = await getEncryptionKey(password, salt);

                    const decryptedContent = await window.crypto.subtle.decrypt(
                        { name: "AES-GCM", iv: iv },
                        key,
                        data
                    );

                    return textDecoder.decode(decryptedContent);
                } catch (error) {
                    console.error("Decryption failed:", error);
                    // This often happens with a wrong password
                    return null;
                }
            }

            // --- CHART HELPERS ---
            function destroyChart(chartId) {
                if (charts[chartId]) {
                    charts[chartId].destroy();
                    delete charts[chartId];
                }
            }

            function renderChart(chartId, type, data, options) {
                destroyChart(chartId); // Ensure old chart is destroyed
                const ctx = document.getElementById(chartId)?.getContext('2d');
                if (ctx) {
                    charts[chartId] = new Chart(ctx, { type, data, options });
                }
            }
            
            // --- DATE & ACADEMIC YEAR HELPERS ---
            function formatDateForInput(dateStr) {
                if (!dateStr) return '';
                return dateStr.slice(0, 7); 
            }

            function formatMonthYear(dateString) {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                return date.toLocaleString('default', { month: 'short', year: 'numeric' });
            }
            
            function formatMMYYYY(dateString) {
                if (!dateString) return 'N/A';
                try {
                    const date = new Date(dateString);
                    date.setDate(date.getDate() + 1);
                    const year = date.getUTCFullYear();
                    const month = (date.getUTCMonth() + 1).toString().padStart(2, '0');
                    return `${month}-${year}`;
                } catch (e) {
                    return 'Invalid Date';
                }
            }

            function getAcademicYear(user) {
                if (!user || !user.universityStartDate) {
                    return { year: null, label: 'Unknown' };
                }
                const currentYear = new Date().getFullYear();
                const currentMonth = new Date().getMonth();
                const start = new Date(user.universityStartDate);
                const startYear = start.getFullYear();
                const startMonth = start.getMonth();
                
                let academicYear = currentYear - startYear;
                if (currentMonth < startMonth) {
                    academicYear--;
                }
                academicYear++; 

                if (academicYear === 1) return { year: 1, label: '1st Year' };
                if (academicYear === 2) return { year: 2, label: '2nd Year' };
                if (academicYear === 3) return { year: 3, label: '3rd Year' };
                if (academicYear === 4) return { year: 4, label: '4th Year' };
                if (academicYear > 4 && academicYear < 10) return { year: 5, label: '5th Year+' };
                if (academicYear >= 10) return { year: 6, label: 'Graduated' };
                return { year: 6, label: 'Graduated' };
            }

            // --- NOTIFICATION / MODAL ---
            function showToast(message, type = 'info', duration = 3000) {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast-notification ${type}`;
                toast.textContent = message;
                container.appendChild(toast);

                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);

                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, duration);
            }
            
            function showConfirmationModal(title, message, onConfirm) { 
                confirmationModalTitle.textContent = title; 
                confirmationModalMessage.textContent = message; 
                confirmCallback = onConfirm; 
                confirmationModal.classList.remove('hidden'); 
                setTimeout(() => { 
                    confirmationModal.querySelector('.modal-overlay')?.classList.remove('opacity-0'); 
                    confirmationModal.querySelector('.modal-content')?.classList.remove('scale-95'); 
                }, 10); 
            }

            function hideConfirmationModal() { 
                confirmationModal.querySelector('.modal-overlay')?.classList.add('opacity-0'); 
                confirmationModal.querySelector('.modal-content')?.classList.add('scale-95'); 
                setTimeout(() => { 
                    confirmationModal.classList.add('hidden'); 
                    confirmCallback = null; 
                }, 300); 
            }

            function showPasswordModal(title, showConfirm, onConfirm) {
                passwordModalTitle.textContent = title;
                passwordForm.reset();
                confirmPasswordContainer.style.display = showConfirm ? 'block' : 'none';
                confirmPasswordField.required = showConfirm;
                passwordCallback = onConfirm;
                passwordModal.classList.remove('hidden');
                setTimeout(() => {
                    passwordModal.querySelector('.modal-overlay')?.classList.remove('opacity-0');
                    passwordModal.querySelector('.modal-content')?.classList.remove('scale-95');
                    passwordField.focus();
                }, 10);
            }

            function hidePasswordModal() {
                passwordModal.querySelector('.modal-overlay')?.classList.add('opacity-0');
                passwordModal.querySelector('.modal-content')?.classList.add('scale-95');
                setTimeout(() => {
                    passwordModal.classList.add('hidden');
                    passwordCallback = null;
                }, 300);
            }

             function showAiModal() {
                aiModal.classList.remove('hidden');
                setTimeout(() => {
                    aiModal.querySelector('.modal-overlay')?.classList.remove('opacity-0');
                    aiModal.querySelector('.modal-content')?.classList.remove('scale-95');
                }, 10);
            }

            function hideAiModal() {
                aiModal.querySelector('.modal-overlay')?.classList.add('opacity-0');
                aiModal.querySelector('.modal-content')?.classList.add('scale-95');
                setTimeout(() => {
                    aiModal.classList.add('hidden');
                }, 300);
            }

            // --- UI and Helper Functions ---
            function loadJsonFile(file) {
                if (!file) { showToast('Please select a JSON backup file.', 'error'); return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const fileContent = e.target.result;
                    try {
                        const data = JSON.parse(fileContent);
                        // Check if it's an unencrypted or encrypted backup
                        if (data.salt && data.iv && data.data) { // It's an encrypted file
                            showPasswordModal('Enter Decryption Password', false, async (password) => {
                                const decryptedJson = await decryptData(data, password);
                                if (!decryptedJson) {
                                    showToast('Decryption failed. Incorrect password or corrupt file.', 'error');
                                    return;
                                }
                                try {
                                    const decryptedData = JSON.parse(decryptedJson);
                                    loadDataIntoApp(decryptedData, file.name);
                                } catch (err) {
                                    showToast('Failed to parse decrypted data. The file might be corrupt.', 'error');
                                }
                            });
                        } else if (data.users && data.competitions) { // It's a plain JSON backup
                            loadDataIntoApp(data, file.name);
                        } else {
                            throw new Error("Invalid backup file format.");
                        }
                    } catch (error) {
                        showToast(`Error reading file: ${error.message}`, 'error');
                    }
                };
                reader.readAsText(file);
            }

            function loadDataIntoApp(data, fileName) {
                if (!data.users || !data.competitions || !data.universities || !data.teams) {
                    showToast("Invalid backup file format. Must contain 'users', 'competitions', 'universities', and 'teams' keys.", 'error');
                    return;
                }
                showConfirmationModal('Overwrite Data?', 'Loading this backup will overwrite all current data. Are you sure?', () => {
                    userDatabase = data.users.map(u => ({...u, updatedAt: new Date(u.updatedAt) })) || [];
                    competitionDatabase = data.competitions || {};
                    universityDatabase = data.universities || [];
                    teamDatabase = data.teams || [];
                    renderAll();
                    showToast(`Successfully loaded backup from ${fileName}.`, 'info');
                });
            }
            
            // --- Database Tab Logic ---
            function addPlacementInput(placement = null) {
                const placementDiv = document.createElement('div');
                placementDiv.className = 'placement-entry';
                const uniqueId = `placement_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                placementDiv.id = uniqueId;
                
                const compName = placement ? placement.name : '';
                const compData = competitionDatabase[compName] || {};
                const teamId = placement ? placement.teamId : '';

                placementDiv.innerHTML = `
                    <button type="button" class="remove-placement-btn absolute -top-2.5 -right-2.5 bg-red-500 text-white rounded-full h-6 w-6 flex items-center justify-center font-bold text-sm hover:bg-red-600 z-10">&times;</button>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="sm:col-span-2">
                            <label class="font-medium text-xs text-gray-600">Competition*</label>
                            <input type="text" list="competition-list" placeholder="Competition Name" class="comp-name-input w-full text-sm p-2 border border-gray-300 rounded-md" value="${compName}" required>
                        </div>

                        <div class="sm:col-span-2">
                            <label class="flex items-center gap-2 mb-2 cursor-pointer">
                                <input type="checkbox" class="team-placement-checkbox h-4 w-4 rounded border-gray-400" ${teamId ? 'checked' : ''}>
                                <span class="text-sm font-medium">Team Placement</span>
                            </label>
                            <div class="team-selection-container ${teamId ? '' : 'hidden'}">
                                <label class="font-medium text-xs text-gray-600 sr-only">Team Name*</label>
                                <select class="team-name-select w-full text-sm p-2 border border-gray-300 rounded-md">
                                    <option value="">Select a team...</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="font-medium text-xs text-gray-600">Date*</label>
                            <input type="month" class="comp-date-input w-full text-sm p-2 border border-gray-300 rounded-md" value="${compData.date || ''}" required>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                             <div>
                                <label class="font-medium text-xs text-gray-600">Rank*</label>
                                <input type="number" placeholder="Rank" min="1" class="comp-rank-input w-full text-sm p-2 border border-gray-300 rounded-md" value="${placement ? placement.rank : ''}" required>
                             </div>
                             <div>
                                <label class="font-medium text-xs text-gray-600">Total*</label>
                                <input type="number" placeholder="Total" min="1" class="comp-total-input w-full text-sm p-2 border border-gray-300 rounded-md" value="${placement ? placement.total : (compData.total || '')}" required>
                             </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <label class="font-medium text-xs text-gray-600">Competition Link*</label>
                        <input type="url" placeholder="https://codeforces.com/contest/..." class="comp-link-input w-full text-sm p-2 border border-gray-300 rounded-md" value="${compData.link || ''}" required>
                    </div>
                `;
                placementsContainer.appendChild(placementDiv);

                const teamCheckbox = placementDiv.querySelector('.team-placement-checkbox');
                const compNameInput = placementDiv.querySelector('.comp-name-input');
                const teamSelect = placementDiv.querySelector('.team-name-select');
                const compDateInput = placementDiv.querySelector('.comp-date-input');

                updateTeamSelectForEntry(placementDiv);
                if (teamId) teamSelect.value = teamId;

                placementDiv.querySelector('.remove-placement-btn').addEventListener('click', () => {
                    showConfirmationModal('Remove Placement?', 'Are you sure you want to remove this placement entry?', () => placementDiv.remove());
                });

                compDateInput.addEventListener('change', () => {
                    updateTeamSelectForEntry(placementDiv);
                });
                
                teamCheckbox.addEventListener('change', (e) => {
                    placementDiv.querySelector('.team-selection-container').classList.toggle('hidden', !e.target.checked);
                    if (e.target.checked) {
                        updateTeamSelectForEntry(placementDiv);
                    }
                });

                compNameInput.addEventListener('input', (e) => {
                    const currentCompName = e.target.value;
                    const comp = competitionDatabase[currentCompName];
                    const compDateInput = placementDiv.querySelector('.comp-date-input');
                    const compTotalInput = placementDiv.querySelector('.comp-total-input');
                    const compLinkInput = placementDiv.querySelector('.comp-link-input');
                    const compRankInput = placementDiv.querySelector('.comp-rank-input');

                    if (comp) {
                        if (comp.date) compDateInput.value = comp.date;
                        if (comp.total) compTotalInput.value = comp.total;
                        if (comp.link) compLinkInput.value = comp.link;
                    }

                    updateTeamSelectForEntry(placementDiv);

                    const isTeamPlacement = teamCheckbox.checked;
                    const selectedTeamId = teamSelect.value;
                    if (!isTeamPlacement || !selectedTeamId || !currentCompName) return;

                    const selectedTeam = teamDatabase.find(t => t.id === selectedTeamId);
                    if (!selectedTeam) return;

                    for (const memberHandle of selectedTeam.members) {
                        const member = userDatabase.find(u => u.handle.toLowerCase() === memberHandle.toLowerCase());
                        if (member) {
                            const teamPlacement = member.placements.find(p => p.teamId === selectedTeam.id && p.name.toLowerCase() === currentCompName.toLowerCase());
                            if (teamPlacement) {
                                compRankInput.value = teamPlacement.rank;
                                compTotalInput.value = teamPlacement.total;
                                showToast(`Auto-filled rank for ${currentCompName} from teammate ${member.handle}.`, 'info');
                                return;
                            }
                        }
                    }
                });
                
                teamSelect.addEventListener('change', () => {
                     compNameInput.dispatchEvent(new Event('input'));
                });

                if (placement) compNameInput.dispatchEvent(new Event('input'));
            }

            function handleDetailedUserFormSubmit(e) {
                e.preventDefault();
                const saveButton = document.getElementById('saveUserBtn');
                const formData = new FormData(detailedUserForm);
                const handle = formData.get('handle').trim();
                const fullName = formData.get('fullName').trim();
                const isEditing = document.getElementById('handleField').readOnly;

                if (!handle) {
                    showToast("Handle is required.", 'error');
                    return;
                }

                // --- MODIFICATION START ---
                // 1. Check for existing handle when ADDING a new user
                if (!isEditing) {
                    const handleExists = userDatabase.some(u => u.id === handle.toLowerCase());
                    if (handleExists) {
                        showToast(`Error: A user with the handle "${handle}" already exists.`, 'error');
                        return; // Stop execution
                    }
                }

                // This function contains the actual saving logic.
                // It will be called either directly or after the user confirms the duplicate name warning.
                const proceedWithSave = () => {
                    const placementsData = [];
                    let placementError = false;
                    document.querySelectorAll('.placement-entry').forEach(entry => {
                        if (placementError) return;
                        const name = entry.querySelector('.comp-name-input').value.trim();
                        const date = entry.querySelector('.comp-date-input').value;
                        const link = entry.querySelector('.comp-link-input').value.trim();
                        const rankStr = entry.querySelector('.comp-rank-input').value;
                        const totalStr = entry.querySelector('.comp-total-input').value;
                        const isTeamPlacement = entry.querySelector('.team-placement-checkbox').checked;
                        const teamId = entry.querySelector('.team-name-select').value;

                        if (!name || !rankStr || !totalStr || !date || !link) {
                            showToast('Competition Name, Date, Link, Rank, and Total fields are required for all placements.', 'error');
                            placementError = true; return;
                        }
                        if(isTeamPlacement && !teamId) {
                            showToast(`A team must be selected for a team placement in "${name}".`, 'error');
                            placementError = true; return;
                        }

                        const rank = parseInt(rankStr, 10);
                        const total = parseInt(totalStr, 10);
                        if (rank > total) {
                             showToast(`Placement error for "${name}": Rank (${rank}) cannot be greater than Total (${total}).`, 'error');
                             placementError = true; return;
                        }

                        placementsData.push({ name, rank, total, teamId: isTeamPlacement ? teamId : null, date, link });
                    });

                    if (placementError) return;
                    
                    saveButton.disabled = true;
                    saveButton.innerHTML = `<div class="flex justify-center items-center gap-2"><div class="spinner w-4 h-4 border-2 rounded-full"></div>Saving...</div>`;
                    
                    setTimeout(() => {
                        const universityName = formData.get('university').trim();
                        if (universityName && !universityDatabase.includes(universityName)) {
                            universityDatabase.push(universityName);
                            universityDatabase.sort();
                        }

                        placementsData.forEach(p => {
                            if (!competitionDatabase[p.name] || competitionDatabase[p.name].total !== p.total || competitionDatabase[p.name].date !== p.date || competitionDatabase[p.name].link !== p.link) {
                               competitionDatabase[p.name] = { total: parseInt(p.total, 10), date: p.date, link: p.link };
                            }
                        });

                        const userToSave = {
                            id: handle.toLowerCase(),
                            handle: handle,
                            fullName: fullName,
                            linkedin: formData.get('linkedin').trim(),
                            university: universityName,
                            profilePicUrl: formData.get('profilePicUrl').trim(),
                            lunaNovaScore: parseFloat(formData.get('lunaNovaScore')) || 0,
                            lunaHardScore: parseFloat(formData.get('lunaHardScore')) || 0,
                            acmLevel: parseInt(formData.get('acmLevel'), 10),
                            joinDate: formData.get('joinDate') || null,
                            universityStartDate: formData.get('universityStartDate') || null,
                            isTrusted: detailedUserForm.querySelector('#isTrustedCheckbox').checked,
                            placements: placementsData.map(({name, rank, total, teamId}) => ({name, rank, total, teamId})),
                            updatedAt: new Date()
                        };

                        saveUserAndUpdateTeams(userToSave);
                        
                        saveButton.disabled = false;
                        saveButton.innerHTML = 'Save User';
                        clearDetailedUserForm();
                        renderAll();
                        showToast(`User ${userToSave.handle} saved successfully.`, 'info');

                    }, 50);
                };

                // 2. Check for duplicate name
                if (fullName) { // Only check if a name is provided
                    const existingUserWithSameName = userDatabase.find(
                        u => u.fullName && u.fullName.toLowerCase() === fullName.toLowerCase() && u.id !== handle.toLowerCase()
                    );

                    if (existingUserWithSameName) {
                        showConfirmationModal(
                            'Duplicate Name Warning',
                            `Another user ('${existingUserWithSameName.handle}') already has the name "${fullName}". Are you sure you want to save?`,
                            proceedWithSave // The confirmation callback
                        );
                    } else {
                        proceedWithSave(); // No duplicate name, save directly
                    }
                } else {
                    proceedWithSave(); // No name provided, save directly
                }
                // --- MODIFICATION END ---
            }


            function saveUserAndUpdateTeams(userToSave) {
                const existingIndex = userDatabase.findIndex(u => u.id === userToSave.id);
                if (existingIndex > -1) {
                    userDatabase.splice(existingIndex, 1, userToSave);
                } else {
                    userDatabase.push(userToSave);
                }

                userToSave.placements.filter(p => p.teamId).forEach(teamPlacement => {
                    const team = teamDatabase.find(t => t.id === teamPlacement.teamId);
                    if (!team) return;

                    team.members.forEach(memberHandle => {
                        if (memberHandle.toLowerCase() === userToSave.id) return;

                        let member = userDatabase.find(u => u.handle.toLowerCase() === memberHandle.toLowerCase());
                        if (member) {
                            const hasPlacement = member.placements.some(p => p.name.toLowerCase() === teamPlacement.name.toLowerCase() && p.teamId === teamPlacement.teamId);
                            if (!hasPlacement) {
                                member.placements.push(teamPlacement);
                                member.updatedAt = new Date();
                                showToast(`Propagated '${teamPlacement.name}' to ${member.handle}.`, 'info');
                            }
                        }
                    });
                });
            }
            
            function clearDetailedUserForm() {
                detailedUserForm.reset();
                placementsContainer.innerHTML = '';
                detailedUserForm.querySelector('[name="handle"]').readOnly = false;
                detailedUserForm.querySelector('#isTrustedCheckbox').checked = true;
                universityInput.value = "";
                profilePicUrlHiddenInput.value = "";
                profilePicFileLabel.classList.remove('bg-green-600', 'hover:bg-green-700');
                profilePicFileLabel.classList.add('bg-gray-600', 'hover:bg-gray-700');
                profilePicFileLabel.textContent = "Choose File";
            }

            function renderAll() {
                renderUserDatabaseTable();
                updateAndRenderStatistics();
                updateDatalists();
            }
            
            function updateDatalists() {
                updateCompetitionDatalist();
                document.querySelectorAll('.placement-entry').forEach(updateTeamSelectForEntry);
                populateUniversityDatalist();
            }

            function renderUserDatabaseTable() {
                const usersWithYear = userDatabase.map(user => ({
                    ...user,
                    academicYear: getAcademicYear(user).label
                }));

                const filteredUsers = usersWithYear.filter(user => {
                    return Object.entries(dbFilters).every(([key, value]) => {
                        const userValue = String(user[key] || '').toLowerCase();
                        return userValue.includes(value.toLowerCase());
                    });
                });

                const { key, direction } = dbSortState;
                filteredUsers.sort((a,b) => {
                    const valA = a[key];
                    const valB = b[key];
                    if (valA < valB) return direction === 'asc' ? -1 : 1;
                    if (valA > valB) return direction === 'asc' ? 1 : -1;
                    return 0;
                });

                detailedUserTableBody.innerHTML = '';
                databaseUserCount.textContent = filteredUsers.length;

                if (filteredUsers.length === 0) {
                    detailedUserTableBody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-500">No matching users found.</td></tr>`;
                    updateSelectAllState(detailedUserTable);
                    return;
                }

                filteredUsers.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.dataset.id = user.id;
                    const formattedDate = new Date(user.updatedAt).toLocaleString([], { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    const handleClass = user.isTrusted ? 'font-semibold' : 'font-semibold text-red-600';
                    row.innerHTML = `
                        <td class="p-2 text-center"><input type="checkbox" class="user-select-checkbox" data-id="${user.id}"></td>
                        <td class="p-2 ${handleClass}">${createUserLink(user.handle)}</td>
                        <td class="p-2">${user.fullName || 'N/A'}</td>
                        <td class="p-2">${user.university || 'N/A'}</td>
                        <td class="p-2">${user.academicYear}</td>
                        <td class="p-2 text-xs text-gray-600">${formattedDate}</td>
                        <td class="p-2 text-center">
                            <button class="details-db-user-btn text-indigo-600 hover:text-indigo-800 text-sm font-medium">Details</button>
                            <button class="edit-db-user-btn text-blue-600 hover:text-blue-800 text-sm ml-2">Edit</button>
                            <button class="delete-db-user-btn text-red-600 hover:text-red-800 ml-2 text-sm">Delete</button>
                        </td>
                    `;
                    detailedUserTableBody.appendChild(row);
                });
                updateDbSortIndicators();
                updateSelectAllState(detailedUserTable);
            }
            
            // --- CSV and Backup/Restore ---
            function parseCsv(text) {
                const lines = text.trim().split('\n');
                const header = lines[0].split(',').map(h => h.trim());
                const rows = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    const row = {};
                    for (let j = 0; j < header.length; j++) {
                        let value = values[j] ? values[j].trim() : '';
                        if (value.startsWith('"') && value.endsWith('"')) {
                            value = value.slice(1, -1).replace(/""/g, '"');
                        }
                        row[header[j]] = value;
                    }
                    rows.push(row);
                }
                return rows;
            }

            function handleFileUpload(file, handler) {
                if (!file) { showToast('Please select a file to upload.', 'error'); return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try { handler(e.target.result); } catch (error) { showToast(`Error processing file: ${error.message}`, 'error'); console.error(error); }
                };
                reader.readAsText(file);
            }

            function handleUserUpload(csvText) {
                const newUsers = parseCsv(csvText);
                showConfirmationModal('Upload Users?', `This will add ${newUsers.length} users and overwrite any existing users with the same handle. Continue?`, () => {
                    newUsers.forEach(newUserRow => {
                        try {
                            const handle = newUserRow.handle;
                            if (!handle) return;
                            const placements = newUserRow.placements_json ? JSON.parse(newUserRow.placements_json) : [];
                            const user = {
                                id: handle.toLowerCase(), handle,
                                fullName: newUserRow.fullName || '',
                                linkedin: newUserRow.linkedin || '',
                                university: newUserRow.university || '',
                                profilePicUrl: newUserRow.profilePicUrl || '',
                                lunaNovaScore: parseFloat(newUserRow.lunaNovaScore) || 0,
                                lunaHardScore: parseFloat(newUserRow.lunaHardScore) || 0,
                                acmLevel: parseInt(newUserRow.acmLevel, 10) || 0,
                                joinDate: newUserRow.joinDate || null,
                                universityStartDate: newUserRow.universityStartDate || null,
                                isTrusted: newUserRow.isTrusted ? newUserRow.isTrusted.toLowerCase() === 'true' : true,
                                placements: placements,
                                updatedAt: new Date()
                            };
                            saveUserAndUpdateTeams(user);
                        } catch (e) {
                            console.error(`Skipping invalid user row:`, newUserRow, e);
                        }
                    });
                    renderAll();
                    showToast(`${newUsers.length} users processed.`, 'info');
                });
            }

            function handleCompetitionUpload(csvText) {
                const newComps = parseCsv(csvText);
                let addedCount = 0;
                newComps.forEach(comp => {
                    const name = comp['Competition Name'];
                    if (name) {
                        competitionDatabase[name] = { 
                            link: comp['Link'] || '', 
                            total: parseInt(comp['Total Participants'], 10) || 0,
                            date: comp['Date (YYYY-MM)'] || null
                        };
                        addedCount++;
                    }
                });
                renderAll();
                showToast(`${addedCount} competitions added or updated.`, 'info');
            }

            function handleUniversityUpload(csvText) {
                const newUnis = csvText.trim().split('\n').map(line => line.split(',')[0].trim()).filter(Boolean);
                let addedCount = 0;
                newUnis.forEach(uni => {
                    if (!universityDatabase.includes(uni)) {
                        universityDatabase.push(uni);
                        addedCount++;
                    }
                });
                universityDatabase.sort();
                renderAll();
                showToast(`${addedCount} new universities added.`, 'info');
            }
            
            function downloadUsersCSV(usersToDownload) {
                if (usersToDownload.length === 0) { showToast("No users selected to download.", 'error'); return; }
                const headers = ['handle', 'fullName', 'linkedin', 'university', 'profilePicUrl', 'lunaNovaScore', 'lunaHardScore', 'acmLevel', 'joinDate', 'universityStartDate', 'isTrusted', 'placements_json'];
                const rows = usersToDownload.map(user => {
                    const placementsStr = `"${JSON.stringify(user.placements).replace(/"/g, '""')}"`;
                    return [
                        user.handle, user.fullName, user.linkedin, user.university,
                        user.profilePicUrl || '', user.lunaNovaScore, user.lunaHardScore, user.acmLevel,
                        user.joinDate || '', user.universityStartDate || '', user.isTrusted, placementsStr
                    ].join(',');
                });
                const csvString = [headers.join(','), ...rows].join('\n');
                downloadFile(csvString, `users_export_${getFormattedDateTimeString()}.csv`, 'text/csv;charset=utf-8;');
            }

            function downloadReadinessModelCSV() {
                if (userDatabase.length === 0) { showToast("No users in the database to download.", 'error'); return; }
                const headers = ['handle', 'luna_nova', 'luna_hard', 'placements', 'is_trusted'];
                const rows = userDatabase.map(user => {
                    const placementsStr = `"${user.placements.map(p => {
                        if (p.total > 0) {
                            return (p.rank / p.total).toFixed(2);
                        }
                        return '0.00';
                    }).join(';')}"`;
                    return [
                        user.handle,
                        user.lunaNovaScore,
                        user.lunaHardScore,
                        placementsStr,
                        user.isTrusted
                    ].join(',');
                });
                const csvString = [headers.join(','), ...rows].join('\n');
                downloadFile(csvString, `readiness_model_input_${getFormattedDateTimeString()}.csv`, 'text/csv;charset=utf-8;');
            }
            
            function downloadDbFullBackup() {
                if (userDatabase.length === 0 && Object.keys(competitionDatabase).length === 0 && universityDatabase.length === 0) {
                    showToast("No data to back up.", 'error'); return;
                }

                showPasswordModal('Create Backup Password', true, async (password) => {
                    const backupData = {
                        users: userDatabase,
                        teams: teamDatabase,
                        competitions: competitionDatabase,
                        universities: universityDatabase,
                        createdAt: new Date().toISOString()
                    };
                    const jsonString = JSON.stringify(backupData, null, 2);
                    
                    const encryptedPayload = await encryptData(jsonString, password);
                    if (encryptedPayload) {
                        const encryptedJsonString = JSON.stringify(encryptedPayload, null, 2);
                        downloadFile(encryptedJsonString, `electi_backup_encrypted_${getFormattedDateTimeString()}.json`, 'application/json');
                        showToast("Encrypted backup downloaded successfully.", "info");
                    }
                });
            }

            // --- Datalist Updaters ---
            function updateCompetitionDatalist() {
                competitionDataList.innerHTML = '';
                Object.keys(competitionDatabase).sort().forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    competitionDataList.appendChild(option);
                });
            }

            function updateTeamSelectForEntry(placementEntryDiv) {
                const select = placementEntryDiv.querySelector('.team-name-select');
                if (!select) return;
                
                const currentVal = select.value;
                const currentUserHandle = handleField.value.toLowerCase();
                const contestDateInput = placementEntryDiv.querySelector('.comp-date-input');
                const contestDateStr = contestDateInput.value;

                if (!currentUserHandle) {
                    select.innerHTML = '<option value="">Enter user handle first</option>';
                    select.disabled = true;
                    return;
                }

                if (!contestDateStr) {
                    select.innerHTML = '<option value="">Select contest date first</option>';
                    select.disabled = true;
                    return;
                }
                
                const contestDate = new Date(contestDateStr);
                contestDate.setMonth(contestDate.getMonth() + 1, 0); 
                contestDate.setHours(23, 59, 59, 999);

                const userTeams = teamDatabase.filter(t => {
                    const isMember = t.members.map(m => m.toLowerCase()).includes(currentUserHandle);
                    if (!isMember) return false;

                    const teamCreatedAt = new Date(t.createdAt);
                    if (teamCreatedAt > contestDate) return false;

                    const teamInactiveAt = t.inactiveAt ? new Date(t.inactiveAt) : null;
                    if (teamInactiveAt && teamInactiveAt < contestDate) {
                        return false;
                    }

                    return true;
                });
                
                if (userTeams.length === 0) {
                     select.innerHTML = '<option value="">No active teams for this date</option>';
                     select.disabled = true;
                     return;
                }

                select.disabled = false;
                select.innerHTML = '<option value="">Select a team...</option>';
                userTeams.sort((a,b) => a.name.localeCompare(b.name)).forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.id;
                    const createdAtStr = formatMonthYear(team.createdAt);
                    const inactiveAtStr = team.inactiveAt ? formatMonthYear(team.inactiveAt) : 'now';
                    const membersStr = team.members.join(', ');
                    
                    option.textContent = `${team.name} (${createdAtStr} to ${inactiveAtStr}) (${membersStr})`;
                    option.title = `University: ${team.university}`;
                    select.appendChild(option);
                });
                select.value = currentVal;
            }

            function populateUniversityDatalist(selectedValue = '') {
                const allUnis = new Set(universityDatabase);
                userDatabase.forEach(u => { if(u.university) allUnis.add(u.university) });
                teamDatabase.forEach(t => { if(t.university) allUnis.add(t.university) });
                universityDatabase = Array.from(allUnis).sort();

                universityDataList.innerHTML = '';
                universityDatabase.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    universityDataList.appendChild(option);
                });
                universityInput.value = selectedValue;
            }

            // --- STATISTICS LOGIC (REFACTORED) ---
            function updateAndRenderStatistics() {
                const totalUsers = userDatabase.length;
                const totalUniversities = universityDatabase.length;
                const totalTeams = teamDatabase.length;
                const totalUniqueCompetitions = Object.keys(competitionDatabase).length;

                statsContainer.innerHTML = `
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <p class="text-3xl font-bold text-blue-600">${totalUsers}</p>
                        <p class="text-sm text-gray-600">Total Users</p>
                    </div>
                    <div class="p-4 bg-indigo-50 rounded-lg">
                        <p class="text-3xl font-bold text-indigo-600">${totalUniversities}</p>
                        <p class="text-sm text-gray-600">Universities</p>
                    </div>
                    <div class="p-4 bg-teal-50 rounded-lg">
                        <p class="text-3xl font-bold text-teal-600">${totalTeams}</p>
                        <p class="text-sm text-gray-600">Total Teams</p>
                    </div>
                    <div class="p-4 bg-green-50 rounded-lg">
                        <p class="text-3xl font-bold text-green-600">${totalUniqueCompetitions}</p>
                        <p class="text-sm text-gray-600">Unique Competitions</p>
                    </div>
                `;

                if (totalUsers === 0) {
                    destroyChart('acmLevelChart');
                    destroyChart('competitionChart');
                    destroyChart('studentYearChart');
                    return;
                }
                
                // Define a shared callback function for tooltips to show percentages.
                const tooltipLabelCallback = (context) => {
                    const label = context.label || '';
                    const value = context.raw;
                    
                    // Ensure the dataset and its data exist before processing
                    if (!context.chart.data.datasets || context.chart.data.datasets.length === 0) {
                        return `${label}: ${value}`;
                    }
                    const dataset = context.chart.data.datasets[0];
                    if (!dataset.data || dataset.data.length === 0) {
                         return `${label}: ${value}`;
                    }

                    const sum = dataset.data.reduce((a, b) => a + b, 0);
                    
                    if (sum === 0) {
                        return `${label}: ${value} (0%)`;
                    }
                    
                    const percentage = ((value / sum) * 100).toFixed(1) + '%';
                    return `${label}: ${value} (${percentage})`;
                };

                // ACM Level Chart
                const levelMap = { '0': 'None', '-1': 'Codeability', '10': 'Level 0', '1': 'Level 1', '2': 'Level 2'};
                const acmLevels = { '0': 0, '-1': 0, '10': 0, '1': 0, '2': 0 };
                userDatabase.forEach(u => { if (acmLevels.hasOwnProperty(u.acmLevel)) acmLevels[u.acmLevel]++; });
                const acmData = { labels: ['None', 'Codeability', 'Level 0', 'Level 1', 'Level 2'], datasets: [{ data: [acmLevels['0'], acmLevels['-1'], acmLevels['10'], acmLevels['1'], acmLevels['2']], backgroundColor: ['#6b7280', '#a1a1aa', '#10b981', '#f59e0b', '#ef4444'], }] };
                
                const acmOptions = {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'ACM Level Breakdown' },
                        datalabels: { display: false },
                        tooltip: { callbacks: { label: tooltipLabelCallback } }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const chart = charts['acmLevelChart'];
                            const index = elements[0].index;
                            const label = chart.data.labels[index];
                            const levelKey = Object.keys(levelMap).find(key => levelMap[key] === label);
                            const users = userDatabase.filter(u => String(u.acmLevel) === levelKey);
                            showListInModal(`Users in ACM Level: ${label}`, users.map(u => createUserLink(u.handle)));
                        }
                    }
                };
                renderChart('acmLevelChart', 'pie', acmData, acmOptions);

                // Student Year Chart
                const yearCounts = { '1st Year': 0, '2nd Year': 0, '3rd Year': 0, '4th Year': 0, '5th Year+': 0, 'Graduated': 0, 'Unknown': 0 };
                userDatabase.forEach(s => {
                    const yearLabel = getAcademicYear(s).label;
                    if(yearCounts.hasOwnProperty(yearLabel)) yearCounts[yearLabel]++;
                });
                const yearLabels = Object.keys(yearCounts).filter(k => yearCounts[k] > 0);
                const yearData = { labels: yearLabels, datasets: [{ data: yearLabels.map(l => yearCounts[l]), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#6b7280', '#a1a1aa'], }] };
                
                const yearOptions = {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Students by Academic Year' },
                        datalabels: { display: false },
                        tooltip: { callbacks: { label: tooltipLabelCallback } }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const chart = charts['studentYearChart'];
                            const index = elements[0].index;
                            const yearLabel = chart.data.labels[index];
                            const filteredStudents = userDatabase.filter(s => getAcademicYear(s).label === yearLabel);
                            showListInModal(`Students in: ${yearLabel}`, filteredStudents.map(u => createUserLink(u.handle)));
                        }
                    }
                };
                renderChart('studentYearChart', 'pie', yearData, yearOptions);

                // Competition Chart
                const compCounts = userDatabase.flatMap(u => u.placements.map(p => p.name)).reduce((acc, name) => { acc[name] = (acc[name] || 0) + 1; return acc; }, {});
                const sortedCompCounts = Object.entries(compCounts).sort(([,a],[,b]) => b-a).slice(0, 10);
                const compData = { labels: sortedCompCounts.map(([name]) => name), datasets: [{ label: 'Participants', data: sortedCompCounts.map(([,count]) => count), backgroundColor: ['#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#ef4444', '#6b7280', '#ec4899', '#6366f1', '#f97316', '#06b6d4'], }] };
                
                const compOptions = {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Top 10 Competitions by Participants' },
                        datalabels: { display: false },
                        tooltip: { callbacks: { label: tooltipLabelCallback } }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const chart = charts['competitionChart'];
                            const index = elements[0].index;
                            const compName = chart.data.labels[index];
                            const users = userDatabase.filter(u => u.placements.some(p => p.name === compName));
                            showListInModal(`Participants in: ${compName}`, users.map(u => createUserLink(u.handle)));
                        }
                    }
                };
                renderChart('competitionChart', 'doughnut', compData, compOptions);
            }
            
            function updateDbSortIndicators() { detailedUserTable.querySelectorAll('th.sortable-header').forEach(th => { th.classList.remove('sort-asc', 'sort-desc'); if (th.dataset.sortKey === dbSortState.key) th.classList.add(`sort-${dbSortState.direction}`); th.querySelector('.sort-icon').textContent = dbSortState.direction === 'asc' ? '' : ''; }); }
            
            function getFormattedDateTimeString() { const now = new Date(); const pad = (num) => num.toString().padStart(2, '0'); return `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}`; }
            
            function downloadFile(content, fileName, mimeType) { const blob = new Blob([content], { type: mimeType }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = fileName; document.body.appendChild(link); link.click(); document.body.removeChild(link); }
            
            function showTeamDetailsModal(teamId) {
                const team = teamDatabase.find(t => t.id === teamId);
                if (!team) {
                    showToast('Team not found.', 'error');
                    return;
                }

                const teamPlacements = userDatabase
                    .flatMap(u => u.placements.filter(p => p.teamId === team.id))
                    .reduce((acc, p) => {
                        if (!acc.some(ap => ap.name === p.name)) acc.push(p);
                        return acc;
                    }, [])
                    .sort((a, b) => (competitionDatabase[b.name]?.date || '').localeCompare(competitionDatabase[a.name]?.date || ''));

                let content = `
                    <h2 class="text-3xl font-bold text-teal-800 mb-2">${team.name}</h2>
                    <p class="text-lg text-gray-600 mb-1">${team.university}</p>
                    <p class="text-sm text-gray-500">Created: ${formatMonthYear(team.createdAt)} ${team.inactiveAt ? `| Inactive since: ${formatMonthYear(team.inactiveAt)}` : ''}</p>
                    <hr class="my-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-xl font-semibold mb-3">Members (${team.members.length})</h3>
                            <div class="space-y-2">
                                ${team.members.map(m => `<div class="p-2 bg-gray-50 rounded text-sm">${createUserLink(m)}</div>`).join('')}
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold mb-3">Competitions (${teamPlacements.length})</h3>
                            <div class="space-y-2 max-h-60 overflow-y-auto pr-2">
                                ${teamPlacements.length > 0 ? teamPlacements.map(p => `
                                    <div class="p-2 bg-gray-50 rounded text-sm">
                                        <span class="font-medium">${createCompetitionLink(p.name)}</span> - Rank ${p.rank}/${p.total}
                                    </div>
                                `).join('') : '<p class="text-gray-500 text-sm">No competitions recorded.</p>'}
                            </div>
                        </div>
                    </div>
                `;
                modalContentContainer.innerHTML = content;
                detailsModal.classList.remove('hidden');
            }

            function showUserDetailsModal(handle) {
                const dbData = userDatabase.find(d => d.id === handle.toLowerCase());

                if (!dbData) { showToast('Could not find data for this user.', 'error'); return; }
                
                let content = '';
                const profilePicUrl = dbData?.profilePicUrl || `https://placehold.co/128x128/e0e0e0/333?text=${handle.charAt(0)}`;
                const trustedBadge = dbData?.isTrusted ? '' : '<span class="ml-2 text-xs font-bold uppercase bg-red-100 text-red-700 px-2 py-1 rounded-full">Untrusted</span>';

                content += `
                    <div class="flex flex-col md:flex-row gap-6 items-start">
                        <img src="${profilePicUrl}" alt="Profile Picture" class="w-32 h-32 rounded-full object-cover border-4 border-gray-200 shadow-md">
                        <div class="flex-grow">
                            <h2 class="text-3xl font-bold mb-1 flex items-center">${dbData.handle} ${trustedBadge}</h2>
                            <p class="text-lg text-gray-600 mb-2">${dbData?.fullName || ''}</p>
                            ${createCodeforcesLink(dbData.handle)}
                        </div>
                    </div>
                    <hr class="my-6">
                `;

                const levelMap = { '0': 'None', '-1': 'Codeability', '10': 'Level 0', '1': 'Level 1', '2': 'Level 2'};
                content += `
                <div class="mb-6 p-4 bg-gray-50 rounded-lg grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div><strong class="block text-gray-500">University</strong> <span class="text-lg">${dbData.university || 'N/A'}</span></div>
                    <div><strong class="block text-gray-500">ACM Level</strong> <span class="text-lg">${levelMap[dbData.acmLevel] || 'N/A'}</span></div>
                    <div><strong class="block text-gray-500">Uni Start Date</strong> <span class="text-lg">${formatMonthYear(dbData.universityStartDate)}</span></div>
                    <div><strong class="block text-gray-500">LinkedIn</strong> ${dbData.linkedin ? `<a href="${dbData.linkedin}" target="_blank" class="text-blue-600 hover:underline text-lg">Profile</a>` : '<span class="text-lg">N/A</span>'}</div>
                </div>`;

                const userTeams = teamDatabase.filter(t => t.members.map(m => m.toLowerCase()).includes(dbData.handle.toLowerCase()));
                if (userTeams.length > 0) {
                    content += `<h3 class="text-xl font-semibold mb-2">Teams</h3><div class="flex flex-wrap gap-2 mb-6">
                        ${userTeams.map(team => `<div class="p-2 bg-teal-50 text-teal-800 rounded text-sm font-medium">${createTeamLink(team.name, team.id)}</div>`).join('')}
                    </div>`;
                }

                const teamPlacements = dbData.placements.filter(p => p.teamId);
                if (teamPlacements.length > 0) {
                    content += `<h3 class="text-xl font-semibold mb-2">Team Placements</h3>
                                <div class="overflow-x-auto mb-6 max-h-48 border rounded-lg">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-gray-100 text-xs uppercase sticky top-0"><tr>
                                        <th class="p-2">Competition</th><th class="p-2">Team</th><th class="p-2">Rank</th><th class="p-2">Placement</th>
                                    </tr></thead><tbody>`;
                    teamPlacements.forEach(p => {
                        const team = teamDatabase.find(t => t.id === p.teamId);
                        const placementPercent = ((p.rank / p.total) * 100).toFixed(2);
                        content += `<tr class="border-b">
                                        <td class="p-2 font-medium">${createCompetitionLink(p.name)}</td>
                                        <td class="p-2">${team ? createTeamLink(team.name, team.id) : 'N/A'}</td>
                                        <td class="p-2">${p.rank}/${p.total}</td>
                                        <td class="p-2 font-bold">Top ${placementPercent}%</td>
                                    </tr>`;
                    });
                    content += `</tbody></table></div>`;
                }

                const soloPlacements = dbData.placements.filter(p => !p.teamId);
                if (soloPlacements.length > 0) {
                    content += `<h3 class="text-xl font-semibold mb-2">Solo Placements</h3>
                                <div class="overflow-x-auto mb-6 max-h-48 border rounded-lg">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-gray-100 text-xs uppercase sticky top-0"><tr>
                                        <th class="p-2">Competition</th><th class="p-2">Rank</th><th class="p-2">Total</th><th class="p-2">Placement</th>
                                    </tr></thead><tbody>`;
                    soloPlacements.forEach(p => {
                        const placementPercent = ((p.rank / p.total) * 100).toFixed(2);
                        content += `<tr class="border-b">
                                        <td class="p-2 font-medium">${createCompetitionLink(p.name)}</td>
                                        <td class="p-2">${p.rank}</td>
                                        <td class="p-2">${p.total}</td>
                                        <td class="p-2 font-bold">Top ${placementPercent}%</td>
                                    </tr>`;
                    });
                    content += `</tbody></table></div>`;
                }

                modalContentContainer.innerHTML = content;
                detailsModal.classList.remove('hidden');
            }

            function hideModal() { 
                detailsModal.classList.add('hidden'); 
            }

            function showListInModal(title, items) {
                let content = `
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">${title} (${items.length})</h2>
                    <hr class="my-4">
                    <div class="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                        ${items.length > 0 ? items.map(item => `
                            <div class="p-2 bg-gray-50 rounded text-sm">${item}</div>
                        `).join('') : '<p class="text-gray-500">No items found.</p>'}
                    </div>
                `;
                modalContentContainer.innerHTML = content;
                detailsModal.classList.remove('hidden');
            }

            function createUserLink(handle) {
                if (!handle) return 'N/A';
                return `<button class="user-link" data-handle="${handle}">${handle}</button>`;
            }

            function createCodeforcesLink(handle) {
                if (!handle) return '';
                return `<a href="https://codeforces.com/profile/${handle}" target="_blank" class="text-blue-600 hover:underline text-sm" title="View Codeforces Profile">
                    View on Codeforces
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block ml-1" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" />
                        <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" />
                    </svg>
                </a>`;
            }

            function createTeamLink(teamName, teamId) {
                return `<button class="team-link" data-team-id="${teamId}">${teamName}</button>`;
            }

            function createCompetitionLink(compName) {
                const comp = competitionDatabase[compName];
                if (comp && comp.link) {
                    return `<a href="${comp.link}" target="_blank" class="competition-link">${compName}</a>`;
                }
                return compName;
            }
            
            function updateSelectAllState(tableElement) {
                if (!tableElement) return;
                const headCheckbox = tableElement.querySelector('thead input[type="checkbox"]');
                const bodyCheckboxes = tableElement.querySelectorAll('tbody input[type="checkbox"]');
                const total = bodyCheckboxes.length;
                const checkedCount = Array.from(bodyCheckboxes).filter(cb => cb.checked).length;
                
                if (headCheckbox) {
                    headCheckbox.checked = total > 0 && total === checkedCount;
                }
            }
            
             // --- Gemini API ---
            async function callGeminiApi(prompt, retries = 3, delay = 1000) {
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && retries > 0) {
                             console.warn(`Rate limited. Retrying in ${delay}ms... (${retries} retries left)`);
                             await new Promise(res => setTimeout(res, delay));
                             return callGeminiApi(prompt, retries - 1, delay * 2);
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error("Invalid response structure from Gemini API");
                    }
                } catch (error) {
                    if (retries > 0) {
                         console.warn(`API call failed. Retrying in ${delay}ms... (${retries} retries left)`);
                         await new Promise(res => setTimeout(res, delay));
                         return callGeminiApi(prompt, retries - 1, delay * 2);
                    } else {
                        console.error("Error calling Gemini API:", error);
                        return `Error: Could not retrieve insights. ${error.message}`;
                    }
                }
            }
            
            async function generateAiInsights() {
                aiInsightContent.innerHTML = '<div class="flex items-center justify-center gap-2 text-gray-600"><div class="spinner w-6 h-6 border-2 rounded-full"></div><span>Generating insights... Please wait.</span></div>';
                showAiModal();

                const totalUsers = userDatabase.length;
                const totalTeams = teamDatabase.length;
                const top5Users = userDatabase.sort((a,b) => (b.lunaHardScore + b.lunaNovaScore) - (a.lunaHardScore + a.lunaNovaScore)).slice(0, 5).map(u => `${u.handle} (Score: ${(u.lunaHardScore + u.lunaNovaScore).toFixed(2)})`).join(', ');
                const uniDistribution = universityDatabase.map(uni => {
                    const count = userDatabase.filter(u => u.university === uni).length;
                    return `${uni}: ${count} users`;
                }).join('\n');

                const prompt = `
                    Based on the following competitive programming community data, provide a brief, insightful summary. The data is about users, their universities, teams, and placements in competitions.

                    - Total Users: ${totalUsers}
                    - Total Teams: ${totalTeams}
                    - Top 5 Users by Score: ${top5Users || 'N/A'}
                    - University Distribution:\n${uniDistribution || 'N/A'}

                    Analyze this data and provide:
                    1. A short, overall summary of the community's status.
                    2. Identify one key strength based on the data.
                    3. Suggest one area for potential improvement or focus.
                    
                    Format the response in clear sections using markdown headings.
                `;

                const insights = await callGeminiApi(prompt);
                
                const formattedInsights = insights
                    .replace(/### (.*)/g, '<h3 class="text-xl font-semibold text-fuchsia-700 mt-4 mb-2">$1</h3>')
                    .replace(/## (.*)/g, '<h2 class="text-2xl font-bold text-fuchsia-800 mb-3">$1</h2>')
                    .replace(/\* \*(.*)\*\*/g, '<strong>$1</strong>')
                    .replace(/\* (.*)/g, '<li class="ml-5 list-disc">$1</li>')
                    .replace(/\n/g, '<br>');

                aiInsightContent.innerHTML = formattedInsights;
            }


            // --- EVENT LISTENERS ---
            appContainer.addEventListener('click', (e) => {
                const userLink = e.target.closest('.user-link');
                const teamLink = e.target.closest('.team-link');
                if (userLink) {
                    e.preventDefault();
                    showUserDetailsModal(userLink.dataset.handle);
                } else if (teamLink) {
                    e.preventDefault();
                    showTeamDetailsModal(teamLink.dataset.teamId);
                }
            });

            downloadAllUsersCsvBtn.addEventListener('click', () => downloadUsersCSV(userDatabase));
            downloadSelectedUsersCsvBtn.addEventListener('click', () => {
                const selectedIds = Array.from(document.querySelectorAll('.user-select-checkbox:checked')).map(cb => cb.dataset.id);
                const selectedUsers = userDatabase.filter(user => selectedIds.includes(user.id));
                downloadUsersCSV(selectedUsers);
            });
            downloadReadinessModelBtn.addEventListener('click', downloadReadinessModelCSV);
            downloadDbFullBackupBtn.addEventListener('click', downloadDbFullBackup);
            downloadDbFullBackupBtn_dummy.addEventListener('click', downloadDbFullBackup);
            detailedUserForm.addEventListener('submit', handleDetailedUserFormSubmit);
            
            handleField.addEventListener('input', () => {
                document.querySelectorAll('.placement-entry').forEach(updateTeamSelectForEntry);
            });
            universityInput.addEventListener('input', () => {
                 document.querySelectorAll('.placement-entry').forEach(updateTeamSelectForEntry);
            });

            clearFormBtn.addEventListener('click', () => { showConfirmationModal('Clear Form?', 'Are you sure you want to clear all fields in the user form?', clearDetailedUserForm); });
            addPlacementBtn.addEventListener('click', () => addPlacementInput());
            
            detailedUserTable.querySelector('thead').addEventListener('click', e => {
                const header = e.target.closest('th.sortable-header');
                if (!header) return;
                const key = header.dataset.sortKey;
                let direction = 'desc';
                if (dbSortState.key === key) {
                    direction = dbSortState.direction === 'desc' ? 'asc' : 'desc';
                }
                dbSortState = { key, direction };
                renderUserDatabaseTable();
            });
            detailedUserTable.querySelector('thead').addEventListener('keyup', e => {
                if(e.target.matches('input[data-filter-key]')) {
                    dbFilters[e.target.dataset.filterKey] = e.target.value;
                    renderUserDatabaseTable();
                }
            });
            
            detailedUserTable.addEventListener('change', e => {
                 if (e.target.id === 'selectAllUsersCheckbox') {
                    document.querySelectorAll('#detailedUserTableBody .user-select-checkbox').forEach(cb => cb.checked = e.target.checked);
                 } else if (e.target.matches('.user-select-checkbox')) {
                    updateSelectAllState(detailedUserTable);
                 }
            });
            
            detailedUserTableBody.addEventListener('click', e => {
                const target = e.target; const row = target.closest('tr'); if (!row) return; const userId = row.dataset.id; const user = userDatabase.find(u => u.id === userId); if (!user) return;
                if (target.classList.contains('delete-db-user-btn')) {
                    showConfirmationModal('Delete User?', `Permanently delete ${user.handle} from the database? This cannot be undone.`, () => {
                        userDatabase = userDatabase.filter(u => u.id !== userId);
                        renderAll();
                    });
                } else if (target.classList.contains('edit-db-user-btn')) {
                    clearDetailedUserForm();
                    detailedUserForm.querySelector('[name="handle"]').value = user.handle;
                    detailedUserForm.querySelector('[name="handle"]').readOnly = true;
                    detailedUserForm.querySelector('[name="fullName"]').value = user.fullName;
                    detailedUserForm.querySelector('[name="linkedin"]').value = user.linkedin;
                    populateUniversityDatalist(user.university);
                    
                    profilePicUrlHiddenInput.value = user.profilePicUrl || '';
                    if(user.profilePicUrl) {
                        profilePicFileLabel.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                        profilePicFileLabel.classList.add('bg-green-600', 'hover:bg-green-700');
                        profilePicFileLabel.textContent = "Image Uploaded";
                    }

                    detailedUserForm.querySelector('[name="lunaNovaScore"]').value = user.lunaNovaScore;
                    detailedUserForm.querySelector('[name="lunaHardScore"]').value = user.lunaHardScore;
                    detailedUserForm.querySelector('[name="acmLevel"]').value = user.acmLevel;
                    detailedUserForm.querySelector('[name="joinDate"]').value = formatDateForInput(user.joinDate);
                    detailedUserForm.querySelector('[name="universityStartDate"]').value = formatDateForInput(user.universityStartDate);
                    detailedUserForm.querySelector('#isTrustedCheckbox').checked = user.isTrusted !== false;
                    placementsContainer.innerHTML = '';
                    user.placements.forEach(p => addPlacementInput(p));
                    handleField.dispatchEvent(new Event('input'));
                    detailedUserForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else if (target.classList.contains('details-db-user-btn')) {
                    showUserDetailsModal(user.handle);
                }
            });
            closeModalBtn.addEventListener('click', hideModal);
            
            detailsModal.addEventListener('click', (e) => { 
                if (e.target === detailsModal) {
                    hideModal();
                    return;
                }
                 const userLink = e.target.closest('.user-link');
                const teamLink = e.target.closest('.team-link');
                if (userLink) {
                    e.preventDefault();
                    showUserDetailsModal(userLink.dataset.handle);
                } else if (teamLink) {
                    e.preventDefault();
                    showTeamDetailsModal(teamLink.dataset.teamId);
                }
            });

            aiInsightBtn.addEventListener('click', generateAiInsights);
            closeAiModalBtn.addEventListener('click', hideAiModal);
            aiModal.addEventListener('click', (e) => { if(e.target === aiModal) hideAiModal()});

            confirmCancelBtn.addEventListener('click', hideConfirmationModal);
            confirmOkBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); hideConfirmationModal(); });
            
            passwordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const password = passwordField.value;
                if (confirmPasswordField.required && password !== confirmPasswordField.value) {
                    showToast("Passwords do not match.", "error");
                    return;
                }
                if (passwordCallback) {
                    passwordCallback(password);
                }
                hidePasswordModal();
            });
            passwordCancelBtn.addEventListener('click', hidePasswordModal);

            jsonFileInput.addEventListener('change', (e) => { loadJsonFile(e.target.files[0]); e.target.value = ''; });
            uploadUsersCsvInput.addEventListener('change', (e) => { handleFileUpload(e.target.files[0], handleUserUpload); e.target.value = ''; });
            uploadCompetitionsCsvInput.addEventListener('change', (e) => { handleFileUpload(e.target.files[0], handleCompetitionUpload); e.target.value = ''; });
            uploadUniversitiesCsvInput.addEventListener('change', (e) => { handleFileUpload(e.target.files[0], handleUniversityUpload); e.target.value = ''; });
            
            profilePicFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (event) => { 
                        profilePicUrlHiddenInput.value = event.target.result; 
                        profilePicFileLabel.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                        profilePicFileLabel.classList.add('bg-green-600', 'hover:bg-green-700');
                        profilePicFileLabel.textContent = "Image Uploaded";
                    };
                    reader.readAsDataURL(file);
                } else {
                    profilePicUrlHiddenInput.value = '';
                    profilePicFileLabel.classList.remove('bg-green-600', 'hover:bg-green-700');
                    profilePicFileLabel.classList.add('bg-gray-600', 'hover:bg-gray-700');
                    profilePicFileLabel.textContent = "Choose File";
                }
            });

            // --- LOCAL STORAGE PERSISTENCE ---
            function saveDataToLocalStorage() {
                try {
                    const dataToSave = {
                        users: userDatabase,
                        teams: teamDatabase,
                        competitions: competitionDatabase,
                        universities: universityDatabase,
                        version: 'v18-simplified'
                    };
                    localStorage.setItem('electiToolData_v18_simplified', JSON.stringify(dataToSave));
                } catch (e) {
                    console.error("Could not save to localStorage. Data might be too large.", e);
                }
            }

            function loadDataFromLocalStorage() {
                const savedData = localStorage.getItem('electiToolData_v18_simplified');
                if (savedData) {
                    try {
                        const data = JSON.parse(savedData);
                        userDatabase = data.users.map(u => ({...u, isTrusted: u.isTrusted !== false, updatedAt: new Date(u.updatedAt) })) || [];
                        teamDatabase = data.teams || [];
                        competitionDatabase = data.competitions || {};
                        universityDatabase = data.universities || [];
                    } catch (e) {
                        console.error("Error parsing data from localStorage", e);
                        userDatabase = []; teamDatabase = []; competitionDatabase = {}; universityDatabase = [];
                    }
                }
            }

            window.addEventListener('beforeunload', saveDataToLocalStorage);

            function initializeApp() {
                loadDataFromLocalStorage();
                renderAll();
            }

            initializeApp();
        });
    </script>
</body>
</html>

