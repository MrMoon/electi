<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operation Electi - Advanced Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .sortable-header {
            cursor: pointer;
            position: relative;
            user-select: none;
        }
        .sortable-header .sort-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.3;
        }
        .sortable-header.sort-asc .sort-icon, .sortable-header.sort-desc .sort-icon {
             opacity: 1;
        }
        .tab-btn.active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
        .editor-tab-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .stat-card {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #f9fafb;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
            z-index: 10;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        .dropdown-content a, .dropdown-content button {
            color: black;
            padding: 10px 14px;
            text-decoration: none;
            display: block;
            font-size: 0.875rem;
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
        }
        .dropdown-content a:hover, .dropdown-content button:hover {background-color: #e5e7eb;}
        .dropdown:hover .dropdown-content {display: block;}
        .file-input-label {
            cursor: pointer;
            display: inline-block;
            padding: 0.5rem 1rem;
            color: white;
            background-color: #4f46e5;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .file-input-label:hover {
            background-color: #4338ca;
        }
        input[type="file"] {
            display: none;
        }
        #detailedUserTable thead tr:nth-child(2) th, .editor-table thead tr:nth-child(2) th {
            padding: 0.5rem;
        }
        #detailedUserTable thead input[type="text"], .editor-table thead input[type="text"] {
            width: 100%;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
        }
        .editor-table input, .editor-table textarea, .editor-table select {
            width: 100%;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            background-color: #f9fafb;
        }
         .editor-table textarea {
            min-height: 60px;
         }
         #detailedUserForm input, #detailedUserForm select {
             width: 100%;
             padding: 6px 10px;
             border-radius: 0.375rem;
             border: 1px solid #d1d5db;
         }
         #detailedUserForm label {
             font-weight: 500;
             font-size: 0.875rem;
             color: #374151;
             margin-bottom: 0.25rem;
             display: block;
         }
        .sub-tab-btn {
            transition: all 0.2s ease-in-out;
        }
         .sub-tab-btn.active {
            background-color: #e0e7ff;
            color: #4338ca;
            font-weight: 600;
        }
        .analytics-toggle-btn {
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid #d1d5db;
            background-color: white;
            color: #4b5563;
            cursor: pointer;
        }
        .analytics-toggle-btn.active {
            background-color: #4338ca;
            color: white;
            border-color: #4338ca;
        }
        .placement-entry {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            position: relative;
        }
        .placement-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        /* Styles for expandable competition list in modal */
        .competition-item summary {
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }
        .competition-item summary:hover {
            background-color: #eef2ff;
        }
        .competition-item[open] summary {
            font-weight: 600;
            color: #4338ca;
        }
        .participant-list {
            padding-left: 1.5rem;
            margin-top: 0.5rem;
            border-left: 2px solid #e5e7eb;
        }
        /* Styles for clickable links */
        .user-link, .team-link, .competition-link {
            font-weight: 500;
            color: #4f46e5;
            cursor: pointer;
            text-decoration: none;
            background: none;
            border: none;
            padding: 0;
        }
        .user-link:hover, .team-link:hover, .competition-link:hover {
            text-decoration: underline;
        }
        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #2d3748;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .toast-notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast-notification.info { background-color: #2b6cb0; }
        .toast-notification.error { background-color: #c53030; }
        /* Select2 Styles */
        .select2-container--default .select2-selection--multiple {
            border: 1px solid #d1d5db;
            background-color: #f9fafb;
            border-radius: 4px;
        }
        .select2-container .select2-selection--multiple {
            min-height: 38px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50 text-gray-800">

    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-6">
            <div class="flex justify-center items-center gap-4 mb-2">
                <img src="https://i.ibb.co/JNyxxBv/logo.png" alt="Operation Electi Logo" class="h-16 w-16" onerror="this.onerror=null; this.src='https://placehold.co/64x64/e0e0e0/333?text=Logo';">
                <h1 class="text-5xl font-bold text-gray-900">Operation Electi</h1>
            </div>
            <p class="mt-2 text-lg text-gray-600">An advanced analytics and user management tool.</p>
        </header>

        <!-- Data Management Panel -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-8">
            <div class="flex flex-wrap justify-center items-center gap-x-6 gap-y-4">
                <div class="text-center">
                    <p class="font-medium text-gray-700 text-sm">Upload Users (CSV)</p>
                    <label for="uploadUsersCsv" class="file-input-label bg-green-600 hover:bg-green-700 text-sm mt-1">Choose File</label>
                    <input type="file" id="uploadUsersCsv" accept=".csv">
                </div>
                <div class="text-center">
                    <p class="font-medium text-gray-700 text-sm">Upload Competitions (CSV)</p>
                    <label for="uploadCompetitionsCsv" class="file-input-label bg-blue-600 hover:bg-blue-700 text-sm mt-1">Choose File</label>
                    <input type="file" id="uploadCompetitionsCsv" accept=".csv">
                </div>
                <div class="text-center">
                    <p class="font-medium text-gray-700 text-sm">Upload Universities (CSV)</p>
                    <label for="uploadUniversitiesCsv" class="file-input-label bg-indigo-600 hover:bg-indigo-700 text-sm mt-1">Choose File</label>
                    <input type="file" id="uploadUniversitiesCsv" accept=".csv">
                </div>
                <div class="text-center">
                    <p class="font-medium text-gray-700 text-sm">Full Backup (JSON)</p>
                    <button id="downloadDbFullBackupBtn" class="file-input-label bg-purple-600 hover:bg-purple-700 text-sm mt-1 w-full text-center">Download</button>
                </div>
                <div class="text-center">
                    <p class="font-medium text-gray-700 text-sm">Restore Backup (JSON)</p>
                    <label for="jsonFileInput" class="file-input-label bg-red-600 hover:bg-red-700 text-sm mt-1">Restore</label>
                    <input type="file" id="jsonFileInput" accept=".json">
                </div>
                 <div class="text-center">
                    <p class="font-medium text-gray-700 text-sm">AI Insights</p>
                    <button id="aiInsightBtn" class="file-input-label bg-fuchsia-600 hover:bg-fuchsia-700 text-sm mt-1 w-full text-center">Generate</button>
                </div>
            </div>
        </div>

        <!-- Tab Controls -->
        <div class="mb-8 border-b border-gray-200">
            <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                <button id="tabBtnDatabase" class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">
                    User Database
                </button>
                <button id="tabBtnEditors" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    Data Editors
                </button>
                <button id="tabBtnAnalyticsDashboard" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    Advanced Analytics
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div id="tabContentDatabase">
            <!-- Form, Stats, and Table will be stacked vertically -->
            
            <!-- Add/Update User Form -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-2xl font-bold mb-4">Add/Update User Info</h2>
                <form id="detailedUserForm" class="space-y-4">
                     <!-- User Info Row -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="handleField">Codeforces Handle*</label>
                            <input type="text" id="handleField" name="handle" placeholder="e.g., tourist" required>
                        </div>
                        <div>
                            <label for="fullNameField">Full Name</label>
                            <input type="text" id="fullNameField" name="fullName" placeholder="e.g., Gennady Korotkevich">
                        </div>
                        <div>
                            <label for="linkedinField">LinkedIn Profile</label>
                            <input type="url" id="linkedinField" name="linkedin" placeholder="https://linkedin.com/in/...">
                        </div>
                    </div>
                    <!-- University & Scores Row -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="md:col-span-2">
                            <label for="universityInput">University</label>
                            <input type="text" list="university-list" name="university" id="universityInput" placeholder="Type or select university">
                            <datalist id="university-list"></datalist>
                        </div>
                        <div>
                            <label for="lunaNovaScoreField">Luna Nova Score</label>
                            <input type="number" step="0.01" id="lunaNovaScoreField" name="lunaNovaScore" placeholder="0.00">
                        </div>
                        <div>
                            <label for="lunaHardScoreField">Luna Score</label>
                            <input type="number" step="0.01" id="lunaHardScoreField" name="lunaHardScore" placeholder="0.00">
                        </div>
                    </div>
                     <!-- Other Info Row -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div>
                            <label for="acmLevel">ACM Level</label>
                            <select name="acmLevel" id="acmLevel">
                                <option value="0">None</option>
                                <option value="-1">Codeability</option>
                                <option value="10">Level 0</option>
                                <option value="1">Level 1</option>
                                <option value="2">Level 2</option>
                            </select>
                        </div>
                        <div>
                            <label for="joinDate">Join Date</label>
                            <input type="month" id="joinDate" name="joinDate">
                        </div>
                         <div>
                            <label for="universityStartDate">University Start Date</label>
                            <input type="month" id="universityStartDate" name="universityStartDate">
                        </div>
                        <div class="flex items-end gap-4">
                            <div class="flex-grow">
                                <label class="block text-sm font-medium text-gray-700">Profile Picture</label>
                                <input type="hidden" name="profilePicUrl" id="profilePicUrlHidden">
                                <label for="profilePicFile" id="profilePicFileLabel" class="file-input-label bg-gray-600 hover:bg-gray-700 text-sm !px-3 !py-2.5 whitespace-nowrap w-full text-center">Choose File</label>
                                <input type="file" id="profilePicFile" accept="image/*">
                            </div>
                            <div class="flex items-center pb-1">
                                <input type="checkbox" name="isTrusted" id="isTrustedCheckbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                <label for="isTrustedCheckbox" class="ml-2 !mb-0 block text-sm font-medium text-gray-900">Trusted</label>
                            </div>
                        </div>
                    </div>
                    <!-- Placements Section -->
                    <hr class="!my-6"/>
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold">Placements</h3>
                    </div>
                    <div id="placementsContainer" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
                    <button type="button" id="addPlacementBtn" class="w-full text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 transition duration-200">Add Placement</button>
                    <datalist id="competition-list"></datalist>
                    <hr class="!my-6"/>
                    <!-- Action Buttons -->
                    <div class="flex gap-4">
                        <button type="submit" id="saveUserBtn" class="w-full bg-green-600 text-white font-bold py-2.5 px-4 rounded-md hover:bg-green-700 transition duration-200">Save User</button>
                        <button type="button" id="clearFormBtn" class="w-full bg-gray-500 text-white font-bold py-2.5 px-4 rounded-md hover:bg-gray-600 transition duration-200">Clear Form</button>
                    </div>
                </form>
            </div>

            <!-- Statistics Section -->
            <div class="stat-card mb-8">
                <h2 class="text-xl font-bold mb-4">Database Statistics</h2>
                <div id="statsContainer" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 text-center">
                    <!-- Stats will be dynamically inserted here -->
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                    <div class="p-4"><canvas id="acmLevelChart"></canvas></div>
                    <div class="p-4"><canvas id="competitionChart"></canvas></div>
                </div>
            </div>
            
            <!-- User Table Section -->
            <div class="bg-white rounded-lg shadow-md">
                <div class="p-4 border-b border-gray-200 flex flex-wrap justify-between items-center gap-4">
                     <h2 class="text-xl font-bold">User Database (<span id="databaseUserCount">0</span>)</h2>
                     <div class="dropdown">
                        <button class="bg-purple-600 text-white font-bold py-2 px-4 rounded-md hover:bg-purple-700 transition duration-200 flex items-center gap-2">
                            Download
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="dropdown-content">
                            <button id="downloadSelectedUsersCsvBtn">Download Selected Users (CSV)</button>
                            <button id="downloadAllUsersCsvBtn">Download All Users (CSV)</button>
                            <button id="downloadReadinessModelBtn">Download Readiness Model Input</button>
                            <button id="downloadDbFullBackupBtn_dummy">Download Full Backup (JSON)</button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table id="detailedUserTable" class="w-full text-sm text-left text-gray-600">
                        <thead class="bg-gray-100 text-xs text-gray-700 uppercase">
                            <tr>
                                <th class="p-2 w-10 text-center"><input type="checkbox" id="selectAllUsersCheckbox"></th>
                                <th class="p-2 sortable-header" data-sort-key="handle">Handle <span class="sort-icon"></span></th>
                                <th class="p-2 sortable-header" data-sort-key="fullName">Full Name <span class="sort-icon"></span></th>
                                <th class="p-2 sortable-header" data-sort-key="university">University <span class="sort-icon"></span></th>
                                <th class="p-2 sortable-header" data-sort-key="academicYear">Student Year <span class="sort-icon"></span></th>
                                <th class="p-2 sortable-header sort-desc" data-sort-key="updatedAt">Last Updated <span class="sort-icon"></span></th>
                                <th class="p-2 text-center">Actions</th>
                            </tr>
                            <tr>
                                <th></th>
                                <th><input type="text" data-filter-key="handle" placeholder="Filter..."></th>
                                <th><input type="text" data-filter-key="fullName" placeholder="Filter..."></th>
                                <th><input type="text" data-filter-key="university" placeholder="Filter..."></th>
                                <th><input type="text" data-filter-key="academicYear" placeholder="Filter..."></th>
                                <th></th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="detailedUserTableBody">
                            <tr><td colspan="7" class="p-4 text-center text-gray-500">No users in the database yet.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="tabContentAnalyticsDashboard" class="hidden">
             <div class="bg-white rounded-lg shadow-md p-6">
                <div class="border-b border-gray-200 mb-4">
                    <nav id="analyticsSubTabs" class="flex flex-wrap -mb-px" aria-label="Analytics Tabs">
                        <button data-analytics-view="global" class="sub-tab-btn active font-medium px-4 py-2 rounded-t-lg">Global</button>
                        <button data-analytics-view="universities" class="sub-tab-btn font-medium px-4 py-2 rounded-t-lg text-gray-600">Universities</button>
                        <button data-analytics-view="competitions" class="sub-tab-btn font-medium px-4 py-2 rounded-t-lg text-gray-600">Competitions</button>
                        <button data-analytics-view="teams" class="sub-tab-btn font-medium px-4 py-2 rounded-t-lg text-gray-600">Teams</button>
                        <button data-analytics-view="individuals" class="sub-tab-btn font-medium px-4 py-2 rounded-t-lg text-gray-600">Individuals</button>
                    </nav>
                </div>
                <div id="advancedStatsContainer">
                    <!-- Advanced analytics content will be rendered here -->
                </div>
            </div>
        </div>

        <div id="tabContentEditors" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="border-b border-gray-200 mb-4">
                    <nav class="flex space-x-1" aria-label="Editor Tabs">
                        <button data-editor="competitions" class="editor-tab-btn active font-medium px-4 py-2 rounded-t-lg">Competitions</button>
                        <button data-editor="universities" class="editor-tab-btn font-medium px-4 py-2 rounded-t-lg text-gray-600">Universities</button>
                        <button data-editor="teams" class="editor-tab-btn font-medium px-4 py-2 rounded-t-lg text-gray-600">Teams</button>
                    </nav>
                </div>

                <div id="editorContainer">
                    <!-- This container will hold the editor sub-tabs and content -->
                </div>
            </div>
        </div>

    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative transform scale-95">
            <h3 id="confirmationModalTitle" class="text-lg font-bold mb-4">Confirm Action</h3>
            <p id="confirmationModalMessage" class="text-gray-700 mb-6">Are you sure?</p>
            <div class="flex justify-end gap-4">
                <button id="confirmCancelBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="confirmOkBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-6 relative transform scale-95">
            <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <div id="modalContentContainer"></div>
        </div>
    </div>
    
    <!-- AI Modal -->
    <div id="aiModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 relative transform scale-95">
            <h3 class="text-2xl font-bold mb-4 text-fuchsia-800">AI-Powered Insights</h3>
            <div id="aiInsightContent" class="space-y-4 max-h-[60vh] overflow-y-auto pr-4">
                <p class="text-gray-600">Generating insights... Please wait.</p>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="closeAiModalBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-container"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE VARIABLES ---
            let userDatabase = [];
            let teamDatabase = [];
            let competitionDatabase = {};
            let universityDatabase = [];
            let charts = {}; // Object to hold all chart instances
            let dbSortState = { key: 'updatedAt', direction: 'desc' };
            let dbFilters = {};
            let editorSortStates = {
                competitions: { key: 'name', direction: 'asc' },
                universities: { key: 'name', direction: 'asc' },
                teams: { key: 'name', direction: 'asc' }
            };
            let editorFilters = {
                competitions: {},
                universities: {},
                teams: {}
            };
            let confirmCallback = null;

            // --- DOM ELEMENT REFERENCES ---
            const appContainer = document.getElementById('app-container');
            const tabButtons = {
                database: document.getElementById('tabBtnDatabase'),
                editors: document.getElementById('tabBtnEditors'),
                analyticsdashboard: document.getElementById('tabBtnAnalyticsDashboard'),
            };
            const tabContents = {
                database: document.getElementById('tabContentDatabase'),
                editors: document.getElementById('tabContentEditors'),
                analyticsdashboard: document.getElementById('tabContentAnalyticsDashboard'),
            };
            const editorContainer = document.getElementById('editorContainer');
            const analyticsSubTabs = document.getElementById('analyticsSubTabs');
            
            const jsonFileInput = document.getElementById('jsonFileInput');
            const downloadSelectedUsersCsvBtn = document.getElementById('downloadSelectedUsersCsvBtn');
            const downloadAllUsersCsvBtn = document.getElementById('downloadAllUsersCsvBtn');
            const downloadReadinessModelBtn = document.getElementById('downloadReadinessModelBtn');
            const downloadDbFullBackupBtn = document.getElementById('downloadDbFullBackupBtn');
            const downloadDbFullBackupBtn_dummy = document.getElementById('downloadDbFullBackupBtn_dummy');
            const detailedUserForm = document.getElementById('detailedUserForm');
            const handleField = document.getElementById('handleField');
            const clearFormBtn = document.getElementById('clearFormBtn');
            const placementsContainer = document.getElementById('placementsContainer');
            const addPlacementBtn = document.getElementById('addPlacementBtn');
            const competitionDataList = document.getElementById('competition-list');
            const universityInput = document.getElementById('universityInput');
            const universityDataList = document.getElementById('university-list');
            const detailedUserTable = document.getElementById('detailedUserTable');
            const detailedUserTableBody = document.getElementById('detailedUserTableBody');
            const databaseUserCount = document.getElementById('databaseUserCount');
            
            const statsContainer = document.getElementById('statsContainer');
            const advancedStatsContainer = document.getElementById('advancedStatsContainer');
            const detailsModal = document.getElementById('detailsModal');
            const modalContentContainer = document.getElementById('modalContentContainer');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const confirmationModal = document.getElementById('confirmationModal');
            const confirmationModalTitle = document.getElementById('confirmationModalTitle');
            const confirmationModalMessage = document.getElementById('confirmationModalMessage');
            const confirmCancelBtn = document.getElementById('confirmCancelBtn');
            const confirmOkBtn = document.getElementById('confirmOkBtn');
            const uploadUsersCsvInput = document.getElementById('uploadUsersCsv');
            const uploadCompetitionsCsvInput = document.getElementById('uploadCompetitionsCsv');
            const uploadUniversitiesCsvInput = document.getElementById('uploadUniversitiesCsv');
            const profilePicFileInput = document.getElementById('profilePicFile');
            const profilePicFileLabel = document.getElementById('profilePicFileLabel');
            const profilePicUrlHiddenInput = document.getElementById('profilePicUrlHidden');
            const aiInsightBtn = document.getElementById('aiInsightBtn');
            const aiModal = document.getElementById('aiModal');
            const aiInsightContent = document.getElementById('aiInsightContent');
            const closeAiModalBtn = document.getElementById('closeAiModalBtn');

            // --- CHART HELPERS ---
            function destroyChart(chartId) {
                if (charts[chartId]) {
                    charts[chartId].destroy();
                    delete charts[chartId];
                }
            }

            function renderChart(chartId, type, data, options) {
                destroyChart(chartId); // Ensure old chart is destroyed
                const ctx = document.getElementById(chartId)?.getContext('2d');
                if (ctx) {
                    charts[chartId] = new Chart(ctx, { type, data, options });
                }
            }
            
            // --- DATE & ACADEMIC YEAR HELPERS ---
            function formatDateForInput(dateStr) {
                if (!dateStr) return '';
                return dateStr.slice(0, 7); 
            }

            function formatMonthYear(dateString) {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                return date.toLocaleString('default', { month: 'short', year: 'numeric' });
            }
            
            function formatMMYYYY(dateString) {
                if (!dateString) return 'N/A';
                try {
                    const date = new Date(dateString);
                    // Add a day to the date to handle timezone issues where it might be the last day of the previous month in UTC
                    date.setDate(date.getDate() + 1);
                    const year = date.getUTCFullYear();
                    const month = (date.getUTCMonth() + 1).toString().padStart(2, '0');
                    return `${month}-${year}`;
                } catch (e) {
                    return 'Invalid Date';
                }
            }

            function getAcademicYear(user) {
                if (!user || !user.universityStartDate) {
                    return { year: null, label: 'Unknown' };
                }
                const currentYear = new Date().getFullYear();
                const currentMonth = new Date().getMonth();
                const start = new Date(user.universityStartDate);
                const startYear = start.getFullYear();
                const startMonth = start.getMonth();
                
                let academicYear = currentYear - startYear;
                if (currentMonth < startMonth) {
                    academicYear--;
                }
                academicYear++; // Convert to 1-based index

                if (academicYear === 1) return { year: 1, label: '1st Year' };
                if (academicYear === 2) return { year: 2, label: '2nd Year' };
                if (academicYear === 3) return { year: 3, label: '3rd Year' };
                if (academicYear === 4) return { year: 4, label: '4th Year' };
                if (academicYear > 4 && academicYear < 10) return { year: 5, label: '5th Year+' }; // Cap at a reasonable number
                if (academicYear >= 10) return { year: 6, label: 'Graduated' };
                return { year: 6, label: 'Graduated' };
            }

            // --- NOTIFICATION / MODAL ---
            function showToast(message, type = 'info', duration = 3000) {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast-notification ${type}`;
                toast.textContent = message;
                container.appendChild(toast);

                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);

                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, duration);
            }
            
            function showConfirmationModal(title, message, onConfirm) { 
                confirmationModalTitle.textContent = title; 
                confirmationModalMessage.textContent = message; 
                confirmCallback = onConfirm; 
                confirmationModal.classList.remove('hidden'); 
                setTimeout(() => { 
                    confirmationModal.querySelector('.modal-overlay')?.classList.remove('opacity-0'); 
                    confirmationModal.querySelector('.modal-content')?.classList.remove('scale-95'); 
                }, 10); 
            }
            function hideConfirmationModal() { 
                confirmationModal.querySelector('.modal-overlay')?.classList.add('opacity-0'); 
                confirmationModal.querySelector('.modal-content')?.classList.add('scale-95'); 
                setTimeout(() => { 
                    confirmationModal.classList.add('hidden'); 
                    confirmCallback = null; 
                }, 300); 
            }
             function showAiModal() {
                aiModal.classList.remove('hidden');
                setTimeout(() => {
                    aiModal.querySelector('.modal-overlay')?.classList.remove('opacity-0');
                    aiModal.querySelector('.modal-content')?.classList.remove('scale-95');
                }, 10);
            }

            function hideAiModal() {
                aiModal.querySelector('.modal-overlay')?.classList.add('opacity-0');
                aiModal.querySelector('.modal-content')?.classList.add('scale-95');
                setTimeout(() => {
                    aiModal.classList.add('hidden');
                }, 300);
            }

            // --- UI and Helper Functions ---
            function loadJsonFile(file) { 
                if (!file) { showToast('Please select a JSON backup file.', 'error'); return; } 
                const reader = new FileReader(); 
                reader.onload = (e) => { 
                    try { 
                        const data = JSON.parse(e.target.result);
                        if (!data.users || !data.competitions || !data.universities || !data.teams) {
                            throw new Error("Invalid backup file format. Must contain 'users', 'competitions', 'universities', and 'teams' keys.");
                        }
                        showConfirmationModal('Overwrite Data?', 'Loading this backup will overwrite all current data. Are you sure?', () => {
                            userDatabase = data.users.map(u => ({...u, updatedAt: new Date(u.updatedAt) })) || [];
                            competitionDatabase = data.competitions || {};
                            universityDatabase = data.universities || [];
                            teamDatabase = data.teams || [];
                            renderAll();
                            showToast(`Successfully loaded backup from ${new Date(data.createdAt).toLocaleString()}.`, 'info');
                        });
                    } catch (error) { 
                        showToast(`Error parsing JSON: ${error.message}`, 'error'); 
                    } 
                }; 
                reader.readAsText(file); 
            }
            
            // --- Database Tab Logic ---
            function addPlacementInput(placement = null) {
                const placementDiv = document.createElement('div');
                placementDiv.className = 'placement-entry';
                const uniqueId = `placement_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                placementDiv.id = uniqueId;
                
                const compName = placement ? placement.name : '';
                const compData = competitionDatabase[compName] || {};
                const teamId = placement ? placement.teamId : '';

                placementDiv.innerHTML = `
                    <button type="button" class="remove-placement-btn absolute -top-2.5 -right-2.5 bg-red-500 text-white rounded-full h-6 w-6 flex items-center justify-center font-bold text-sm hover:bg-red-600 z-10">&times;</button>
                    <div class="flex justify-between items-center gap-4">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" class="team-placement-checkbox h-4 w-4 rounded border-gray-400" ${teamId ? 'checked' : ''}>
                            <label class="text-sm font-medium !mb-0">Team Placement</label>
                        </div>
                        <div class="team-selection-container ${teamId ? '' : 'hidden'} flex-grow">
                            <label class="font-medium text-xs text-gray-600 sr-only">Team Name*</label>
                            <select class="team-name-select w-full text-sm p-2 border border-gray-300 rounded-md">
                                <option value="">Select a team...</option>
                            </select>
                        </div>
                    </div>
                    <div class="placement-fields grid-cols-1 sm:grid-cols-3">
                        <div class="sm:col-span-1">
                            <label class="font-medium text-xs text-gray-600">Competition*</label>
                            <input type="text" list="competition-list" placeholder="Competition Name" class="comp-name-input w-full text-sm p-2 border border-gray-300 rounded-md" value="${compName}" required>
                        </div>
                        <div class="sm:col-span-1">
                            <label class="font-medium text-xs text-gray-600">Date*</label>
                            <input type="month" class="comp-date-input w-full text-sm p-2 border border-gray-300 rounded-md" value="${compData.date || ''}" required>
                        </div>
                        <div class="sm:col-span-1 grid grid-cols-2 gap-2">
                             <div>
                                <label class="font-medium text-xs text-gray-600">Rank*</label>
                                <input type="number" placeholder="Rank" min="1" class="comp-rank-input w-full text-sm p-2 border border-gray-300 rounded-md" value="${placement ? placement.rank : ''}" required>
                             </div>
                             <div>
                                <label class="font-medium text-xs text-gray-600">Total*</label>
                                <input type="number" placeholder="Total" min="1" class="comp-total-input w-full text-sm p-2 border border-gray-300 rounded-md" value="${placement ? placement.total : (compData.total || '')}" required>
                             </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <label class="font-medium text-xs text-gray-600">Competition Link*</label>
                        <input type="url" placeholder="https://codeforces.com/contest/..." class="comp-link-input w-full text-sm p-2 border border-gray-300 rounded-md" value="${compData.link || ''}" required>
                    </div>
                `;
                placementsContainer.appendChild(placementDiv);

                // Attach event listeners to the new elements
                const teamCheckbox = placementDiv.querySelector('.team-placement-checkbox');
                const compNameInput = placementDiv.querySelector('.comp-name-input');
                const teamSelect = placementDiv.querySelector('.team-name-select');
                const compDateInput = placementDiv.querySelector('.comp-date-input');

                updateTeamSelectForEntry(placementDiv);
                if (teamId) teamSelect.value = teamId;


                placementDiv.querySelector('.remove-placement-btn').addEventListener('click', () => {
                    showConfirmationModal('Remove Placement?', 'Are you sure you want to remove this placement entry?', () => placementDiv.remove());
                });

                // Add listener for manual date changes
                compDateInput.addEventListener('change', () => {
                    updateTeamSelectForEntry(placementDiv);
                });
                
                teamCheckbox.addEventListener('change', (e) => {
                    placementDiv.querySelector('.team-selection-container').classList.toggle('hidden', !e.target.checked);
                    if (e.target.checked) {
                        updateTeamSelectForEntry(placementDiv);
                    }
                });

                compNameInput.addEventListener('input', (e) => {
                    const currentCompName = e.target.value;
                    const comp = competitionDatabase[currentCompName];
                    const compDateInput = placementDiv.querySelector('.comp-date-input');
                    const compTotalInput = placementDiv.querySelector('.comp-total-input');
                    const compLinkInput = placementDiv.querySelector('.comp-link-input');
                    const compRankInput = placementDiv.querySelector('.comp-rank-input');

                    if (comp) {
                        if (comp.date) compDateInput.value = comp.date;
                        if (comp.total) compTotalInput.value = comp.total;
                        if (comp.link) compLinkInput.value = comp.link;
                    }

                    // Always update team list when competition might have changed date
                    updateTeamSelectForEntry(placementDiv);

                    // Auto-populate from teammate
                    const isTeamPlacement = teamCheckbox.checked;
                    const selectedTeamId = teamSelect.value;
                    if (!isTeamPlacement || !selectedTeamId || !currentCompName) return;

                    const selectedTeam = teamDatabase.find(t => t.id === selectedTeamId);
                    if (!selectedTeam) return;

                    for (const memberHandle of selectedTeam.members) {
                        const member = userDatabase.find(u => u.handle.toLowerCase() === memberHandle.toLowerCase());
                        if (member) {
                            const teamPlacement = member.placements.find(p => p.teamId === selectedTeam.id && p.name.toLowerCase() === currentCompName.toLowerCase());
                            if (teamPlacement) {
                                compRankInput.value = teamPlacement.rank;
                                compTotalInput.value = teamPlacement.total;
                                showToast(`Auto-filled rank for ${currentCompName} from teammate ${member.handle}.`, 'info');
                                return;
                            }
                        }
                    }
                });
                
                teamSelect.addEventListener('change', () => {
                     compNameInput.dispatchEvent(new Event('input')); // Re-trigger check
                });

                if (placement) compNameInput.dispatchEvent(new Event('input'));
            }

            function handleDetailedUserFormSubmit(e) {
                e.preventDefault();
                const saveButton = document.getElementById('saveUserBtn');

                // --- Start of Async Change ---
                const formData = new FormData(detailedUserForm);
                const handle = formData.get('handle').trim();
                if (!handle) { 
                    showToast("Handle is required.", 'error'); 
                    return; 
                }

                const placementsData = [];
                let placementError = false;
                document.querySelectorAll('.placement-entry').forEach(entry => {
                    if (placementError) return;
                    const name = entry.querySelector('.comp-name-input').value.trim();
                    const date = entry.querySelector('.comp-date-input').value;
                    const link = entry.querySelector('.comp-link-input').value.trim();
                    const rankStr = entry.querySelector('.comp-rank-input').value;
                    const totalStr = entry.querySelector('.comp-total-input').value;
                    const isTeamPlacement = entry.querySelector('.team-placement-checkbox').checked;
                    const teamId = entry.querySelector('.team-name-select').value;

                    if (!name || !rankStr || !totalStr || !date || !link) {
                        showToast('Competition Name, Date, Link, Rank, and Total fields are required for all placements.', 'error');
                        placementError = true; return;
                    }
                    if(isTeamPlacement && !teamId) {
                        showToast(`A team must be selected for a team placement in "${name}".`, 'error');
                        placementError = true; return;
                    }

                    const rank = parseInt(rankStr, 10);
                    const total = parseInt(totalStr, 10);
                    if (rank > total) {
                         showToast(`Placement error for "${name}": Rank (${rank}) cannot be greater than Total (${total}).`, 'error');
                         placementError = true; return;
                    }

                    placementsData.push({ name, rank, total, teamId: isTeamPlacement ? teamId : null, date, link });
                });

                if (placementError) return;
                
                saveButton.disabled = true;
                saveButton.innerHTML = `<div class="flex justify-center items-center gap-2"><div class="spinner w-4 h-4 border-2 rounded-full"></div>Saving...</div>`;
                
                setTimeout(() => {
                    const universityName = formData.get('university').trim();
                    if (universityName && !universityDatabase.includes(universityName)) {
                        universityDatabase.push(universityName);
                        universityDatabase.sort();
                    }

                    // Process competitions from placements
                    placementsData.forEach(p => {
                        if (!competitionDatabase[p.name] || competitionDatabase[p.name].total !== p.total || competitionDatabase[p.name].date !== p.date || competitionDatabase[p.name].link !== p.link) {
                           competitionDatabase[p.name] = { total: parseInt(p.total, 10), date: p.date, link: p.link };
                        }
                    });

                    const userToSave = {
                        id: handle.toLowerCase(),
                        handle: handle,
                        fullName: formData.get('fullName').trim(),
                        linkedin: formData.get('linkedin').trim(),
                        university: universityName,
                        profilePicUrl: formData.get('profilePicUrl').trim(),
                        lunaNovaScore: parseFloat(formData.get('lunaNovaScore')) || 0,
                        lunaHardScore: parseFloat(formData.get('lunaHardScore')) || 0,
                        acmLevel: parseInt(formData.get('acmLevel'), 10),
                        joinDate: formData.get('joinDate') || null,
                        universityStartDate: formData.get('universityStartDate') || null,
                        isTrusted: detailedUserForm.querySelector('#isTrustedCheckbox').checked,
                        placements: placementsData.map(({name, rank, total, teamId}) => ({name, rank, total, teamId})), // Save only necessary fields
                        updatedAt: new Date()
                    };

                    saveUserAndUpdateTeams(userToSave);
                    
                    // Restore button and give feedback
                    saveButton.disabled = false;
                    saveButton.innerHTML = 'Save User';
                    clearDetailedUserForm();
                    renderAll();
                    showToast(`User ${userToSave.handle} saved successfully.`, 'info');

                }, 50); // Small delay to allow UI to update
                // --- End of Async Change ---
            }


            function saveUserAndUpdateTeams(userToSave) {
                const existingIndex = userDatabase.findIndex(u => u.id === userToSave.id);
                if (existingIndex > -1) {
                    // Replace the existing user object with the updated one
                    userDatabase.splice(existingIndex, 1, userToSave);
                } else {
                    userDatabase.push(userToSave);
                }

                // Propagate team placements to other members
                userToSave.placements.filter(p => p.teamId).forEach(teamPlacement => {
                    const team = teamDatabase.find(t => t.id === teamPlacement.teamId);
                    if (!team) return;

                    team.members.forEach(memberHandle => {
                        if (memberHandle.toLowerCase() === userToSave.id) return; // Don't propagate to self

                        let member = userDatabase.find(u => u.handle.toLowerCase() === memberHandle.toLowerCase());
                        if (member) {
                            const hasPlacement = member.placements.some(p => p.name.toLowerCase() === teamPlacement.name.toLowerCase() && p.teamId === teamPlacement.teamId);
                            if (!hasPlacement) {
                                member.placements.push(teamPlacement);
                                member.updatedAt = new Date();
                                showToast(`Propagated '${teamPlacement.name}' to ${member.handle}.`, 'info');
                            }
                        }
                    });
                });
            }
            
            function clearDetailedUserForm() {
                detailedUserForm.reset();
                placementsContainer.innerHTML = '';
                detailedUserForm.querySelector('[name="handle"]').readOnly = false;
                detailedUserForm.querySelector('#isTrustedCheckbox').checked = true;
                universityInput.value = "";
                profilePicUrlHiddenInput.value = "";
                profilePicFileLabel.classList.remove('bg-green-600', 'hover:bg-green-700');
                profilePicFileLabel.classList.add('bg-gray-600', 'hover:bg-gray-700');
                profilePicFileLabel.textContent = "Choose File";
            }

            function renderAll() {
                renderUserDatabaseTable();
                updateAndRenderStatistics();
                renderCurrentEditorView();
                renderAdvancedStats();
                updateAllDatalists();
            }
            
            function updateAllDatalists() {
                updateCompetitionDatalist();
                document.querySelectorAll('.placement-entry').forEach(updateTeamSelectForEntry);
                populateUniversityDatalist();
            }

            function renderUserDatabaseTable() {
                // Add academic year to each user object for sorting/filtering
                const usersWithYear = userDatabase.map(user => ({
                    ...user,
                    academicYear: getAcademicYear(user).label
                }));

                const filteredUsers = usersWithYear.filter(user => {
                    return Object.entries(dbFilters).every(([key, value]) => {
                        const userValue = String(user[key] || '').toLowerCase();
                        return userValue.includes(value.toLowerCase());
                    });
                });

                const { key, direction } = dbSortState;
                filteredUsers.sort((a,b) => {
                    const valA = a[key];
                    const valB = b[key];
                    if (valA < valB) return direction === 'asc' ? -1 : 1;
                    if (valA > valB) return direction === 'asc' ? 1 : -1;
                    return 0;
                });

                detailedUserTableBody.innerHTML = '';
                databaseUserCount.textContent = filteredUsers.length;

                if (filteredUsers.length === 0) {
                    detailedUserTableBody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-500">No matching users found.</td></tr>`;
                    updateSelectAllState(detailedUserTable);
                    return;
                }

                filteredUsers.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.dataset.id = user.id;
                    const formattedDate = new Date(user.updatedAt).toLocaleString([], { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    const handleClass = user.isTrusted ? 'font-semibold' : 'font-semibold text-red-600';
                    row.innerHTML = `
                        <td class="p-2 text-center"><input type="checkbox" class="user-select-checkbox" data-id="${user.id}"></td>
                        <td class="p-2 ${handleClass}">${createUserLink(user.handle)}</td>
                        <td class="p-2">${user.fullName || 'N/A'}</td>
                        <td class="p-2">${user.university || 'N/A'}</td>
                        <td class="p-2">${user.academicYear}</td>
                        <td class="p-2 text-xs text-gray-600">${formattedDate}</td>
                        <td class="p-2 text-center">
                            <button class="details-db-user-btn text-indigo-600 hover:text-indigo-800 text-sm font-medium">Details</button>
                            <button class="edit-db-user-btn text-blue-600 hover:text-blue-800 text-sm ml-2">Edit</button>
                            <button class="delete-db-user-btn text-red-600 hover:text-red-800 ml-2 text-sm">Delete</button>
                        </td>
                    `;
                    detailedUserTableBody.appendChild(row);
                });
                updateDbSortIndicators();
                updateSelectAllState(detailedUserTable);
            }
            
            // --- CSV and Backup/Restore ---
            function parseCsv(text) {
                const lines = text.trim().split('\n');
                const header = lines[0].split(',').map(h => h.trim());
                const rows = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    const row = {};
                    for (let j = 0; j < header.length; j++) {
                        let value = values[j] ? values[j].trim() : '';
                        if (value.startsWith('"') && value.endsWith('"')) {
                            value = value.slice(1, -1).replace(/""/g, '"');
                        }
                        row[header[j]] = value;
                    }
                    rows.push(row);
                }
                return rows;
            }

            function handleFileUpload(file, handler) {
                if (!file) { showToast('Please select a file to upload.', 'error'); return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try { handler(e.target.result); } catch (error) { showToast(`Error processing file: ${error.message}`, 'error'); console.error(error); }
                };
                reader.readAsText(file);
            }

            function handleUserUpload(csvText) {
                const newUsers = parseCsv(csvText);
                showConfirmationModal('Upload Users?', `This will add ${newUsers.length} users and overwrite any existing users with the same handle. Continue?`, () => {
                    newUsers.forEach(newUserRow => {
                        try {
                            const handle = newUserRow.handle;
                            if (!handle) return;
                            const placements = newUserRow.placements_json ? JSON.parse(newUserRow.placements_json) : [];
                            const user = {
                                id: handle.toLowerCase(), handle,
                                fullName: newUserRow.fullName || '',
                                linkedin: newUserRow.linkedin || '',
                                university: newUserRow.university || '',
                                profilePicUrl: newUserRow.profilePicUrl || '',
                                lunaNovaScore: parseFloat(newUserRow.lunaNovaScore) || 0,
                                lunaHardScore: parseFloat(newUserRow.lunaHardScore) || 0,
                                acmLevel: parseInt(newUserRow.acmLevel, 10) || 0,
                                joinDate: newUserRow.joinDate || null,
                                universityStartDate: newUserRow.universityStartDate || null,
                                isTrusted: newUserRow.isTrusted ? newUserRow.isTrusted.toLowerCase() === 'true' : true,
                                placements: placements,
                                updatedAt: new Date()
                            };
                            saveUserAndUpdateTeams(user);
                        } catch (e) {
                            console.error(`Skipping invalid user row:`, newUserRow, e);
                        }
                    });
                    renderAll();
                    showToast(`${newUsers.length} users processed.`, 'info');
                });
            }

            function handleCompetitionUpload(csvText) {
                const newComps = parseCsv(csvText);
                let addedCount = 0;
                newComps.forEach(comp => {
                    const name = comp['Competition Name'];
                    if (name) {
                        competitionDatabase[name] = { 
                            link: comp['Link'] || '', 
                            total: parseInt(comp['Total Participants'], 10) || 0,
                            date: comp['Date (YYYY-MM)'] || null
                        };
                        addedCount++;
                    }
                });
                renderAll();
                showToast(`${addedCount} competitions added or updated.`, 'info');
            }

            function handleUniversityUpload(csvText) {
                const newUnis = csvText.trim().split('\n').map(line => line.split(',')[0].trim()).filter(Boolean);
                let addedCount = 0;
                newUnis.forEach(uni => {
                    if (!universityDatabase.includes(uni)) {
                        universityDatabase.push(uni);
                        addedCount++;
                    }
                });
                universityDatabase.sort();
                renderAll();
                showToast(`${addedCount} new universities added.`, 'info');
            }

             function handleTeamUpload(csvText) {
                const newTeams = parseCsv(csvText);
                let addedCount = 0;
                newTeams.forEach(teamRow => {
                    const name = teamRow['Team Name'];
                    const university = teamRow['University'];
                    const members = teamRow['Members'] ? teamRow['Members'].split(',').map(h => h.trim()) : [];
                    if (name && university) {
                        const existingTeam = teamDatabase.find(t => t.name.toLowerCase() === name.toLowerCase());
                        const teamData = {
                            name, university, members,
                            isActive: teamRow['Is Active'] ? teamRow['Is Active'].toLowerCase() === 'true' : true,
                            createdAt: teamRow['Created At'] || new Date().toISOString(),
                            inactiveAt: teamRow['Inactive At'] || null
                        };

                        if (existingTeam) {
                            existingTeam.university = teamData.university;
                            existingTeam.members = teamData.members;
                            existingTeam.isActive = teamData.isActive;
                            existingTeam.inactiveAt = teamData.inactiveAt;
                        } else {
                            teamData.id = crypto.randomUUID();
                            teamDatabase.push(teamData);
                        }
                        addedCount++;
                    }
                });
                renderAll();
                showToast(`${addedCount} teams added or updated.`, 'info');
            }
            
            function downloadUsersCSV(usersToDownload) {
                if (usersToDownload.length === 0) { alert("No users selected to download."); return; }
                const headers = ['handle', 'fullName', 'linkedin', 'university', 'profilePicUrl', 'lunaNovaScore', 'lunaHardScore', 'acmLevel', 'joinDate', 'universityStartDate', 'isTrusted', 'placements_json'];
                const rows = usersToDownload.map(user => {
                    const placementsStr = `"${JSON.stringify(user.placements).replace(/"/g, '""')}"`;
                    return [
                        user.handle, user.fullName, user.linkedin, user.university,
                        user.profilePicUrl || '', user.lunaNovaScore, user.lunaHardScore, user.acmLevel,
                        user.joinDate || '', user.universityStartDate || '', user.isTrusted, placementsStr
                    ].join(',');
                });
                const csvString = [headers.join(','), ...rows].join('\n');
                downloadFile(csvString, `users_export_${getFormattedDateTimeString()}.csv`, 'text/csv;charset=utf-8;');
            }

            function downloadReadinessModelCSV() {
                if (userDatabase.length === 0) { alert("No users in the database to download."); return; }
                const headers = ['handle', 'luna_nova', 'luna_hard', 'placements', 'is_trusted'];
                const rows = userDatabase.map(user => {
                    const placementsStr = `"${user.placements.map(p => {
                        if (p.total > 0) {
                            return (p.rank / p.total).toFixed(2);
                        }
                        return '0.00';
                    }).join(';')}"`;
                    return [
                        user.handle,
                        user.lunaNovaScore,
                        user.lunaHardScore,
                        placementsStr,
                        user.isTrusted
                    ].join(',');
                });
                const csvString = [headers.join(','), ...rows].join('\n');
                downloadFile(csvString, `readiness_model_input_${getFormattedDateTimeString()}.csv`, 'text/csv;charset=utf-8;');
            }
            
            function downloadDbFullBackup() {
                if (userDatabase.length === 0 && Object.keys(competitionDatabase).length === 0 && universityDatabase.length === 0) {
                    alert("No data to back up."); return;
                }
                const backupData = {
                    users: userDatabase,
                    teams: teamDatabase,
                    competitions: competitionDatabase,
                    universities: universityDatabase,
                    createdAt: new Date().toISOString()
                };
                const jsonString = JSON.stringify(backupData, null, 2);
                downloadFile(jsonString, `electi_backup_${getFormattedDateTimeString()}.json`, 'application/json');
            }

            // --- Editor Rendering ---
            function renderCurrentEditorView() {
                const activeTab = document.querySelector('.editor-tab-btn.active')?.dataset.editor;
                if (!activeTab) return;
                
                const editorViews = {
                    competitions: getCompetitionEditorHTML(),
                    universities: getUniversityEditorHTML(),
                    teams: getTeamEditorHTML()
                };
                editorContainer.innerHTML = editorViews[activeTab];
                renderEditorTable(activeTab);
                attachEditorTableEventListeners(activeTab);
            }

            function getGenericEditorHTML(type, title, headers) {
                const typeCaps = capitalize(type);
                const tableHeaders = headers.map(h => `<th class="p-3 sortable-header" data-sort-key="${h.key}">${h.label} <span class="sort-icon"></span></th>`).join('');
                const filterHeaders = headers.map(h => `<th>${h.filterable ? `<input type="text" data-filter-key="${h.key}" placeholder="Filter...">` : ''}</th>`).join('');

                return `
                    <div id="editorContent${typeCaps}" data-editor-type="${type}">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold">${title}</h2>
                        </div>
                        <div id="${type}EditorView">
                             <div class="flex flex-wrap gap-4 items-center mb-4">
                                <button id="add${typeCaps}RowBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 transition text-sm">Add New ${typeCaps.slice(0,-1)}</button>
                                <button id="deleteSelected${typeCaps}Btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 transition text-sm">Delete Selected</button>
                                <div class="flex-grow"></div>
                                <label for="upload${typeCaps}CsvEditor" class="file-input-label bg-blue-600 hover:bg-blue-700 !text-sm !py-2 !px-4">Upload CSV</label>
                                <input type="file" id="upload${typeCaps}CsvEditor" accept=".csv">
                                <button id="download${typeCaps}CsvEditor" class="bg-purple-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-purple-700 transition text-sm">Download CSV</button>
                            </div>
                            <div class="overflow-x-auto border rounded-lg">
                                <table id="${type}EditorTable" class="w-full text-sm text-left text-gray-600 editor-table">
                                    <thead class="bg-gray-100 text-xs text-gray-700 uppercase">
                                        <tr>
                                            <th class="p-2 w-10 text-center"><input type="checkbox" class="select-all-editor-checkbox"></th>
                                            ${tableHeaders}
                                        </tr>
                                        <tr>
                                            <th></th>
                                            ${filterHeaders}
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }

            function getCompetitionEditorHTML() {
                return getGenericEditorHTML('competitions', 'Competition Editor', [
                    { label: 'Competition Name', key: 'name', filterable: true },
                    { label: 'Date (YYYY-MM)', key: 'date', filterable: true },
                    { label: 'Total Participants', key: 'total', filterable: true },
                    { label: 'Link', key: 'link', filterable: false },
                    { label: 'Actions', key: 'actions', filterable: false }
                ]);
            }

            function getUniversityEditorHTML() {
                return getGenericEditorHTML('universities', 'University Editor', [
                    { label: 'University Name', key: 'name', filterable: true },
                    { label: 'Actions', key: 'actions', filterable: false }
                ]);
            }

            function getTeamEditorHTML() {
                return getGenericEditorHTML('teams', 'Team Editor', [
                    { label: 'Team Name', key: 'name', filterable: true },
                    { label: 'University', key: 'university', filterable: true },
                    { label: 'Members', key: 'members', filterable: false },
                    { label: 'Active', key: 'isActive', filterable: false },
                    { label: 'Created At', key: 'createdAt', filterable: true },
                    { label: 'Inactive At', key: 'inactiveAt', filterable: true },
                    { label: 'Actions', key: 'actions', filterable: false }
                ]);
            }

            function renderEditorTable(editorType) {
                const table = document.querySelector(`#${editorType}EditorTable`);
                if (!table) return;
                const tableBody = table.querySelector('tbody');
                if (!tableBody) return;
                tableBody.innerHTML = '';
                
                let data;
                switch (editorType) {
                    case 'competitions':
                        data = Object.entries(competitionDatabase).map(([name, d]) => ({ ...d, name }));
                        break;
                    case 'universities':
                        data = universityDatabase.map(name => ({ name }));
                        break;
                    case 'teams':
                        data = [...teamDatabase];
                        break;
                }

                // Apply filters
                const filters = editorFilters[editorType];
                const filteredData = data.filter(item => {
                    return Object.entries(filters).every(([key, value]) => {
                        let itemValue = item[key];
                        // Special handling for date filtering
                        if (key === 'createdAt' || key === 'inactiveAt') {
                            itemValue = formatMMYYYY(itemValue);
                        }
                        return String(itemValue || '').toLowerCase().includes(value.toLowerCase());
                    });
                });

                // Apply sorting
                const { key, direction } = editorSortStates[editorType];
                filteredData.sort((a, b) => {
                    const valA = a[key] || '';
                    const valB = b[key] || '';
                    if (valA < valB) return direction === 'asc' ? -1 : 1;
                    if (valA > valB) return direction === 'asc' ? 1 : -1;
                    return 0;
                });

                // Render rows
                filteredData.forEach(item => {
                    const row = tableBody.insertRow();
                    switch (editorType) {
                        case 'competitions':
                            row.dataset.id = item.name;
                            row.innerHTML = `
                                <td class="p-2 text-center"><input type="checkbox" class="editor-select-checkbox" data-id="${item.name}"></td>
                                <td class="p-2" data-key="name">${createCompetitionLink(item.name)}</td>
                                <td class="p-2" data-key="date">${item.date || ''}</td>
                                <td class="p-2" data-key="total">${item.total || ''}</td>
                                <td class="p-2" data-key="link"><a href="${item.link || '#'}" target="_blank" class="text-blue-600 hover:underline">${item.link ? 'Link' : ''}</a></td>
                                <td class="p-2 whitespace-nowrap"><button class="edit-btn text-blue-600 hover:underline">Edit</button> <button class="delete-btn text-red-600 hover:underline ml-2">Delete</button></td>`;
                            break;
                        case 'universities':
                            row.dataset.id = item.name;
                            row.innerHTML = `
                                <td class="p-2 text-center"><input type="checkbox" class="editor-select-checkbox" data-id="${item.name}"></td>
                                <td class="p-2" data-key="name">${item.name}</td>
                                <td class="p-2 whitespace-nowrap"><button class="edit-btn text-blue-600 hover:underline">Edit</button> <button class="delete-btn text-red-600 hover:underline ml-2">Delete</button></td>`;
                            break;
                        case 'teams':
                            row.dataset.id = item.id;
                            row.innerHTML = `
                                <td class="p-2 text-center"><input type="checkbox" class="editor-select-checkbox" data-id="${item.id}"></td>
                                <td class="p-2" data-key="name">${createTeamLink(item.name, item.id)}</td>
                                <td class="p-2" data-key="university">${item.university}</td>
                                <td class="p-2" data-key="members">
                                    <div class="space-y-1">${item.members.map(m => `<div>${createUserLink(m)}</div>`).join('')}</div>
                                </td>
                                <td class="p-2" data-key="isActive"><input type="checkbox" ${item.isActive ? 'checked' : ''} disabled></td>
                                <td class="p-2" data-key="createdAt">${formatMMYYYY(item.createdAt)}</td>
                                <td class="p-2" data-key="inactiveAt">${formatMMYYYY(item.inactiveAt)}</td>
                                <td class="p-2 whitespace-nowrap"><button class="edit-btn text-blue-600 hover:underline">Edit</button> <button class="delete-btn text-red-600 hover:underline ml-2">Delete</button></td>`;
                            break;
                    }
                });
                updateEditorSortIndicators(editorType);
                updateSelectAllState(table);
            }
            
            function addEditorTableRow(editorType) {
                const tableBody = document.querySelector(`#${editorType}EditorTable tbody`);
                if (!tableBody) return;
                const row = tableBody.insertRow(0);
                row.dataset.id = `new_${Date.now()}`;
                let cells = '';
                switch (editorType) {
                    case 'competitions':
                        cells = `<td></td>
                                 <td><input type="text" data-key="name" placeholder="New Competition"></td>
                                 <td><input type="month" data-key="date"></td>
                                 <td><input type="number" data-key="total" placeholder="0"></td>
                                 <td><input type="url" data-key="link" placeholder="URL"></td>`;
                        break;
                    case 'universities':
                        cells = `<td></td>
                                 <td><input type="text" data-key="name" placeholder="New University"></td>`;
                        break;
                    case 'teams':
                        const today = new Date();
                        const year = today.getFullYear();
                        const month = (today.getMonth() + 1).toString().padStart(2, '0');

                        cells = `<td></td>
                                 <td><input type="text" data-key="name" placeholder="New Team"></td>
                                 <td><input type="text" list="university-list" data-key="university" placeholder="University"></td>
                                 <td><select data-key="members" class="team-members-select" multiple="multiple" style="width: 100%;"></select></td>
                                 <td><input type="checkbox" data-key="isActive" class="is-active-checkbox" checked></td>
                                 <td><input type="month" data-key="createdAt" value="${year}-${month}"></td>
                                 <td><input type="month" data-key="inactiveAt" class="inactive-at-input" disabled></td>
                                 `;
                        break;
                }
                row.innerHTML = `${cells}<td class="p-2 whitespace-nowrap"><button class="save-btn text-green-600 hover:underline">Save</button> <button class="cancel-btn text-gray-600 hover:underline ml-2">Cancel</button></td>`;
                
                if (editorType === 'teams') {
                    const select = row.querySelector('.team-members-select');
                    userDatabase.forEach(user => {
                        $(select).append(new Option(user.handle, user.handle, false, false));
                    });
                    $(select).select2({ placeholder: "Select members" });

                    const isActiveCheckbox = row.querySelector('.is-active-checkbox');
                    const inactiveAtInput = row.querySelector('.inactive-at-input');
                    isActiveCheckbox.addEventListener('change', (e) => {
                        inactiveAtInput.disabled = e.target.checked;
                        if(e.target.checked) {
                            inactiveAtInput.value = '';
                        }
                    });
                }
            }

            function handleEditorTableEvents(e, editorType) {
                const btn = e.target;
                const row = btn.closest('tr');
                if (!row) return;
                const id = row.dataset.id;

                if (btn.classList.contains('edit-btn')) {
                    const itemData = editorType === 'teams' ? teamDatabase.find(t => t.id === id) : null;

                    row.querySelectorAll('td[data-key]').forEach(td => {
                        const key = td.dataset.key;
                        let value = td.textContent.trim();
                         if (key === 'members') {
                            const members = Array.from(td.querySelectorAll('.user-link')).map(link => link.dataset.handle);
                            td.innerHTML = `<select data-key="members" class="team-members-select" multiple="multiple" style="width: 100%;"></select>`;
                            const select = td.querySelector('.team-members-select');
                            userDatabase.forEach(user => {
                                const isSelected = members.includes(user.handle);
                                $(select).append(new Option(user.handle, user.handle, isSelected, isSelected));
                            });
                            $(select).select2({ placeholder: "Select members" }).trigger('change');
                        } else if (key === 'university') {
                            td.innerHTML = `<input type="text" list="university-list" data-key="university" value="${value}">`;
                        } else if (key === 'date') {
                             td.innerHTML = `<input type="month" data-key="date" value="${value}">`;
                        } else if (key === 'inactiveAt') {
                             td.innerHTML = `<input type="month" data-key="inactiveAt" class="inactive-at-input" value="${formatDateForInput(itemData?.inactiveAt)}" ${itemData?.isActive ? 'disabled' : ''}>`;
                        } else if (key === 'link') {
                             td.innerHTML = `<input type="url" data-key="link" value="${td.querySelector('a')?.href || ''}">`;
                        } else if (key === 'isActive') {
                            const isChecked = td.querySelector('input').checked;
                            td.innerHTML = `<input type="checkbox" data-key="isActive" class="is-active-checkbox" ${isChecked ? 'checked' : ''}>`;
                        } else if (key === 'createdAt') {
                            const team = teamDatabase.find(t => t.id === id);
                            const dateValue = team ? new Date(team.createdAt) : new Date();
                            dateValue.setDate(dateValue.getDate() + 1);
                            const year = dateValue.getUTCFullYear();
                            const month = (dateValue.getUTCMonth() + 1).toString().padStart(2, '0');
                            td.innerHTML = `<input type="month" data-key="createdAt" value="${year}-${month}">`;
                        } else {
                            td.innerHTML = `<input type="text" data-key="${key}" value="${value}">`;
                        }
                    });
                    btn.closest('td').innerHTML = `<button class="save-btn text-green-600 hover:underline">Save</button> <button class="cancel-btn text-gray-600 hover:underline ml-2">Cancel</button>`;
                    
                    if (editorType === 'teams') {
                        const isActiveCheckbox = row.querySelector('.is-active-checkbox');
                        const inactiveAtInput = row.querySelector('.inactive-at-input');
                        isActiveCheckbox.addEventListener('change', (e) => {
                            inactiveAtInput.disabled = e.target.checked;
                            if(e.target.checked) {
                                inactiveAtInput.value = '';
                            }
                        });
                    }

                } else if (btn.classList.contains('cancel-btn')) {
                    if (id.startsWith('new_')) {
                        row.remove();
                    } else {
                        renderEditorTable(editorType); // Just re-render to cancel edits
                    }
                } else if (btn.classList.contains('delete-btn')) {
                    showConfirmationModal(`Delete ${capitalize(editorType.slice(0, -1))}?`, `Are you sure you want to delete this entry? This cannot be undone.`, () => {
                        switch (editorType) {
                            case 'competitions': delete competitionDatabase[id]; break;
                            case 'universities': universityDatabase = universityDatabase.filter(name => name !== id); break;
                            case 'teams': teamDatabase = teamDatabase.filter(t => t.id !== id); break;
                        }
                        renderAll();
                    });
                } else if (btn.classList.contains('save-btn')) {
                    const data = {};
                    let newId;
                    let isValid = true;
                    
                    row.querySelectorAll('input[data-key], select[data-key]').forEach(input => {
                        const key = input.dataset.key;
                        const value = input.type === 'checkbox' ? input.checked : (input.value || '').trim();
                         if (key === 'name' && !value) {
                            isValid = false;
                            alert("Name cannot be empty.");
                        }
                        if (key === 'name') newId = value;

                        if (key === 'members') {
                            data[key] = $(input).val();
                        } else {
                            data[key] = value;
                        }
                    });

                    if (!isValid) return;

                    switch (editorType) {
                        case 'competitions':
                            if (id !== newId) delete competitionDatabase[id];
                            competitionDatabase[newId] = { date: data.date, total: parseInt(data.total, 10) || 0, link: data.link };
                            break;
                        case 'universities':
                            if (id.startsWith('new_')) {
                                if (!universityDatabase.includes(newId)) universityDatabase.push(newId);
                            } else {
                                const index = universityDatabase.indexOf(id);
                                if (index > -1) universityDatabase[index] = newId;
                            }
                            universityDatabase.sort();
                            break;
                        case 'teams':
                            const universityName = data.university;
                            if (universityName && !universityDatabase.includes(universityName)) {
                                universityDatabase.push(universityName);
                                universityDatabase.sort();
                            }
                            
                            const createdAtDate = data.createdAt ? new Date(data.createdAt).toISOString() : new Date().toISOString();
                            let inactiveAtDate = data.inactiveAt ? new Date(data.inactiveAt).toISOString() : null;

                            if (data.isActive) {
                                inactiveAtDate = null; // Force inactive date to null if team is active
                            }

                            if (inactiveAtDate && new Date(inactiveAtDate) < new Date(createdAtDate)) {
                                showToast('Inactive date cannot be before the created date.', 'error');
                                return;
                            }

                            const teamIndex = teamDatabase.findIndex(t => t.id === id);
                            const teamData = {
                                name: data.name,
                                university: data.university,
                                members: data.members || [],
                                isActive: data.isActive,
                                createdAt: createdAtDate,
                                inactiveAt: inactiveAtDate
                            };

                            if (teamIndex > -1) {
                                teamDatabase[teamIndex] = { ...teamDatabase[teamIndex], ...teamData };
                            } else {
                                teamData.id = crypto.randomUUID();
                                teamDatabase.push(teamData);
                            }
                            break;
                    }
                    renderAll();
                }
            }

            function downloadEditorCSV(editorType) {
                let csvContent = "data:text/csv;charset=utf-8,";
                let rows = [];
                switch (editorType) {
                    case 'competitions':
                        rows.push(['Competition Name', 'Date (YYYY-MM)', 'Total Participants', 'Link']);
                        Object.entries(competitionDatabase).forEach(([name, data]) => {
                            rows.push([name, data.date, data.total, data.link]);
                        });
                        break;
                    case 'universities':
                        rows.push(['University Name']);
                        universityDatabase.forEach(name => rows.push([name]));
                        break;
                    case 'teams':
                        rows.push(['Team Name', 'University', 'Members', 'Is Active', 'Created At', 'Inactive At']);
                        teamDatabase.forEach(team => {
                            rows.push([`"${team.name}"`, `"${team.university}"`, `"${team.members.join(',')}"`, team.isActive, new Date(team.createdAt).toISOString(), team.inactiveAt ? new Date(team.inactiveAt).toISOString() : '']);
                        });
                        break;
                }
                const csvString = rows.map(e => e.map(cell => typeof cell === 'string' && cell.includes(',') ? `"${cell}"` : cell).join(",")).join("\n");
                downloadFile(csvString, `${editorType}_export_${getFormattedDateTimeString()}.csv`, 'text/csv;charset=utf-8;')
            }

            function handleDeleteSelected(editorType) {
                const table = document.getElementById(`${editorType}EditorTable`);
                const selectedCheckboxes = table.querySelectorAll('.editor-select-checkbox:checked');
                if (selectedCheckboxes.length === 0) {
                    showToast('No items selected to delete.', 'error');
                    return;
                }

                const idsToDelete = Array.from(selectedCheckboxes).map(cb => cb.dataset.id);

                showConfirmationModal(`Delete ${selectedCheckboxes.length} items?`, 'This action is permanent and cannot be undone.', () => {
                    let deletedCount = 0;
                    switch (editorType) {
                        case 'competitions':
                            idsToDelete.forEach(id => { if(competitionDatabase[id]) { delete competitionDatabase[id]; deletedCount++; } });
                            break;
                        case 'universities':
                            const initialLengthUni = universityDatabase.length;
                            universityDatabase = universityDatabase.filter(name => !idsToDelete.includes(name));
                            deletedCount = initialLengthUni - universityDatabase.length;
                            break;
                        case 'teams':
                            const initialLengthTeam = teamDatabase.length;
                            teamDatabase = teamDatabase.filter(t => !idsToDelete.includes(t.id));
                            deletedCount = initialLengthTeam - teamDatabase.length;
                            break;
                    }
                    showToast(`${deletedCount} items deleted.`, 'info');
                    renderAll();
                });
            }

            function attachEditorTableEventListeners(editorType) {
                const editorContentDiv = document.querySelector(`[data-editor-type="${editorType}"]`);
                if(!editorContentDiv) return;

                editorContentDiv.addEventListener('click', e => {
                    const targetId = e.target.id;
                    const editorTable = editorContentDiv.querySelector('.editor-table');

                    if (targetId === `add${capitalize(editorType)}RowBtn`) {
                        addEditorTableRow(editorType);
                    } else if (targetId === `deleteSelected${capitalize(editorType)}Btn`) {
                        handleDeleteSelected(editorType);
                    } else if (targetId === `download${capitalize(editorType)}CsvEditor`) {
                        downloadEditorCSV(editorType);
                    } else if (e.target.closest('.sortable-header')) {
                        const header = e.target.closest('.sortable-header');
                        const key = header.dataset.sortKey;
                        let direction = 'desc';
                        if (editorSortStates[editorType].key === key) {
                            direction = editorSortStates[editorType].direction === 'desc' ? 'asc' : 'desc';
                        }
                        editorSortStates[editorType] = { key, direction };
                        renderEditorTable(editorType);
                    } else if (e.target.matches('.save-btn, .cancel-btn, .edit-btn, .delete-btn')) {
                        handleEditorTableEvents(e, editorType);
                    }
                });
                
                editorContentDiv.addEventListener('change', e => {
                    const target = e.target;
                    const editorTable = editorContentDiv.querySelector('.editor-table');
                    if (target.matches('.select-all-editor-checkbox')) {
                        editorTable.querySelectorAll('tbody .editor-select-checkbox').forEach(cb => {
                            cb.checked = target.checked;
                        });
                    } else if(target.matches('.editor-select-checkbox')) {
                        updateSelectAllState(editorTable);
                    } else if (target.id === `upload${capitalize(editorType)}CsvEditor`) {
                         const handlers = { competitions: handleCompetitionUpload, universities: handleUniversityUpload, teams: handleTeamUpload };
                         handleFileUpload(target.files[0], handlers[editorType]); 
                         target.value = ''; // Reset file input
                    }
                });

                editorContentDiv.addEventListener('keyup', e => {
                    if (e.target.matches('input[data-filter-key]')) {
                        editorFilters[editorType][e.target.dataset.filterKey] = e.target.value;
                        renderEditorTable(editorType);
                    }
                });
            }

            function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

            // --- Datalist Updaters ---
            function updateCompetitionDatalist() {
                competitionDataList.innerHTML = '';
                Object.keys(competitionDatabase).sort().forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    competitionDataList.appendChild(option);
                });
            }

            // MODIFIED FUNCTION: This function now filters teams based on the contest date.
            function updateTeamSelectForEntry(placementEntryDiv) {
                const select = placementEntryDiv.querySelector('.team-name-select');
                if (!select) return;
                
                const currentVal = select.value;
                const currentUserHandle = handleField.value.toLowerCase();
                const contestDateInput = placementEntryDiv.querySelector('.comp-date-input');
                const contestDateStr = contestDateInput.value; // YYYY-MM

                if (!currentUserHandle) {
                    select.innerHTML = '<option value="">Enter user handle first</option>';
                    select.disabled = true;
                    return;
                }

                if (!contestDateStr) {
                    select.innerHTML = '<option value="">Select contest date first</option>';
                    select.disabled = true;
                    return;
                }

                // Use the last day of the month for accurate comparison
                const contestDate = new Date(contestDateStr);
                contestDate.setMonth(contestDate.getMonth() + 1, 0); 
                contestDate.setHours(23, 59, 59, 999); // Set to end of the day to be inclusive

                const userTeams = teamDatabase.filter(t => {
                    const isMember = t.members.map(m => m.toLowerCase()).includes(currentUserHandle);
                    if (!isMember) return false;

                    const teamCreatedAt = new Date(t.createdAt);
                    if (teamCreatedAt > contestDate) return false; // Team created after contest

                    const teamInactiveAt = t.inactiveAt ? new Date(t.inactiveAt) : null;
                    // If team is inactive, the inactive date must be AFTER the contest date
                    if (teamInactiveAt && teamInactiveAt < contestDate) {
                        return false;
                    }

                    return true;
                });
                
                if (userTeams.length === 0) {
                     select.innerHTML = '<option value="">No active teams for this date</option>';
                     select.disabled = true;
                     return;
                }

                select.disabled = false;
                select.innerHTML = '<option value="">Select a team...</option>';
                userTeams.sort((a,b) => a.name.localeCompare(b.name)).forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.id;
                    const createdAtStr = formatMMYYYY(team.createdAt);
                    const inactiveAtStr = team.inactiveAt ? ` - ${formatMMYYYY(team.inactiveAt)}` : '';
                    option.textContent = `${team.name} (Active: ${createdAtStr}${inactiveAtStr})`;
                    option.title = `${team.name} (Created: ${createdAtStr})\nMembers: ${team.members.join(', ')}`;
                    select.appendChild(option);
                });
                select.value = currentVal;
            }

            function populateUniversityDatalist(selectedValue = '') {
                const allUnis = new Set(universityDatabase);
                userDatabase.forEach(u => { if(u.university) allUnis.add(u.university) });
                teamDatabase.forEach(t => { if(t.university) allUnis.add(t.university) });
                universityDatabase = Array.from(allUnis).sort();

                universityDataList.innerHTML = '';
                universityDatabase.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    universityDataList.appendChild(option);
                });
                universityInput.value = selectedValue;
            }

            // --- STATISTICS LOGIC ---
            function updateAndRenderStatistics() {
                const totalUsers = userDatabase.length;
                const totalUniversities = universityDatabase.length;
                const totalTeams = teamDatabase.length;
                const totalUniqueCompetitions = Object.keys(competitionDatabase).length;

                statsContainer.innerHTML = `
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <p class="text-3xl font-bold text-blue-600">${totalUsers}</p>
                        <p class="text-sm text-gray-600">Total Users</p>
                    </div>
                    <div class="p-4 bg-indigo-50 rounded-lg">
                        <p class="text-3xl font-bold text-indigo-600">${totalUniversities}</p>
                        <p class="text-sm text-gray-600">Universities</p>
                    </div>
                    <div class="p-4 bg-teal-50 rounded-lg">
                        <p class="text-3xl font-bold text-teal-600">${totalTeams}</p>
                        <p class="text-sm text-gray-600">Total Teams</p>
                    </div>
                    <div class="p-4 bg-green-50 rounded-lg">
                        <p class="text-3xl font-bold text-green-600">${totalUniqueCompetitions}</p>
                        <p class="text-sm text-gray-600">Unique Competitions</p>
                    </div>
                `;

                if (totalUsers === 0) {
                    destroyChart('acmLevelChart');
                    destroyChart('competitionChart');
                    return;
                }
                
                // ACM Level Chart
                const levelMap = { '0': 'None', '-1': 'Codeability', '10': 'Level 0', '1': 'Level 1', '2': 'Level 2'};
                const acmLevels = { '0': 0, '-1': 0, '10': 0, '1': 0, '2': 0 };
                userDatabase.forEach(u => { if (acmLevels.hasOwnProperty(u.acmLevel)) acmLevels[u.acmLevel]++; });
                const acmData = { labels: ['None', 'Codeability', 'Level 0', 'Level 1', 'Level 2'], datasets: [{ data: [acmLevels['0'], acmLevels['-1'], acmLevels['10'], acmLevels['1'], acmLevels['2']], backgroundColor: ['#6b7280', '#a1a1aa', '#10b981', '#f59e0b', '#ef4444'], }] };
                renderChart('acmLevelChart', 'pie', acmData, { 
                    responsive: true, 
                    plugins: { 
                        legend: { position: 'top' }, 
                        title: { display: true, text: 'ACM Level Breakdown' } 
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const chart = charts['acmLevelChart'];
                            const index = elements[0].index;
                            const label = chart.data.labels[index];
                            const levelKey = Object.keys(levelMap).find(key => levelMap[key] === label);
                            const users = userDatabase.filter(u => String(u.acmLevel) === levelKey);
                            showListInModal(`Users in ACM Level: ${label}`, users.map(u => createUserLink(u.handle)));
                        }
                    }
                });

                // Competition Chart
                const compCounts = userDatabase.flatMap(u => u.placements.map(p => p.name)).reduce((acc, name) => { acc[name] = (acc[name] || 0) + 1; return acc; }, {});
                const sortedCompCounts = Object.entries(compCounts).sort(([,a],[,b]) => b-a).slice(0, 10);
                const compData = { labels: sortedCompCounts.map(([name]) => name), datasets: [{ label: 'Participants', data: sortedCompCounts.map(([,count]) => count), backgroundColor: ['#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#ef4444', '#6b7280', '#ec4899', '#6366f1', '#f97316', '#06b6d4'], }] };
                renderChart('competitionChart', 'doughnut', compData, { 
                    responsive: true, 
                    plugins: { 
                        legend: { position: 'top' }, 
                        title: { display: true, text: 'Top 10 Competitions by Participants' } 
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const chart = charts['competitionChart'];
                            const index = elements[0].index;
                            const compName = chart.data.labels[index];
                            const users = userDatabase.filter(u => u.placements.some(p => p.name === compName));
                            showListInModal(`Participants in: ${compName}`, users.map(u => createUserLink(u.handle)));
                        }
                    }
                });
            }

            // --- ADVANCED ANALYTICS ---
            function renderAdvancedStats() {
                const activeView = document.querySelector('#analyticsSubTabs .active')?.dataset.analyticsView || 'global';
                
                const renderFunctions = {
                    individuals: renderIndividualAnalytics,
                    teams: renderTeamAnalytics,
                    universities: renderUniversityAnalytics,
                    competitions: renderCompetitionAnalytics,
                    global: renderGlobalAnalytics,
                };

                if (renderFunctions[activeView]) {
                    renderFunctions[activeView]();
                }
            }

            function renderIndividualAnalytics() {
                let html = `<div class="mb-4">
                                <label for="individualAnalyticsSelect" class="text-sm font-medium">Select User:</label>
                                <select id="individualAnalyticsSelect" class="w-full md:w-1/3 p-2 border rounded-md mt-1 bg-white">
                                    <option value="">-- Select a User --</option>
                                    ${userDatabase.map(u => u.handle).sort().map(h => `<option value="${h}">${h}</option>`).join('')}
                                </select>
                            </div>
                            <div id="individualAnalyticsContent"></div>`;
                advancedStatsContainer.innerHTML = html;
                const selector = document.getElementById('individualAnalyticsSelect');
                selector.addEventListener('change', (e) => renderIndividualAnalyticsContent(e.target.value));
                renderIndividualAnalyticsContent(selector.value);
            }

            function renderIndividualAnalyticsContent(handle) {
                const contentEl = document.getElementById('individualAnalyticsContent');
                if (!handle) {
                    contentEl.innerHTML = `<div class="text-center p-8 bg-gray-50 rounded-lg"><p class="text-gray-500">Select a user to see their detailed analytics.</p></div>`;
                    return;
                }

                const user = userDatabase.find(u => u.handle === handle);
                if (!user) {
                    contentEl.innerHTML = `<div class="text-center p-8 bg-red-50 rounded-lg"><p class="text-red-600">User not found.</p></div>`;
                    return;
                }

                const placements = user.placements.map(p => ({
                    ...p,
                    percentile: (p.rank / p.total) * 100,
                    date: competitionDatabase[p.name]?.date
                })).filter(p => p.date).sort((a, b) => new Date(a.date) - new Date(b.date));

                const bestPlacement = placements.length > 0 ? Math.min(...placements.map(p => p.percentile)) : null;
                const totalCompetitions = user.placements.length;
                const soloCompetitions = user.placements.filter(p => !p.teamId).length;
                const teamCompetitions = totalCompetitions - soloCompetitions;

                let html = `
                    <div class="stat-card p-6 mb-8">
                        <h3 class="font-bold text-2xl text-green-700 mb-4">Performance Summary: ${createUserLink(user.handle)}</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div class="p-4 bg-gray-100 rounded-lg">
                                <p class="text-3xl font-bold">${totalCompetitions}</p>
                                <p class="text-sm text-gray-600">Total Competitions</p>
                            </div>
                            <div class="p-4 bg-gray-100 rounded-lg">
                                <p class="text-3xl font-bold">${bestPlacement !== null ? `Top ${bestPlacement.toFixed(1)}%` : 'N/A'}</p>
                                <p class="text-sm text-gray-600">Best Placement</p>
                            </div>
                            <div class="p-4 bg-gray-100 rounded-lg">
                                <p class="text-3xl font-bold">${soloCompetitions}</p>
                                <p class="text-sm text-gray-600">Solo Contests</p>
                            </div>
                            <div class="p-4 bg-gray-100 rounded-lg">
                                <p class="text-3xl font-bold">${teamCompetitions}</p>
                                <p class="text-sm text-gray-600">Team Contests</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-3">Placement Progression Over Time</h3>
                        <p class="text-xs text-gray-500 mb-3">Lower percentile is better.</p>
                        <div class="p-4 bg-white rounded-lg shadow-inner">
                            ${placements.length > 0 ? '<canvas id="individualProgressionChart"></canvas>' : '<p class="text-center text-gray-500 py-4">No dated placements available to show progression.</p>'}
                        </div>
                    </div>
                `;
                contentEl.innerHTML = html;

                if (placements.length > 0) {
                    renderChart('individualProgressionChart', 'line', {
                        labels: placements.map(p => p.date),
                        datasets: [{
                            label: 'Placement Percentile',
                            data: placements.map(p => p.percentile),
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: true,
                            tension: 0.1
                        }]
                    }, {
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: 'month' },
                                title: { display: true, text: 'Date' }
                            },
                            y: {
                                reverse: true, // Lower is better
                                beginAtZero: true,
                                title: { display: true, text: 'Placement Percentile (%)' }
                            }
                        },
                        plugins: { tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Top ${context.parsed.y.toFixed(2)}% in ${placements[context.dataIndex].name}`;
                                }
                            }
                        } }
                    });
                }
            }
            
            function renderTeamAnalytics() {
                let html = `<div class="mb-4">
                                <label for="teamAnalyticsSelect" class="text-sm font-medium">Select Team:</label>
                                <select id="teamAnalyticsSelect" class="w-full md:w-1/3 p-2 border rounded-md mt-1 bg-white">
                                    <option value="">-- Select a Team --</option>
                                    ${teamDatabase.map(t => t.name).sort().map(name => `<option value="${name}">${name}</option>`).join('')}
                                </select>
                            </div>
                            <div id="teamAnalyticsContent"></div>`;
                advancedStatsContainer.innerHTML = html;
                const selector = document.getElementById('teamAnalyticsSelect');
                selector.addEventListener('change', (e) => renderTeamAnalyticsContent(e.target.value));
                renderTeamAnalyticsContent(selector.value);
            }

            function renderTeamAnalyticsContent(teamName) {
                const contentEl = document.getElementById('teamAnalyticsContent');
                if (!teamName) {
                    contentEl.innerHTML = `<div class="text-center p-8 bg-gray-50 rounded-lg"><p class="text-gray-500">Select a team to see its detailed analytics.</p></div>`;
                    return;
                }

                const team = teamDatabase.find(t => t.name === teamName);
                if (!team) {
                    contentEl.innerHTML = `<div class="text-center p-8 bg-red-50 rounded-lg"><p class="text-red-600">Team not found.</p></div>`;
                    return;
                }

                // Find all placements for this team
                const teamPlacements = userDatabase
                    .flatMap(u => u.placements.filter(p => p.teamId === team.id))
                    .reduce((acc, p) => { // Deduplicate placements
                        if (!acc.some(ap => ap.name === p.name)) {
                            acc.push(p);
                        }
                        return acc;
                    }, [])
                    .map(p => ({
                        ...p,
                        percentile: (p.rank / p.total) * 100,
                        date: competitionDatabase[p.name]?.date
                    }))
                    .filter(p => p.date)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));

                const bestPlacement = teamPlacements.length > 0 ? Math.min(...teamPlacements.map(p => p.percentile)) : null;
                const totalCompetitions = teamPlacements.length;

                let html = `
                    <div class="stat-card p-6 mb-8">
                        <h3 class="font-bold text-2xl text-teal-700 mb-2">Performance Summary: ${createTeamLink(team.name, team.id)}</h3>
                        <div class="text-sm text-gray-600 mb-4">
                            <h4 class="font-semibold text-gray-700 mb-1">Members:</h4>
                            <div class="pl-2 space-y-1">
                                ${team.members.map(m => `<div>${createUserLink(m)}</div>`).join('')}
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div class="p-4 bg-gray-100 rounded-lg">
                                <p class="text-3xl font-bold">${totalCompetitions}</p>
                                <p class="text-sm text-gray-600">Total Competitions</p>
                            </div>
                            <div class="p-4 bg-gray-100 rounded-lg">
                                <p class="text-3xl font-bold">${bestPlacement !== null ? `Top ${bestPlacement.toFixed(1)}%` : 'N/A'}</p>
                                <p class="text-sm text-gray-600">Best Placement</p>
                            </div>
                             <div class="p-4 bg-gray-100 rounded-lg">
                                <p class="text-3xl font-bold">${team.members.length}</p>
                                <p class="text-sm text-gray-600">Members</p>
                            </div>
                             <div class="p-4 bg-gray-100 rounded-lg">
                                <p class="text-lg font-bold">${team.university}</p>
                                <p class="text-sm text-gray-600">University</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-3">Placement Progression Over Time</h3>
                        <p class="text-xs text-gray-500 mb-3">Lower percentile is better.</p>
                        <div class="p-4 bg-white rounded-lg shadow-inner">
                            ${teamPlacements.length > 0 ? '<canvas id="teamProgressionChart"></canvas>' : '<p class="text-center text-gray-500 py-4">No dated placements available to show progression.</p>'}
                        </div>
                    </div>
                `;
                contentEl.innerHTML = html;

                if (teamPlacements.length > 0) {
                    renderChart('teamProgressionChart', 'line', {
                        labels: teamPlacements.map(p => p.date),
                        datasets: [{
                            label: 'Placement Percentile',
                            data: teamPlacements.map(p => p.percentile),
                            borderColor: '#0d9488',
                            backgroundColor: 'rgba(13, 148, 136, 0.1)',
                            fill: true,
                            tension: 0.1
                        }]
                    }, {
                        scales: {
                            x: { type: 'time', time: { unit: 'month' }, title: { display: true, text: 'Date' } },
                            y: { reverse: true, beginAtZero: true, title: { display: true, text: 'Placement Percentile (%)' } }
                        },
                        plugins: { tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Top ${context.parsed.y.toFixed(2)}% in ${teamPlacements[context.dataIndex].name}`;
                                }
                            }
                        } }
                    });
                }
            }

            function renderUniversityAnalytics() {
                 let html = `<div class="mb-4">
                                <label for="universityAnalyticsSelect" class="text-sm font-medium">Select University:</label>
                                <select id="universityAnalyticsSelect" class="w-full md:w-1/3 p-2 border rounded-md mt-1 bg-white">
                                    <option value="">-- All Universities --</option>
                                    ${universityDatabase.map(u => `<option value="${u}">${u}</option>`).join('')}
                                </select>
                            </div>
                            <div id="universityAnalyticsContent"></div>`;
                advancedStatsContainer.innerHTML = html;
                const selector = document.getElementById('universityAnalyticsSelect');
                selector.addEventListener('change', (e) => {
                    renderUniversityAnalyticsContent(e.target.value);
                });
                renderUniversityAnalyticsContent(selector.value);
            }

            function renderUniversityAnalyticsContent(uniName) {
                const contentEl = document.getElementById('universityAnalyticsContent');
                if (!uniName) {
                    contentEl.innerHTML = `<div class="text-center p-8 bg-gray-50 rounded-lg">
                        <h3 class="text-xl font-bold">University Breakdown</h3>
                        <p class="text-gray-500">Select a university to see a detailed breakdown.</p>
                    </div>`;
                    return;
                }

                const students = userDatabase.filter(u => u.university === uniName);
                const allTeams = teamDatabase.filter(t => t.university === uniName);
                const activeTeams = allTeams.filter(t => t.isActive);
                
                const allPlacements = students.flatMap(s =>
                    s.placements.map(p => ({
                        ...p,
                        handle: s.handle,
                        percentile: (p.rank / p.total) * 100
                    }))
                );

                const topTeamPlacements = Object.values(allPlacements
                    .filter(p => p.teamId)
                    .reduce((acc, p) => {
                        const key = `${p.teamId}-${p.name}`;
                        if (!acc[key] || p.percentile < acc[key].percentile) {
                             const team = teamDatabase.find(t => t.id === p.teamId);
                             if(team){
                                acc[key] = { ...p, teamName: team.name };
                             }
                        }
                        return acc;
                    }, {}))
                    .sort((a, b) => a.percentile - b.percentile)
                    .slice(0, 5);

                const topStudentPlacements = allPlacements
                    .filter(p => !p.teamId)
                    .sort((a, b) => a.percentile - b.percentile)
                    .slice(0, 5);
                
                let html = `
                    <div class="stat-card p-6">
                        <h3 class="font-bold text-2xl text-indigo-700 mb-4">${uniName}</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-8">
                            <div class="p-4 bg-gray-100 rounded-lg"><p class="text-3xl font-bold">${students.length}</p><p class="text-sm text-gray-600">Total Students</p></div>
                            <div class="p-4 bg-gray-100 rounded-lg"><p class="text-3xl font-bold">${activeTeams.length}</p><p class="text-sm text-gray-600">Active Teams</p></div>
                            <div class="p-4 bg-gray-100 rounded-lg"><p class="text-3xl font-bold">${allTeams.length}</p><p class="text-sm text-gray-600">All Teams</p></div>
                        </div>

                        <div class="grid grid-cols-1 gap-8 mb-8">
                            <div id="universityGrowthContainer"></div>
                            <div id="universityActiveTeamsContainer"></div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                            <div>
                                <h4 class="text-xl font-semibold mb-3">Students by Academic Year</h4>
                                <div class="p-4 bg-white rounded-lg shadow-inner h-64 flex items-center justify-center">
                                    <canvas id="studentsByYearChart"></canvas>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-xl font-semibold mb-3">Top 5 Student Placements</h4>
                                <div class="space-y-2">
                                    ${topStudentPlacements.length > 0 ? topStudentPlacements.map(p => `
                                        <div class="p-3 bg-green-50 rounded text-sm border border-green-200">
                                            <div class="font-bold text-green-800">Top ${p.percentile.toFixed(1)}%</div>
                                            <div class="text-green-700">${createUserLink(p.handle)} in ${createCompetitionLink(p.name)}</div>
                                            <div class="text-xs text-green-600">Rank ${p.rank} / ${p.total}</div>
                                        </div>
                                    `).join('') : '<p class="text-gray-500 text-sm p-2 bg-gray-50 rounded">No solo placements recorded.</p>'}
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <div>
                                <h4 class="text-xl font-semibold mb-3">Students (${students.length})</h4>
                                <input type="text" id="studentSearchInput" placeholder="Search students by name or handle..." class="w-full p-2 border rounded-md mb-2 bg-gray-50">
                                <div id="studentListContainer" class="space-y-2 max-h-96 overflow-y-auto pr-2 border rounded-lg p-2 bg-white">
                                    ${students.length > 0 ? students.sort((a,b) => a.handle.localeCompare(b.handle)).map(s => `<div class="p-2 bg-gray-50 rounded text-sm" data-handle="${s.handle}" data-name="${s.fullName || ''}">${createUserLink(s.handle)}</div>`).join('') : '<p class="text-gray-500 text-sm p-2">No students.</p>'}
                                </div>
                            </div>
                            <div>
                                <h4 class="text-xl font-semibold mb-3">Teams (${allTeams.length})</h4>
                                <input type="text" id="teamSearchInput" placeholder="Search teams by name or members..." class="w-full p-2 border rounded-md mb-2 bg-gray-50">
                                <div id="teamListContainer" class="space-y-2 max-h-96 overflow-y-auto pr-2 border rounded-lg p-2 bg-white">
                                    ${allTeams.length > 0 ? allTeams.sort((a,b) => a.name.localeCompare(b.name)).map(t => `<div class="p-2 ${t.isActive ? 'bg-gray-50' : 'bg-gray-100'} rounded text-sm" data-team-id="${t.id}">${createTeamLink(t.name, t.id)} ${!t.isActive ? '<span class="text-xs text-red-600">(Inactive)</span>' : ''}</div>`).join('') : '<p class="text-gray-500 text-sm p-2">No teams.</p>'}
                                </div>
                            </div>
                             <div>
                                <h4 class="text-xl font-semibold mb-3">Top 5 Team Placements</h4>
                                <div class="space-y-2">
                                    ${topTeamPlacements.length > 0 ? topTeamPlacements.map(p => `
                                        <div class="p-3 bg-teal-50 rounded text-sm border border-teal-200">
                                            <div class="font-bold text-teal-800">Top ${p.percentile.toFixed(1)}%</div>
                                            <div class="text-teal-700">${createTeamLink(p.teamName, p.teamId)} in ${createCompetitionLink(p.name)}</div>
                                            <div class="text-xs text-teal-600">Rank ${p.rank} / ${p.total}</div>
                                        </div>
                                    `).join('') : '<p class="text-gray-500 text-sm p-2 bg-gray-50 rounded">No team placements recorded.</p>'}
                                </div>
                            </div>
                        </div>
                    </div>`;
                contentEl.innerHTML = html;
                renderUniversityGrowthChart(uniName);
                renderUniversityActiveTeamsChart(uniName);
                renderStudentsByYearChart(uniName);

                // Add search event listeners
                document.getElementById('studentSearchInput').addEventListener('keyup', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    document.querySelectorAll('#studentListContainer > div').forEach(div => {
                        const handle = div.dataset.handle.toLowerCase();
                        const name = div.dataset.name.toLowerCase();
                        div.style.display = (handle.includes(searchTerm) || name.includes(searchTerm)) ? '' : 'none';
                    });
                });
                document.getElementById('teamSearchInput').addEventListener('keyup', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    document.querySelectorAll('#teamListContainer > div').forEach(div => {
                        const teamId = div.dataset.teamId;
                        const team = teamDatabase.find(t => t.id === teamId);
                        if (!team) return;

                        const teamName = team.name.toLowerCase();
                        const memberHandles = team.members.map(m => m.toLowerCase());
                        const memberNames = team.members.map(handle => {
                            const user = userDatabase.find(u => u.handle.toLowerCase() === handle);
                            return user ? user.fullName.toLowerCase() : '';
                        });

                        const isMatch = teamName.includes(searchTerm) || 
                                      memberHandles.some(h => h.includes(searchTerm)) || 
                                      memberNames.some(n => n.includes(searchTerm));

                        div.style.display = isMatch ? '' : 'none';
                    });
                });
            }

            function renderUniversityGrowthChart(uniName) {
                const container = document.getElementById('universityGrowthContainer');
                container.innerHTML = `
                    <div class="flex flex-wrap items-center justify-between mb-3 gap-y-2">
                        <h4 class="text-xl font-semibold">Cumulative User Growth</h4>
                        <div class="flex flex-wrap items-end gap-2">
                             <div>
                                <label for="uniGrowthStartDate" class="text-xs font-medium">Start Date</label>
                                <input type="month" id="uniGrowthStartDate" class="p-1.5 border rounded-md bg-white text-sm">
                            </div>
                            <div>
                                <label for="uniGrowthEndDate" class="text-xs font-medium">End Date</label>
                                <input type="month" id="uniGrowthEndDate" class="p-1.5 border rounded-md bg-white text-sm">
                            </div>
                            <button id="renderUniGrowthBtn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 text-sm">Update</button>
                        </div>
                    </div>
                    <div class="p-4 bg-white rounded-lg shadow-inner">
                        <canvas id="universityGrowthChart"></canvas>
                    </div>
                `;

                const updateButton = document.getElementById('renderUniGrowthBtn');
                updateButton.addEventListener('click', () => {
                    const startDate = document.getElementById('uniGrowthStartDate').value;
                    const endDate = document.getElementById('uniGrowthEndDate').value;
                    if (startDate && endDate && startDate > endDate) {
                        showToast('Start date cannot be after end date.', 'error');
                        return;
                    }
                    drawUniversityGrowthChart(uniName, startDate, endDate);
                });

                drawUniversityGrowthChart(uniName); // Initial draw
            }

            function showUsersUpToMonth(uniName, month) {
                const users = userDatabase.filter(u => u.university === uniName && u.joinDate && u.joinDate.slice(0, 7) <= month)
                                        .sort((a,b) => a.handle.localeCompare(b.handle));
                
                let content = `
                    <h2 class="text-2xl font-bold text-indigo-800 mb-2">Users in ${uniName}</h2>
                    <p class="text-lg text-gray-600 mb-4">Joined on or before ${formatMonthYear(month + '-02')}</p>
                    <hr class="my-4">
                    <div class="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                        ${users.length > 0 ? users.map(u => `
                            <div class="p-2 bg-gray-50 rounded text-sm">${createUserLink(u.handle)}</div>
                        `).join('') : '<p class="text-gray-500">No users found for this period.</p>'}
                    </div>
                `;
                modalContentContainer.innerHTML = content;
                detailsModal.classList.remove('hidden');
            }

            function drawUniversityGrowthChart(uniName, startDate = null, endDate = null) {
                let students = userDatabase.filter(u => u.university === uniName && u.joinDate);
                if (students.length === 0) {
                    destroyChart('universityGrowthChart');
                    return;
                }

                students.sort((a,b) => new Date(a.joinDate) - new Date(b.joinDate));

                const firstMonth = students[0].joinDate.slice(0, 7);
                const lastMonth = students[students.length - 1].joinDate.slice(0, 7);

                const effectiveStartDate = startDate || firstMonth;
                const effectiveEndDate = endDate || lastMonth;

                // Calculate initial count before the start date
                let cumulativeTotal = 0;
                students.forEach(u => {
                    if (u.joinDate.slice(0, 7) < effectiveStartDate) {
                        cumulativeTotal++;
                    }
                });

                const joinCounts = {};
                students.forEach(u => {
                    const month = u.joinDate.slice(0, 7);
                    if (month >= effectiveStartDate && month <= effectiveEndDate) {
                         joinCounts[month] = (joinCounts[month] || 0) + 1;
                    }
                });

                const labels = [];
                const dataPoints = [];
                let current = new Date(effectiveStartDate + '-02'); // Use day 2 to avoid timezone issues
                const end = new Date(effectiveEndDate + '-02');

                while(current <= end) {
                    const monthStr = current.getFullYear() + '-' + (current.getMonth() + 1).toString().padStart(2, '0');
                    labels.push(monthStr);
                    cumulativeTotal += (joinCounts[monthStr] || 0);
                    dataPoints.push(cumulativeTotal);
                    current.setMonth(current.getMonth() + 1);
                }

                renderChart('universityGrowthChart', 'line', {
                    labels: labels,
                    datasets: [{
                        label: 'Cumulative Users',
                        data: dataPoints,
                        borderColor: '#4338ca',
                        backgroundColor: 'rgba(67, 56, 202, 0.1)',
                        fill: true,
                        tension: 0.1,
                        stepped: true,
                    }]
                }, { 
                    scales: { y: { beginAtZero: false, ticks: { stepSize: 1 } } },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const chart = charts['universityGrowthChart'];
                            const index = elements[0].index;
                            const month = chart.data.labels[index];
                            showUsersUpToMonth(uniName, month);
                        }
                    }
                });
            }

            function renderUniversityActiveTeamsChart(uniName) {
                const container = document.getElementById('universityActiveTeamsContainer');
                container.innerHTML = `
                    <h4 class="text-xl font-semibold mb-3">Active Teams Growth</h4>
                    <div class="p-4 bg-white rounded-lg shadow-inner">
                        <canvas id="universityActiveTeamsChart"></canvas>
                    </div>
                `;
                drawUniversityActiveTeamsChart(uniName);
            }

            function showActiveTeamsUpToMonth(uniName, month) {
                const monthDate = new Date(month + '-02');
                const teams = teamDatabase.filter(team => {
                    if (team.university !== uniName) return false;
                    const createdAt = new Date(team.createdAt);
                    const inactiveAt = team.inactiveAt ? new Date(team.inactiveAt) : null;
                    return createdAt <= monthDate && (!inactiveAt || inactiveAt > monthDate);
                }).sort((a,b) => a.name.localeCompare(b.name));
                
                let content = `
                    <h2 class="text-2xl font-bold text-teal-800 mb-2">Active Teams in ${uniName}</h2>
                    <p class="text-lg text-gray-600 mb-4">As of ${formatMonthYear(month + '-02')}</p>
                    <hr class="my-4">
                    <div class="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                        ${teams.length > 0 ? teams.map(t => `
                            <div class="p-2 bg-gray-50 rounded text-sm">${createTeamLink(t.name, t.id)}</div>
                        `).join('') : '<p class="text-gray-500">No active teams found for this period.</p>'}
                    </div>
                `;
                modalContentContainer.innerHTML = content;
                detailsModal.classList.remove('hidden');
            }

            function drawUniversityActiveTeamsChart(uniName) {
                const teams = teamDatabase.filter(t => t.university === uniName);
                if (teams.length === 0) {
                    destroyChart('universityActiveTeamsChart');
                    return;
                }
                const dates = teams.flatMap(t => [t.createdAt, t.inactiveAt]).filter(Boolean);
                if (dates.length === 0) return;

                const allMonths = new Set();
                dates.forEach(d => allMonths.add(d.slice(0, 7)));
                const sortedMonths = Array.from(allMonths).sort();

                const dataPoints = sortedMonths.map(month => {
                    const monthDate = new Date(month + '-02');
                    return teams.filter(team => {
                        const createdAt = new Date(team.createdAt);
                        const inactiveAt = team.inactiveAt ? new Date(team.inactiveAt) : null;
                        return createdAt <= monthDate && (!inactiveAt || inactiveAt > monthDate);
                    }).length;
                });

                renderChart('universityActiveTeamsChart', 'line', {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Active Teams',
                        data: dataPoints,
                        borderColor: '#0d9488',
                        backgroundColor: 'rgba(13, 148, 136, 0.1)',
                        fill: true,
                        tension: 0.1,
                        stepped: true
                    }]
                }, { 
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const chart = charts['universityActiveTeamsChart'];
                            const index = elements[0].index;
                            const month = chart.data.labels[index];
                            showActiveTeamsUpToMonth(uniName, month);
                        }
                    }
                });
            }
            
            function renderStudentsByYearChart(uniName) {
                const students = userDatabase.filter(u => u.university === uniName);
                if (students.length === 0) {
                    destroyChart('studentsByYearChart');
                    return;
                }

                const yearCounts = { '1st Year': 0, '2nd Year': 0, '3rd Year': 0, '4th Year': 0, '5th Year+': 0, 'Graduated': 0, 'Unknown': 0 };
                
                students.forEach(s => {
                    const yearLabel = getAcademicYear(s).label;
                    if(yearCounts.hasOwnProperty(yearLabel)) {
                        yearCounts[yearLabel]++;
                    } else {
                        yearCounts['Unknown']++;
                    }
                });
                
                const labels = Object.keys(yearCounts).filter(k => yearCounts[k] > 0);
                const data = labels.map(l => yearCounts[l]);

                renderChart('studentsByYearChart', 'pie', {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#6b7280', '#a1a1aa'],
                    }]
                }, {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'right' }, 
                        title: { display: false } 
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const chart = charts['studentsByYearChart'];
                            const index = elements[0].index;
                            const yearLabel = chart.data.labels[index];
                            const filteredStudents = students.filter(s => getAcademicYear(s).label === yearLabel);
                            showListInModal(`Students in ${uniName}: ${yearLabel}`, filteredStudents.map(u => createUserLink(u.handle)));
                        }
                    }
                });
            }


            function renderCompetitionAnalytics() {
                let html = `<div class="mb-4">
                                <label for="competitionAnalyticsSelect" class="text-sm font-medium">Select Competition:</label>
                                <select id="competitionAnalyticsSelect" class="w-full md:w-1/3 p-2 border rounded-md mt-1 bg-white">
                                    <option value="">-- Select Competition --</option>
                                    ${Object.keys(competitionDatabase).sort().map(c => `<option value="${c}">${c}</option>`).join('')}
                                </select>
                            </div>
                            <div id="competitionAnalyticsContent"></div>`;
                advancedStatsContainer.innerHTML = html;
                const selector = document.getElementById('competitionAnalyticsSelect');
                selector.addEventListener('change', (e) => renderCompetitionAnalyticsContent(e.target.value));
            }

            function getContestSeries(name) {
                if (!name) return '';
                // Remove any year from the name, trim, and convert to lowercase.
                return name.replace(/\b\d{4}\b/g, '').trim().toLowerCase();
            }

            function isFirstTimeForUser(userHandle, currentCompName) {
                const currentSeries = getContestSeries(currentCompName);
                if (!currentSeries) return false;
                const user = userDatabase.find(u => u.handle.toLowerCase() === userHandle.toLowerCase());
                if (!user) return false;

                const hasPastParticipation = user.placements.some(p => {
                    return p.name !== currentCompName && getContestSeries(p.name) === currentSeries;
                });
                return !hasPastParticipation;
            }

            function isFirstTimeForTeam(team, currentCompName) {
                for (const memberHandle of team.members) {
                    if (!isFirstTimeForUser(memberHandle, currentCompName)) {
                        return false; // Found a member with past experience, so not a first-timer team
                    }
                }
                return true; // No members had past participation in this series
            }

            function renderCompetitionAnalyticsContent(compName) {
                const contentEl = document.getElementById('competitionAnalyticsContent');
                if (!compName) {
                    contentEl.innerHTML = `<div class="text-center p-8 bg-gray-50 rounded-lg"><p class="text-gray-500">Select a competition to view standings.</p></div>`;
                    return;
                }

                // Expand team placements into individual entries for the individual standings
                const individualStandings = userDatabase.flatMap(user => {
                    return user.placements
                        .filter(p => p.name === compName)
                        .map(p => {
                            const team = p.teamId ? teamDatabase.find(t => t.id === p.teamId) : null;
                            return {
                                rank: p.rank,
                                handle: user.handle,
                                university: user.university,
                                teamName: team ? team.name : null,
                                teamId: team ? team.id : null,
                                isFirstTime: isFirstTimeForUser(user.handle, compName)
                            };
                        });
                }).sort((a,b) => a.rank - b.rank);

                // Aggregate team placements for the team standings
                const teamPlacementsAgg = individualStandings.filter(p => p.teamId).reduce((acc, p) => {
                    if (!acc[p.teamId]) {
                        const team = teamDatabase.find(t => t.id === p.teamId);
                        if (team) {
                             acc[p.teamId] = {
                                rank: p.rank,
                                teamName: team.name,
                                university: team.university,
                                members: team.members,
                                teamId: team.id,
                                isFirstTime: isFirstTimeForTeam(team, compName)
                            };
                        }
                    }
                    return acc;
                }, {});
                const teamStandings = Object.values(teamPlacementsAgg).sort((a,b) => a.rank - b.rank);

                let html = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <div>
                                    <h3 class="text-xl font-bold mb-3">Team Standings</h3>
                                    ${renderStandingsTable(teamStandings, true)}
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold mb-3">Individual Standings</h3>
                                    ${renderStandingsTable(individualStandings, false)}
                                </div>
                            </div>`;
                contentEl.innerHTML = html;
            }

            function renderStandingsTable(placements, isTeamTable) {
                if (placements.length === 0) return `<div class="p-4 text-sm bg-gray-50 rounded-md text-center text-gray-500">No ${isTeamTable ? 'team' : 'individual'} placements recorded.</div>`;
                
                let table = `<div class="overflow-x-auto border rounded-lg"><table class="w-full text-sm">
                                <thead class="bg-gray-100 text-xs uppercase"><tr>
                                    <th class="p-2 text-left">Rank</th>
                                    <th class="p-2 text-left">${isTeamTable ? 'Team' : 'Handle'}</th>
                                    <th class="p-2 text-left">University</th>
                                </tr></thead><tbody>`;
                
                placements.forEach(p => {
                    let nameCell;
                    const firstTimerBadge = p.isFirstTime ? `<span class="ml-2 text-xs font-bold bg-cyan-100 text-cyan-700 px-2 py-0.5 rounded-full">First Timer</span>` : '';

                    if (isTeamTable) {
                        nameCell = `${createTeamLink(p.teamName, p.teamId)}${firstTimerBadge}`;
                    } else {
                        const teamInfo = p.teamName ? ` <span class="text-xs text-gray-500">(${createTeamLink(p.teamName, p.teamId)})</span>` : '';
                        nameCell = `${createUserLink(p.handle)}${teamInfo}${firstTimerBadge}`;
                    }

                    table += `<tr class="border-b hover:bg-gray-50">
                                <td class="p-2 font-bold">${p.rank}</td>
                                <td class="p-2">${nameCell}</td>
                                <td class="p-2">${p.university || 'N/A'}</td>
                              </tr>`;
                });

                table += `</tbody></table></div>`;
                return table;
            }

            function renderGlobalAnalytics() {
                // Calculate University Dominance
                const uniScores = {};
                universityDatabase.forEach(uni => {
                    const students = userDatabase.filter(u => u.university === uni);
                    if (students.length > 0) {
                        const totalPlacements = students.flatMap(s => s.placements);
                        if (totalPlacements.length > 0) {
                            const avgPercentile = totalPlacements.reduce((sum, p) => sum + (p.rank / p.total), 0) / totalPlacements.length;
                            // Score: more students and better average percentile is better.
                            uniScores[uni] = {
                                score: students.length * (1 - avgPercentile),
                                students: students.length,
                                avgPercentile: avgPercentile * 100
                            };
                        }
                    }
                });
                const topUniversities = Object.entries(uniScores).sort((a, b) => b[1].score - a[1].score).slice(0, 5);

                // Calculate Top Individuals (most top 10% placements)
                const individualScores = {};
                userDatabase.forEach(u => {
                    const topPlacements = u.placements.filter(p => (p.rank / p.total) <= 0.1).length;
                    if (topPlacements > 0) {
                        individualScores[u.handle] = topPlacements;
                    }
                });
                const topIndividuals = Object.entries(individualScores).sort((a,b) => b[1] - a[1]).slice(0, 5);
                
                let html = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-xl font-bold mb-3">Top 5 Universities (by Dominance Index)</h3>
                            <p class="text-xs text-gray-500 mb-3">Dominance Index = (No. of Students) * (1 - Avg. Placement Percentile)</p>
                            <div class="space-y-3">
                                ${topUniversities.length > 0 ? topUniversities.map(([uni, data]) => `
                                    <div class="p-3 bg-indigo-50 rounded-lg border border-indigo-200">
                                        <div class="font-bold text-indigo-800">${uni}</div>
                                        <div class="text-sm text-indigo-600">Score: ${data.score.toFixed(2)} (${data.students} students, avg. top ${data.avgPercentile.toFixed(1)}%)</div>
                                    </div>
                                `).join('') : '<p class="text-gray-500">Not enough data.</p>'}
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-3">Top 5 Individuals (by Top 10% Placements)</h3>
                             <div class="space-y-3">
                                ${topIndividuals.length > 0 ? topIndividuals.map(([handle, count]) => `
                                    <div class="p-3 bg-green-50 rounded-lg border border-green-200">
                                        <div class="font-bold text-green-800">${createUserLink(handle)}</div>
                                        <div class="text-sm text-green-600">${count} top 10% placements</div>
                                    </div>
                                `).join('') : '<p class="text-gray-500">Not enough data.</p>'}
                            </div>
                        </div>
                    </div>

                    <div class="mt-8">
                        <h3 class="text-xl font-bold mb-3">Active Teams Growth Over Time</h3>
                        <div class="p-4 bg-white rounded-lg shadow-inner">
                            <canvas id="activeTeamsGrowthChart"></canvas>
                        </div>
                    </div>

                    <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-xl font-bold mb-3">User Distribution by University</h3>
                            <div class="p-4 bg-white rounded-lg shadow-inner h-80 flex items-center justify-center">
                                <canvas id="userDistributionChart"></canvas>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-3">Team Distribution by University</h3>
                            <div class="p-4 bg-white rounded-lg shadow-inner h-80 flex items-center justify-center">
                                <canvas id="teamDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                `;
                advancedStatsContainer.innerHTML = html;
                renderActiveTeamsGrowthChart();
                renderDistributionCharts();
            }

            function renderActiveTeamsGrowthChart() {
                if (teamDatabase.length === 0) {
                    destroyChart('activeTeamsGrowthChart');
                    return;
                }
                const dates = teamDatabase.flatMap(t => [t.createdAt, t.inactiveAt]).filter(Boolean);
                if (dates.length === 0) return;

                const allMonths = new Set();
                dates.forEach(d => allMonths.add(d.slice(0, 7)));
                const sortedMonths = Array.from(allMonths).sort();

                const dataPoints = sortedMonths.map(month => {
                    const monthDate = new Date(month + '-02');
                    return teamDatabase.filter(team => {
                        const createdAt = new Date(team.createdAt);
                        const inactiveAt = team.inactiveAt ? new Date(team.inactiveAt) : null;
                        const isActiveInMonth = createdAt <= monthDate && (!inactiveAt || inactiveAt >= monthDate);
                        return isActiveInMonth;
                    }).length;
                });

                renderChart('activeTeamsGrowthChart', 'line', {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Active Teams',
                        data: dataPoints,
                        borderColor: '#0d9488',
                        backgroundColor: 'rgba(13, 148, 136, 0.1)',
                        fill: true,
                        tension: 0.1,
                        stepped: true
                    }]
                }, { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } });
            }

            function renderDistributionCharts() {
                // User Distribution
                const userUniCounts = universityDatabase.reduce((acc, uni) => {
                    acc[uni] = userDatabase.filter(u => u.university === uni).length;
                    return acc;
                }, {});
                const sortedUserUnis = Object.entries(userUniCounts).filter(([,count]) => count > 0).sort((a,b) => b[1] - a[1]);
                renderChart('userDistributionChart', 'pie', {
                    labels: sortedUserUnis.map(u => u[0]),
                    datasets: [{ data: sortedUserUnis.map(u => u[1]), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#6b7280', '#ec4899', '#6366f1', '#f97316', '#06b6d4'] }]
                }, { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } });

                // Team Distribution
                const teamUniCounts = universityDatabase.reduce((acc, uni) => {
                    acc[uni] = teamDatabase.filter(t => t.university === uni).length;
                    return acc;
                }, {});
                const sortedTeamUnis = Object.entries(teamUniCounts).filter(([,count]) => count > 0).sort((a,b) => b[1] - a[1]);
                renderChart('teamDistributionChart', 'pie', {
                    labels: sortedTeamUnis.map(u => u[0]),
                    datasets: [{ data: sortedTeamUnis.map(u => u[1]), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#6b7280', '#ec4899', '#6366f1', '#f97316', '#06b6d4'] }]
                }, { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } });
            }
            
            function updateDbSortIndicators() { detailedUserTable.querySelectorAll('th.sortable-header').forEach(th => { th.classList.remove('sort-asc', 'sort-desc'); if (th.dataset.sortKey === dbSortState.key) th.classList.add(`sort-${dbSortState.direction}`); th.querySelector('.sort-icon').textContent = dbSortState.direction === 'asc' ? '' : ''; }); }
            function updateEditorSortIndicators(editorType) { const table = document.getElementById(`${editorType}EditorTable`); if (!table) return; table.querySelectorAll('th.sortable-header').forEach(th => { th.classList.remove('sort-asc', 'sort-desc'); if (th.dataset.sortKey === editorSortStates[editorType].key) th.classList.add(`sort-${editorSortStates[editorType].direction}`); th.querySelector('.sort-icon').textContent = editorSortStates[editorType].direction === 'asc' ? '' : ''; }); }
            
            function getFormattedDateTimeString() { const now = new Date(); const pad = (num) => num.toString().padStart(2, '0'); return `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}`; }
            
            function downloadFile(content, fileName, mimeType) { const blob = new Blob([content], { type: mimeType }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = fileName; document.body.appendChild(link); link.click(); document.body.removeChild(link); }
            
            function showTeamDetailsModal(teamId) {
                const team = teamDatabase.find(t => t.id === teamId);
                if (!team) {
                    alert('Team not found.');
                    return;
                }

                const teamPlacements = userDatabase
                    .flatMap(u => u.placements.filter(p => p.teamId === team.id))
                    .reduce((acc, p) => { // Deduplicate
                        if (!acc.some(ap => ap.name === p.name)) acc.push(p);
                        return acc;
                    }, [])
                    .sort((a, b) => (competitionDatabase[b.name]?.date || '').localeCompare(competitionDatabase[a.name]?.date || ''));

                let content = `
                    <h2 class="text-3xl font-bold text-teal-800 mb-2">${team.name}</h2>
                    <p class="text-lg text-gray-600 mb-1">${team.university}</p>
                    <p class="text-sm text-gray-500">Created: ${formatMonthYear(team.createdAt)} ${team.inactiveAt ? `| Inactive since: ${formatMonthYear(team.inactiveAt)}` : ''}</p>
                    <hr class="my-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-xl font-semibold mb-3">Members (${team.members.length})</h3>
                            <div class="space-y-2">
                                ${team.members.map(m => `<div class="p-2 bg-gray-50 rounded text-sm">${createUserLink(m)}</div>`).join('')}
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold mb-3">Competitions (${teamPlacements.length})</h3>
                            <div class="space-y-2 max-h-60 overflow-y-auto pr-2">
                                ${teamPlacements.length > 0 ? teamPlacements.map(p => `
                                    <div class="p-2 bg-gray-50 rounded text-sm">
                                        <span class="font-medium">${createCompetitionLink(p.name)}</span> - Rank ${p.rank}/${p.total}
                                    </div>
                                `).join('') : '<p class="text-gray-500 text-sm">No competitions recorded.</p>'}
                            </div>
                        </div>
                    </div>
                `;
                modalContentContainer.innerHTML = content;
                detailsModal.classList.remove('hidden');
            }

            function showUserDetailsModal(handle) {
                const dbData = userDatabase.find(d => d.id === handle.toLowerCase());

                if (!dbData) { alert('Could not find data for this user.'); return; }
                
                let content = '';
                const profilePicUrl = dbData?.profilePicUrl || `https://placehold.co/128x128/e0e0e0/333?text=${handle.charAt(0)}`;
                const trustedBadge = dbData?.isTrusted ? '' : '<span class="ml-2 text-xs font-bold uppercase bg-red-100 text-red-700 px-2 py-1 rounded-full">Untrusted</span>';

                content += `
                    <div class="flex flex-col md:flex-row gap-6 items-start">
                        <img src="${profilePicUrl}" alt="Profile Picture" class="w-32 h-32 rounded-full object-cover border-4 border-gray-200 shadow-md">
                        <div class="flex-grow">
                            <h2 class="text-3xl font-bold mb-1 flex items-center">${dbData.handle} ${trustedBadge}</h2>
                            <p class="text-lg text-gray-600 mb-2">${dbData?.fullName || ''}</p>
                            ${createCodeforcesLink(dbData.handle)}
                        </div>
                    </div>
                    <hr class="my-6">
                `;

                const levelMap = { '0': 'None', '-1': 'Codeability', '10': 'Level 0', '1': 'Level 1', '2': 'Level 2'};
                content += `
                <div class="mb-6 p-4 bg-gray-50 rounded-lg grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div><strong class="block text-gray-500">University</strong> <span class="text-lg">${dbData.university || 'N/A'}</span></div>
                    <div><strong class="block text-gray-500">ACM Level</strong> <span class="text-lg">${levelMap[dbData.acmLevel] || 'N/A'}</span></div>
                    <div><strong class="block text-gray-500">Uni Start Date</strong> <span class="text-lg">${formatMonthYear(dbData.universityStartDate)}</span></div>
                    <div><strong class="block text-gray-500">LinkedIn</strong> ${dbData.linkedin ? `<a href="${dbData.linkedin}" target="_blank" class="text-blue-600 hover:underline text-lg">Profile</a>` : '<span class="text-lg">N/A</span>'}</div>
                </div>`;

                const userTeams = teamDatabase.filter(t => t.members.map(m => m.toLowerCase()).includes(dbData.handle.toLowerCase()));
                if (userTeams.length > 0) {
                    content += `<h3 class="text-xl font-semibold mb-2">Teams</h3><div class="flex flex-wrap gap-2 mb-6">
                        ${userTeams.map(team => `<div class="p-2 bg-teal-50 text-teal-800 rounded text-sm font-medium">${createTeamLink(team.name, team.id)}</div>`).join('')}
                    </div>`;
                }

                const teamPlacements = dbData.placements.filter(p => p.teamId);
                if (teamPlacements.length > 0) {
                    content += `<h3 class="text-xl font-semibold mb-2">Team Placements</h3>
                                <div class="overflow-x-auto mb-6 max-h-48 border rounded-lg">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-gray-100 text-xs uppercase sticky top-0"><tr>
                                        <th class="p-2">Competition</th><th class="p-2">Team</th><th class="p-2">Rank</th><th class="p-2">Placement</th>
                                    </tr></thead><tbody>`;
                    teamPlacements.forEach(p => {
                        const team = teamDatabase.find(t => t.id === p.teamId);
                        const placementPercent = ((p.rank / p.total) * 100).toFixed(2);
                        content += `<tr class="border-b">
                                        <td class="p-2 font-medium">${createCompetitionLink(p.name)}</td>
                                        <td class="p-2">${team ? createTeamLink(team.name, team.id) : 'N/A'}</td>
                                        <td class="p-2">${p.rank}/${p.total}</td>
                                        <td class="p-2 font-bold">Top ${placementPercent}%</td>
                                    </tr>`;
                    });
                    content += `</tbody></table></div>`;
                }

                const soloPlacements = dbData.placements.filter(p => !p.teamId);
                if (soloPlacements.length > 0) {
                    content += `<h3 class="text-xl font-semibold mb-2">Solo Placements</h3>
                                <div class="overflow-x-auto mb-6 max-h-48 border rounded-lg">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-gray-100 text-xs uppercase sticky top-0"><tr>
                                        <th class="p-2">Competition</th><th class="p-2">Rank</th><th class="p-2">Total</th><th class="p-2">Placement</th>
                                    </tr></thead><tbody>`;
                    soloPlacements.forEach(p => {
                        const placementPercent = ((p.rank / p.total) * 100).toFixed(2);
                        content += `<tr class="border-b">
                                        <td class="p-2 font-medium">${createCompetitionLink(p.name)}</td>
                                        <td class="p-2">${p.rank}</td>
                                        <td class="p-2">${p.total}</td>
                                        <td class="p-2 font-bold">Top ${placementPercent}%</td>
                                    </tr>`;
                    });
                    content += `</tbody></table></div>`;
                }

                modalContentContainer.innerHTML = content;
                detailsModal.classList.remove('hidden');
            }

            function hideModal() { 
                detailsModal.classList.add('hidden'); 
            }

            function showListInModal(title, items) {
                let content = `
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">${title} (${items.length})</h2>
                    <hr class="my-4">
                    <div class="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                        ${items.length > 0 ? items.map(item => `
                            <div class="p-2 bg-gray-50 rounded text-sm">${item}</div>
                        `).join('') : '<p class="text-gray-500">No items found.</p>'}
                    </div>
                `;
                modalContentContainer.innerHTML = content;
                detailsModal.classList.remove('hidden');
            }

            function createUserLink(handle) {
                if (!handle) return 'N/A';
                return `<button class="user-link" data-handle="${handle}">${handle}</button>`;
            }

            function createCodeforcesLink(handle) {
                if (!handle) return '';
                return `<a href="https://codeforces.com/profile/${handle}" target="_blank" class="text-blue-600 hover:underline text-sm" title="View Codeforces Profile">
                    View on Codeforces
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block ml-1" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" />
                        <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" />
                    </svg>
                </a>`;
            }

            function createTeamLink(teamName, teamId) {
                return `<button class="team-link" data-team-id="${teamId}">${teamName}</button>`;
            }

            function createCompetitionLink(compName) {
                const comp = competitionDatabase[compName];
                if (comp && comp.link) {
                    return `<a href="${comp.link}" target="_blank" class="competition-link">${compName}</a>`;
                }
                return compName;
            }
            
            function updateSelectAllState(tableElement) {
                if (!tableElement) return;
                const headCheckbox = tableElement.querySelector('thead input[type="checkbox"]');
                const bodyCheckboxes = tableElement.querySelectorAll('tbody input[type="checkbox"]');
                const total = bodyCheckboxes.length;
                const checkedCount = Array.from(bodyCheckboxes).filter(cb => cb.checked).length;
                
                if (headCheckbox) {
                    headCheckbox.checked = total > 0 && total === checkedCount;
                }
            }
            
             // --- Gemini API ---
            async function callGeminiApi(prompt, retries = 3, delay = 1000) {
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && retries > 0) {
                             console.warn(`Rate limited. Retrying in ${delay}ms... (${retries} retries left)`);
                             await new Promise(res => setTimeout(res, delay));
                             return callGeminiApi(prompt, retries - 1, delay * 2);
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error("Invalid response structure from Gemini API");
                    }
                } catch (error) {
                    if (retries > 0) {
                         console.warn(`API call failed. Retrying in ${delay}ms... (${retries} retries left)`);
                         await new Promise(res => setTimeout(res, delay));
                         return callGeminiApi(prompt, retries - 1, delay * 2);
                    } else {
                        console.error("Error calling Gemini API:", error);
                        return `Error: Could not retrieve insights. ${error.message}`;
                    }
                }
            }
            
            async function generateAiInsights() {
                aiInsightContent.innerHTML = '<div class="flex items-center justify-center gap-2 text-gray-600"><div class="spinner w-6 h-6 border-2 rounded-full"></div><span>Generating insights... Please wait.</span></div>';
                showAiModal();

                const totalUsers = userDatabase.length;
                const totalTeams = teamDatabase.length;
                const top5Users = userDatabase.sort((a,b) => (b.lunaHardScore + b.lunaNovaScore) - (a.lunaHardScore + a.lunaNovaScore)).slice(0, 5).map(u => `${u.handle} (Score: ${(u.lunaHardScore + u.lunaNovaScore).toFixed(2)})`).join(', ');
                const uniDistribution = universityDatabase.map(uni => {
                    const count = userDatabase.filter(u => u.university === uni).length;
                    return `${uni}: ${count} users`;
                }).join('\n');

                const prompt = `
                    Based on the following competitive programming community data, provide a brief, insightful summary. The data is about users, their universities, teams, and placements in competitions.

                    - Total Users: ${totalUsers}
                    - Total Teams: ${totalTeams}
                    - Top 5 Users by Score: ${top5Users || 'N/A'}
                    - University Distribution:\n${uniDistribution || 'N/A'}

                    Analyze this data and provide:
                    1. A short, overall summary of the community's status.
                    2. Identify one key strength based on the data.
                    3. Suggest one area for potential improvement or focus.
                    
                    Format the response in clear sections using markdown headings.
                `;

                const insights = await callGeminiApi(prompt);
                
                // A simple markdown to HTML converter
                const formattedInsights = insights
                    .replace(/### (.*)/g, '<h3 class="text-xl font-semibold text-fuchsia-700 mt-4 mb-2">$1</h3>')
                    .replace(/## (.*)/g, '<h2 class="text-2xl font-bold text-fuchsia-800 mb-3">$1</h2>')
                    .replace(/\* \*(.*)\*\*/g, '<strong>$1</strong>')
                    .replace(/\* (.*)/g, '<li class="ml-5 list-disc">$1</li>')
                    .replace(/\n/g, '<br>');

                aiInsightContent.innerHTML = formattedInsights;
            }


            // --- EVENT LISTENERS ---
            appContainer.addEventListener('click', (e) => {
                const userLink = e.target.closest('.user-link');
                const teamLink = e.target.closest('.team-link');
                if (userLink) {
                    e.preventDefault();
                    showUserDetailsModal(userLink.dataset.handle);
                } else if (teamLink) {
                    e.preventDefault();
                    showTeamDetailsModal(teamLink.dataset.teamId);
                }
            });

            Object.values(tabButtons).forEach(button => {
                button.addEventListener('click', () => {
                    Object.values(tabButtons).forEach(btn => btn.classList.remove('active', 'text-blue-600', 'border-blue-600'));
                    button.classList.add('active', 'text-blue-600', 'border-blue-600');
                    Object.values(tabContents).forEach(content => content.classList.add('hidden'));
                    const contentId = button.id.replace('tabBtn', 'tabContent');
                    document.getElementById(contentId).classList.remove('hidden');
                    
                    if (button.id === 'tabBtnAnalyticsDashboard') {
                        renderAdvancedStats();
                    }
                });
            });

            analyticsSubTabs.addEventListener('click', (e) => {
                if (e.target.matches('.sub-tab-btn')) {
                    analyticsSubTabs.querySelectorAll('.sub-tab-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    renderAdvancedStats();
                }
            });

            editorContainer.addEventListener('click', e => {
                if(e.target.matches('.editor-tab-btn')){
                     editorContainer.querySelectorAll('.editor-tab-btn').forEach(btn => btn.classList.remove('active'));
                     e.target.classList.add('active');
                     renderCurrentEditorView();
                }
            });
            document.querySelector('#tabContentEditors .flex.space-x-1').addEventListener('click', e => {
                if(e.target.matches('.editor-tab-btn')){
                    document.querySelectorAll('#tabContentEditors .editor-tab-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    renderCurrentEditorView();
                }
            });


            downloadAllUsersCsvBtn.addEventListener('click', () => downloadUsersCSV(userDatabase));
            downloadSelectedUsersCsvBtn.addEventListener('click', () => {
                const selectedIds = Array.from(document.querySelectorAll('.user-select-checkbox:checked')).map(cb => cb.dataset.id);
                const selectedUsers = userDatabase.filter(user => selectedIds.includes(user.id));
                downloadUsersCSV(selectedUsers);
            });
            downloadReadinessModelBtn.addEventListener('click', downloadReadinessModelCSV);
            downloadDbFullBackupBtn.addEventListener('click', downloadDbFullBackup);
            downloadDbFullBackupBtn_dummy.addEventListener('click', downloadDbFullBackup);
            detailedUserForm.addEventListener('submit', handleDetailedUserFormSubmit);
            
            handleField.addEventListener('input', () => {
                document.querySelectorAll('.placement-entry').forEach(updateTeamSelectForEntry);
            });
            universityInput.addEventListener('input', () => {
                 document.querySelectorAll('.placement-entry').forEach(updateTeamSelectForEntry);
            });

            clearFormBtn.addEventListener('click', () => { showConfirmationModal('Clear Form?', 'Are you sure you want to clear all fields in the user form?', clearDetailedUserForm); });
            addPlacementBtn.addEventListener('click', () => addPlacementInput());
            
            detailedUserTable.querySelector('thead').addEventListener('click', e => {
                const header = e.target.closest('th.sortable-header');
                if (!header) return;
                const key = header.dataset.sortKey;
                let direction = 'desc';
                if (dbSortState.key === key) {
                    direction = dbSortState.direction === 'desc' ? 'asc' : 'desc';
                }
                dbSortState = { key, direction };
                renderUserDatabaseTable();
            });
            detailedUserTable.querySelector('thead').addEventListener('keyup', e => {
                if(e.target.matches('input[data-filter-key]')) {
                    dbFilters[e.target.dataset.filterKey] = e.target.value;
                    renderUserDatabaseTable();
                }
            });
            
            detailedUserTable.addEventListener('change', e => {
                 if (e.target.id === 'selectAllUsersCheckbox') {
                    document.querySelectorAll('#detailedUserTableBody .user-select-checkbox').forEach(cb => cb.checked = e.target.checked);
                 } else if (e.target.matches('.user-select-checkbox')) {
                    updateSelectAllState(detailedUserTable);
                 }
            });
            
            detailedUserTableBody.addEventListener('click', e => {
                const target = e.target; const row = target.closest('tr'); if (!row) return; const userId = row.dataset.id; const user = userDatabase.find(u => u.id === userId); if (!user) return;
                if (target.classList.contains('delete-db-user-btn')) {
                    showConfirmationModal('Delete User?', `Permanently delete ${user.handle} from the database? This cannot be undone.`, () => {
                        userDatabase = userDatabase.filter(u => u.id !== userId);
                        renderAll();
                    });
                } else if (target.classList.contains('edit-db-user-btn')) {
                    clearDetailedUserForm();
                    detailedUserForm.querySelector('[name="handle"]').value = user.handle;
                    detailedUserForm.querySelector('[name="handle"]').readOnly = true;
                    detailedUserForm.querySelector('[name="fullName"]').value = user.fullName;
                    detailedUserForm.querySelector('[name="linkedin"]').value = user.linkedin;
                    populateUniversityDatalist(user.university);
                    
                    profilePicUrlHiddenInput.value = user.profilePicUrl || '';
                    if(user.profilePicUrl) {
                        profilePicFileLabel.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                        profilePicFileLabel.classList.add('bg-green-600', 'hover:bg-green-700');
                        profilePicFileLabel.textContent = "Image Uploaded";
                    }

                    detailedUserForm.querySelector('[name="lunaNovaScore"]').value = user.lunaNovaScore;
                    detailedUserForm.querySelector('[name="lunaHardScore"]').value = user.lunaHardScore;
                    detailedUserForm.querySelector('[name="acmLevel"]').value = user.acmLevel;
                    detailedUserForm.querySelector('[name="joinDate"]').value = formatDateForInput(user.joinDate);
                    detailedUserForm.querySelector('[name="universityStartDate"]').value = formatDateForInput(user.universityStartDate);
                    detailedUserForm.querySelector('#isTrustedCheckbox').checked = user.isTrusted !== false; // Default to true if undefined
                    placementsContainer.innerHTML = '';
                    user.placements.forEach(p => addPlacementInput(p));
                    handleField.dispatchEvent(new Event('input')); // Manually trigger to populate team dropdowns
                    detailedUserForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else if (target.classList.contains('details-db-user-btn')) {
                    showUserDetailsModal(user.handle);
                }
            });
            closeModalBtn.addEventListener('click', hideModal);
            
            // FIX: Add event listener to modal overlay for navigation
            detailsModal.addEventListener('click', (e) => { 
                if (e.target === detailsModal) {
                    hideModal();
                    return;
                }
                 const userLink = e.target.closest('.user-link');
                const teamLink = e.target.closest('.team-link');
                if (userLink) {
                    e.preventDefault();
                    showUserDetailsModal(userLink.dataset.handle);
                } else if (teamLink) {
                    e.preventDefault();
                    showTeamDetailsModal(teamLink.dataset.teamId);
                }
            });

            aiInsightBtn.addEventListener('click', generateAiInsights);
            closeAiModalBtn.addEventListener('click', hideAiModal);
            aiModal.addEventListener('click', (e) => { if(e.target === aiModal) hideAiModal()});

            confirmCancelBtn.addEventListener('click', hideConfirmationModal);
            confirmOkBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); hideConfirmationModal(); });
            jsonFileInput.addEventListener('change', (e) => { loadJsonFile(e.target.files[0]); e.target.value = ''; });
            uploadUsersCsvInput.addEventListener('change', (e) => { handleFileUpload(e.target.files[0], handleUserUpload); e.target.value = ''; });
            uploadCompetitionsCsvInput.addEventListener('change', (e) => { handleFileUpload(e.target.files[0], handleCompetitionUpload); e.target.value = ''; });
            uploadUniversitiesCsvInput.addEventListener('change', (e) => { handleFileUpload(e.target.files[0], handleUniversityUpload); e.target.value = ''; });
            
            profilePicFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (event) => { 
                        profilePicUrlHiddenInput.value = event.target.result; 
                        profilePicFileLabel.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                        profilePicFileLabel.classList.add('bg-green-600', 'hover:bg-green-700');
                        profilePicFileLabel.textContent = "Image Uploaded";
                    };
                    reader.readAsDataURL(file);
                } else {
                    profilePicUrlHiddenInput.value = '';
                    profilePicFileLabel.classList.remove('bg-green-600', 'hover:bg-green-700');
                    profilePicFileLabel.classList.add('bg-gray-600', 'hover:bg-gray-700');
                    profilePicFileLabel.textContent = "Choose File";
                }
            });

            // --- LOCAL STORAGE PERSISTENCE ---
            function saveDataToLocalStorage() {
                try {
                    const dataToSave = {
                        users: userDatabase,
                        teams: teamDatabase,
                        competitions: competitionDatabase,
                        universities: universityDatabase,
                        version: 'v17' // Increment version for new data model
                    };
                    localStorage.setItem('electiToolData_v17', JSON.stringify(dataToSave));
                } catch (e) {
                    console.error("Could not save to localStorage. Data might be too large.", e);
                }
            }

            function loadDataFromLocalStorage() {
                const savedData = localStorage.getItem('electiToolData_v17');
                if (savedData) {
                    try {
                        const data = JSON.parse(savedData);
                        userDatabase = data.users.map(u => ({...u, isTrusted: u.isTrusted !== false, updatedAt: new Date(u.updatedAt) })) || [];
                        teamDatabase = data.teams || [];
                        competitionDatabase = data.competitions || {};
                        universityDatabase = data.universities || [];
                    } catch (e) {
                        console.error("Error parsing data from localStorage", e);
                        userDatabase = []; teamDatabase = []; competitionDatabase = {}; universityDatabase = [];
                    }
                }
            }

            // Automatically save on changes
            window.addEventListener('beforeunload', saveDataToLocalStorage);

            // Initial setup
            function initializeApp() {
                loadDataFromLocalStorage();
                updateDbSortIndicators();
                // Set the default active tab
                Object.values(tabButtons).forEach(btn => btn.classList.remove('active'));
                Object.values(tabContents).forEach(content => content.classList.add('hidden'));
                document.getElementById('tabBtnDatabase').classList.add('active');
                document.getElementById('tabContentDatabase').classList.remove('hidden');
                renderAll();
            }

            initializeApp();
        });
    </script>
</body>
</html>

