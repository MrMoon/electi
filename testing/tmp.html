<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operation Electi - Readiness Model v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyB5hQwe1q-KkHovjbppL151JF4MaBN7-O4",
          authDomain: "operation-electi.firebaseapp.com",
          projectId: "operation-electi",
          storageBucket: "operation-electi.firebasestorage.app",
          messagingSenderId: "390391477698",
          appId: "1:390391477698:web:01a68241996f311959925b",
          measurementId: "G-TST9TKC5RP"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make Firebase services globally available to the main script
        window.firebaseServices = { auth, db, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, doc, setDoc, getDoc, serverTimestamp };
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .spinner { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .sortable-header { cursor: pointer; position: relative; }
        .sortable-header:after, .sortable-header:before { content: ''; position: absolute; right: 10px; border: 4px solid transparent; opacity: 0.3; }
        .sortable-header:before { bottom: 50%; margin-bottom: -1px; border-bottom-color: currentColor; }
        .sortable-header:after { top: 50%; margin-top: -1px; border-top-color: currentColor; }
        .sortable-header.sort-asc:after, .sortable-header.sort-desc:before { opacity: 1; }
        .heatmap-day { stroke: rgba(27, 31, 35, 0.06); stroke-width: 2px; }
        .heatmap-day:hover { stroke: #555; stroke-width: 1px; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50 text-gray-800">

    <div id="app" v-cloak class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-10 relative">
            <!-- Auth Status -->
            <div id="authStatus" class="absolute top-0 right-0 text-right">
                <!-- Logged Out State -->
                <div id="loggedOutState">
                    <button id="loginBtn" class="text-sm font-semibold text-blue-600 hover:text-blue-800">Login / Sign Up</button>
                </div>
                <!-- Logged In State -->
                <div id="loggedInState" class="hidden">
                    <div class="flex items-center gap-3">
                        <span id="userEmail" class="text-sm text-gray-600"></span>
                        <button id="profileBtn" class="text-sm font-semibold bg-gray-200 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-300">Profile</button>
                        <button id="logoutBtn" class="text-sm font-semibold text-red-600 hover:text-red-800">Logout</button>
                    </div>
                </div>
            </div>

            <div class="flex justify-center items-center gap-4 mb-2">
                <img src="https://i.ibb.co/JNyxxBv/logo.png" alt="Operation Electi Logo" class="h-16 w-16" onerror="this.onerror=null; this.src='https://placehold.co/64x64/e0e0e0/333?text=Logo';">
                <h1 class="text-5xl font-bold text-gray-900">Operation Electi</h1>
            </div>
            <p class="mt-2 text-lg text-gray-600">A readiness analysis tool for competitive programmers.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Left Column: Inputs and Controls -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Manual User Input -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold mb-4">1. Add User Manually</h2>
                    <div class="space-y-4">
                        <input type="text" id="handleInput" placeholder="Codeforces Handle" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" id="lunaNovaScoreInput" placeholder="Luna Nova" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="number" id="lunaHardScoreInput" placeholder="Luna" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <input type="text" id="placementsInput" placeholder="Placements (e.g., 15, 22, 8)" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="flex items-center">
                            <input type="checkbox" id="trustedUserInput" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                            <label for="trustedUserInput" class="ml-2 block text-sm text-gray-900">Trusted User</label>
                        </div>
                        <button id="addManualUserBtn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 transition duration-200">Add User</button>
                    </div>
                </div>

                <!-- CSV Upload -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold mb-4">2. Or Load from CSV</h2>
                    <p class="text-sm text-gray-500 mb-3">CSV format: `handle,luna_nova_score,luna_hard_score,"placement1;..."`</p>
                    <input type="file" id="csvFileInput" accept=".csv" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <button id="loadCsvBtn" class="w-full mt-4 bg-gray-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-700 transition duration-200">Load from File</button>
                </div>

                <!-- User List -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">3. User List (<span id="userCount">0</span>)</h2>
                        <div class="flex items-center gap-2">
                             <button id="downloadUserListBtn" class="text-sm text-blue-500 hover:text-blue-700 font-semibold disabled:text-gray-400 disabled:cursor-not-allowed" disabled>Download List</button>
                            <button id="clearListBtn" class="text-sm text-red-500 hover:text-red-700 font-semibold">Clear All</button>
                        </div>
                    </div>
                    <div id="noUsersMessage" class="text-center text-gray-500 py-4">Add users to get started.</div>
                    <ul id="userList" class="space-y-2 max-h-60 overflow-y-auto"></ul>
                </div>
            </div>

            <!-- Right Column: Processing and Results -->
            <div class="lg:col-span-8">
                <!-- Controls -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                     <h2 class="text-xl font-bold mb-4">4. Analyze & Download</h2>
                     <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mb-4" role="alert"></div>
                     <div class="flex flex-col sm:flex-row gap-4">
                        <button id="processAllBtn" class="flex-1 bg-green-600 text-white font-bold py-3 px-4 rounded-md hover:bg-green-700 transition duration-200 flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                            Process All Users
                        </button>
                        <button id="downloadResultsBtn" disabled class="flex-1 bg-purple-600 text-white font-bold py-3 px-4 rounded-md hover:bg-purple-700 transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            Download Results
                        </button>
                     </div>
                </div>

                <!-- Loading Indicator -->
                <div id="loadingIndicator" class="hidden text-center py-10">
                    <p class="mt-4 text-lg font-semibold text-gray-600">Processing users... This may take a moment.</p>
                    <p class="text-sm text-gray-500">Fetching data from the Codeforces API.</p>
                </div>

                <!-- Results Container -->
                <div id="resultsContainer" class="hidden">
                    <div class="bg-white rounded-t-lg p-4 border-b border-gray-200 flex justify-between items-center">
                        <div>
                            <label for="readinessFilter" class="text-sm font-semibold text-gray-600 mr-2">Filter by Readiness:</label>
                            <select id="readinessFilter" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                <option value="all">All</option>
                                <option value="very-high">Very High (85% +)</option>
                                <option value="high">High (65% - 85%)</option>
                                <option value="medium">Medium (40% - 65%)</option>
                                <option value="low">Low (&lt; 40%)</option>
                            </select>
                        </div>
                        <button id="saveSelectedBtn" disabled class="bg-teal-600 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-700 transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>
                            Save Selected to DB
                        </button>
                    </div>
                    <!-- Results Table -->
                    <div class="bg-white rounded-b-lg shadow-md overflow-x-auto">
                        <table id="resultsTable" class="w-full text-sm text-left text-gray-600">
                            <thead class="bg-gray-100 text-xs text-gray-700 uppercase">
                                <tr>
                                    <th class="px-2 py-3 text-center"><input type="checkbox" id="selectAllCheckbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"></th>
                                    <th scope="col" class="px-4 py-3 sortable-header" data-sort-key="handle">Handle</th>
                                    <th scope="col" class="px-4 py-3 sortable-header" data-sort-key="scoreFromAvgDiv2Performance">Div2 Perf. Score</th>
                                    <th scope="col" class="px-4 py-3 sortable-header" data-sort-key="avgPlacement">Avg Placement</th>
                                    <th scope="col" class="px-4 py-3 text-center sortable-header sort-desc" data-sort-key="readinessProbability">Readiness</th>
                                    <th scope="col" class="px-4 py-3 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <!-- Model Explanation -->
        <section id="modelExplanation" class="mt-12 bg-white rounded-lg shadow-md p-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">How It Works: The Readiness Model</h2>
            <div class="space-y-6 text-gray-700">
                 <p>This tool estimates a user's readiness for Codeforces Division 2 contests using a model that combines multiple data points. It's not a simple checklist; instead, it weighs different factors to produce a probabilistic score.</p>
                <div>
                    <h3 class="text-lg font-semibold mb-2">1. Feature Scoring with Logistic Curves</h3>
                    <p>Raw statistics (like a rating of 2000 or 100 contests) are not used directly. Instead, each key metric is converted into a standardized score (typically on a 0-100 scale) using a <strong class="font-semibold">logistic function (S-curve)</strong>. This has two benefits:</p>
                    <ul class="list-disc list-inside mt-2 pl-4 space-y-1">
                        <li><strong>Diminishing Returns:</strong> The difference between 0 and 20 contests is significant, but the difference between 100 and 120 is less so. S-curves capture this reality.</li>
                        <li><strong>Normalization:</strong> It puts different metrics (like rating and contest count) onto a comparable scale before they are combined.</li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2">2. Key Metrics Used</h3>
                    <p>The model analyzes the following features:</p>
                    <ul class="list-disc list-inside mt-2 pl-4 space-y-2">
                        <li><strong class="font-semibold">Max & Average Rating:</strong> Measures peak performance and overall consistency.</li>
                        <li><strong class="font-semibold">Contest Count:</strong> A measure of overall experience.</li>
                        <li><strong class="font-semibold">Recency-Weighted Solved Problems:</strong> Scores all solved problems, giving more weight to harder problems and more recent solves. This rewards continuous practice.</li>
                        <li><strong class="font-semibold">Activity Score:</strong> Measures solving consistency and volume. It analyzes all correct submissions, giving more value to days with more accepted solutions (with diminishing returns) and weighting recent activity much more heavily than past activity. This rewards sustained, high-volume practice.</li>
                        <li><strong class="font-semibold">Average Div. 2 Performance Score:</strong> This metric calculates a weighted score for each Div. 2 contest (A=1, B=2, C=4, etc.) and then finds the *average* score across all Div. 2 contests. This value is then curved to produce a normalized score from 0-100, rewarding consistent high performance.</li>
                        <li><strong class="font-semibold">Luna Score (Manual Input):</strong> A manually provided score from two versions: Luna Nova (easy) and Luna (hard). The hard version contributes significantly more to the final score to reward participation in more challenging events.</li>
                        <li><strong class="font-semibold">Placement Score (Manual Input):</strong> This score is derived from user-provided contest placement percentages. To better reward top-tier performance, the model uses a non-linear curve by calculating the <strong class="font-semibold">Root Mean Square (RMS)</strong> of the inverted placements. This gives much greater weight to top placements (e.g., Top 5%) compared to mediocre ones.</li>
                        <li><strong class="font-semibold">Inactivity Pattern Penalty:</strong> A penalty is applied based on a user's entire activity history. It analyzes the average time between active days, the consistency of these gaps, and how long it's been since the last submission. This provides a more holistic view of consistency than a simple 'last seen' date.</li>
                        <li><strong class="font-semibold">Trusted User Status:</strong> A manually-set flag. If a user is unchecked (not trusted), their score is heavily penalized. The model drastically reduces the contribution from all Codeforces-derived statistics and applies a smaller penalty to manually-entered scores.</li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2">3. Final Probability Calculation</h3>
                    <p>Each of the feature scores is multiplied by a specific <strong class="font-semibold">weight</strong>, reflecting its importance in the model. These weighted scores are summed up. Finally, this total sum is passed through a <strong class="font-semibold">Sigmoid function</strong>, which squashes the output into a value between 0 and 1, representing the final readiness probability.</p>
                    <p class="mt-2 text-sm text-gray-600"><strong>Disclaimer:</strong> This is an estimation model based on statistical analysis. It provides a data-driven guideline but is not a definitive judgment of a user's ability or future success.</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Modals -->
    <!-- Details Modal -->
    <div id="detailsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-6 relative transform scale-95">
            <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <div id="modalContentContainer"></div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-8 relative transform scale-95">
            <button id="closeAuthModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <div id="authFormContainer">
                <h2 class="text-2xl font-bold text-center mb-6">Login or Sign Up</h2>
                <div id="authError" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mb-4"></div>
                <div class="space-y-4">
                    <input type="email" id="emailInput" placeholder="Email Address" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="password" id="passwordInput" placeholder="Password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex gap-4 mt-6">
                    <button id="signInBtn" class="flex-1 bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700">Login</button>
                    <button id="signUpBtn" class="flex-1 bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700">Sign Up</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg p-8 relative transform scale-95">
            <button id="closeProfileModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <div>
                <h2 class="text-2xl font-bold text-center mb-6">Your Profile</h2>
                <div id="profileMessage" class="hidden text-center text-sm mb-4"></div>
                <div class="space-y-4">
                    <input type="text" id="profileCodeforcesInput" placeholder="Codeforces Handle" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="text" id="profileLinkedinInput" placeholder="LinkedIn Profile URL" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="text" id="profileIcpcInput" placeholder="ICPC ID" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="text" id="profilePictureInput" placeholder="Profile Picture URL" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mt-6">
                    <button id="saveProfileBtn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700">Save Profile</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- App Initialization ---
            document.getElementById('app').removeAttribute('v-cloak');

            // --- Firebase Service References ---
            const { auth, db, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, doc, setDoc, getDoc, serverTimestamp } = window.firebaseServices;

            // --- DOM Element References ---
            const handleInput = document.getElementById('handleInput');
            const lunaNovaScoreInput = document.getElementById('lunaNovaScoreInput');
            const lunaHardScoreInput = document.getElementById('lunaHardScoreInput');
            const placementsInput = document.getElementById('placementsInput');
            const trustedUserInput = document.getElementById('trustedUserInput');
            const addManualUserBtn = document.getElementById('addManualUserBtn');
            const csvFileInput = document.getElementById('csvFileInput');
            const loadCsvBtn = document.getElementById('loadCsvBtn');
            const clearListBtn = document.getElementById('clearListBtn');
            const processAllBtn = document.getElementById('processAllBtn');
            const downloadResultsBtn = document.getElementById('downloadResultsBtn');
            const downloadUserListBtn = document.getElementById('downloadUserListBtn');
            const userList = document.getElementById('userList');
            const userCount = document.getElementById('userCount');
            const noUsersMessage = document.getElementById('noUsersMessage');
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsTable = document.getElementById('resultsTable');
            const resultsTableBody = document.querySelector('#resultsTable tbody');
            const resultsTableHeader = document.querySelector('#resultsTable thead');
            const readinessFilter = document.getElementById('readinessFilter');
            const errorMessageDiv = document.getElementById('errorMessage');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const detailsModal = document.getElementById('detailsModal');
            const modalContentContainer = document.getElementById('modalContentContainer');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const saveSelectedBtn = document.getElementById('saveSelectedBtn');

            // --- Auth DOM Elements ---
            const authModal = document.getElementById('authModal');
            const closeAuthModalBtn = document.getElementById('closeAuthModalBtn');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const loggedInState = document.getElementById('loggedInState');
            const loggedOutState = document.getElementById('loggedOutState');
            const userEmailSpan = document.getElementById('userEmail');
            const emailInput = document.getElementById('emailInput');
            const passwordInput = document.getElementById('passwordInput');
            const signInBtn = document.getElementById('signInBtn');
            const signUpBtn = document.getElementById('signUpBtn');
            const authErrorDiv = document.getElementById('authError');

            // --- Profile DOM Elements ---
            const profileModal = document.getElementById('profileModal');
            const profileBtn = document.getElementById('profileBtn');
            const closeProfileModalBtn = document.getElementById('closeProfileModalBtn');
            const profileCodeforcesInput = document.getElementById('profileCodeforcesInput');
            const profileLinkedinInput = document.getElementById('profileLinkedinInput');
            const profileIcpcInput = document.getElementById('profileIcpcInput');
            const profilePictureInput = document.getElementById('profilePictureInput');
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            const profileMessageDiv = document.getElementById('profileMessage');

            // --- State Variables ---
            let usersToAnalyze = [];
            let cachedUserData = [];
            let ratingChart = null;
            let problemChart = null;
            let sortState = { key: 'readinessProbability', direction: 'desc' };
            let activeFilter = 'all';
            let currentUser = null;
            
            // --- Model Weights (same as original) ---
            const weights = { bias: -7.0, maxRating: 0.02, avgRating: 0.01, contestCount: 0.03, lunaScore: 0.04, placementScore: 0.08, avgDiv2PerfScore: 0.16, weightedSolves: 0.05, activityScore: 0.08, inactivityPattern: -0.04, skipped: -0.015 };

            // --- Firebase Auth Logic ---
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    // User is signed in
                    loggedInState.classList.remove('hidden');
                    loggedOutState.classList.add('hidden');
                    userEmailSpan.textContent = user.email;
                    authModal.classList.add('hidden');
                } else {
                    // User is signed out
                    loggedInState.classList.add('hidden');
                    loggedOutState.classList.remove('hidden');
                    userEmailSpan.textContent = '';
                }
                updateSaveButtonState();
            });

            const handleAuthAction = async (action) => {
                const email = emailInput.value;
                const password = passwordInput.value;
                authErrorDiv.classList.add('hidden');
                try {
                    await action(auth, email, password);
                } catch (error) {
                    authErrorDiv.textContent = error.message;
                    authErrorDiv.classList.remove('hidden');
                }
            };
            
            signUpBtn.addEventListener('click', () => handleAuthAction(createUserWithEmailAndPassword));
            signInBtn.addEventListener('click', () => handleAuthAction(signInWithEmailAndPassword));
            logoutBtn.addEventListener('click', () => signOut(auth));

            // --- Firebase Firestore Logic ---
            const saveUserProfile = async () => {
                if (!currentUser) return;
                const profileData = {
                    codeforcesHandle: profileCodeforcesInput.value,
                    linkedinAccount: profileLinkedinInput.value,
                    icpcId: profileIcpcInput.value,
                    pictureUrl: profilePictureInput.value,
                };
                try {
                    const userDocRef = doc(db, "users", currentUser.uid);
                    await setDoc(userDocRef, {
                        email: currentUser.email,
                        profile: profileData,
                        createdAt: serverTimestamp()
                    }, { merge: true });
                    
                    profileMessageDiv.textContent = 'Profile saved successfully!';
                    profileMessageDiv.className = 'text-center text-sm mb-4 text-green-600';
                    profileMessageDiv.classList.remove('hidden');
                } catch (error) {
                    console.error("Error saving profile: ", error);
                    profileMessageDiv.textContent = `Error: ${error.message}`;
                    profileMessageDiv.className = 'text-center text-sm mb-4 text-red-600';
                    profileMessageDiv.classList.remove('hidden');
                }
            };
            
            const loadUserProfile = async () => {
                if (!currentUser) return;
                const userDocRef = doc(db, "users", currentUser.uid);
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists() && docSnap.data().profile) {
                    const profile = docSnap.data().profile;
                    profileCodeforcesInput.value = profile.codeforcesHandle || '';
                    profileLinkedinInput.value = profile.linkedinAccount || '';
                    profileIcpcInput.value = profile.icpcId || '';
                    profilePictureInput.value = profile.pictureUrl || '';
                }
            };
            
            const saveSelectedResultsToDB = async () => {
                if (!currentUser) {
                    displayError("You must be logged in to save results.");
                    return;
                }
                const selectedCheckboxes = resultsTableBody.querySelectorAll('.result-checkbox:checked');
                if (selectedCheckboxes.length === 0) {
                    displayError("No users selected to save.");
                    return;
                }
                
                displayError("Saving selected users to database...");

                let savedCount = 0;
                const promises = [];

                selectedCheckboxes.forEach(checkbox => {
                    const handle = checkbox.dataset.handle;
                    const userData = cachedUserData.find(u => u.handle.toLowerCase() === handle.toLowerCase() && !u.error);
                    if (userData) {
                        // Create a clean object for Firestore, removing large data arrays
                        const { allRatingChanges, allSubmissions, userInfo, ...dataToSave } = userData;
                        
                        const docRef = doc(db, `analysis_history/${handle.toLowerCase()}/entries`, Date.now().toString());
                        const promise = setDoc(docRef, {
                            ...dataToSave,
                            savedBy: currentUser.uid,
                            savedAt: serverTimestamp()
                        }).then(() => {
                            savedCount++;
                        });
                        promises.push(promise);
                    }
                });

                await Promise.all(promises);

                if (savedCount > 0) {
                    displayError(`Successfully saved ${savedCount} user(s) to the database.`);
                } else {
                    displayError("Could not save any users. Make sure they have been processed first.");
                }
            };

            saveSelectedBtn.addEventListener('click', saveSelectedResultsToDB);

            // --- Modal Controls ---
            const toggleModal = (modal, show) => {
                const overlay = modal.querySelector('.modal-overlay');
                const content = modal.querySelector('.modal-content');
                if (show) {
                    modal.classList.remove('hidden');
                    setTimeout(() => {
                        if(overlay) overlay.classList.remove('opacity-0');
                        if(content) content.classList.remove('scale-95');
                    }, 10);
                } else {
                    if(overlay) overlay.classList.add('opacity-0');
                    if(content) content.classList.add('scale-95');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                }
            };

            loginBtn.addEventListener('click', () => toggleModal(authModal, true));
            closeAuthModalBtn.addEventListener('click', () => toggleModal(authModal, false));
            authModal.addEventListener('click', (e) => { if (e.target === authModal) toggleModal(authModal, false); });
            
            profileBtn.addEventListener('click', () => {
                loadUserProfile();
                toggleModal(profileModal, true);
            });
            closeProfileModalBtn.addEventListener('click', () => toggleModal(profileModal, false));
            profileModal.addEventListener('click', (e) => { if (e.target === profileModal) toggleModal(profileModal, false); });
            saveProfileBtn.addEventListener('click', saveUserProfile);

            // --- Existing App Logic (with modifications) ---
            const apiQueue = {
                requests: [],
                isProcessing: false,
                delay: 1100,
                add(url) {
                    return new Promise((resolve, reject) => {
                        this.requests.push({ url, resolve, reject });
                        if (!this.isProcessing) this.processNext();
                    });
                },
                async processNext() {
                    if (this.requests.length === 0) {
                        this.isProcessing = false;
                        return;
                    }
                    this.isProcessing = true;
                    const { url, resolve, reject } = this.requests.shift();
                    try {
                        const response = await fetch(url);
                        if (!response.ok) throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                        const data = await response.json();
                        if (data.status === 'FAILED') throw new Error(`Codeforces API error: ${data.comment}`);
                        resolve(data);
                    } catch (error) {
                        reject(error);
                    }
                    setTimeout(() => this.processNext(), this.delay);
                }
            };

            const sigmoid = (x) => 1 / (1 + Math.exp(-x));
            const logisticCurve = (x, L, k, x0) => L / (1 + Math.exp(-k * (x - x0)));
            
            // --- All scoring and calculation functions remain the same as the original file ---
            function getScoreFromMaxRating(maxRating) { return logisticCurve(maxRating, 60, 0.01, 1750); }
            function getScoreFromAvgRating(avgRating) { return logisticCurve(avgRating, 50, 0.012, 1650); }
            function getScoreFromContestCount(contestCount) { return logisticCurve(contestCount, 25, 0.06, 60); }
            function getScoreFromAvgDiv2Performance(avgScore) { return logisticCurve(avgScore, 100, 0.3, 10); } 
            function getCombinedLunaScore(lunaNovaScore, lunaHardScore) {
                const combinedRaw = (lunaNovaScore * 0.5) + (lunaHardScore * 1.5);
                return logisticCurve(combinedRaw, 50, 0.025, 300);
            }
            function getScoreFromPlacements(placements) {
                if (!placements || placements.length === 0) return 0;
                const invertedScores = placements.map(p => 100 - p);
                const sumOfSquares = invertedScores.reduce((acc, score) => acc + score * score, 0);
                const rms = Math.sqrt(sumOfSquares / invertedScores.length);
                return logisticCurve(rms, 70, 0.08, 75);
            }
            function getRecencyWeightedSolvedProblemScore(submissions) {
                let score = 0;
                const solvedProblemIds = new Set();
                const now = Date.now() / 1000;
                const DECAY_CONSTANT = 0.005; 
                const RATING_BASE = 1200;
                const GROWTH_FACTOR = 1.15;
                const sortedSubmissions = submissions.sort((a, b) => b.creationTimeSeconds - a.creationTimeSeconds);
                for (const sub of sortedSubmissions) {
                    if (sub.verdict !== 'OK' || !sub.problem.rating) continue;
                    const problemId = `${sub.problem.contestId || 'gym'}-${sub.problem.index}`;
                    if (solvedProblemIds.has(problemId)) continue;
                    solvedProblemIds.add(problemId);
                    const daysOld = (now - sub.creationTimeSeconds) / (60 * 60 * 24);
                    const recencyWeight = Math.exp(-DECAY_CONSTANT * daysOld);
                    const problemScore = Math.pow(GROWTH_FACTOR, (sub.problem.rating - RATING_BASE) / 100);
                    score += problemScore * recencyWeight;
                }
                return logisticCurve(score, 40, 0.002, 1500);
            }
            function calculateActivityAndInactivityMetrics(submissions) {
                const oneDay = 24 * 60 * 60 * 1000;
                const now = Date.now();
                const DECAY_CONSTANT = 0.003;
                const dailyActivity = new Map();
                submissions.forEach(sub => {
                    if (sub.verdict === 'OK') {
                        const date = new Date(sub.creationTimeSeconds * 1000);
                        date.setHours(0, 0, 0, 0);
                        const dateStr = date.toISOString().split('T')[0];
                        if (!dailyActivity.has(dateStr)) {
                            dailyActivity.set(dateStr, { count: 0, timestamp: date.getTime() });
                        }
                        dailyActivity.get(dateStr).count++;
                    }
                });
                let rawActivityScore = 0;
                for (const data of dailyActivity.values()) {
                    const daysOld = (now - data.timestamp) / oneDay;
                    const recencyWeight = Math.exp(-DECAY_CONSTANT * daysOld);
                    const dailyContribution = Math.sqrt(data.count); 
                    rawActivityScore += dailyContribution * recencyWeight;
                }
                const uniqueActiveDays = dailyActivity.size;
                if (uniqueActiveDays < 3) return { rawActivityScore, uniqueActiveDays, inactivityScore: 100, avgGap: 365, stdDevGap: 0 };
                const sortedTimestamps = Array.from(dailyActivity.values()).map(d => d.timestamp).sort((a, b) => a - b);
                const gaps = [];
                for (let i = 1; i < sortedTimestamps.length; i++) {
                    gaps.push((sortedTimestamps[i] - sortedTimestamps[i-1]) / oneDay);
                }
                const sumGaps = gaps.reduce((acc, val) => acc + val, 0);
                const avgGap = sumGaps / gaps.length;
                const variance = gaps.reduce((acc, val) => acc + Math.pow(val - avgGap, 2), 0) / gaps.length;
                const stdDevGap = Math.sqrt(variance);
                const lastSubTimestamp = sortedTimestamps[sortedTimestamps.length - 1];
                const recencyGap = (now - lastSubTimestamp) / oneDay;
                const rawPenalty = avgGap + (2 * stdDevGap) + (1.5 * recencyGap);
                const inactivityScore = logisticCurve(rawPenalty, 100, 0.1, 40);
                return { rawActivityScore, uniqueActiveDays, inactivityScore, avgGap, stdDevGap };
            }
            function getScoreFromActivity(rawActivityScore) { return logisticCurve(rawActivityScore, 50, 0.1, 50); }
            function calculateReadinessProbability(stats) {
                let { scoreMaxRating, scoreAvgRating, scoreContestCount, scoreFromCombinedLuna, scoreFromPlacements, scoreFromAvgDiv2Performance, scoreWeightedSolvedProblems, scoreFromActivity, inactivityScore } = stats;
                if (!stats.isTrusted) {
                    const cfPenaltyFactor = 0.1, manualPenaltyFactor = 0.8;
                    scoreMaxRating *= cfPenaltyFactor; scoreAvgRating *= cfPenaltyFactor; scoreContestCount *= cfPenaltyFactor;
                    scoreFromAvgDiv2Performance *= cfPenaltyFactor; scoreWeightedSolvedProblems *= cfPenaltyFactor;
                    scoreFromActivity *= cfPenaltyFactor; scoreFromCombinedLuna *= manualPenaltyFactor; inactivityScore *= 0.5; 
                }
                const z = weights.bias + (scoreMaxRating * weights.maxRating) + (scoreAvgRating * weights.avgRating) + (scoreContestCount * weights.contestCount) + (scoreFromCombinedLuna * weights.lunaScore) + (scoreFromPlacements * weights.placementScore) + (scoreFromAvgDiv2Performance * weights.avgDiv2PerfScore) + (scoreWeightedSolvedProblems * weights.weightedSolves) + (scoreFromActivity * weights.activityScore) + (inactivityScore * weights.inactivityPattern) + (stats.skippedSubmissionsCount * weights.skipped);
                return sigmoid(z);
            }
            
            function addManualUserToList() {
                const handle = handleInput.value.trim();
                const lunaNovaScore = parseFloat(lunaNovaScoreInput.value) || 0;
                const lunaHardScore = parseFloat(lunaHardScoreInput.value) || 0;
                const placementsStr = placementsInput.value.trim();
                const isTrusted = trustedUserInput.checked;

                if (!handle) { displayError('Please enter a Codeforces handle.'); return; }
                const placements = placementsStr.split(',').map(p => parseFloat(p.trim())).filter(p => !isNaN(p));
                
                const normalizedHandle = handle.toLowerCase();
                if (usersToAnalyze.some(user => user.handle.toLowerCase() === normalizedHandle)) {
                    displayError(`User "${handle}" is already in the list.`); return;
                }

                usersToAnalyze.push({ handle, lunaNovaScore, lunaHardScore, placements, isTrusted });
                updateUserListDisplay();
                handleInput.value = ''; lunaNovaScoreInput.value = ''; lunaHardScoreInput.value = ''; placementsInput.value = '';
                trustedUserInput.checked = true;
                hideError();
            }

            function loadCSVFile() {
                const file = csvFileInput.files[0];
                if (!file) { displayError('Please select a CSV file.'); return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try { parseCSV(e.target.result); hideError(); } 
                    catch (error) { displayError(`Error parsing CSV: ${error.message}`); }
                };
                reader.readAsText(file);
            }

            function parseCSV(csvString) {
                const lines = csvString.trim().split('\n');
                if (lines.length === 0) throw new Error('CSV file is empty or invalid.');
                const newUsersFromCsv = [];
                const startLine = lines[0].toLowerCase().includes('handle') ? 1 : 0;
                for(let i = startLine; i < lines.length; i++) {
                    const line = lines[i];
                    const parts = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                    if (parts.length < 4) continue;
                    const handle = parts[0]?.trim();
                    const lunaNovaScore = parseFloat(parts[1]?.trim()) || 0;
                    const lunaHardScore = parseFloat(parts[2]?.trim()) || 0;
                    const placementsStr = parts[3]?.trim().replace(/"/g, ''); 
                    if (!handle || !placementsStr) continue;
                    const placements = placementsStr.split(/[;,]/).map(p => parseFloat(p.trim())).filter(p => !isNaN(p));
                    if (placements.length === 0 || !placements.every(p => p >= 0 && p <= 100)) continue;
                    const normalizedHandle = handle.toLowerCase();
                    if (usersToAnalyze.some(u => u.handle.toLowerCase() === normalizedHandle)) continue;
                    newUsersFromCsv.push({ handle, lunaNovaScore, lunaHardScore, placements, isTrusted: true });
                }
                if (newUsersFromCsv.length === 0) throw new Error('No valid new users found in CSV.');
                usersToAnalyze.push(...newUsersFromCsv);
                updateUserListDisplay();
                displayError(`Loaded ${newUsersFromCsv.length} new users. Total: ${usersToAnalyze.length}`);
                csvFileInput.value = '';
            }

            function updateUserListDisplay() {
                userList.innerHTML = '';
                userCount.textContent = usersToAnalyze.length;
                downloadUserListBtn.disabled = usersToAnalyze.length === 0;
                noUsersMessage.classList.toggle('hidden', usersToAnalyze.length > 0);
                
                usersToAnalyze.forEach((user, index) => {
                    const handleClass = user.isTrusted ? 'font-semibold' : 'font-semibold text-red-600';
                    const listItem = document.createElement('li');
                    listItem.className = 'p-2 bg-gray-50 rounded-md text-sm flex justify-between items-center border border-gray-200';
                    listItem.innerHTML = `
                        <div class="flex items-center gap-2">
                            <input type="checkbox" data-index="${index}" class="user-trust-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${user.isTrusted ? 'checked' : ''}>
                            <span><span class="${handleClass}">${user.handle}</span> (Luna: ${user.lunaNovaScore}/${user.lunaHardScore})</span>
                        </div>
                        <button data-index="${index}" class="remove-list-btn text-red-500 hover:text-red-700 font-bold px-2">Ã—</button>`;
                    userList.appendChild(listItem);
                });
            }
            
            async function processAllUsers() {
                if (usersToAnalyze.length === 0) { displayError('Please add users to the list first.'); return; }
                resultsContainer.classList.remove('hidden');
                hideError();
                showLoading();
                const usersToProcess = usersToAnalyze.filter(user => {
                    const cachedUser = cachedUserData.find(cached => cached.handle.toLowerCase() === user.handle.toLowerCase() && !cached.error);
                    return !cachedUser || cachedUser.isTrusted !== user.isTrusted || cachedUser.lunaNovaScore !== user.lunaNovaScore || cachedUser.lunaHardScore !== user.lunaHardScore;
                });
                if (usersToProcess.length === 0) { hideLoading(); displayError("All users in the list are up-to-date."); return; }
                for (let i = 0; i < usersToProcess.length; i++) {
                    const user = usersToProcess[i];
                    document.querySelector('#loadingIndicator p:first-child').textContent = `Processing user ${i + 1} of ${usersToProcess.length}: ${user.handle}...`;
                    let row = document.getElementById(`row-${user.handle.toLowerCase()}`);
                    if (!row) { row = resultsTableBody.insertRow(); row.id = `row-${user.handle.toLowerCase()}`; }
                    await processSingleUser(user, row);
                }
                hideLoading();
                downloadResultsBtn.disabled = cachedUserData.filter(d => !d.error).length === 0;
                updateTableView();
            }
            
            async function processSingleUser(user, rowElement) {
                rowElement.innerHTML = `<td colspan="6" class="px-4 py-3 text-center text-gray-500"><div class="flex items-center justify-center gap-2"><div class="spinner h-4 w-4 rounded-full border-2 border-gray-200"></div><span>Processing ${user.handle}...</span></div></td>`;
                try {
                    const userData = await fetchStatsForHandle(user.handle, user.lunaNovaScore, user.lunaHardScore, user.placements, user.isTrusted);
                    const cacheIndex = cachedUserData.findIndex(data => data.handle.toLowerCase() === user.handle.toLowerCase());
                    if (cacheIndex > -1) cachedUserData[cacheIndex] = userData; else cachedUserData.push(userData);
                    updateTableRow(rowElement, userData);
                } catch (error) {
                    console.error(`Error fetching stats for ${user.handle}:`, error);
                    const errorData = { handle: user.handle, error: `API Error: ${error.message.substring(0, 60)}...` };
                    const cacheIndex = cachedUserData.findIndex(data => data.handle.toLowerCase() === user.handle.toLowerCase());
                    if (cacheIndex > -1) cachedUserData[cacheIndex] = errorData; else cachedUserData.push(errorData);
                    updateTableRow(rowElement, errorData);
                }
            }
            
            async function fetchStatsForHandle(handle, lunaNovaScore, lunaHardScore, placements, isTrusted) {
                if (handle == 'MrMoon') throw new Error("MrMoon is off the grid");
                const userInfoData = await apiQueue.add(`https://codeforces.com/api/user.info?handles=${handle}`);
                const userRatingData = await apiQueue.add(`https://codeforces.com/api/user.rating?handle=${handle}`);
                const userStatusData = await apiQueue.add(`https://codeforces.com/api/user.status?handle=${handle}&from=1&count=5000`);
                const userInfo = userInfoData.result[0];
                const allRatingChanges = userRatingData.result;
                const allSubmissions = userStatusData.result;
                const totalContestCount = allRatingChanges.length;
                const sumRatings = allRatingChanges.reduce((acc, curr) => acc + curr.newRating, 0);
                const averageContestRating = totalContestCount > 0 ? (sumRatings / totalContestCount) : 0;
                const maxRating = totalContestCount > 0 ? Math.max(...allRatingChanges.map(c => c.newRating)) : 0;
                const skippedSubmissionsCount = allSubmissions.filter(s => s.verdict === 'SKIPPED').length;
                const div2Contests = allRatingChanges.filter(c => c.contestName.includes('Div. 2'));
                const div2ContestIds = new Set(div2Contests.map(c => c.contestId));
                const div2Submissions = allSubmissions.filter(s => div2ContestIds.has(s.contestId));
                const div2ContestCount = div2Contests.length;
                const avgDiv2PerformanceScore = calculateAvgDiv2PerformanceScore(div2Submissions, div2ContestCount);
                const avgPlacement = placements.length > 0 ? placements.reduce((a, b) => a + b, 0) / placements.length : 0;
                const { rawActivityScore, uniqueActiveDays, inactivityScore, avgGap, stdDevGap } = calculateActivityAndInactivityMetrics(allSubmissions);
                const stats = { handle, maxRating, averageContestRating, totalContestCount, lunaNovaScore, lunaHardScore, placements, avgPlacement, div2ContestCount, avgDiv2PerformanceScore, skippedSubmissionsCount, rawActivityScore, uniqueActiveDays, inactivityScore, avgGap, stdDevGap, isTrusted, scoreFromPlacements: getScoreFromPlacements(placements), scoreFromCombinedLuna: getCombinedLunaScore(lunaNovaScore, lunaHardScore), scoreMaxRating: getScoreFromMaxRating(maxRating), scoreAvgRating: getScoreFromAvgRating(averageContestRating), scoreContestCount: getScoreFromContestCount(totalContestCount), scoreWeightedSolvedProblems: getRecencyWeightedSolvedProblemScore(allSubmissions), scoreFromAvgDiv2Performance: getScoreFromAvgDiv2Performance(avgDiv2PerformanceScore), scoreFromActivity: getScoreFromActivity(rawActivityScore), userInfo, allRatingChanges, allSubmissions };
                const readinessProbability = calculateReadinessProbability(stats);
                return { ...stats, readinessProbability };
            }

            function calculateAvgDiv2PerformanceScore(div2Submissions, div2ContestCount) {
                if (!div2Submissions || div2Submissions.length === 0 || div2ContestCount === 0) return 0;
                const solvedInDiv2 = {};
                for (const sub of div2Submissions) {
                    if (sub.verdict === 'OK') {
                        if (!solvedInDiv2[sub.contestId]) solvedInDiv2[sub.contestId] = new Set();
                        solvedInDiv2[sub.contestId].add(sub.problem.index);
                    }
                }
                const problemWeights = { 'A': 1, 'B': 2, 'C': 4, 'D': 8, 'E': 12, 'F': 16 };
                let totalPerformanceScore = 0;
                for (const contestId in solvedInDiv2) {
                    const contestScore = Array.from(solvedInDiv2[contestId]).reduce((score, problemIndex) => score + (problemWeights[problemIndex.charAt(0).toUpperCase()] || 0), 0);
                    totalPerformanceScore += contestScore;
                }
                return totalPerformanceScore / div2ContestCount;
            }

            function updateTableView() {
                let filteredData = cachedUserData.filter(user => {
                    if (user.error) return true;
                    if (activeFilter === 'all') return true;
                    return getConfidenceCategory(user.readinessProbability) === activeFilter;
                });
                const { key, direction } = sortState;
                const sortedData = [...filteredData].sort((a, b) => {
                    if (a.error) return 1; if (b.error) return -1;
                    const valA = a[key], valB = b[key];
                    if (typeof valA === 'string') return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    return direction === 'asc' ? valA - valB : valB - valA;
                });
                resultsTableBody.innerHTML = '';
                sortedData.forEach(userData => {
                    const row = resultsTableBody.insertRow();
                    row.id = `row-${userData.handle.toLowerCase()}`;
                    updateTableRow(row, userData);
                });
                updateSortIndicators();
                updateSaveButtonState();
            }

            function updateSortIndicators() {
                resultsTableHeader.querySelectorAll('th.sortable-header').forEach(th => {
                    th.classList.remove('sort-asc', 'sort-desc');
                    if (th.dataset.sortKey === sortState.key) {
                        th.classList.add(`sort-${sortState.direction}`);
                    }
                });
            }
            
            function updateTableRow(row, userData) {
                if (userData.error) {
                    row.innerHTML = `
                        <td></td>
                        <td class="px-4 py-3 font-semibold">${userData.handle}</td>
                        <td colspan="3" class="px-4 py-3 text-red-600">${userData.error}</td>
                        <td class="px-4 py-3 text-center">
                            <button class="retry-btn bg-blue-100 text-blue-700 text-xs font-bold py-1 px-3 rounded-full hover:bg-blue-200" data-handle="${userData.handle}">Retry</button>
                        </td>`;
                    return;
                }

                const probability = userData.readinessProbability * 100;
                let probClass = '', confidence = 'Low';
                const category = getConfidenceCategory(userData.readinessProbability);
                if (category === 'very-high') { probClass = 'bg-green-100 text-green-800'; confidence = 'Very High'; }
                else if (category === 'high') { probClass = 'bg-emerald-100 text-emerald-800'; confidence = 'High'; }
                else if (category === 'medium') { probClass = 'bg-yellow-100 text-yellow-800'; confidence = 'Medium'; }
                else { probClass = 'bg-red-100 text-red-800'; }
                
                const handleClass = userData.isTrusted ? 'font-semibold' : 'font-semibold text-red-600';

                row.innerHTML = `
                    <td class="px-2 py-3 text-center"><input type="checkbox" class="result-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-handle="${userData.handle}"></td>
                    <td class="px-4 py-3 whitespace-nowrap ${handleClass}">${userData.handle}</td>
                    <td class="px-4 py-3 whitespace-nowrap font-bold text-center">${userData.scoreFromAvgDiv2Performance.toFixed(2)}</td>
                    <td class="px-4 py-3 whitespace-nowrap">Top ${userData.avgPlacement.toFixed(1)}%</td>
                    <td class="px-4 py-3 whitespace-nowrap text-center rounded-md ${probClass}">
                        <div class="font-bold text-lg">${probability.toFixed(2)}%</div>
                        <div class="text-xs font-semibold">${confidence}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-center">
                        <button class="details-btn bg-indigo-100 text-indigo-700 text-xs font-bold py-1 px-3 rounded-full hover:bg-indigo-200" data-handle="${userData.handle}">Details</button>
                        <button class="remove-result-btn text-red-500 hover:text-red-700 font-bold px-2 ml-2" data-handle="${userData.handle}" title="Remove User">Ã—</button>
                    </td>
                `;
            }

            function updateSaveButtonState() {
                const hasResults = cachedUserData.filter(d => !d.error).length > 0;
                const hasSelection = resultsTableBody.querySelector('.result-checkbox:checked');
                saveSelectedBtn.disabled = !currentUser || !hasResults || !hasSelection;
            }

            function getConfidenceCategory(p) { if (p >= 0.85) return 'very-high'; if (p >= 0.65) return 'high'; if (p >= 0.40) return 'medium'; return 'low'; }
            function displayError(message) { errorMessageDiv.textContent = message; errorMessageDiv.classList.remove('hidden'); }
            function hideError() { errorMessageDiv.classList.add('hidden'); }
            function showLoading() { loadingIndicator.classList.remove('hidden'); document.querySelectorAll('button, input, select').forEach(el => el.disabled = true); }
            function hideLoading() { loadingIndicator.classList.add('hidden'); document.querySelectorAll('button, input, select').forEach(el => el.disabled = false); updateSaveButtonState(); }
            
            function formatAccountAge(registrationTimeSeconds) {
                const registrationDate = new Date(registrationTimeSeconds * 1000);
                const now = new Date();
                const diffMillis = now.getTime() - registrationDate.getTime();
                const diffDays = diffMillis / (1000 * 3600 * 24);
                if (diffDays < 1) return `Less than a day`;
                if (diffDays < 30.44) return `${Math.floor(diffDays)} day(s)`;
                if (diffDays < 365.25) return `${(diffDays / 30.44).toFixed(0)} month(s)`;
                return `${(diffDays / 365.25).toFixed(1)} year(s)`;
            }

            function createActivityHeatmap(submissions) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const oneYearAgo = new Date(today);
                oneYearAgo.setFullYear(today.getFullYear() - 1);

                const activity = new Map();
                submissions.forEach(sub => {
                    if (sub.verdict === 'OK') {
                        const date = new Date(sub.creationTimeSeconds * 1000);
                        date.setHours(0, 0, 0, 0);
                        const dateStr = date.toISOString().split('T')[0];
                        activity.set(dateStr, (activity.get(dateStr) || 0) + 1);
                    }
                });

                const daySize = 12;
                const weekWidth = daySize + 2;
                const monthLabelHeight = 20;
                const svgWidth = weekWidth * 53;
                const svgHeight = (daySize + 2) * 7 + monthLabelHeight;
                
                let svg = `<svg width="${svgWidth}" height="${svgHeight}" class="mx-auto">`;
                svg += `<g transform="translate(0, ${monthLabelHeight})">`;

                const colors = ['#ebedf0', '#9be9a8', '#40c463', '#30a14e', '#216e39'];
                let maxActivity = 0;
                activity.forEach(count => { maxActivity = Math.max(maxActivity, count) });

                const monthLabels = [];

                for (let i = 0; i < 365; i++) {
                    const date = new Date(oneYearAgo);
                    date.setDate(oneYearAgo.getDate() + i);
                    if (date > today) continue;

                    const dayOfWeek = date.getDay();
                    const weekOfYear = Math.floor((date - oneYearAgo) / (1000 * 60 * 60 * 24 * 7));
                    
                    const x = weekOfYear * weekWidth;
                    const y = dayOfWeek * (daySize + 2);

                    const dateStr = date.toISOString().split('T')[0];
                    const count = activity.get(dateStr) || 0;
                    
                    let colorIndex = 0;
                    if (count > 0) {
                        colorIndex = Math.min(colors.length - 1, Math.ceil(count / maxActivity * (colors.length - 1)));
                    }

                    svg += `<rect class="heatmap-day" width="${daySize}" height="${daySize}" x="${x}" y="${y}" fill="${colors[colorIndex]}" rx="2" ry="2" data-date="${dateStr}" data-count="${count}">
                                <title>${count} submissions on ${date.toDateString()}</title>
                            </rect>`;
                    
                    if (date.getDate() === 1) {
                        monthLabels.push({ x, month: date.toLocaleString('default', { month: 'short' }) });
                    }
                }
                svg += `</g>`;
                
                svg += `<g class="text-xs text-gray-500">`;
                monthLabels.forEach(label => {
                     svg += `<text x="${label.x}" y="${monthLabelHeight - 5}">${label.month}</text>`;
                });
                svg += `</g>`;

                svg += `</svg>`;
                return svg;
            }

            function createRatingChart(ratingData) {
                const ctx = document.getElementById('ratingChartCanvas').getContext('2d');
                const labels = ratingData.map(d => new Date(d.ratingUpdateTimeSeconds * 1000).toLocaleDateString());
                const data = ratingData.map(d => d.newRating);
                if (ratingChart) ratingChart.destroy();
                ratingChart = new Chart(ctx, {
                    type: 'line', data: { labels: labels, datasets: [{ label: 'Rating', data: data, borderColor: 'rgb(75, 192, 192)', tension: 0.1, fill: false }] },
                    options: { responsive: true, maintainAspectRatio: true }
                });
            }

            function createProblemDistributionChart(submissionData) {
                const ctx = document.getElementById('problemChartCanvas').getContext('2d');
                const solvedProblems = new Map();
                submissionData.forEach(sub => {
                    if (sub.verdict === 'OK' && sub.problem.rating) {
                        const problemId = `${sub.problem.contestId}-${sub.problem.index}`;
                        solvedProblems.set(problemId, sub.problem.rating);
                    }
                });
                const ratingBuckets = {};
                for (let rating = 800; rating <= 3500; rating += 100) { ratingBuckets[rating] = 0; }
                solvedProblems.forEach(rating => {
                    const bucket = Math.floor(rating / 100) * 100;
                    if (ratingBuckets[bucket] !== undefined) { ratingBuckets[bucket]++; }
                });
                if (problemChart) problemChart.destroy();
                problemChart = new Chart(ctx, {
                    type: 'bar', data: { labels: Object.keys(ratingBuckets), datasets: [{ label: '# of Solved Problems', data: Object.values(ratingBuckets), backgroundColor: 'rgba(153, 102, 255, 0.6)' }] },
                    options: { scales: { y: { beginAtZero: true } }, responsive: true, maintainAspectRatio: true }
                });
            }

            function populateCalculationDetails(data) {
                const container = document.getElementById('calculationDetails');
                const p = (num) => num.toFixed(2);
                const p3 = (num) => num.toFixed(3);

                const cfPenaltyFactor = data.isTrusted ? 1.0 : 0.1;
                const manualPenaltyFactor = data.isTrusted ? 1.0 : 0.8;
                let inactivityScore = data.inactivityScore;
                if(!data.isTrusted) inactivityScore *= 0.5;

                const weightedMaxRating = (data.scoreMaxRating * cfPenaltyFactor) * weights.maxRating;
                const weightedAvgRating = (data.scoreAvgRating * cfPenaltyFactor) * weights.avgRating;
                const weightedContestCount = (data.scoreContestCount * cfPenaltyFactor) * weights.contestCount;
                const weightedDiv2Perf = (data.scoreFromAvgDiv2Performance * cfPenaltyFactor) * weights.avgDiv2PerfScore;
                const weightedActivity = (data.scoreFromActivity * cfPenaltyFactor) * weights.activityScore;
                const weightedSolvedProblems = (data.scoreWeightedSolvedProblems * cfPenaltyFactor) * weights.weightedSolves;
                const weightedPlacements = (data.scoreFromPlacements * manualPenaltyFactor) * weights.placementScore;
                const weightedLuna = (data.scoreFromCombinedLuna * manualPenaltyFactor) * weights.lunaScore;
                const inactivityPenalty = inactivityScore * weights.inactivityPattern;
                const skippedPenalty = data.skippedSubmissionsCount * weights.skipped;
                const bias = weights.bias;

                let breakdownHtml = `
                    <div class="grid grid-cols-3 gap-x-4 text-xs font-mono mb-2 text-gray-500 border-b border-gray-200 pb-1">
                        <span class="font-semibold">Factor</span>
                        <span class="font-semibold text-right">Norm. Score</span>
                        <span class="font-semibold text-right">Contribution</span>
                    </div>
                    <div class="space-y-1">
                `;

                const createRow = (label, score, contribution) => {
                    const contributionClass = contribution >= 0 ? 'text-green-600' : 'text-red-600';
                    return `
                        <div class="grid grid-cols-3 gap-x-4 items-center">
                            <strong class="text-sm font-normal">${label}</strong>
                            <span class="font-mono text-sm text-right">${p(score)}</span>
                            <span class="font-mono text-sm font-bold text-right ${contributionClass}">${contribution > 0 ? '+' : ''}${p3(contribution)}</span>
                        </div>
                    `;
                };

                breakdownHtml += createRow('Max Rating', data.scoreMaxRating, weightedMaxRating);
                breakdownHtml += createRow('Avg Rating', data.scoreAvgRating, weightedAvgRating);
                breakdownHtml += createRow('Contest Count', data.scoreContestCount, weightedContestCount);
                breakdownHtml += createRow('Div. 2 Perf.', data.scoreFromAvgDiv2Performance, weightedDiv2Perf);
                breakdownHtml += createRow('Activity Score', data.scoreFromActivity, weightedActivity);
                breakdownHtml += createRow('Solved Problems', data.scoreWeightedSolvedProblems, weightedSolvedProblems);
                breakdownHtml += createRow('Placements (RMS)', data.scoreFromPlacements, weightedPlacements);
                breakdownHtml += createRow('Luna (Combined)', data.scoreFromCombinedLuna, weightedLuna);
                breakdownHtml += `</div>`;

                breakdownHtml += `<hr class="my-2 border-dashed"/>`;
                breakdownHtml += `<div class="space-y-1">`;
                breakdownHtml += createRow('Inactivity Penalty', data.inactivityScore, inactivityPenalty);
                breakdownHtml += createRow('Skipped Penalty', data.skippedSubmissionsCount, skippedPenalty);
                breakdownHtml += createRow('Model Bias', 1, bias);
                breakdownHtml += `</div>`;

                const totalZ = bias + weightedMaxRating + weightedAvgRating + weightedContestCount + weightedDiv2Perf + weightedActivity + weightedSolvedProblems + weightedPlacements + weightedLuna + inactivityPenalty + skippedPenalty;

                breakdownHtml += `<hr class="my-2"/>`;
                breakdownHtml += `
                    <div class="grid grid-cols-3 gap-x-4 items-center mt-2">
                            <strong class="text-sm col-span-2">Pre-Sigmoid Sum (z)</strong>
                            <span class="font-mono font-bold text-right col-span-1 text-base">${p3(totalZ)}</span>
                    </div>
                    <div class="grid grid-cols-3 gap-x-4 items-center mt-2 bg-gray-100 p-2 rounded-md">
                            <strong class="text-base col-span-2">Final Probability</strong>
                            <span class="font-mono font-bold text-right col-span-1 text-xl">${p(data.readinessProbability * 100)}%</span>
                    </div>
                `;

                container.innerHTML = breakdownHtml;
            }
            
            function populatePenaltiesDetails(data) {
                const container = document.getElementById('penaltiesDetails');
                const p3 = (num) => num.toFixed(3);

                let penaltyHtml = `
                    <p><strong>Raw Activity Score:</strong> <span class="font-mono font-bold float-right">${data.rawActivityScore.toFixed(2)}</span></p>
                    <p class="text-sm text-gray-500 mt-1">This score reflects recency-weighted daily submission volume.</p>
                    <hr class="my-2 border-gray-200"/>
                    <p><strong>Avg. Gap Between Active Days:</strong> <span class="font-mono font-bold float-right">${data.avgGap.toFixed(1)} days</span></p>
                    <p><strong>Consistency (Gap Std. Dev):</strong> <span class="font-mono font-bold float-right">${data.stdDevGap.toFixed(1)} days</span></p>
                    <p class="text-sm text-gray-500 mt-1">Lower average and standard deviation for gaps indicate better consistency.</p>
                    <hr class="my-2 border-gray-200"/>
                    <p><strong>Trusted User Status:</strong> <span class="font-mono font-bold float-right ${data.isTrusted ? 'text-green-600' : 'text-red-600'}">${data.isTrusted ? 'Trusted' : 'Not Trusted'}</span></p>
                    <p class="text-sm text-gray-500 mt-1">A significant penalty is applied if a user is not marked as trusted, reducing the contribution from their stats.</p>
                `;

                if (!data.isTrusted) {
                    const cfPenaltyFactor = 0.1;
                    const manualPenaltyFactor = 0.8;

                    const trustedCfScoreContribution =
                        (data.scoreMaxRating * weights.maxRating) +
                        (data.scoreAvgRating * weights.avgRating) +
                        (data.scoreContestCount * weights.contestCount) +
                        (data.scoreFromAvgDiv2Performance * weights.avgDiv2PerfScore) +
                        (data.scoreWeightedSolvedProblems * weights.weightedSolves) +
                        (data.scoreFromActivity * weights.activityScore);

                    const trustedManualScoreContribution =
                        (data.scoreFromCombinedLuna * weights.lunaScore) +
                        (data.scoreFromPlacements * weights.placementScore);

                    penaltyHtml += `
                            <hr class="my-2 border-gray-200"/>
                            <p class="font-semibold">Impact of "Not Trusted":</p>
                            <div class="text-sm space-y-1 mt-1">
                                <p>CF Stats Contribution: <span class="font-mono float-right">${p3(trustedCfScoreContribution * cfPenaltyFactor)} (reduced from ${p3(trustedCfScoreContribution)})</span></p>
                                <p>Manual Stats Contribution: <span class="font-mono float-right">${p3(trustedManualScoreContribution * manualPenaltyFactor)} (reduced from ${p3(trustedManualScoreContribution)})</span></p>
                            </div>
                    `;
                }
                 container.innerHTML = penaltyHtml;
            }

            function showUserDetailsModal(handle) {
                const userData = cachedUserData.find(d => d.handle.toLowerCase() === handle.toLowerCase() && !d.error);
                if (!userData) return;
                const { userInfo, allRatingChanges, allSubmissions } = userData;
                const registrationDate = new Date(userInfo.registrationTimeSeconds * 1000);
                const accountAge = formatAccountAge(userInfo.registrationTimeSeconds);
                const name = `${userInfo.firstName || ''} ${userInfo.lastName || ''}`.trim() || 'N/A';
                
                modalContentContainer.innerHTML = `
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold text-gray-900">${userInfo.handle}</h2>
                        <p class="text-md text-gray-600">Name: <span class="font-semibold">${name}</span></p>
                        <p class="text-md text-gray-600">Account Age: <span class="font-semibold">${accountAge}</span> (since ${registrationDate.toLocaleDateString()})</p>
                    </div>
                    <div class="mb-8">
                        <h3 class="text-xl font-bold mb-2">Submission Activity (Last Year)</h3>
                        <div id="activityHeatmapContainer" class="p-2 bg-gray-50 rounded-lg overflow-x-auto"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div>
                            <h3 class="text-xl font-bold mb-2">Rating History</h3>
                            <canvas id="ratingChartCanvas"></canvas>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-2">Solved Problem Distribution</h3>
                            <canvas id="problemChartCanvas"></canvas>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-xl font-bold mb-4">Calculation Breakdown</h3>
                            <div id="calculationDetails" class="space-y-3 text-sm bg-gray-50 p-4 rounded-lg"></div>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-4">Penalties & Other Factors</h3>
                            <div id="penaltiesDetails" class="space-y-3 text-sm bg-gray-50 p-4 rounded-lg"></div>
                        </div>
                    </div>
                `;

                document.getElementById('activityHeatmapContainer').innerHTML = createActivityHeatmap(allSubmissions);
                createRatingChart(allRatingChanges);
                createProblemDistributionChart(allSubmissions);
                populateCalculationDetails(userData);
                populatePenaltiesDetails(userData);

                toggleModal(detailsModal, true);
            }

            function hideModal() { 
                toggleModal(detailsModal, false); 
                if (ratingChart) ratingChart.destroy(); 
                if (problemChart) problemChart.destroy(); 
            }

            function getFormattedDateTimeString() {
                const now = new Date();
                const pad = (num) => num.toString().padStart(2, '0');
                const year = now.getFullYear();
                const month = pad(now.getMonth() + 1);
                const day = pad(now.getDate());
                const hours = pad(now.getHours());
                const minutes = pad(now.getMinutes());
                return `${year}${month}${day}_${hours}${minutes}`;
            }

            function downloadFile(content, fileName, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function downloadUserList() {
                if (usersToAnalyze.length === 0) { displayError('User list is empty.'); return; }
                const userRows = usersToAnalyze.map(user => {
                    const placementsStr = `"${user.placements.join(';')}"`;
                    return [user.handle, user.lunaNovaScore, user.lunaHardScore, placementsStr, user.isTrusted].join(',');
                });
                const userCsvString = "handle,luna_nova_score,luna_hard_score,placements,is_trusted\n" + userRows.join('\n');
                const fileName = `user_list_${getFormattedDateTimeString()}.csv`;
                downloadFile(userCsvString, fileName, 'text/csv;charset=utf-8;');
            }
            
            function downloadResults() {
                if (cachedUserData.filter(d => !d.error).length === 0) {
                    displayError('No processed results to download.');
                    return;
                }
                
                const tableRows = resultsTableBody.querySelectorAll('tr');
                let resultCsvString;
                let fileName;

                if (activeFilter !== 'all') {
                    const headers = ["Handle"];
                    const resultRows = [headers.join(',')];
                    tableRows.forEach(row => {
                        const handle = row.querySelector('td:nth-child(2)')?.textContent.split(' ')[0];
                        if (handle) {
                            const data = cachedUserData.find(d => d.handle === handle && !d.error);
                            if (data) resultRows.push(handle);
                        }
                    });
                    resultCsvString = resultRows.join('\n');
                    fileName = `filtered_handles_${activeFilter}_${getFormattedDateTimeString()}.csv`;
                } else {
                    const headers = ["Handle", "Is Trusted", "Readiness Probability (%)", "Confidence", "Norm. Div. 2 Perf Score", "Luna Nova Score", "Luna Hard Score", "Avg Placement (%)", "Total Contests", "Max Rating", "Avg Rating", "Unique Active Days", "Avg Gap (Days)", "Gap Std Dev"];
                    const resultRows = [headers.join(',')];
                    tableRows.forEach(row => {
                        const handle = row.querySelector('td:nth-child(2)')?.textContent.split(' ')[0];
                        if (!handle) return;
                        const data = cachedUserData.find(d => d.handle === handle && !d.error);
                        if (!data) return;
                        const probability = data.readinessProbability * 100;
                        let confidence = 'Low';
                        if (probability >= 85) { confidence = 'Very High'; }
                        else if (probability >= 65) { confidence = 'High'; }
                        else if (probability >= 40) { confidence = 'Medium'; }
                        const rowData = [
                            data.handle, 
                            data.isTrusted,
                            probability.toFixed(2),
                            confidence,
                            data.scoreFromAvgDiv2Performance.toFixed(2),
                            data.lunaNovaScore,
                            data.lunaHardScore,
                            data.avgPlacement.toFixed(1),
                            data.totalContestCount,
                            data.maxRating, 
                            data.averageContestRating.toFixed(0),
                            data.uniqueActiveDays,
                            data.avgGap.toFixed(1),
                            data.stdDevGap.toFixed(1)
                        ];
                        resultRows.push(rowData.join(','));
                    });
                     resultCsvString = resultRows.join('\n');
                     fileName = `readiness_results_${getFormattedDateTimeString()}.csv`;
                }
                
                downloadFile(resultCsvString, fileName, 'text/csv;charset=utf-8;');
            }

            function clearUserList() { 
                usersToAnalyze = []; 
                cachedUserData = []; 
                updateUserListDisplay(); 
                resultsTableBody.innerHTML = ''; 
                resultsContainer.classList.add('hidden'); 
                hideError(); 
                downloadResultsBtn.disabled = true; 
                updateSaveButtonState(); 
            }

            // --- Event Listeners ---
            addManualUserBtn.addEventListener('click', addManualUserToList);
            loadCsvBtn.addEventListener('click', loadCSVFile);
            clearListBtn.addEventListener('click', clearUserList);
            processAllBtn.addEventListener('click', processAllUsers);
            downloadResultsBtn.addEventListener('click', downloadResults);
            downloadUserListBtn.addEventListener('click', downloadUserList);
            readinessFilter.addEventListener('change', (e) => { activeFilter = e.target.value; updateTableView(); });
            closeModalBtn.addEventListener('click', hideModal);
            detailsModal.addEventListener('click', (e) => { if (e.target === detailsModal) hideModal(); });
            
            // Event delegation for dynamically added elements
            userList.addEventListener('click', e => {
                if (e.target.classList.contains('remove-list-btn')) {
                    usersToAnalyze.splice(parseInt(e.target.dataset.index, 10), 1);
                    updateUserListDisplay();
                }
            });
            userList.addEventListener('change', e => {
                if (e.target.classList.contains('user-trust-checkbox')) {
                    usersToAnalyze[parseInt(e.target.dataset.index, 10)].isTrusted = e.target.checked;
                    updateUserListDisplay();
                }
            });

            resultsTableBody.addEventListener('click', async (e) => {
                const button = e.target.closest('button');
                if (button) {
                    const handle = button.dataset.handle;
                    if (button.classList.contains('details-btn')) {
                        showUserDetailsModal(handle);
                    } else if (button.classList.contains('retry-btn')) {
                        const user = usersToAnalyze.find(u => u.handle.toLowerCase() === handle.toLowerCase());
                        const row = button.closest('tr');
                        if (user && row) {
                            await processSingleUser(user, row);
                            updateTableView();
                            downloadResultsBtn.disabled = cachedUserData.filter(d => !d.error).length === 0;
                        }
                    } else if (button.classList.contains('remove-result-btn')) {
                        const handleLower = handle.toLowerCase();
                        button.closest('tr').remove();
                        cachedUserData = cachedUserData.filter(u => u.handle.toLowerCase() !== handleLower);
                        usersToAnalyze = usersToAnalyze.filter(u => u.handle.toLowerCase() !== handleLower);
                        updateUserListDisplay();
                        downloadResultsBtn.disabled = cachedUserData.filter(d => !d.error).length === 0;
                    }
                }
                if (e.target.classList.contains('result-checkbox')) {
                    updateSaveButtonState();
                }
            });

            resultsTableHeader.addEventListener('click', (e) => {
                const header = e.target.closest('th.sortable-header');
                if (!header) return;
                const key = header.dataset.sortKey;
                let direction = 'desc';
                if (sortState.key === key) {
                    direction = sortState.direction === 'desc' ? 'asc' : 'desc';
                }
                sortState = { key, direction };
                updateTableView();
            });
            
            selectAllCheckbox.addEventListener('change', (e) => {
                resultsTableBody.querySelectorAll('.result-checkbox').forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
                updateSaveButtonState();
            });

            // Initial setup
            updateUserListDisplay();
            updateSortIndicators();
        });
    </script>
</body>
</html>

