<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operation Electi - Readiness Model v15</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .sortable-header {
            cursor: pointer;
            position: relative;
            user-select: none;
        }
        .sortable-header .sort-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.3;
        }
        .sortable-header.sort-asc .sort-icon, .sortable-header.sort-desc .sort-icon {
             opacity: 1;
        }
        .tab-btn.active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
        .editor-tab-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .stat-card {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #f9fafb;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
            z-index: 10;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        .dropdown-content a, .dropdown-content button {
            color: black;
            padding: 10px 14px;
            text-decoration: none;
            display: block;
            font-size: 0.875rem;
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
        }
        .dropdown-content a:hover, .dropdown-content button:hover {background-color: #e5e7eb;}
        .dropdown:hover .dropdown-content {display: block;}
        .file-input-label {
            cursor: pointer;
            display: inline-block;
            padding: 0.5rem 1rem;
            color: white;
            background-color: #4f46e5;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .file-input-label:hover {
            background-color: #4338ca;
        }
        input[type="file"] {
            display: none;
        }
        #detailedUserTable thead tr:nth-child(2) th, .editor-table thead tr:nth-child(2) th {
            padding: 0.5rem;
        }
        #detailedUserTable thead input[type="text"], .editor-table thead input[type="text"] {
            width: 100%;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
        }
        .editor-table input, .editor-table textarea, .editor-table select {
            width: 100%;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            background-color: #f9fafb;
        }
         .editor-table textarea {
            min-height: 60px;
         }
         #detailedUserForm input, #detailedUserForm select {
             width: 100%;
             padding: 6px 10px;
             border-radius: 0.375rem;
             border: 1px solid #d1d5db;
         }
         #detailedUserForm label {
             font-weight: 500;
             font-size: 0.875rem;
             color: #374151;
             margin-bottom: 0.25rem;
             display: block;
         }
         .sub-tab-btn.active {
            background-color: #e0e7ff;
            color: #4338ca;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-10">
            <div class="flex justify-center items-center gap-4 mb-2">
                <img src="https://i.ibb.co/JNyxxBv/logo.png" alt="Operation Electi Logo" class="h-16 w-16" onerror="this.onerror=null; this.src='https://placehold.co/64x64/e0e0e0/333?text=Logo';">
                <h1 class="text-5xl font-bold text-gray-900">Operation Electi</h1>
            </div>
            <p class="mt-2 text-lg text-gray-600">A readiness analysis and user management tool.</p>
        </header>

        <!-- Tab Controls -->
        <div class="mb-8 border-b border-gray-200">
            <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                <button id="tabBtnAnalysis" class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">
                    Readiness Analysis
                </button>
                <button id="tabBtnDatabase" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    User Database
                </button>
                 <button id="tabBtnEditors" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    Data Editors
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div id="tabContentAnalysis">
            <main class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Left Column: Inputs and Controls -->
                <div class="lg:col-span-4 space-y-6">
                    <!-- Manual User Input -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-bold mb-4">1. Add User Manually</h2>
                         <p class="text-sm text-gray-500 mb-3">Add users here to quickly get their readiness score. For more details, use the User Database tab.</p>
                        <div class="space-y-4">
                            <input type="text" id="handleInput" placeholder="Codeforces Handle" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <div class="grid grid-cols-2 gap-4">
                                <input type="number" step="0.01" id="lunaNovaScoreInput" placeholder="Luna Nova" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <input type="number" step="0.01" id="lunaHardScoreInput" placeholder="Luna" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <input type="text" id="placementsInput" placeholder="Placements (e.g., 15, 22, 8)" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <div class="flex items-center">
                                <input type="checkbox" id="trustedUserInput" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                <label for="trustedUserInput" class="ml-2 block text-sm text-gray-900">Trusted User</label>
                            </div>
                            <button id="addManualUserBtn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 transition duration-200">Add User</button>
                        </div>
                    </div>

                    <!-- User List -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold">2. User List (<span id="userCount">0</span>)</h2>
                            <button id="clearListBtn" class="text-sm text-red-500 hover:text-red-700 font-semibold">Clear All</button>
                        </div>
                        <div id="noUsersMessage" class="text-center text-gray-500 py-4">Add users to get started.</div>
                        <ul id="userList" class="space-y-2 max-h-96 overflow-y-auto"></ul>
                    </div>
                </div>

                <!-- Right Column: Processing and Results -->
                <div class="lg:col-span-8">
                    <!-- Controls -->
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <h2 class="text-xl font-bold mb-4">3. Analyze & Download</h2>
                        <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mb-4" role="alert"></div>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button id="processAllBtn" class="flex-1 bg-green-600 text-white font-bold py-3 px-4 rounded-md hover:bg-green-700 transition duration-200 flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                                Process All Users
                            </button>
                            <div class="dropdown flex-1">
                                <button id="downloadAnalysisBtn" disabled class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-md hover:bg-purple-700 transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                    Download Results
                                </button>
                                <div id="downloadDropdownContent" class="dropdown-content">
                                    <a href="#" id="downloadAnalysisResultsCsvBtn">Download Full Analysis (CSV)</a>
                                    <a href="#" id="downloadFilteredHandlesCsvBtn">Download Filtered Handles (CSV)</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="loadingIndicator" class="hidden text-center py-10">
                        <p class="mt-4 text-lg font-semibold text-gray-600">Processing users... This may take a moment.</p>
                        <p class="text-sm text-gray-500">Fetching data from the Codeforces API.</p>
                    </div>

                    <div id="resultsContainer" class="hidden">
                        <div class="bg-white rounded-t-lg p-4 border-b border-gray-200 flex justify-between items-center">
                            <div class="flex items-center">
                                <label for="readinessFilter" class="text-sm font-semibold text-gray-600 mr-2">Filter by Readiness:</label>
                                <select id="readinessFilter" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                    <option value="all">All</option>
                                    <option value="very-high">Very High (85% +)</option>
                                    <option value="high">High (65% - 85%)</option>
                                    <option value="medium">Medium (40% - 65%)</option>
                                    <option value="low">Low (&lt; 40%)</option>
                                </select>
                            </div>
                        </div>
                        <div class="bg-white rounded-b-lg shadow-md overflow-x-auto">
                            <table id="resultsTable" class="w-full text-sm text-left text-gray-600">
                                <thead class="bg-gray-100 text-xs text-gray-700 uppercase">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 sortable-header" data-sort-key="handle">Handle <span class="sort-icon"></span></th>
                                        <th scope="col" class="px-4 py-3 sortable-header" data-sort-key="scoreFromAvgDiv2Performance">Div2 Perf. Score <span class="sort-icon"></span></th>
                                        <th scope="col" class="px-4 py-3 sortable-header" data-sort-key="avgPlacement">Avg Placement <span class="sort-icon"></span></th>
                                        <th scope="col" class="px-4 py-3 text-center sortable-header sort-desc" data-sort-key="readinessProbability">Readiness <span class="sort-icon"></span></th>
                                        <th scope="col" class="px-4 py-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <div id="tabContentDatabase" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Left Column: Data Management -->
                <div class="lg:col-span-4 space-y-6">
                    <div class="bg-white rounded-lg shadow-md p-6 sticky top-8">
                        <h2 class="text-xl font-bold mb-4">Data Management</h2>
                        <div class="grid grid-cols-1 gap-6">
                            <!-- Upload Section -->
                            <div class="space-y-4">
                                <h3 class="text-lg font-semibold text-gray-800">Upload Data</h3>
                                <div class="p-4 border rounded-lg bg-gray-50">
                                    <p class="font-medium text-gray-700">Upload Users (CSV)</p>
                                    <p class="text-xs text-gray-500 mb-2">Replaces existing users with the same handle.</p>
                                    <label for="uploadUsersCsv" class="file-input-label bg-green-600 hover:bg-green-700">Choose File</label>
                                    <input type="file" id="uploadUsersCsv" accept=".csv">
                                </div>
                                <div class="p-4 border rounded-lg bg-gray-50">
                                    <p class="font-medium text-gray-700">Upload Competitions (CSV)</p>
                                    <p class="text-xs text-gray-500 mb-2">Adds or updates competitions.</p>
                                    <label for="uploadCompetitionsCsv" class="file-input-label bg-blue-600 hover:bg-blue-700">Choose File</label>
                                    <input type="file" id="uploadCompetitionsCsv" accept=".csv">
                                </div>
                                <div class="p-4 border rounded-lg bg-gray-50">
                                    <p class="font-medium text-gray-700">Upload Universities (CSV)</p>
                                    <p class="text-xs text-gray-500 mb-2">Adds new universities to the list.</p>
                                    <label for="uploadUniversitiesCsv" class="file-input-label bg-indigo-600 hover:bg-indigo-700">Choose File</label>
                                    <input type="file" id="uploadUniversitiesCsv" accept=".csv">
                                </div>
                            </div>
                            <!-- Backup Section -->
                            <div class="space-y-4">
                                <h3 class="text-lg font-semibold text-gray-800">Backup & Restore</h3>
                                <div class="p-4 border rounded-lg bg-gray-50">
                                    <p class="font-medium text-gray-700">Full System Backup (JSON)</p>
                                    <p class="text-xs text-gray-500 mb-2">Save all users, competitions, and universities.</p>
                                    <button id="downloadDbFullBackupBtn" class="file-input-label bg-purple-600 hover:bg-purple-700 w-full text-center">Download Backup</button>
                                </div>
                                <div class="p-4 border rounded-lg bg-gray-50">
                                    <p class="font-medium text-gray-700">Restore from Backup (JSON)</p>
                                    <p class="text-xs text-gray-500 mb-2">Overwrite all existing data.</p>
                                    <label for="jsonFileInput" class="file-input-label bg-red-600 hover:bg-red-700 w-full text-center">Restore from File</label>
                                    <input type="file" id="jsonFileInput" accept=".json">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Form, Stats, and Table -->
                <div class="lg:col-span-8 space-y-8">
                    <!-- Add/Update User Form -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-2xl font-bold mb-4">Add/Update User Info</h2>
                        <form id="detailedUserForm" class="space-y-4">
                             <!-- User Info Row -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="handleField">Codeforces Handle*</label>
                                    <input type="text" id="handleField" name="handle" placeholder="e.g., tourist" required>
                                </div>
                                <div>
                                    <label for="fullNameField">Full Name</label>
                                    <input type="text" id="fullNameField" name="fullName" placeholder="e.g., Gennady Korotkevich">
                                </div>
                                <div>
                                    <label for="linkedinField">LinkedIn Profile</label>
                                    <input type="url" id="linkedinField" name="linkedin" placeholder="https://linkedin.com/in/...">
                                </div>
                            </div>
                            <!-- University & Scores Row -->
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div class="md:col-span-2">
                                    <label for="universityInput">University</label>
                                    <input type="text" list="university-list" name="university" id="universityInput" placeholder="Type or select university">
                                    <datalist id="university-list"></datalist>
                                </div>
                                <div>
                                    <label for="lunaNovaScoreField">Luna Nova Score</label>
                                    <input type="number" step="0.01" id="lunaNovaScoreField" name="lunaNovaScore" placeholder="0.00">
                                </div>
                                <div>
                                    <label for="lunaHardScoreField">Luna Score</label>
                                    <input type="number" step="0.01" id="lunaHardScoreField" name="lunaHardScore" placeholder="0.00">
                                </div>
                            </div>
                             <!-- Other Info Row -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                <div>
                                    <label for="acmLevel">ACM Level</label>
                                    <select name="acmLevel" id="acmLevel">
                                        <option value="0">None</option>
                                        <option value="-1">Codeability</option>
                                        <option value="10">Level 0</option>
                                        <option value="1">Level 1</option>
                                        <option value="2">Level 2</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="joinDate">Join Date</label>
                                    <input type="month" id="joinDate" name="joinDate">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Profile Picture</label>
                                    <div class="flex items-center gap-2">
                                        <input type="text" name="profilePicUrl" id="profilePicUrl" placeholder="Image URL" class="bg-gray-50">
                                        <label for="profilePicFile" class="file-input-label bg-gray-600 hover:bg-gray-700 text-sm !px-3 !py-1.5 whitespace-nowrap">Choose</label>
                                        <input type="file" id="profilePicFile" accept="image/*">
                                    </div>
                                </div>
                            </div>
                            <!-- Placements Section -->
                            <hr class="!my-6"/>
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-semibold">Placements</h3>
                                <div class="flex items-center">
                                    <input type="checkbox" name="isTrusted" id="isTrustedCheckbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                    <label for="isTrustedCheckbox" class="ml-2 !mb-0 block text-sm font-medium text-gray-900">This is a trusted user</label>
                                </div>
                            </div>
                            <div id="placementsContainer" class="space-y-3 max-h-60 overflow-y-auto pr-2"></div>
                            <button type="button" id="addPlacementBtn" class="w-full text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 transition duration-200">Add Placement</button>
                            <datalist id="competition-list"></datalist>
                            <datalist id="team-list"></datalist>
                            <hr class="!my-6"/>
                            <!-- Action Buttons -->
                            <div class="flex gap-4">
                                <button type="submit" class="w-full bg-green-600 text-white font-bold py-2.5 px-4 rounded-md hover:bg-green-700 transition duration-200">Save User</button>
                                <button type="button" id="clearFormBtn" class="w-full bg-gray-500 text-white font-bold py-2.5 px-4 rounded-md hover:bg-gray-600 transition duration-200">Clear Form</button>
                            </div>
                        </form>
                    </div>

                    <!-- Statistics Section -->
                    <div class="stat-card">
                        <h2 class="text-xl font-bold mb-4">Database Statistics</h2>
                        <div id="statsContainer" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 text-center">
                            <!-- Stats will be dynamically inserted here -->
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                            <div class="p-4"><canvas id="acmLevelChart"></canvas></div>
                            <div class="p-4"><canvas id="competitionChart"></canvas></div>
                        </div>
                        <!-- University & Global Stats Section -->
                        <div id="advancedStatsContainer" class="mt-8"></div>
                    </div>
                    
                    <!-- User Table Section -->
                    <div class="bg-white rounded-lg shadow-md">
                        <div class="p-4 border-b border-gray-200 flex flex-wrap justify-between items-center gap-4">
                             <h2 class="text-xl font-bold">User Database (<span id="databaseUserCount">0</span>)</h2>
                             <div class="dropdown">
                                <button class="bg-purple-600 text-white font-bold py-2 px-4 rounded-md hover:bg-purple-700 transition duration-200 flex items-center gap-2">
                                    Download
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <div class="dropdown-content">
                                    <button id="downloadSelectedUsersCsvBtn">Download Selected Users (CSV)</button>
                                    <button id="downloadAllUsersCsvBtn">Download All Users (CSV)</button>
                                    <button id="downloadDbFullBackupBtn_dummy">Download Full Backup (JSON)</button>
                                </div>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table id="detailedUserTable" class="w-full text-sm text-left text-gray-600">
                                <thead class="bg-gray-100 text-xs text-gray-700 uppercase">
                                    <tr>
                                        <th class="p-2 w-10 text-center"><input type="checkbox" id="selectAllUsersCheckbox"></th>
                                        <th class="p-2 sortable-header" data-sort-key="handle">Handle <span class="sort-icon"></span></th>
                                        <th class="p-2 sortable-header" data-sort-key="fullName">Full Name <span class="sort-icon"></span></th>
                                        <th class="p-2 sortable-header" data-sort-key="university">University <span class="sort-icon"></span></th>
                                        <th class="p-2 sortable-header" data-sort-key="updatedAt">Last Updated <span class="sort-icon"></span></th>
                                        <th class="p-2 text-center">Actions</th>
                                    </tr>
                                    <tr>
                                        <th></th>
                                        <th><input type="text" data-filter-key="handle" placeholder="Filter..."></th>
                                        <th><input type="text" data-filter-key="fullName" placeholder="Filter..."></th>
                                        <th><input type="text" data-filter-key="university" placeholder="Filter..."></th>
                                        <th></th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="detailedUserTableBody">
                                    <tr><td colspan="6" class="p-4 text-center text-gray-500">No users in the database yet.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tabContentEditors" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="border-b border-gray-200 mb-4">
                    <nav class="flex space-x-1" aria-label="Editor Tabs">
                        <button data-editor="competitions" class="editor-tab-btn active font-medium px-4 py-2 rounded-t-lg">Competitions</button>
                        <button data-editor="universities" class="editor-tab-btn font-medium px-4 py-2 rounded-t-lg text-gray-600">Universities</button>
                        <button data-editor="teams" class="editor-tab-btn font-medium px-4 py-2 rounded-t-lg text-gray-600">Teams</button>
                    </nav>
                </div>

                <div id="editorContainer">
                    <!-- This container will hold the editor sub-tabs and content -->
                </div>
            </div>
        </div>

    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative transform scale-95">
            <h3 id="confirmationModalTitle" class="text-lg font-bold mb-4">Confirm Action</h3>
            <p id="confirmationModalMessage" class="text-gray-700 mb-6">Are you sure?</p>
            <div class="flex justify-end gap-4">
                <button id="confirmCancelBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="confirmOkBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-6 relative transform scale-95">
            <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <div id="modalContentContainer"></div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE VARIABLES ---
            let usersToAnalyze = [];
            let userDatabase = [];
            let teamDatabase = [];
            let competitionDatabase = {};
            let universityDatabase = [];
            let cachedUserData = [];
            let charts = {}; // Object to hold all chart instances
            let analysisSortState = { key: 'readinessProbability', direction: 'desc' };
            let dbSortState = { key: 'updatedAt', direction: 'desc' };
            let dbFilters = {};
            let activeFilter = 'all';
            let confirmCallback = null;

            // --- DOM ELEMENT REFERENCES ---
            const tabButtons = {
                analysis: document.getElementById('tabBtnAnalysis'),
                database: document.getElementById('tabBtnDatabase'),
                editors: document.getElementById('tabBtnEditors'),
            };
            const tabContents = {
                analysis: document.getElementById('tabContentAnalysis'),
                database: document.getElementById('tabContentDatabase'),
                editors: document.getElementById('tabContentEditors'),
            };
            const editorTabButtons = document.querySelectorAll('.editor-tab-btn');
            const editorContainer = document.getElementById('editorContainer');

            const handleInput = document.getElementById('handleInput');
            const lunaNovaScoreInput = document.getElementById('lunaNovaScoreInput');
            const lunaHardScoreInput = document.getElementById('lunaHardScoreInput');
            const placementsInput = document.getElementById('placementsInput');
            const trustedUserInput = document.getElementById('trustedUserInput');
            const addManualUserBtn = document.getElementById('addManualUserBtn');
            const jsonFileInput = document.getElementById('jsonFileInput');
            const clearListBtn = document.getElementById('clearListBtn');
            const processAllBtn = document.getElementById('processAllBtn');
            const downloadAnalysisBtn = document.getElementById('downloadAnalysisBtn');
            const downloadAnalysisResultsCsvBtn = document.getElementById('downloadAnalysisResultsCsvBtn');
            const downloadFilteredHandlesCsvBtn = document.getElementById('downloadFilteredHandlesCsvBtn');
            const downloadSelectedUsersCsvBtn = document.getElementById('downloadSelectedUsersCsvBtn');
            const downloadAllUsersCsvBtn = document.getElementById('downloadAllUsersCsvBtn');
            const downloadDbFullBackupBtn = document.getElementById('downloadDbFullBackupBtn');
            const downloadDbFullBackupBtn_dummy = document.getElementById('downloadDbFullBackupBtn_dummy');
            const userList = document.getElementById('userList');
            const userCount = document.getElementById('userCount');
            const noUsersMessage = document.getElementById('noUsersMessage');
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsTableBody = document.querySelector('#resultsTable tbody');
            const analysisResultsTableHeader = document.querySelector('#resultsTable thead');
            const readinessFilter = document.getElementById('readinessFilter');
            const errorMessageDiv = document.getElementById('errorMessage');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const detailedUserForm = document.getElementById('detailedUserForm');
            const clearFormBtn = document.getElementById('clearFormBtn');
            const placementsContainer = document.getElementById('placementsContainer');
            const addPlacementBtn = document.getElementById('addPlacementBtn');
            const competitionDataList = document.getElementById('competition-list');
            const teamDataList = document.getElementById('team-list');
            const universityInput = document.getElementById('universityInput');
            const universityDataList = document.getElementById('university-list');
            const detailedUserTable = document.getElementById('detailedUserTable');
            const detailedUserTableBody = document.getElementById('detailedUserTableBody');
            const databaseUserCount = document.getElementById('databaseUserCount');
            
            const statsContainer = document.getElementById('statsContainer');
            const advancedStatsContainer = document.getElementById('advancedStatsContainer');
            const detailsModal = document.getElementById('detailsModal');
            const modalContentContainer = document.getElementById('modalContentContainer');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const confirmationModal = document.getElementById('confirmationModal');
            const confirmationModalTitle = document.getElementById('confirmationModalTitle');
            const confirmationModalMessage = document.getElementById('confirmationModalMessage');
            const confirmCancelBtn = document.getElementById('confirmCancelBtn');
            const confirmOkBtn = document.getElementById('confirmOkBtn');
            const uploadUsersCsvInput = document.getElementById('uploadUsersCsv');
            const uploadCompetitionsCsvInput = document.getElementById('uploadCompetitionsCsv');
            const uploadUniversitiesCsvInput = document.getElementById('uploadUniversitiesCsv');
            const profilePicFileInput = document.getElementById('profilePicFile');
            const profilePicUrlInput = document.getElementById('profilePicUrl');

            // --- MODEL WEIGHTS (same as original) ---
            const weights = { bias: -7.0, maxRating: 0.02, avgRating: 0.01, contestCount: 0.03, lunaScore: 0.04, placementScore: 0.08, avgDiv2PerfScore: 0.16, weightedSolves: 0.05, activityScore: 0.08, inactivityPattern: -0.04, skipped: -0.015, };

            // --- API QUEUE (same as original) ---
            const apiQueue = { requests: [], isProcessing: false, delay: 1100, add(url) { return new Promise((resolve, reject) => { this.requests.push({ url, resolve, reject }); if (!this.isProcessing) this.processNext(); }); }, async processNext() { if (this.requests.length === 0) { this.isProcessing = false; return; } this.isProcessing = true; const { url, resolve, reject } = this.requests.shift(); try { const response = await fetch(url); if (!response.ok) throw new Error(`API request failed: ${response.status}`); const data = await response.json(); if (data.status === 'FAILED') throw new Error(`Codeforces API error: ${data.comment}`); resolve(data); } catch (error) { reject(error); } setTimeout(() => this.processNext(), this.delay); } };
            
            // --- CHART HELPERS ---
            function destroyChart(chartId) {
                if (charts[chartId]) {
                    charts[chartId].destroy();
                    delete charts[chartId];
                }
            }

            function renderChart(chartId, type, data, options) {
                destroyChart(chartId); // Ensure old chart is destroyed
                const ctx = document.getElementById(chartId)?.getContext('2d');
                if (ctx) {
                    charts[chartId] = new Chart(ctx, { type, data, options });
                }
            }
            
            // --- CORE CALCULATION LOGIC & MODEL (largely unchanged) ---
            const sigmoid = (x) => 1 / (1 + Math.exp(-x));
            const logisticCurve = (x, L, k, x0) => L / (1 + Math.exp(-k * (x - x0)));
            function getScoreFromMaxRating(maxRating) { return logisticCurve(maxRating, 60, 0.01, 1750); }
            function getScoreFromAvgRating(avgRating) { return logisticCurve(avgRating, 50, 0.012, 1650); }
            function getScoreFromContestCount(contestCount) { return logisticCurve(contestCount, 25, 0.06, 60); }
            function getScoreFromAvgDiv2Performance(avgScore) { return logisticCurve(avgScore, 100, 0.3, 10); } 
            function getCombinedLunaScore(lunaNovaScore, lunaHardScore) { const combinedRaw = (lunaNovaScore * 0.5) + (lunaHardScore * 1.5); return logisticCurve(combinedRaw, 50, 0.025, 300); }
            function getScoreFromPlacements(placements) { if (!placements || placements.length === 0) return 0; const invertedScores = placements.map(p => 100 - p); const sumOfSquares = invertedScores.reduce((acc, score) => acc + score * score, 0); const rms = Math.sqrt(sumOfSquares / invertedScores.length); return logisticCurve(rms, 70, 0.08, 75); }
            function getRecencyWeightedSolvedProblemScore(submissions) { let score = 0; const solvedProblemIds = new Set(); const now = Date.now() / 1000; const sortedSubmissions = submissions.sort((a, b) => b.creationTimeSeconds - a.creationTimeSeconds); for (const sub of sortedSubmissions) { if (sub.verdict !== 'OK' || !sub.problem.rating) continue; const problemId = `${sub.problem.contestId || 'gym'}-${sub.problem.index}`; if (solvedProblemIds.has(problemId)) continue; solvedProblemIds.add(problemId); const daysOld = (now - sub.creationTimeSeconds) / 86400; const recencyWeight = Math.exp(-0.005 * daysOld); const problemScore = Math.pow(1.15, (sub.problem.rating - 1200) / 100); score += problemScore * recencyWeight; } return logisticCurve(score, 40, 0.002, 1500); }
            function calculateActivityAndInactivityMetrics(submissions) { const oneDay = 86400000; const now = Date.now(); const dailyActivity = new Map(); submissions.forEach(sub => { if (sub.verdict === 'OK') { const date = new Date(sub.creationTimeSeconds * 1000); date.setHours(0, 0, 0, 0); const dateStr = date.toISOString().split('T')[0]; if (!dailyActivity.has(dateStr)) { dailyActivity.set(dateStr, { count: 0, timestamp: date.getTime() }); } dailyActivity.get(dateStr).count++; } }); let rawActivityScore = 0; for (const data of dailyActivity.values()) { const daysOld = (now - data.timestamp) / oneDay; rawActivityScore += Math.sqrt(data.count) * Math.exp(-0.003 * daysOld); } if (dailyActivity.size < 3) return { rawActivityScore, inactivityScore: 100, avgGap: 365, stdDevGap: 0 }; const sortedTimestamps = Array.from(dailyActivity.values()).map(d => d.timestamp).sort((a, b) => a - b); const gaps = []; for (let i = 1; i < sortedTimestamps.length; i++) { gaps.push((sortedTimestamps[i] - sortedTimestamps[i-1]) / oneDay); } const avgGap = gaps.reduce((a, v) => a + v, 0) / gaps.length; const stdDevGap = Math.sqrt(gaps.reduce((a, v) => a + Math.pow(v - avgGap, 2), 0) / gaps.length); const recencyGap = (now - sortedTimestamps[sortedTimestamps.length - 1]) / oneDay; const rawPenalty = avgGap + (2 * stdDevGap) + (1.5 * recencyGap); const inactivityScore = logisticCurve(rawPenalty, 100, 0.1, 40); return { rawActivityScore, inactivityScore, avgGap, stdDevGap }; }
            function getScoreFromActivity(rawActivityScore) { return logisticCurve(rawActivityScore, 50, 0.1, 50); }
            function calculateReadinessProbability(stats) { let { scoreMaxRating, scoreAvgRating, scoreContestCount, scoreFromCombinedLuna, scoreFromPlacements, scoreFromAvgDiv2Performance, scoreWeightedSolvedProblems, scoreFromActivity, inactivityScore } = stats; if (!stats.isTrusted) { const cfPenalty = 0.1, manualPenalty = 0.8; scoreMaxRating *= cfPenalty; scoreAvgRating *= cfPenalty; scoreContestCount *= cfPenalty; scoreFromAvgDiv2Performance *= cfPenalty; scoreWeightedSolvedProblems *= cfPenalty; scoreFromActivity *= cfPenalty; scoreFromCombinedLuna *= manualPenalty; inactivityScore *= 0.5; } const z = weights.bias + (scoreMaxRating * weights.maxRating) + (scoreAvgRating * weights.avgRating) + (scoreContestCount * weights.contestCount) + (scoreFromCombinedLuna * weights.lunaScore) + (scoreFromPlacements * weights.placementScore) + (scoreFromAvgDiv2PerfScore * weights.avgDiv2PerfScore) + (scoreWeightedSolvedProblems * weights.weightedSolves) + (scoreFromActivity * weights.activityScore) + (inactivityScore * weights.inactivityPattern) + (stats.skippedSubmissionsCount * weights.skipped); return sigmoid(z); }
            
            // --- DATE HELPERS ---
            function formatDateForInput(dateStr) {
                if (!dateStr) return '';
                return dateStr.slice(0, 7); 
            }

            // --- CONFIRMATION MODAL ---
            function showConfirmationModal(title, message, onConfirm) { confirmationModalTitle.textContent = title; confirmationModalMessage.textContent = message; confirmCallback = onConfirm; confirmationModal.classList.remove('hidden'); setTimeout(() => { confirmationModal.querySelector('.modal-overlay')?.classList.remove('opacity-0'); confirmationModal.querySelector('.modal-content')?.classList.remove('scale-95'); }, 10); }
            function hideConfirmationModal() { confirmationModal.querySelector('.modal-overlay')?.classList.add('opacity-0'); confirmationModal.querySelector('.modal-content')?.classList.add('scale-95'); setTimeout(() => { confirmationModal.classList.add('hidden'); confirmCallback = null; }, 300); }

            // --- UI and Helper Functions ---
            function addOrUpdateUserInAnalysisList(user) {
                const normalizedHandle = user.handle.toLowerCase();
                const existingUserIndex = usersToAnalyze.findIndex(u => u.handle.toLowerCase() === normalizedHandle);
                if (existingUserIndex > -1) { usersToAnalyze[existingUserIndex] = { ...usersToAnalyze[existingUserIndex], ...user }; } 
                else { usersToAnalyze.push(user); }
                updateUserListDisplay();
            }

            function addManualUserToList() {
                const handle = handleInput.value.trim();
                if (!handle) { displayError('Please enter a Codeforces handle.'); return; }
                const lunaNovaScore = parseFloat(lunaNovaScoreInput.value) || 0;
                const lunaHardScore = parseFloat(lunaHardScoreInput.value) || 0;
                const placementsStr = placementsInput.value.trim();
                const isTrusted = trustedUserInput.checked;
                if (lunaNovaScore < 0 || lunaHardScore < 0) { displayError('Luna Scores cannot be negative.'); return; }
                if (!placementsStr) { displayError('Please enter contest placement percentages.'); return; }
                const placements = placementsStr.split(',').map(p => parseFloat(p.trim())).filter(p => !isNaN(p));
                if (placements.length === 0 || !placements.every(p => p >= 0 && p <= 100)) { displayError('Please enter valid, comma-separated percentages (0-100).'); return; }
                const newUser = { handle, lunaNovaScore, lunaHardScore, placements, isTrusted };
                const normalizedHandle = handle.toLowerCase();
                const existingUserIndex = usersToAnalyze.findIndex(user => user.handle.toLowerCase() === normalizedHandle);
                if (existingUserIndex > -1) {
                    showConfirmationModal('Update User?', `User "${handle}" is already in the list. Do you want to update their information?`, () => {
                        usersToAnalyze[existingUserIndex] = newUser;
                        updateUserListDisplay();
                        clearManualInputs();
                        hideError();
                    });
                } else {
                    usersToAnalyze.push(newUser);
                    updateUserListDisplay();
                    clearManualInputs();
                    hideError();
                }
            }

            function clearManualInputs() { handleInput.value = ''; lunaNovaScoreInput.value = ''; lunaHardScoreInput.value = ''; placementsInput.value = ''; trustedUserInput.checked = true; }
            
            function loadJsonFile(file) { 
                if (!file) { displayError('Please select a JSON backup file.'); return; } 
                const reader = new FileReader(); 
                reader.onload = (e) => { 
                    try { 
                        const data = JSON.parse(e.target.result);
                        if (!data.users || !data.competitions || !data.universities || !data.teams) {
                            throw new Error("Invalid backup file format. Must contain 'users', 'competitions', 'universities', and 'teams' keys.");
                        }
                        showConfirmationModal('Overwrite Data?', 'Loading this backup will overwrite all current data. Are you sure?', () => {
                            userDatabase = data.users.map(u => ({...u, updatedAt: new Date(u.updatedAt) })) || [];
                            competitionDatabase = data.competitions || {};
                            universityDatabase = data.universities || [];
                            teamDatabase = data.teams || [];
                            usersToAnalyze = userDatabase.map(dbUser => {
                                const placementPercentages = dbUser.placements.map(p => (p.rank / p.total) * 100);
                                return { handle: dbUser.handle, lunaNovaScore: dbUser.lunaNovaScore, lunaHardScore: dbUser.lunaHardScore, placements: placementPercentages, isTrusted: dbUser.isTrusted !== false };
                            });
                            cachedUserData = [];
                            renderAll();
                            displayError(`Successfully loaded backup.`);
                        });
                    } catch (error) { 
                        displayError(`Error parsing JSON: ${error.message}`); 
                    } 
                }; 
                reader.readAsText(file); 
            }
            
            function updateUserListDisplay() { userList.innerHTML = ''; userCount.textContent = usersToAnalyze.length; noUsersMessage.classList.toggle('hidden', usersToAnalyze.length > 0); usersToAnalyze.forEach((user, index) => { const handleClass = user.isTrusted ? 'font-semibold' : 'font-semibold text-red-600'; const listItem = document.createElement('li'); listItem.className = 'p-2 bg-gray-50 rounded-md text-sm flex justify-between items-center border border-gray-200'; listItem.innerHTML = `<div class="flex items-center gap-2"><input type="checkbox" data-index="${index}" class="user-trust-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${user.isTrusted ? 'checked' : ''}><span><span class="${handleClass}">${user.handle}</span> (Luna: ${user.lunaNovaScore}/${user.lunaHardScore})</span></div><button data-index="${index}" class="remove-list-btn text-red-500 hover:text-red-700 font-bold px-2">×</button>`; userList.appendChild(listItem); }); }
            function clearUserList() { showConfirmationModal('Clear User List?', 'This will remove all users from the analysis list and clear any processed results. Are you sure?', () => { usersToAnalyze = []; cachedUserData = []; updateUserListDisplay(); resultsTableBody.innerHTML = ''; resultsContainer.classList.add('hidden'); hideError(); downloadAnalysisBtn.disabled = true; clearManualInputs(); }); }
            async function processSingleUser(user, rowElement) { rowElement.innerHTML = `<td colspan="5" class="px-4 py-3 text-center text-gray-500"><div class="flex items-center justify-center gap-2"><div class="spinner h-4 w-4 rounded-full border-2 border-gray-200"></div><span>Processing ${user.handle}...</span></div></td>`; try { const userData = await fetchStatsForHandle(user.handle, user.lunaNovaScore, user.lunaHardScore, user.placements, user.isTrusted); const cacheIndex = cachedUserData.findIndex(data => data.handle.toLowerCase() === user.handle.toLowerCase()); if (cacheIndex > -1) cachedUserData[cacheIndex] = userData; else cachedUserData.push(userData); updateTableRow(rowElement, userData); } catch (error) { console.error(`Error fetching stats for ${user.handle}:`, error); const errorData = { handle: user.handle, error: `API Error: ${error.message.substring(0, 60)}...` }; const cacheIndex = cachedUserData.findIndex(data => data.handle.toLowerCase() === user.handle.toLowerCase()); if (cacheIndex > -1) cachedUserData[cacheIndex] = errorData; else cachedUserData.push(errorData); updateTableRow(rowElement, errorData); } }
            async function processAllUsers() { if (usersToAnalyze.length === 0) { displayError('Please add users to the list first.'); return; } resultsContainer.classList.remove('hidden'); hideError(); showLoading(); const usersToProcess = usersToAnalyze.filter(user => { const cachedUser = cachedUserData.find(cached => cached.handle.toLowerCase() === user.handle.toLowerCase() && !cached.error); return !cachedUser || cachedUser.isTrusted !== user.isTrusted || cachedUser.lunaNovaScore !== user.lunaNovaScore || cachedUser.lunaHardScore !== user.lunaHardScore; }); if (usersToProcess.length === 0) { hideLoading(); displayError("All users in the list are up-to-date."); updateAnalysisTableView(); return; } for (let i = 0; i < usersToProcess.length; i++) { const user = usersToProcess[i]; const loadingMessage = document.querySelector('#loadingIndicator p:first-child'); if (loadingMessage) loadingMessage.textContent = `Processing user ${i + 1} of ${usersToProcess.length}: ${user.handle}...`; let row = document.getElementById(`row-${user.handle.toLowerCase()}`); if (!row) { row = resultsTableBody.insertRow(); row.id = `row-${user.handle.toLowerCase()}`; } await processSingleUser(user, row); } hideLoading(); downloadAnalysisBtn.disabled = cachedUserData.filter(d => !d.error).length === 0; updateAnalysisTableView(); }

            // --- Database Tab Logic ---
            function addPlacementInput(placement = null) {
                const placementDiv = document.createElement('div');
                placementDiv.className = 'p-4 border border-gray-200 rounded-lg space-y-3 placement-entry bg-gray-50 relative';
                
                const compName = placement ? placement.name : '';
                const compData = competitionDatabase[compName] || {};
                const teamId = placement ? placement.teamId : '';
                const teamName = teamId ? (teamDatabase.find(t => t.id === teamId)?.name || '') : '';

                placementDiv.innerHTML = `
                    <button type="button" class="remove-placement-btn absolute -top-2.5 -right-2.5 bg-red-500 text-white rounded-full h-6 w-6 flex items-center justify-center font-bold text-sm hover:bg-red-600 z-10">&times;</button>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="font-medium text-xs text-gray-600">Competition*</label>
                            <input type="text" list="competition-list" placeholder="Competition Name" class="comp-name-input w-full text-sm p-2 border border-gray-300 rounded-md" value="${compName}" required>
                        </div>
                        <div>
                            <label class="font-medium text-xs text-gray-600">Date*</label>
                            <input type="month" class="comp-date-input w-full text-sm p-2 border border-gray-300 rounded-md" value="${compData.date || ''}" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                             <label class="font-medium text-xs text-gray-600">Rank*</label>
                             <input type="number" placeholder="Rank" min="1" class="comp-rank-input w-full text-sm p-2 border border-gray-300 rounded-md" value="${placement ? placement.rank : ''}" required>
                        </div>
                        <div>
                             <label class="font-medium text-xs text-gray-600">Total Participants*</label>
                             <input type="number" placeholder="Total" min="1" class="comp-total-input w-full text-sm p-2 border border-gray-300 rounded-md" value="${placement ? placement.total : (compData.total || '')}" required>
                        </div>
                    </div>
                     <div class="pt-1">
                        <div class="flex items-center gap-2">
                             <input type="checkbox" class="team-placement-checkbox h-4 w-4 rounded border-gray-400" ${teamId ? 'checked' : ''}>
                             <label class="text-sm font-medium !mb-0">Team Placement</label>
                        </div>
                        <div class="team-selection-container ${teamId ? '' : 'hidden'} mt-2">
                            <input type="text" list="team-list-${placementDiv.id}" placeholder="Select Team" class="team-name-input w-full text-sm p-2 border border-gray-300 rounded-md" value="${teamName}">
                            <datalist id="team-list-${placementDiv.id}"></datalist>
                        </div>
                    </div>
                `;
                placementsContainer.appendChild(placementDiv);

                const teamCheckbox = placementDiv.querySelector('.team-placement-checkbox');
                const teamSelectionContainer = placementDiv.querySelector('.team-selection-container');
                const teamNameInput = placementDiv.querySelector('.team-name-input');
                const compNameInput = placementDiv.querySelector('.comp-name-input');
                const compDateInput = placementDiv.querySelector('.comp-date-input');
                const compRankInput = placementDiv.querySelector('.comp-rank-input');
                const compTotalInput = placementDiv.querySelector('.comp-total-input');

                // Populate team list for this specific entry
                updateTeamDatalistForEntry(placementDiv);

                placementDiv.querySelector('.remove-placement-btn').addEventListener('click', () => {
                    showConfirmationModal('Remove Placement?', 'Are you sure you want to remove this placement entry?', () => placementDiv.remove());
                });
                
                teamCheckbox.addEventListener('change', (e) => {
                    teamSelectionContainer.classList.toggle('hidden', !e.target.checked);
                });

                compNameInput.addEventListener('change', (e) => {
                    const currentCompName = e.target.value;
                    const comp = competitionDatabase[currentCompName];
                    if (comp) {
                        if (comp.total) compTotalInput.value = comp.total;
                        if (comp.date) compDateInput.value = comp.date;
                    }

                    // Now check for team auto-population
                    const isTeamPlacement = teamCheckbox.checked;
                    if (!isTeamPlacement) return;

                    const selectedTeamName = teamNameInput.value;
                    if (!selectedTeamName) return;

                    const selectedTeam = teamDatabase.find(t => t.name.toLowerCase() === selectedTeamName.toLowerCase());
                    if (!selectedTeam) return;

                    // Find if a teammate has already submitted for this competition
                    for (const memberHandle of selectedTeam.members) {
                        const member = userDatabase.find(u => u.handle.toLowerCase() === memberHandle.toLowerCase());
                        if (member) {
                            const teamPlacement = member.placements.find(p => p.teamId === selectedTeam.id && p.name.toLowerCase() === currentCompName.toLowerCase());
                            if (teamPlacement) {
                                compRankInput.value = teamPlacement.rank;
                                compTotalInput.value = teamPlacement.total;
                                if(competitionDatabase[teamPlacement.name]?.date) {
                                    compDateInput.value = competitionDatabase[teamPlacement.name].date;
                                }
                                displayError(`Auto-filled placement from teammate ${member.handle}.`, 'info');
                                return; // Stop after finding the first one
                            }
                        }
                    }
                });

                if (placement) compNameInput.dispatchEvent(new Event('change'));
            }

            function handleDetailedUserFormSubmit(e) {
                e.preventDefault();
                const formData = new FormData(detailedUserForm);
                const handle = formData.get('handle').trim();
                if (!handle) { alert("Handle is required."); return; }

                const placements = [];
                let placementError = false;
                document.querySelectorAll('.placement-entry').forEach(entry => {
                    if (placementError) return;
                    const name = entry.querySelector('.comp-name-input').value.trim();
                    const date = entry.querySelector('.comp-date-input').value;
                    const rankStr = entry.querySelector('.comp-rank-input').value;
                    const totalStr = entry.querySelector('.comp-total-input').value;
                    const isTeamPlacement = entry.querySelector('.team-placement-checkbox').checked;
                    const teamName = entry.querySelector('.team-name-input').value.trim();
                    const team = isTeamPlacement ? teamDatabase.find(t => t.name.toLowerCase() === teamName.toLowerCase()) : null;

                    if (!name || !rankStr || !totalStr || !date) {
                        alert('Competition Name, Date, Rank, and Total fields are required for all placements.');
                        placementError = true; return;
                    }
                    if(isTeamPlacement && !team) {
                        alert(`Team "${teamName}" not found. Please create the team first in the Data Editors tab.`);
                        placementError = true; return;
                    }

                    const rank = parseInt(rankStr, 10);
                    const total = parseInt(totalStr, 10);
                    if (rank > total) {
                         alert(`Placement error for "${name}": Rank (${rank}) cannot be greater than Total (${total}).`);
                         placementError = true; return;
                    }

                    placements.push({ name, rank, total, teamId: team ? team.id : null });
                    if (!competitionDatabase[name] || competitionDatabase[name].total !== total || competitionDatabase[name].date !== date) {
                        competitionDatabase[name] = { total, date, link: competitionDatabase[name]?.link || '' };
                    }
                });

                if (placementError) return;
                
                const universityName = formData.get('university').trim();
                if (universityName && !universityDatabase.includes(universityName)) {
                    universityDatabase.push(universityName);
                    universityDatabase.sort();
                }

                const userToSave = {
                    id: handle.toLowerCase(),
                    handle: handle,
                    fullName: formData.get('fullName').trim(),
                    linkedin: formData.get('linkedin').trim(),
                    university: universityName,
                    profilePicUrl: formData.get('profilePicUrl').trim(),
                    lunaNovaScore: parseFloat(formData.get('lunaNovaScore')) || 0,
                    lunaHardScore: parseFloat(formData.get('lunaHardScore')) || 0,
                    acmLevel: parseInt(formData.get('acmLevel'), 10),
                    joinDate: formData.get('joinDate') || null,
                    isTrusted: detailedUserForm.querySelector('#isTrustedCheckbox').checked,
                    placements: placements,
                    updatedAt: new Date()
                };

                saveUserAndUpdateTeams(userToSave);
                updateAnalysisListFromDatabase(userToSave);
                clearDetailedUserForm();
                renderAll();
            }

            function saveUserAndUpdateTeams(userToSave) {
                const existingIndex = userDatabase.findIndex(u => u.id === userToSave.id);
                if (existingIndex > -1) {
                    userDatabase[existingIndex] = userToSave;
                } else {
                    userDatabase.push(userToSave);
                }

                userToSave.placements.filter(p => p.teamId).forEach(teamPlacement => {
                    const team = teamDatabase.find(t => t.id === teamPlacement.teamId);
                    if (!team) return;

                    team.members.forEach(memberHandle => {
                        if (memberHandle.toLowerCase() === userToSave.id) return; 

                        let member = userDatabase.find(u => u.handle.toLowerCase() === memberHandle.toLowerCase());
                        if (member) {
                            const hasPlacement = member.placements.some(p => p.name === teamPlacement.name && p.rank === teamPlacement.rank && p.teamId === teamPlacement.teamId);
                            if (!hasPlacement) {
                                member.placements.push(teamPlacement);
                                member.updatedAt = new Date();
                            }
                        }
                    });
                });
            }
            
            function clearDetailedUserForm() {
                detailedUserForm.reset();
                placementsContainer.innerHTML = '';
                detailedUserForm.querySelector('[name="handle"]').readOnly = false;
                detailedUserForm.querySelector('#isTrustedCheckbox').checked = true;
                universityInput.value = "";
            }

            function updateAnalysisListFromDatabase(dbUser) {
                const placementPercentages = dbUser.placements.map(p => (p.rank / p.total) * 100);
                const analysisUser = {
                    handle: dbUser.handle,
                    lunaNovaScore: dbUser.lunaNovaScore,
                    lunaHardScore: dbUser.lunaHardScore,
                    placements: placementPercentages,
                    isTrusted: dbUser.isTrusted
                };
                addOrUpdateUserInAnalysisList(analysisUser);
            }

            function renderAll() {
                renderUserDatabaseTable();
                updateAndRenderStatistics();
                renderCurrentEditorView();
                updateAllDatalists();
            }
            
            function updateAllDatalists() {
                updateCompetitionDatalist();
                document.querySelectorAll('.placement-entry').forEach(updateTeamDatalistForEntry);
                populateUniversityDatalist();
            }

            function renderUserDatabaseTable() {
                const filteredUsers = userDatabase.filter(user => {
                    return Object.entries(dbFilters).every(([key, value]) => {
                        const userValue = String(user[key] || '').toLowerCase();
                        return userValue.includes(value.toLowerCase());
                    });
                });

                const { key, direction } = dbSortState;
                filteredUsers.sort((a,b) => {
                    const valA = a[key];
                    const valB = b[key];
                    if (valA < valB) return direction === 'asc' ? -1 : 1;
                    if (valA > valB) return direction === 'asc' ? 1 : -1;
                    return 0;
                });

                detailedUserTableBody.innerHTML = '';
                databaseUserCount.textContent = filteredUsers.length;

                if (filteredUsers.length === 0) {
                    detailedUserTableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500">No matching users found.</td></tr>`;
                    return;
                }

                filteredUsers.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.dataset.id = user.id;
                    const formattedDate = new Date(user.updatedAt).toLocaleString([], { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    const handleClass = user.isTrusted ? 'font-semibold' : 'font-semibold text-red-600';
                    row.innerHTML = `
                        <td class="p-2 text-center"><input type="checkbox" class="user-select-checkbox" data-id="${user.id}"></td>
                        <td class="p-2 ${handleClass}">${user.handle}</td>
                        <td class="p-2">${user.fullName || 'N/A'}</td>
                        <td class="p-2">${user.university || 'N/A'}</td>
                        <td class="p-2 text-xs text-gray-600">${formattedDate}</td>
                        <td class="p-2 text-center">
                            <button class="details-db-user-btn text-indigo-600 hover:text-indigo-800 text-sm font-medium">Details</button>
                            <button class="edit-db-user-btn text-blue-600 hover:text-blue-800 text-sm ml-2">Edit</button>
                            <button class="delete-db-user-btn text-red-600 hover:text-red-800 ml-2 text-sm">Delete</button>
                        </td>
                    `;
                    detailedUserTableBody.appendChild(row);
                });
                updateDbSortIndicators();
            }
            
            // --- CSV and Backup/Restore ---
            function parseCsv(text) {
                const lines = text.trim().split('\n');
                const header = lines[0].split(',').map(h => h.trim());
                const rows = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    const row = {};
                    for (let j = 0; j < header.length; j++) {
                        let value = values[j] ? values[j].trim() : '';
                        if (value.startsWith('"') && value.endsWith('"')) {
                            value = value.slice(1, -1).replace(/""/g, '"');
                        }
                        row[header[j]] = value;
                    }
                    rows.push(row);
                }
                return rows;
            }

            function handleFileUpload(file, handler) {
                if (!file) { displayError('Please select a file to upload.'); return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try { handler(e.target.result); } catch (error) { displayError(`Error processing file: ${error.message}`); console.error(error); }
                };
                reader.readAsText(file);
            }

            function handleUserUpload(csvText) {
                const newUsers = parseCsv(csvText);
                showConfirmationModal('Upload Users?', `This will add ${newUsers.length} users and overwrite any existing users with the same handle. Continue?`, () => {
                    newUsers.forEach(newUserRow => {
                        try {
                            const handle = newUserRow.handle;
                            if (!handle) return;
                            const placements = newUserRow.placements_json ? JSON.parse(newUserRow.placements_json) : [];
                            const user = {
                                id: handle.toLowerCase(), handle,
                                fullName: newUserRow.fullName || '',
                                linkedin: newUserRow.linkedin || '',
                                university: newUserRow.university || '',
                                profilePicUrl: newUserRow.profilePicUrl || '',
                                lunaNovaScore: parseFloat(newUserRow.lunaNovaScore) || 0,
                                lunaHardScore: parseFloat(newUserRow.lunaHardScore) || 0,
                                acmLevel: parseInt(newUserRow.acmLevel, 10) || 0,
                                joinDate: newUserRow.joinDate || null,
                                isTrusted: newUserRow.isTrusted ? newUserRow.isTrusted.toLowerCase() === 'true' : true,
                                placements: placements,
                                updatedAt: new Date()
                            };
                            saveUserAndUpdateTeams(user);
                            updateAnalysisListFromDatabase(user);
                        } catch (e) {
                            console.error(`Skipping invalid user row:`, newUserRow, e);
                        }
                    });
                    renderAll();
                    displayError(`${newUsers.length} users processed.`);
                });
            }

            function handleCompetitionUpload(csvText) {
                const newComps = parseCsv(csvText);
                let addedCount = 0;
                newComps.forEach(comp => {
                    const name = comp['Competition Name'];
                    if (name) {
                        competitionDatabase[name] = { 
                            link: comp['Link'] || '', 
                            total: parseInt(comp['Total Participants'], 10) || 0,
                            date: comp['Date (YYYY-MM)'] || null
                        };
                        addedCount++;
                    }
                });
                renderAll();
                displayError(`${addedCount} competitions added or updated.`);
            }

            function handleUniversityUpload(csvText) {
                const newUnis = csvText.trim().split('\n').map(line => line.split(',')[0].trim()).filter(Boolean);
                let addedCount = 0;
                newUnis.forEach(uni => {
                    if (!universityDatabase.includes(uni)) {
                        universityDatabase.push(uni);
                        addedCount++;
                    }
                });
                universityDatabase.sort();
                renderAll();
                displayError(`${addedCount} new universities added.`);
            }

             function handleTeamUpload(csvText) {
                const newTeams = parseCsv(csvText);
                let addedCount = 0;
                newTeams.forEach(teamRow => {
                    const name = teamRow['Team Name'];
                    const university = teamRow['University'];
                    const members = teamRow['Members'] ? teamRow['Members'].split(';').map(h => h.trim()) : [];
                    if (name && university) {
                        const existingTeam = teamDatabase.find(t => t.name.toLowerCase() === name.toLowerCase());
                        if (existingTeam) {
                            existingTeam.university = university;
                            existingTeam.members = members;
                        } else {
                            teamDatabase.push({ id: crypto.randomUUID(), name, university, members });
                        }
                        addedCount++;
                    }
                });
                renderAll();
                displayError(`${addedCount} teams added or updated.`);
            }
            
            function downloadUsersCSV(usersToDownload) {
                if (usersToDownload.length === 0) { alert("No users selected to download."); return; }
                const headers = ['handle', 'fullName', 'linkedin', 'university', 'profilePicUrl', 'lunaNovaScore', 'lunaHardScore', 'acmLevel', 'joinDate', 'isTrusted', 'placements_json'];
                const rows = usersToDownload.map(user => {
                    const placementsStr = `"${JSON.stringify(user.placements).replace(/"/g, '""')}"`;
                    return [
                        user.handle, user.fullName, user.linkedin, user.university,
                        user.profilePicUrl || '', user.lunaNovaScore, user.lunaHardScore, user.acmLevel,
                        user.joinDate || '', user.isTrusted, placementsStr
                    ].join(',');
                });
                const csvString = [headers.join(','), ...rows].join('\n');
                downloadFile(csvString, `users_export_${getFormattedDateTimeString()}.csv`, 'text/csv;charset=utf-8;');
            }
            
            function downloadDbFullBackup() {
                if (userDatabase.length === 0 && Object.keys(competitionDatabase).length === 0 && universityDatabase.length === 0) {
                    alert("No data to back up."); return;
                }
                const backupData = {
                    users: userDatabase,
                    teams: teamDatabase,
                    competitions: competitionDatabase,
                    universities: universityDatabase,
                    createdAt: new Date().toISOString()
                };
                const jsonString = JSON.stringify(backupData, null, 2);
                downloadFile(jsonString, `electi_backup_${getFormattedDateTimeString()}.json`, 'application/json');
            }

            // --- Editor Rendering ---
            function renderCurrentEditorView() {
                const activeTab = document.querySelector('.editor-tab-btn.active').dataset.editor;
                const editorViews = {
                    competitions: getCompetitionEditorHTML(),
                    universities: getUniversityEditorHTML(),
                    teams: getTeamEditorHTML()
                };
                editorContainer.innerHTML = editorViews[activeTab];

                const activeSubTab = document.querySelector(`#editorContent${capitalize(activeTab)} .sub-tab-btn.active`)?.dataset.view || 'editor';
                
                if (activeSubTab === 'dashboard') {
                    renderEditorDashboard(activeTab);
                } else {
                    renderEditorTable(activeTab);
                    attachEditorTableEventListeners(activeTab);
                }
            }

            function attachEditorTableEventListeners(editorType) {
                const type = capitalize(editorType);
                document.getElementById(`add${type}RowBtn`)?.addEventListener('click', () => addEditorTableRow(editorType));
                document.querySelector(`#${editorType}EditorTable tbody`)?.addEventListener('click', (e) => handleEditorTableEvents(e, editorType));
                
                document.getElementById(`upload${type}CsvEditor`)?.addEventListener('change', (e) => {
                    const handlers = { competitions: handleCompetitionUpload, universities: handleUniversityUpload, teams: handleTeamUpload };
                    handleFileUpload(e.target.files[0], handlers[editorType]); e.target.value = '';
                });
                document.getElementById(`download${type}CsvEditor`)?.addEventListener('click', () => downloadEditorCSV(editorType));
            }

            function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

            editorContainer.addEventListener('click', (e) => {
                if (e.target.matches('.sub-tab-btn')) {
                    const editorType = e.target.closest('[data-editor-type]').dataset.editorType;
                    document.querySelectorAll(`#editorContent${capitalize(editorType)} .sub-tab-btn`).forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    renderCurrentEditorView();
                }
            });

            // --- Datalist Updaters ---
            function updateCompetitionDatalist() {
                competitionDataList.innerHTML = '';
                Object.keys(competitionDatabase).sort().forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    competitionDataList.appendChild(option);
                });
            }
            function updateTeamDatalistForEntry(placementEntryDiv) {
                const datalist = placementEntryDiv.querySelector('datalist');
                if (!datalist) return;
                datalist.innerHTML = '';
                const currentUniversity = universityInput.value;
                const filteredTeams = currentUniversity ? teamDatabase.filter(t => t.university === currentUniversity) : teamDatabase;
                filteredTeams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.name;
                    datalist.appendChild(option);
                });
            }
            function populateUniversityDatalist(selectedValue = '') {
                const allUnis = new Set(universityDatabase);
                userDatabase.forEach(u => { if(u.university) allUnis.add(u.university) });
                universityDatabase = Array.from(allUnis).sort();

                universityDataList.innerHTML = '';
                universityDatabase.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    universityDataList.appendChild(option);
                });
                universityInput.value = selectedValue;
            }

            // --- STATISTICS LOGIC ---
            function updateAndRenderStatistics() {
                const totalUsers = userDatabase.length;
                const totalUniversities = universityDatabase.length;
                const totalTeams = teamDatabase.length;
                const totalUniqueCompetitions = Object.keys(competitionDatabase).length;

                statsContainer.innerHTML = `
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <p class="text-3xl font-bold text-blue-600">${totalUsers}</p>
                        <p class="text-sm text-gray-600">Total Users</p>
                    </div>
                    <div class="p-4 bg-indigo-50 rounded-lg">
                        <p class="text-3xl font-bold text-indigo-600">${totalUniversities}</p>
                        <p class="text-sm text-gray-600">Universities</p>
                    </div>
                    <div class="p-4 bg-teal-50 rounded-lg">
                        <p class="text-3xl font-bold text-teal-600">${totalTeams}</p>
                        <p class="text-sm text-gray-600">Total Teams</p>
                    </div>
                    <div class="p-4 bg-green-50 rounded-lg">
                        <p class="text-3xl font-bold text-green-600">${totalUniqueCompetitions}</p>
                        <p class="text-sm text-gray-600">Unique Competitions</p>
                    </div>
                `;

                if (totalUsers === 0) {
                    destroyChart('acmLevelChart');
                    destroyChart('competitionChart');
                    advancedStatsContainer.innerHTML = '';
                    return;
                }
                
                // ACM Level Chart
                const levelMap = { '0': 'None', '-1': 'Codeability', '10': 'Level 0', '1': 'Level 1', '2': 'Level 2'};
                const acmLevels = { '0': 0, '-1': 0, '10': 0, '1': 0, '2': 0 };
                userDatabase.forEach(u => { if (acmLevels.hasOwnProperty(u.acmLevel)) acmLevels[u.acmLevel]++; });
                const acmData = { labels: ['None', 'Codeability', 'Level 0', 'Level 1', 'Level 2'], datasets: [{ data: [acmLevels['0'], acmLevels['-1'], acmLevels['10'], acmLevels['1'], acmLevels['2']], backgroundColor: ['#6b7280', '#a1a1aa', '#10b981', '#f59e0b', '#ef4444'], }] };
                renderChart('acmLevelChart', 'pie', acmData, { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: 'ACM Level Breakdown' } } });

                // Competition Chart
                const compCounts = userDatabase.flatMap(u => u.placements.map(p => p.name)).reduce((acc, name) => { acc[name] = (acc[name] || 0) + 1; return acc; }, {});
                const sortedCompCounts = Object.entries(compCounts).sort(([,a],[,b]) => b-a).slice(0, 10);
                const compData = { labels: sortedCompCounts.map(([name]) => name), datasets: [{ label: 'Participants', data: sortedCompCounts.map(([,count]) => count), backgroundColor: ['#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#ef4444', '#6b7280', '#ec4899', '#6366f1', '#f97316', '#06b6d4'], }] };
                renderChart('competitionChart', 'doughnut', compData, { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Top 10 Competitions by Participants' } } });
                
                renderAdvancedStats();
            }

            function renderAdvancedStats() {
                advancedStatsContainer.innerHTML = '';
                const usersWithPlacements = userDatabase.filter(u => u.placements && u.placements.length > 0);
                if (usersWithPlacements.length === 0) return;
                
                let html = `<h3 class="text-xl font-bold mt-8 mb-4">Advanced Analytics</h3><div class="space-y-8">`;

                // --- Individual & Team Progression ---
                html += `<div><h4 class="text-lg font-semibold text-gray-800 mb-3">Performance Progression</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="individualProgressSelect" class="text-sm font-medium">Select Individual:</label>
                            <select id="individualProgressSelect" class="w-full p-2 border rounded-md">${userDatabase.map(u => `<option value="${u.handle}">${u.handle}</option>`).join('')}</select>
                            <canvas id="individualProgressChart" class="mt-2"></canvas>
                        </div>
                        <div>
                            <label for="teamProgressSelect" class="text-sm font-medium">Select Team:</label>
                            <select id="teamProgressSelect" class="w-full p-2 border rounded-md">${teamDatabase.map(t => `<option value="${t.id}">${t.name}</option>`).join('')}</select>
                            <canvas id="teamProgressChart" class="mt-2"></canvas>
                        </div>
                    </div>
                </div>`;
                
                // --- University Rankings ---
                const uniStats = {};
                usersWithPlacements.forEach(user => {
                    if (!user.university) return;
                    if (!uniStats[user.university]) {
                        uniStats[user.university] = { totalScore: 0, studentCount: new Set(), topPerformances: [], teams: new Set() };
                    }
                    uniStats[user.university].studentCount.add(user.handle);
                    user.placements.forEach(p => {
                        const rankScore = 1 / Math.log(p.rank + 1.1);
                        const participationScore = Math.log(p.total + 1.1);
                        const finalScore = rankScore * participationScore;
                        uniStats[user.university].totalScore += finalScore;
                        uniStats[user.university].topPerformances.push({ handle: user.handle, comp: p.name, score: finalScore, rank: p.rank, total: p.total });
                        if (p.teamId) {
                            const team = teamDatabase.find(t => t.id === p.teamId);
                            if (team) uniStats[user.university].teams.add(team.name);
                        }
                    });
                });

                const uniDominance = Object.entries(uniStats).map(([name, stats]) => ({
                    name,
                    dominanceIndex: stats.totalScore / stats.studentCount.size,
                    topPerformances: stats.topPerformances.sort((a,b) => b.score - a.score).slice(0,3),
                    teams: Array.from(stats.teams)
                })).sort((a, b) => b.dominanceIndex - a.dominanceIndex);

                if (uniDominance.length > 0) {
                    html += `<div><h4 class="text-lg font-semibold text-gray-800 mb-3">University Rankings (Individuals & Teams)</h4><div class="space-y-4">`;
                    uniDominance.forEach((uni, index) => {
                        html += `<div class="p-4 border rounded-lg bg-gray-50">
                            <div class="flex items-baseline gap-3">
                                <span class="text-2xl font-bold text-indigo-600">#${index + 1}</span>
                                <h5 class="font-bold text-lg text-indigo-800">${uni.name}</h5>
                            </div>
                            <p class="text-sm text-gray-600 ml-8">Dominance Index: <span class="font-semibold">${uni.dominanceIndex.toFixed(2)}</span></p>
                            <h6 class="font-semibold text-xs mt-2 ml-8 mb-1">Top Individual Performances:</h6>
                            <ul class="text-xs space-y-1 list-disc list-inside ml-12">
                                ${uni.topPerformances.map(p => `<li><strong>${p.handle}</strong> in ${p.comp} (Rank ${p.rank}/${p.total})</li>`).join('')}
                            </ul>
                             ${uni.teams.length > 0 ? `<h6 class="font-semibold text-xs mt-2 ml-8 mb-1">Active Teams:</h6><p class="text-xs ml-12 text-gray-700">${uni.teams.join(', ')}</p>` : ''}
                        </div>`;
                    });
                    html += `</div></div>`;
                }

                // --- Global Competition Breakdown ---
                const allPlacements = [];
                usersWithPlacements.forEach(user => {
                    user.placements.forEach(p => {
                        allPlacements.push({
                            ...p,
                            handle: user.handle,
                            university: user.university || 'N/A',
                            percentage: (p.rank / p.total) * 100
                        });
                    });
                });

                const placementsByComp = allPlacements.reduce((acc, p) => {
                    if (!acc[p.name]) acc[p.name] = [];
                    acc[p.name].push(p);
                    return acc;
                }, {});

                const sortedCompetitions = Object.entries(placementsByComp).sort(([,a],[,b]) => b.length - a.length);

                if (sortedCompetitions.length > 0) {
                     html += `<div><h4 class="text-lg font-semibold text-gray-800 mb-3">Global Competition Breakdown</h4><div class="space-y-4">`;
                     sortedCompetitions.slice(0, 10).forEach(([compName, placements]) => {
                         const sortedPlacements = placements.sort((a, b) => a.percentage - b.percentage);
                         html += `<details class="p-4 border rounded-lg bg-gray-50 group">
                            <summary class="font-bold text-lg text-purple-800 cursor-pointer">${compName} <span class="text-sm font-normal text-gray-600">(${placements.length} participants)</span></summary>
                            <div class="mt-3 overflow-x-auto">
                                <table class="w-full text-xs">
                                    <thead class="bg-gray-200"><tr>
                                        <th class="p-2 text-left">Rank</th><th class="p-2 text-left">Handle</th><th class="p-2 text-left">University</th><th class="p-2 text-left">Placement</th>
                                    </tr></thead>
                                    <tbody>
                                    ${sortedPlacements.slice(0, 10).map((p, i) => `
                                        <tr class="border-b">
                                            <td class="p-2 font-bold">${i+1}</td>
                                            <td class="p-2">${p.handle} ${p.teamId ? `<span class="text-teal-600 font-medium">(T)</span>` : ''}</td>
                                            <td class="p-2">${p.university}</td>
                                            <td class="p-2"><strong>${p.rank}</strong> / ${p.total} <span class="text-gray-500">(${p.percentage.toFixed(1)}%)</span></td>
                                        </tr>
                                    `).join('')}
                                    </tbody>
                                </table>
                            </div>
                         </details>`;
                     });
                     html += `</div></div>`;
                }


                html += `</div>`;
                advancedStatsContainer.innerHTML = html;

                // Attach listeners and render progression charts
                const individualSelect = document.getElementById('individualProgressSelect');
                const teamSelect = document.getElementById('teamProgressSelect');
                individualSelect.addEventListener('change', () => renderIndividualProgressChart(individualSelect.value));
                teamSelect.addEventListener('change', () => renderTeamProgressChart(teamSelect.value));
                if (userDatabase.length > 0) renderIndividualProgressChart(userDatabase[0].handle);
                if (teamDatabase.length > 0) renderTeamProgressChart(teamDatabase[0].id);
            }
            
            // --- Original functions (fetchStatsForHandle, table updates, etc.) ---
            function calculateAvgDiv2PerformanceScore(div2Submissions, div2ContestCount) { if (!div2Submissions || div2Submissions.length === 0 || div2ContestCount === 0) return 0; const solvedInDiv2 = {}; for (const sub of div2Submissions) { if (sub.verdict === 'OK') { if (!solvedInDiv2[sub.contestId]) solvedInDiv2[sub.contestId] = new Set(); solvedInDiv2[sub.contestId].add(sub.problem.index); } } const problemWeights = { 'A': 1, 'B': 2, 'C': 4, 'D': 8, 'E': 12, 'F': 16 }; let totalPerformanceScore = 0; for (const contestId in solvedInDiv2) { const solvedProblems = Array.from(solvedInDiv2[contestId]); let contestScore = 0; for (const problemIndex of solvedProblems) { const problemChar = problemIndex.charAt(0).toUpperCase(); contestScore += problemWeights[problemChar] || 0; } totalPerformanceScore += contestScore; } return totalPerformanceScore / div2ContestCount; }
            async function fetchStatsForHandle(handle, lunaNovaScore, lunaHardScore, placements, isTrusted) { if (handle == 'MrMoon') throw new Error("MrMoon is off the grid"); const userInfoData = await apiQueue.add(`https://codeforces.com/api/user.info?handles=${handle}`); const userRatingData = await apiQueue.add(`https://codeforces.com/api/user.rating?handle=${handle}`); const userStatusData = await apiQueue.add(`https://codeforces.com/api/user.status?handle=${handle}&from=1&count=5000`); const userInfo = userInfoData.result[0]; const allRatingChanges = userRatingData.result; const allSubmissions = userStatusData.result; const totalContestCount = allRatingChanges.length; const sumRatings = allRatingChanges.reduce((acc, curr) => acc + curr.newRating, 0); const averageContestRating = totalContestCount > 0 ? (sumRatings / totalContestCount) : 0; const maxRating = totalContestCount > 0 ? Math.max(...allRatingChanges.map(c => c.newRating)) : 0; const skippedSubmissionsCount = allSubmissions.filter(s => s.verdict === 'SKIPPED').length; const div2Contests = allRatingChanges.filter(c => c.contestName.includes('Div. 2')); const div2ContestIds = new Set(div2Contests.map(c => c.contestId)); const div2Submissions = allSubmissions.filter(s => div2ContestIds.has(s.contestId)); const div2ContestCount = div2Contests.length; const avgDiv2PerformanceScore = calculateAvgDiv2PerformanceScore(div2Submissions, div2ContestCount); const avgPlacement = placements.length > 0 ? placements.reduce((a, b) => a + b, 0) / placements.length : 0; const { rawActivityScore, inactivityScore, avgGap, stdDevGap } = calculateActivityAndInactivityMetrics(allSubmissions); const stats = { handle, maxRating, averageContestRating, totalContestCount, lunaNovaScore, lunaHardScore, placements, avgPlacement, div2ContestCount, avgDiv2PerformanceScore, skippedSubmissionsCount, rawActivityScore, inactivityScore, avgGap, stdDevGap, isTrusted, scoreFromPlacements: getScoreFromPlacements(placements), scoreFromCombinedLuna: getCombinedLunaScore(lunaNovaScore, lunaHardScore), scoreMaxRating: getScoreFromMaxRating(maxRating), scoreAvgRating: getScoreFromAvgRating(averageContestRating), scoreContestCount: getScoreFromContestCount(totalContestCount), scoreWeightedSolvedProblems: getRecencyWeightedSolvedProblemScore(allSubmissions), scoreFromAvgDiv2Performance: getScoreFromAvgDiv2Performance(avgDiv2PerformanceScore), scoreFromActivity: getScoreFromActivity(rawActivityScore), userInfo, allRatingChanges, allSubmissions }; const readinessProbability = calculateReadinessProbability(stats); return { ...stats, readinessProbability }; }
            function getConfidenceCategory(probability) { if (probability >= 0.85) return 'very-high'; if (probability >= 0.65) return 'high'; if (probability >= 0.40) return 'medium'; return 'low'; }
            function updateAnalysisTableView() { let filteredData = cachedUserData.filter(user => { if (user.error) return true; if (activeFilter === 'all') return true; return getConfidenceCategory(user.readinessProbability) === activeFilter; }); const { key, direction } = analysisSortState; const sortedData = [...filteredData].sort((a, b) => { if (a.error) return 1; if (b.error) return -1; const valA = a[key]; const valB = b[key]; if (valA === undefined || valA === null) return 1; if (valB === undefined || valB === null) return -1; return direction === 'asc' ? String(valA).localeCompare(String(valB), undefined, {numeric: true}) : String(valB).localeCompare(String(valA), undefined, {numeric: true}); }); resultsTableBody.innerHTML = ''; sortedData.forEach(userData => { const row = resultsTableBody.insertRow(); row.id = `row-${userData.handle.toLowerCase()}`; updateTableRow(row, userData); }); updateAnalysisSortIndicators(); }
            function updateAnalysisSortIndicators() { analysisResultsTableHeader.querySelectorAll('th.sortable-header').forEach(th => { th.classList.remove('sort-asc', 'sort-desc'); if (th.dataset.sortKey === analysisSortState.key) th.classList.add(`sort-${analysisSortState.direction}`); th.querySelector('.sort-icon').textContent = analysisSortState.direction === 'asc' ? '▲' : '▼'; }); }
            function updateDbSortIndicators() { detailedUserTable.querySelectorAll('th.sortable-header').forEach(th => { th.classList.remove('sort-asc', 'sort-desc'); if (th.dataset.sortKey === dbSortState.key) th.classList.add(`sort-${dbSortState.direction}`); th.querySelector('.sort-icon').textContent = dbSortState.direction === 'asc' ? '▲' : '▼'; }); }
            function updateTableRow(row, userData) { if (userData.error) { row.innerHTML = `<td class="px-4 py-3 font-semibold">${userData.handle}</td><td colspan="3" class="px-4 py-3 text-red-600">${userData.error}</td><td class="px-4 py-3 text-center"><button class="retry-btn bg-blue-100 text-blue-700 text-xs font-bold py-1 px-3 rounded-full hover:bg-blue-200" data-handle="${userData.handle}">Retry</button></td>`; return; } const probability = userData.readinessProbability * 100; let probClass = '', confidence = 'Low'; const category = getConfidenceCategory(userData.readinessProbability); if (category === 'very-high') { probClass = 'bg-green-100 text-green-800'; confidence = 'Very High'; } else if (category === 'high') { probClass = 'bg-emerald-100 text-emerald-800'; confidence = 'High'; } else if (category === 'medium') { probClass = 'bg-yellow-100 text-yellow-800'; confidence = 'Medium'; } else { probClass = 'bg-red-100 text-red-800'; } const handleClass = userData.isTrusted ? 'font-semibold' : 'font-semibold text-red-600'; row.innerHTML = `<td class="px-4 py-3 whitespace-nowrap ${handleClass}">${userData.handle}</td><td class="px-4 py-3 whitespace-nowrap font-bold text-center">${userData.scoreFromAvgDiv2Performance.toFixed(2)}</td><td class="px-4 py-3 whitespace-nowrap">Top ${userData.avgPlacement.toFixed(1)}%</td><td class="px-4 py-3 whitespace-nowrap text-center rounded-md ${probClass}"><div class="font-bold text-lg">${probability.toFixed(2)}%</div><div class="text-xs font-semibold">${confidence}</div></td><td class="px-4 py-3 whitespace-nowrap text-center"><button class="details-btn bg-indigo-100 text-indigo-700 text-xs font-bold py-1 px-3 rounded-full hover:bg-indigo-200" data-handle="${userData.handle}">Details</button><button class="remove-result-btn text-red-500 hover:text-red-700 font-bold px-2 ml-2" data-handle="${userData.handle}" title="Remove User">×</button></td>`; }
            function getFormattedDateTimeString() { const now = new Date(); const pad = (num) => num.toString().padStart(2, '0'); return `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}`; }
            function downloadFile(content, fileName, mimeType) { const blob = new Blob([content], { type: mimeType }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = fileName; document.body.appendChild(link); link.click(); document.body.removeChild(link); }
            
            function downloadAnalysisResults() {
                if (cachedUserData.filter(d => !d.error).length === 0) { displayError('No processed results to download.'); return; }
                const headers = ["Handle", "Is Trusted", "Readiness Probability (%)", "Confidence", "Norm. Div. 2 Perf Score", "Luna Nova Score", "Luna Hard Score", "Avg Placement (%)", "Total Contests", "Max Rating", "Avg Rating"];
                const resultRows = [headers.join(',')];
                cachedUserData.filter(d => !d.error).forEach(data => {
                    const probability = data.readinessProbability * 100;
                    let confidence = getConfidenceCategory(data.readinessProbability).replace('-', ' ');
                    confidence = confidence.charAt(0).toUpperCase() + confidence.slice(1);
                    const rowData = [data.handle, data.isTrusted, probability.toFixed(2), confidence, data.scoreFromAvgDiv2Performance.toFixed(2), data.lunaNovaScore, data.lunaHardScore, data.avgPlacement.toFixed(1), data.totalContestCount, data.maxRating, data.averageContestRating.toFixed(0)];
                    resultRows.push(rowData.join(','));
                });
                downloadFile(resultRows.join('\n'), `readiness_analysis_${getFormattedDateTimeString()}.csv`, 'text/csv;charset=utf-8;');
            }

            function downloadFilteredHandles() {
                const filteredHandles = Array.from(resultsTableBody.querySelectorAll('tr'))
                    .map(row => row.querySelector('td:first-child')?.textContent)
                    .filter(Boolean);
                if (filteredHandles.length === 0) { displayError('No filtered users to download.'); return; }
                downloadFile(filteredHandles.join('\n'), `filtered_handles_${activeFilter}_${getFormattedDateTimeString()}.csv`, 'text/csv;charset=utf-8;');
            }

            function showUserDetailsModal(handle) {
                const apiData = cachedUserData.find(d => d.handle.toLowerCase() === handle.toLowerCase() && !d.error);
                const dbData = userDatabase.find(d => d.id === handle.toLowerCase());

                if (!apiData && !dbData) { alert('Could not find data for this user.'); return; }
                
                let content = '';
                const profilePicUrl = dbData?.profilePicUrl || `https://placehold.co/128x128/e0e0e0/333?text=${handle.charAt(0)}`;
                const trustedBadge = dbData?.isTrusted ? '' : '<span class="ml-2 text-xs font-bold uppercase bg-red-100 text-red-700 px-2 py-1 rounded-full">Untrusted</span>';

                content += `
                    <div class="flex flex-col md:flex-row gap-6 items-start">
                        <img src="${profilePicUrl}" alt="Profile Picture" class="w-32 h-32 rounded-full object-cover border-4 border-gray-200 shadow-md">
                        <div class="flex-grow">
                            <h2 class="text-3xl font-bold mb-1 flex items-center">${handle} ${trustedBadge}</h2>
                            <p class="text-lg text-gray-600">${dbData?.fullName || ''}</p>
                        </div>
                    </div>
                    <hr class="my-6">
                `;

                if (dbData) {
                    const levelMap = { '0': 'None', '-1': 'Codeability', '10': 'Level 0', '1': 'Level 1', '2': 'Level 2'};
                    content += `
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                        <div><strong class="block text-gray-500">University</strong> <span class="text-lg">${dbData.university || 'N/A'}</span></div>
                        <div><strong class="block text-gray-500">ACM Level</strong> <span class="text-lg">${levelMap[dbData.acmLevel] || 'N/A'}</span></div>
                        <div><strong class="block text-gray-500">LinkedIn</strong> ${dbData.linkedin ? `<a href="${dbData.linkedin}" target="_blank" class="text-blue-600 hover:underline text-lg">Profile</a>` : '<span class="text-lg">N/A</span>'}</div>
                    </div>`;
                }

                const userTeams = teamDatabase.filter(t => t.members.map(m => m.toLowerCase()).includes(dbData.handle.toLowerCase()));
                if (userTeams.length > 0) {
                    content += `<h3 class="text-xl font-semibold mb-2">Team Placements</h3><div class="space-y-4 mb-6">`;
                    userTeams.forEach(team => {
                        const teamPlacements = dbData.placements.filter(p => p.teamId === team.id);
                        if (teamPlacements.length === 0) return;
                        content += `<div class="p-3 border rounded-lg bg-gray-50">
                            <h4 class="font-bold text-md text-teal-800">${team.name}</h4>
                            <p class="text-xs text-gray-500 mb-2">With: ${team.members.filter(m => m.toLowerCase() !== dbData.handle.toLowerCase()).map(m => `<button class="text-teal-600 hover:underline modal-teammate-btn" data-handle="${m}">${m}</button>`).join(', ')}</p>
                            <ul class="text-sm space-y-1 list-disc list-inside">
                            ${teamPlacements.map(p => `<li>${p.name}: <strong>Rank ${p.rank}/${p.total}</strong></li>`).join('')}
                            </ul>
                        </div>`;
                    });
                    content += `</div>`;
                }

                const soloPlacements = dbData.placements.filter(p => !p.teamId);
                if (soloPlacements.length > 0) {
                    content += `<h3 class="text-xl font-semibold mb-2">Solo Placements</h3>
                                <div class="overflow-x-auto mb-6 max-h-48 border rounded-lg">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-gray-100 text-xs uppercase sticky top-0"><tr>
                                        <th class="p-2">Competition</th><th class="p-2">Rank</th><th class="p-2">Total</th><th class="p-2">Placement</th>
                                    </tr></thead><tbody>`;
                    soloPlacements.forEach(p => {
                        const placementPercent = ((p.rank / p.total) * 100).toFixed(2);
                        content += `<tr class="border-b">
                                        <td class="p-2 font-medium">${p.name}</td>
                                        <td class="p-2">${p.rank}</td>
                                        <td class="p-2">${p.total}</td>
                                        <td class="p-2 font-bold">Top ${placementPercent}%</td>
                                    </tr>`;
                    });
                    content += `</tbody></table></div>`;
                }

                if (apiData) {
                    content += `<h3 class="text-xl font-semibold mb-4">Codeforces Analysis</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div><canvas id="modalRatingChart"></canvas></div>
                                    <div><canvas id="modalProblemChart"></canvas></div>
                                </div>
                                <div class="mt-6"><h4 class="font-semibold mb-2">Submission Heatmap (Last Year)</h4><div id="modalHeatmapContainer" class="p-2 border rounded-lg overflow-x-auto"></div></div>`;
                } else {
                    content += `<div class="text-center p-6 bg-yellow-50 text-yellow-700 rounded-lg">Run the analysis on the main page to see detailed Codeforces stats.</div>`;
                }

                modalContentContainer.innerHTML = content;
                detailsModal.classList.remove('hidden');

                if (apiData) renderModalCharts(apiData);
            }

            function renderModalCharts(userData) {
                destroyChart('modalRatingChart');
                destroyChart('modalProblemChart');
                
                const ratingCtx = document.getElementById('modalRatingChart')?.getContext('2d');
                const problemCtx = document.getElementById('modalProblemChart')?.getContext('2d');
                const heatmapContainer = document.getElementById('modalHeatmapContainer');

                if(ratingCtx) {
                    renderChart('modalRatingChart', 'line', {
                        labels: userData.allRatingChanges.map(c => new Date(c.ratingUpdateTimeSeconds * 1000).toLocaleDateString()),
                        datasets: [{ label: 'Rating', data: userData.allRatingChanges.map(c => c.newRating), borderColor: 'rgb(75, 192, 192)', tension: 0.1 }]
                    }, { plugins: { title: { display: true, text: 'Rating History' } } });
                }

                if(problemCtx) {
                    const solvedProblems = {};
                    userData.allSubmissions.forEach(sub => {
                        if (sub.verdict === 'OK' && sub.problem.rating) {
                            solvedProblems[sub.problem.rating] = (solvedProblems[sub.problem.rating] || 0) + 1;
                        }
                    });
                    const ratings = Object.keys(solvedProblems).sort((a,b) => a-b);
                    renderChart('modalProblemChart', 'bar', {
                        labels: ratings,
                        datasets: [{ label: 'Solved Problems', data: ratings.map(r => solvedProblems[r]), backgroundColor: 'rgba(153, 102, 255, 0.6)' }]
                    }, { plugins: { title: { display: true, text: 'Solved Problems by Rating' } } });
                }
                
                if(heatmapContainer) {
                    const heatmapData = {};
                    userData.allSubmissions.forEach(sub => {
                        if (sub.verdict === 'OK') {
                            const date = new Date(sub.creationTimeSeconds * 1000).toISOString().slice(0, 10);
                            heatmapData[date] = (heatmapData[date] || 0) + 1;
                        }
                    });
                    const today = new Date();
                    const oneYearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
                    let svg = `<svg width="722" height="112"><g transform="translate(10, 20)">`;
                    const daySize = 12; const dayMargin = 2;
                    for (let i = 0; i < 53; i++) {
                        for (let j = 0; j < 7; j++) {
                            const date = new Date(oneYearAgo);
                            date.setDate(date.getDate() + (i * 7 + j));
                            if (date > today) continue;
                            const dateString = date.toISOString().slice(0, 10);
                            const count = heatmapData[dateString] || 0;
                            let color = '#ebedf0';
                            if (count > 0) color = '#9be9a8';
                            if (count > 3) color = '#40c463';
                            if (count > 6) color = '#30a14e';
                            if (count > 9) color = '#216e39';
                            svg += `<rect class="heatmap-day" width="${daySize}" height="${daySize}" x="${i * (daySize + dayMargin)}" y="${j * (daySize + dayMargin)}" fill="${color}" data-date="${dateString}" data-count="${count}"><title>${count} submissions on ${dateString}</title></rect>`;
                        }
                    }
                    svg += '</g></svg>';
                    heatmapContainer.innerHTML = svg;
                }
            }

            function hideModal() { detailsModal.classList.add('hidden'); destroyChart('modalRatingChart'); destroyChart('modalProblemChart'); }
            function displayError(message, type = 'error') { 
                errorMessageDiv.textContent = message; 
                errorMessageDiv.classList.remove('hidden', 'bg-red-100', 'border-red-400', 'text-red-700', 'bg-blue-100', 'border-blue-400', 'text-blue-700');
                if (type === 'info') {
                    errorMessageDiv.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-700');
                } else {
                    errorMessageDiv.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                }
                setTimeout(() => hideError(), 5000); 
            }
            function hideError() { errorMessageDiv.classList.add('hidden'); }
            function showLoading() { loadingIndicator.classList.remove('hidden'); document.querySelectorAll('button, input, select').forEach(el => el.disabled = true); }
            function hideLoading() { loadingIndicator.classList.add('hidden'); document.querySelectorAll('button, input, select').forEach(el => el.disabled = false); downloadAnalysisBtn.disabled = cachedUserData.filter(d => !d.error).length === 0; }

            // --- EVENT LISTENERS ---
            Object.values(tabButtons).forEach(button => {
                button.addEventListener('click', () => {
                    Object.values(tabButtons).forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    Object.values(tabContents).forEach(content => content.classList.add('hidden'));
                    tabContents[button.id.replace('tabBtn', '').toLowerCase()].classList.remove('hidden');
                });
            });
            editorTabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    editorTabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    renderCurrentEditorView();
                });
            });

            addManualUserBtn.addEventListener('click', addManualUserToList);
            clearListBtn.addEventListener('click', clearUserList);
            processAllBtn.addEventListener('click', processAllUsers);
            downloadAnalysisResultsCsvBtn.addEventListener('click', downloadAnalysisResults);
            downloadFilteredHandlesCsvBtn.addEventListener('click', downloadFilteredHandles);
            downloadAllUsersCsvBtn.addEventListener('click', () => downloadUsersCSV(userDatabase));
            downloadSelectedUsersCsvBtn.addEventListener('click', () => {
                const selectedIds = Array.from(document.querySelectorAll('.user-select-checkbox:checked')).map(cb => cb.dataset.id);
                const selectedUsers = userDatabase.filter(user => selectedIds.includes(user.id));
                downloadUsersCSV(selectedUsers);
            });
            downloadDbFullBackupBtn.addEventListener('click', downloadDbFullBackup);
            downloadDbFullBackupBtn_dummy.addEventListener('click', downloadDbFullBackup);
            readinessFilter.addEventListener('change', (e) => { activeFilter = e.target.value; updateAnalysisTableView(); });
            [handleInput, lunaNovaScoreInput, lunaHardScoreInput, placementsInput].forEach(input => { input.addEventListener('keypress', (e) => { if(e.key === 'Enter') addManualUserToList() }); });
            userList.addEventListener('click', (e) => { if (e.target.classList.contains('remove-list-btn')) { const indexToRemove = parseInt(e.target.dataset.index, 10); const handle = usersToAnalyze[indexToRemove].handle; showConfirmationModal('Remove User?', `Are you sure you want to remove ${handle} from the list?`, () => { usersToAnalyze.splice(indexToRemove, 1); updateUserListDisplay(); }); } else if (e.target.classList.contains('user-trust-checkbox')) { const indexToUpdate = parseInt(e.target.dataset.index, 10); usersToAnalyze[indexToUpdate].isTrusted = e.target.checked; updateUserListDisplay(); } });
            detailedUserForm.addEventListener('submit', handleDetailedUserFormSubmit);
            universityInput.addEventListener('input', () => {
                 document.querySelectorAll('.placement-entry').forEach(updateTeamDatalistForEntry);
            });
            clearFormBtn.addEventListener('click', () => { showConfirmationModal('Clear Form?', 'Are you sure you want to clear all fields in the user form?', clearDetailedUserForm); });
            addPlacementBtn.addEventListener('click', () => addPlacementInput());
            
            detailedUserTable.querySelector('thead').addEventListener('click', e => {
                const header = e.target.closest('th.sortable-header');
                if (!header) return;
                const key = header.dataset.sortKey;
                let direction = 'desc';
                if (dbSortState.key === key) {
                    direction = dbSortState.direction === 'desc' ? 'asc' : 'desc';
                }
                dbSortState = { key, direction };
                renderUserDatabaseTable();
            });
            detailedUserTable.querySelector('thead').addEventListener('keyup', e => {
                if(e.target.matches('input[data-filter-key]')) {
                    dbFilters[e.target.dataset.filterKey] = e.target.value;
                    renderUserDatabaseTable();
                }
            });
            document.getElementById('selectAllUsersCheckbox').addEventListener('change', e => {
                document.querySelectorAll('#detailedUserTableBody .user-select-checkbox').forEach(cb => cb.checked = e.target.checked);
            });
            detailedUserTableBody.addEventListener('click', e => {
                const target = e.target; const row = target.closest('tr'); if (!row) return; const userId = row.dataset.id; const user = userDatabase.find(u => u.id === userId); if (!user) return;
                if (target.classList.contains('delete-db-user-btn')) {
                    showConfirmationModal('Delete User?', `Permanently delete ${user.handle} from the database? This cannot be undone.`, () => {
                        userDatabase = userDatabase.filter(u => u.id !== userId);
                        usersToAnalyze = usersToAnalyze.filter(u => u.handle.toLowerCase() !== userId);
                        cachedUserData = cachedUserData.filter(u => u.handle.toLowerCase() !== userId);
                        renderAll(); updateUserListDisplay(); updateAnalysisTableView();
                    });
                } else if (target.classList.contains('edit-db-user-btn')) {
                    clearDetailedUserForm();
                    detailedUserForm.querySelector('[name="handle"]').value = user.handle;
                    detailedUserForm.querySelector('[name="handle"]').readOnly = true;
                    detailedUserForm.querySelector('[name="fullName"]').value = user.fullName;
                    detailedUserForm.querySelector('[name="linkedin"]').value = user.linkedin;
                    populateUniversityDatalist(user.university);
                    detailedUserForm.querySelector('[name="profilePicUrl"]').value = user.profilePicUrl || '';
                    detailedUserForm.querySelector('[name="lunaNovaScore"]').value = user.lunaNovaScore;
                    detailedUserForm.querySelector('[name="lunaHardScore"]').value = user.lunaHardScore;
                    detailedUserForm.querySelector('[name="acmLevel"]').value = user.acmLevel;
                    detailedUserForm.querySelector('[name="joinDate"]').value = formatDateForInput(user.joinDate);
                    detailedUserForm.querySelector('#isTrustedCheckbox').checked = user.isTrusted !== false; // Default to true if undefined
                    placementsContainer.innerHTML = '';
                    user.placements.forEach(p => addPlacementInput(p));
                    detailedUserForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else if (target.classList.contains('details-db-user-btn')) {
                    showUserDetailsModal(user.handle);
                }
            });
            closeModalBtn.addEventListener('click', hideModal);
            detailsModal.addEventListener('click', (e) => { 
                if (e.target === detailsModal) hideModal(); 
                if (e.target.classList.contains('modal-teammate-btn')) {
                    const handle = e.target.dataset.handle;
                    hideModal();
                    // Timeout to allow current modal to close before opening new one
                    setTimeout(() => showUserDetailsModal(handle), 350);
                }
            });
            confirmCancelBtn.addEventListener('click', hideConfirmationModal);
            confirmOkBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); hideConfirmationModal(); });
            resultsTableBody.addEventListener('click', async (e) => { const button = e.target.closest('button'); if (!button) return; const handle = button.dataset.handle; if (button.classList.contains('details-btn')) { showUserDetailsModal(handle); } else if (button.classList.contains('retry-btn')) { const user = usersToAnalyze.find(u => u.handle.toLowerCase() === handle.toLowerCase()); if (user && button.closest('tr')) await processSingleUser(user, button.closest('tr')); } else if (button.classList.contains('remove-result-btn')) { showConfirmationModal('Remove User?', `Remove ${handle} from the results and the analysis list?`, () => { const handleLower = handle.toLowerCase(); button.closest('tr').remove(); cachedUserData = cachedUserData.filter(u => u.handle.toLowerCase() !== handleLower); usersToAnalyze = usersToAnalyze.filter(u => u.handle.toLowerCase() !== handleLower); updateUserListDisplay(); downloadAnalysisBtn.disabled = cachedUserData.filter(d => !d.error).length === 0; }); } });
            analysisResultsTableHeader.addEventListener('click', (e) => { const header = e.target.closest('th.sortable-header'); if (!header) return; const key = header.dataset.sortKey; let direction = 'desc'; if (analysisSortState.key === key) direction = analysisSortState.direction === 'desc' ? 'asc' : 'desc'; analysisSortState = { key, direction }; updateAnalysisTableView(); });
            jsonFileInput.addEventListener('change', (e) => { loadJsonFile(e.target.files[0]); e.target.value = ''; });
            uploadUsersCsvInput.addEventListener('change', (e) => { handleFileUpload(e.target.files[0], handleUserUpload); e.target.value = ''; });
            uploadCompetitionsCsvInput.addEventListener('change', (e) => { handleFileUpload(e.target.files[0], handleCompetitionUpload); e.target.value = ''; });
            uploadUniversitiesCsvInput.addEventListener('change', (e) => { handleFileUpload(e.target.files[0], handleUniversityUpload); e.target.value = ''; });
            profilePicFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (event) => { profilePicUrlInput.value = event.target.result; };
                    reader.readAsDataURL(file);
                } else {
                    profilePicUrlInput.value = '';
                }
            });

            // --- LOCAL STORAGE PERSISTENCE ---
            function saveDataToLocalStorage() {
                try {
                    const dataToSave = {
                        users: userDatabase,
                        teams: teamDatabase,
                        competitions: competitionDatabase,
                        universities: universityDatabase
                    };
                    localStorage.setItem('electiToolDataV15', JSON.stringify(dataToSave));
                } catch (e) {
                    console.error("Could not save to localStorage. Data might be too large.", e);
                }
            }

            function loadDataFromLocalStorage() {
                const savedData = localStorage.getItem('electiToolDataV15');
                if (savedData) {
                    try {
                        const data = JSON.parse(savedData);
                        userDatabase = data.users.map(u => ({...u, isTrusted: u.isTrusted !== false, updatedAt: new Date(u.updatedAt) })) || [];
                        teamDatabase = data.teams || [];
                        competitionDatabase = data.competitions || {};
                        universityDatabase = data.universities || [];
                        usersToAnalyze = userDatabase.map(dbUser => {
                            const placementPercentages = dbUser.placements.map(p => (p.rank / p.total) * 100);
                            return { handle: dbUser.handle, lunaNovaScore: dbUser.lunaNovaScore, lunaHardScore: dbUser.lunaHardScore, placements: placementPercentages, isTrusted: dbUser.isTrusted };
                        });
                    } catch (e) {
                        console.error("Error parsing data from localStorage", e);
                        userDatabase = []; teamDatabase = []; competitionDatabase = {}; universityDatabase = [];
                    }
                }
            }

            // Automatically save on changes
            window.addEventListener('beforeunload', saveDataToLocalStorage);

            // Initial setup
            loadDataFromLocalStorage();
            updateUserListDisplay();
            updateAnalysisSortIndicators();
            renderAll();
        });
    </script>
</body>
</html>

